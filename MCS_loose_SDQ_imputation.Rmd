---
title: "MCS_autism_loose_inclusion"
author: "Yira Zhang"
date: "2023-11-28"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Load data
```{r warning=FALSE}
library(readr)
library(tidyverse)
library(naniar)
library(fastDummies)
library(reshape)
mcs2_parent_cm <- read_delim("/Users/zhangxinhe/Documents/who recieves a diagnosis/MCS/MCS_data/UKDA-5350-tab/tab/mcs2_parent_cm_interview.tab", show_col_types = FALSE)
mcs2_parent_cm$cmid <- paste(mcs2_parent_cm$MCSID,mcs2_parent_cm$BCNUM00, sep = "")
mcs3_parent_cm <- read_delim("/Users/zhangxinhe/Documents/who recieves a diagnosis/MCS/MCS_data/UKDA-5795-tab/tab/mcs3_parent_cm_interview.tab", show_col_types = FALSE)
mcs3_parent_cm$cmid <- paste(mcs3_parent_cm$MCSID,mcs3_parent_cm$CCNUM00, sep = "")

mcs4_parent_cm <- read_delim("/Users/zhangxinhe/Documents/who recieves a diagnosis/MCS/MCS_data/UKDA-6411-tab/tab/mcs4_parent_cm_interview.tab", show_col_types = FALSE)
mcs4_parent_cm$cmid <- paste(mcs4_parent_cm$MCSID,mcs4_parent_cm$DCNUM00, sep = "")

mcs5_parent_cm <- read_delim("/Users/zhangxinhe/Documents/who recieves a diagnosis/MCS/MCS_data/UKDA-7464-tab/tab/mcs5_parent_cm_interview.tab", show_col_types = FALSE)
mcs5_parent_cm$cmid <- paste(mcs5_parent_cm$MCSID,mcs5_parent_cm$ECNUM00, sep = "")

mcs6_parent_cm <- read_delim("/Users/zhangxinhe/Documents/who recieves a diagnosis/MCS/MCS_data/UKDA-8156-tab/tab/mcs6_parent_cm_interview.tab", show_col_types = FALSE)
mcs6_parent_cm$cmid <- paste(mcs6_parent_cm$MCSID,mcs6_parent_cm$FCNUM00, sep = "")

mcs7_parent_cm <- read_delim("/Users/zhangxinhe/Documents/who recieves a diagnosis/MCS/MCS_data/UKDA-8682-tab/tab/mcs7_parent_cm_interview.tab", show_col_types = FALSE)
mcs7_parent_cm$cmid <- paste(mcs7_parent_cm$MCSID,mcs7_parent_cm$GCNUM00, sep = "")

```

## Identify autism diagnosis
```{r}
mcs3_asd <- mcs3_parent_cm %>%  dplyr::select(MCSID,cmid,CPNUM00,CPAUTS00)
colnames(mcs3_asd)[3] <- "PNUM"
mcs4_asd <- mcs4_parent_cm%>% dplyr::select(MCSID,cmid,DPNUM00,DPAUTS00)
mcs4_asd$DPAUTS00[mcs4_asd$DPAUTS00 == " "] <- NA
colnames(mcs4_asd)[3] <- "PNUM"
mcs5_asd <- mcs5_parent_cm  %>% dplyr::select(MCSID,cmid,EPNUM00,EPAUTS00)
colnames(mcs5_asd)[3] <- "PNUM"
mcs6_asd <- mcs6_parent_cm  %>% dplyr::select(MCSID,cmid,FPNUM00,FPAUTS00)
colnames(mcs6_asd)[3] <- "PNUM"
```

########## Q: how loose should we get ?
1) reported one diagnosis at any timepoint OR require at least *two consecutive* reports if the first report was not at the last sweep
2) limits on invalid data? (Mandy et al., 2022 included only those with at most one NA across sweeps)

######### A: as loose as possible: anyone with at least one report at any time, no matter how many invalid reports at other time points, i.e., it could be 1-NA-NA-NA, in the initial sample

######### Q: Co-occurring conditions? E.g., ADHD
######### A: Hierachical ? (Ford paper?)
CPADHD00
```{r}
asd_list <- list(mcs3_asd,mcs4_asd,mcs5_asd,mcs6_asd)
asd_pattern <- unique(Reduce(function(x, y) merge(x, y, by = c('MCSID', 'cmid',"PNUM"), all = TRUE), asd_list)) %>% mutate_all(., ~ifelse(. %in% c(-1,-2,-8,-9), NA, .)) 

asd_pattern$EPAUTS00 <- ifelse(asd_pattern$DPAUTS00 == 1 & is.na(asd_pattern$EPAUTS00), 1, asd_pattern$EPAUTS00)
asd_pattern$FPAUTS00 <- ifelse(asd_pattern$EPAUTS00 == 1 & is.na(asd_pattern$FPAUTS00), 1, asd_pattern$FPAUTS00)

asd_pattern$pattern <- paste(asd_pattern$CPAUTS00,asd_pattern$DPAUTS00,asd_pattern$EPAUTS00,asd_pattern$FPAUTS00, sep = "-")
# as in sweep5 (Exxxx) and sweep6 (Fxxxx), autism diagnosis was not asked to those who recieved diagnosis, here we automatically add 1 if they reported diagnoses in the prior sweep
mcs_asd <- asd_pattern[grepl("1", asd_pattern$pattern) > 0, ]

```



# Loosest sample

```{r}
############ Loosest version:no limit on #NA or consecutive reports 
complete_asd_loose <- mcs_asd %>%
  mutate(
    num_diag = rowSums(dplyr::select(.,ends_with("AUTS00")) == 1, na.rm = TRUE),
    num_na = rowSums(is.na(dplyr::select(., ends_with("AUTS00")))))

asd_sample_loose <- complete_asd_loose %>% 
  dplyr::arrange(cmid, desc(num_diag), num_na) %>%
  group_by(cmid) %>% slice(1) %>% 
  ungroup() %>% 
  dplyr::select(-num_diag, - num_na)  

# Create a column for the position of the first one
asd_sample_diag_loose <- asd_sample_loose %>%
  mutate(first_one = sapply(strsplit(pattern, "-"), function(x) which(x == "1")[1])) %>%
  mutate(diag.age = case_when(
    first_one == 1 ~ 5,
    first_one == 2 ~ 7,
    first_one == 3 ~ 11,
    first_one == 4 ~ 14
  ))

# Create a column to identify if it has at least two consecutive 1's
asd_sample_diag_loose <- asd_sample_diag_loose %>%
  mutate(cons.diag = as.integer(grepl("1-1", pattern))) # N = 623
# table(asd_sample_diag_loose_cons$diag.age) 
# N5:7:11:14 = 88:127:209:154 ~ 1:1.44:2.38:1.75
table(asd_sample_diag_loose$diag.age)  # N 5:7:11:14 = 131:127:211:154
```

```{r eval = FALSE}
MCS_autism <- read.csv("/Users/zhangxinhe/Documents/who recieves a diagnosis/MCS/MCS_SDQ_autism.csv")

```

```{r}
mcs1_cm_derived <- read_delim("/Users/zhangxinhe/Documents/who recieves a diagnosis/MCS/MCS_data/UKDA-4683-tab/tab/mcs1_cm_derived.tab", show_col_types = F)
mcs1_cm_derived$cmid <- paste(mcs1_cm_derived$MCSID, mcs1_cm_derived$ACNUM00, sep = "")
mcs1_hhgrid <- read_delim("/Users/zhangxinhe/Documents/who recieves a diagnosis/MCS/MCS_data/UKDA-4683-tab/tab/mcs1_hhgrid.tab", show_col_types = FALSE)

mcs1_hhgrid$cmid <- paste(mcs1_hhgrid$MCSID, mcs1_hhgrid$ACNUM00, sep = "")
mcs1_parent_derived <- read_delim("/Users/zhangxinhe/Documents/who recieves a diagnosis/MCS/MCS_data/UKDA-4683-tab/tab/mcs1_parent_derived.tab", show_col_types = FALSE)
mcs2_hhgrid <- read_delim("/Users/zhangxinhe/Documents/who recieves a diagnosis/MCS/MCS_data/UKDA-5350-tab/tab/mcs2_hhgrid.tab", show_col_types = FALSE)
mcs2_hhgrid$cmid <- paste(mcs2_hhgrid$MCSID, mcs2_hhgrid$BCNUM00, sep = "")
mcs2_cog <- read_delim("/Users/zhangxinhe/Documents/who recieves a diagnosis/MCS/MCS_data/UKDA-5350-tab/tab/mcs2_cm_cognitive_assessment.tab", show_col_types = FALSE)
mcs2_cog$cmid <- paste(mcs2_cog$MCSID,mcs2_cog$BCNUM00, sep = "")
mcs2_cm_derived <- read_delim("/Users/zhangxinhe/Documents/who recieves a diagnosis/MCS/MCS_data/UKDA-5350-tab/tab/mcs2_cm_derived.tab", show_col_types = FALSE)
mcs2_cm_derived$cmid <- paste(mcs2_cm_derived$MCSID,mcs2_cm_derived$BCNUM00, sep = "")
mcs2_parent_interview <- read_delim("/Users/zhangxinhe/Documents/who recieves a diagnosis/MCS/MCS_data/UKDA-5350-tab/tab/mcs2_parent_interview.tab",show_col_types = FALSE)
mcs2_family_derived <- read_delim("/Users/zhangxinhe/Documents/who recieves a diagnosis/MCS/MCS_data/UKDA-5350-tab/tab/mcs2_family_derived.tab", show_col_types = FALSE)
mcs2_geo <- read_delim("/Users/zhangxinhe/Documents/who recieves a diagnosis/MCS/MCS_data/UKDA-5350-tab/tab/mcs2_geographically_linked_data.tab",show_col_types = FALSE)
mcs2_neighb <- read_delim("/Users/zhangxinhe/Documents/who recieves a diagnosis/MCS/MCS_data/UKDA-5350-tab/tab/mcs2_neighbourhood_observations.tab", show_col_types = F)
mcs2_parent_derived <- read_delim("/Users/zhangxinhe/Documents/who recieves a diagnosis/MCS/MCS_data/UKDA-5350-tab/tab/mcs2_parent_derived.tab", show_col_types = FALSE)

mcs3_cm_derived <- read_delim("/Users/zhangxinhe/Documents/who recieves a diagnosis/MCS/MCS_data/UKDA-5795-tab/tab/mcs3_cm_derived.tab", show_col_types = FALSE)
mcs3_cm_derived$cmid <- paste(mcs3_cm_derived$MCSID,mcs3_cm_derived$CCNUM00, sep = "")
mcs3_parent_derived <- read_delim("/Users/zhangxinhe/Documents/who recieves a diagnosis/MCS/MCS_data/UKDA-5795-tab/tab/mcs3_parent_derived.tab", show_col_types = FALSE)

mcs4_cm_derived <- read_delim("/Users/zhangxinhe/Documents/who recieves a diagnosis/MCS/MCS_data/UKDA-6411-tab/tab/mcs4_cm_derived.tab", show_col_types = FALSE)
mcs4_cm_derived$cmid <- paste(mcs4_cm_derived$MCSID,mcs4_cm_derived$DCNUM00, sep = "")

mcs5_cm_derived <- read_delim("/Users/zhangxinhe/Documents/who recieves a diagnosis/MCS/MCS_data/UKDA-7464-tab/tab/mcs5_cm_derived.tab", show_col_types = FALSE)
mcs5_cm_derived$cmid <- paste(mcs5_cm_derived$MCSID,mcs5_cm_derived$ECNUM00, sep = "")
mcs5_cm_interview <- read_delim("/Users/zhangxinhe/Documents/who recieves a diagnosis/MCS/MCS_data/UKDA-7464-tab/tab/mcs5_cm_interview.tab", show_col_types = FALSE)
mcs5_cm_interview$cmid <- paste(mcs5_cm_interview$MCSID,mcs5_cm_interview$ECNUM00, sep = "")

mcs6_cm_derived <- read_delim("/Users/zhangxinhe/Documents/who recieves a diagnosis/MCS/MCS_data/UKDA-8156-tab/tab/mcs6_cm_derived.tab", show_col_types = FALSE)
mcs6_cm_derived$cmid <- paste(mcs6_cm_derived$MCSID,mcs6_cm_derived$FCNUM00, sep = "")

mcs7_cm_derived <- read_delim("/Users/zhangxinhe/Documents/who recieves a diagnosis/MCS/MCS_data/UKDA-8682-tab/tab/mcs7_cm_derived.tab", show_col_types = FALSE)
mcs7_cm_derived$cmid <- paste(mcs7_cm_derived$MCSID,mcs7_cm_derived$GCNUM00, sep = "")

```



# Demographics 
## Sex
```{r}

mcs1_sex <- mcs1_hhgrid %>% filter(cmid %in% asd_sample_diag_loose$cmid) %>% dplyr::select(MCSID, cmid,AHCSEX00)
mcs2_sex <- mcs2_hhgrid %>% filter(cmid %in% asd_sample_diag_loose$cmid) %>% dplyr::select(MCSID, cmid,BHCSEX00)

mcs_sex <- merge(mcs1_sex,mcs2_sex, by = c("MCSID","cmid"), all = T)

mcs_sex$sex <- ifelse(!is.na(mcs_sex$AHCSEX00) & !is.na(mcs_sex$BHCSEX00),ifelse(mcs_sex$AHCSEX00 == mcs_sex$BHCSEX00, mcs_sex$AHCSEX00, -9),ifelse(!is.na(mcs_sex$AHCSEX00), mcs_sex$AHCSEX00,mcs_sex$BHCSEX00))
table(mcs_sex$sex) # M480,F143
```

## Maternal age at delivery
```{r}
mcs1_birth_age <- mcs1_parent_derived %>% filter(MCSID %in% mcs_sex$MCSID & ADDRES00 == 1)  %>% dplyr::select(MCSID, ADDAGB00, ADDGAB00) 
#names(mcs1_birth_age) <- c("MCSID","MAD","MAD_grp")

mcs2_birth_age <- mcs2_parent_derived %>% filter(MCSID %in% mcs_sex$MCSID & BDDRES00 == 1)  %>% dplyr::select(MCSID, BDDAGB00, BDDGAB00)
#names(mcs2_birth_age) <- c("MCSID","MAD","MAD_grp")
mcs_birth_age <- merge(mcs1_birth_age,mcs2_birth_age,  all = T)
mcs_birth_age[mcs_birth_age <0]<- NA
mcs_birth_age$mad <-  coalesce(mcs_birth_age$ADDGAB00,mcs_birth_age$BDDGAB00)
# Natural mother, age at birth of CM

```

## Ethnicity
```{r}
mcs1_eth <- mcs1_cm_derived %>% filter(cmid %in% mcs_sex$cmid) %>%
  dplyr::select(MCSID, cmid, ADC06E00)
mcs2_eth <- mcs2_cm_derived %>% filter(cmid %in% mcs_sex$cmid) %>% dplyr::select(MCSID, cmid, BDC06E00)
mcs3_eth <- mcs3_cm_derived %>% filter(cmid %in% mcs_sex$cmid) %>% dplyr::select(MCSID, cmid, CDC06E00)
mcs_eth <- merge(mcs1_eth, merge(mcs2_eth, mcs3_eth, by = c("MCSID","cmid"), all = T),by = c("MCSID","cmid"), all = T)
mcs_eth[mcs_eth < 0] <- NA

mcs_eth$eth <-  coalesce(mcs_eth$ADC06E00, mcs_eth$BDC06E00, mcs_eth$CDC06E00)
 # 618 available ethnicity
table(mcs_eth$eth) # 1White=550; 2Mixed = 19; 3Indian = 3; 4Pakistani and Bangladeshi= 18; 5Black or Black British= 20; 6Other Ethnic group (inc Chinese,Other)= 8 
mcs_eth_mad <- merge(mcs_eth, mcs_birth_age, by = "MCSID", all = T)
```


## Other tips
# socio-economic status (pca), maternal age at delivery,iq (pca), deprivation(pca)
```{r}
mcs_ses <- read.csv("/Users/zhangxinhe/Documents/who recieves a diagnosis/MCS/mcs_other_ses_identifier.csv")
mcs_asd_ses <- mcs_ses%>% filter(MCSID %in% asd_sample_diag_loose$MCSID) %>% select(MCSID,BOECDSC0,BDCWRK00,	BDOEDP00,	BDROOW00,PC1)
colnames(mcs_asd_ses) <- c("MCSID","BOECDSC0","BDCWRK00","BDOEDP00","BDROOW00","ses_PC1")
mcs_iq <- read.csv("/Users/zhangxinhe/Documents/who recieves a diagnosis/MCS/mcs_ID_identifier.csv")
mcs_iq <- mcs_iq[,-1]
colnames(mcs_iq) <- c("MCSID","BCNUM00","cmid","IQ_PC1","ID")
mcs_iq$cmid <- paste(mcs_iq$MCSID, mcs_iq$BCNUM00, sep = "")
mcs_asd_iq <- mcs_iq %>% filter(cmid %in% asd_sample_diag_loose$cmid) %>% select(cmid,IQ_PC1)

mcs_dep <- read.csv("/Users/zhangxinhe/Documents/who recieves a diagnosis/MCS/mcs_deprivation_identifier.csv")
mcs_asd_dep <- mcs_dep%>% filter(MCSID %in% asd_sample_diag_loose$MCSID) %>% select(MCSID,ccountry,Overall,Income,Employment,HealthDisability,EduSkillTrain,PC1)
colnames(mcs_asd_dep) <- c("MCSID","ccountry","Overall","Income","Employment","HealthDisability","EduSkillTrain","dep_PC1")


```

# add raw score (summary score) of cognitive assessments
```{r}
mcs2_cog <- read_delim("/Users/zhangxinhe/Documents/who recieves a diagnosis/MCS/MCS_data/UKDA-5350-tab/tab/mcs2_cm_cognitive_assessment.tab")
mcs2_cog$cmid <- paste(mcs2_cog$MCSID,mcs2_cog$BCNUM00, sep = "")
mcs2_asd_loose_cog <- mcs2_cog %>% filter(cmid %in% asd_sample_diag_loose$cmid)
mcs3_cog <- read_delim("/Users/zhangxinhe/Documents/who recieves a diagnosis/MCS/MCS_data/UKDA-5795-tab/tab/mcs3_cm_cognitive_assessment.tab")
mcs3_cog$cmid <- paste(mcs3_cog$MCSID,mcs3_cog$CCNUM00, sep = "")
mcs3_asd_loose_cog <- mcs3_cog %>% filter(cmid %in% asd_sample_diag_loose$cmid)
mcs4_cog <- read_delim("/Users/zhangxinhe/Documents/who recieves a diagnosis/MCS/MCS_data/UKDA-6411-tab/tab/mcs4_cm_cognitive_assessment.tab")
mcs4_cog$cmid <- paste(mcs4_cog$MCSID,mcs4_cog$DCNUM00, sep = "")
mcs4_asd_loose_cog <- mcs4_cog %>% filter(cmid %in% asd_sample_diag_loose$cmid)
mcs5_cog <- read_delim("/Users/zhangxinhe/Documents/who recieves a diagnosis/MCS/MCS_data/UKDA-7464-tab/tab/mcs5_cm_cognitive_assessment.tab")
mcs5_cog$cmid <- paste(mcs5_cog$MCSID,mcs5_cog$ECNUM00, sep = "")
mcs5_asd_loose_cog <- mcs5_cog %>% filter(cmid %in% asd_sample_diag_loose$cmid)

```

```{r}
# all used ability score or composit standard score/age standardised score when ability score is not available 
mcs2_cog_sum <- dplyr::select(mcs2_asd_loose_cog, cmid,BDSRCS00,BDBASA00) %>% mutate_all(~ifelse(. < 0 | . == "", NA, .))

mcs3_cog_sum <- dplyr::select(mcs3_asd_loose_cog,cmid,CCNVABIL,CCPCABIL,CCPSABIL) %>% mutate_all(~ifelse(. < 0 | . == "", NA, .))
                          
mcs4_cog_sum <- dplyr::select(mcs4_asd_loose_cog,cmid,DCPCAB00,DCWRAB00,DCMATHS7SA)%>% mutate_all(~ifelse(. < 0 | . == "", NA, .))
 
mcs5_cog_sum <- dplyr::select(mcs5_asd_loose_cog, cmid,ECDTOT00) %>% mutate_all(~ifelse(. < 0 | . == "", NA, .))
                              

cog_list <- list(mcs2_cog_sum, mcs3_cog_sum, mcs4_cog_sum, mcs5_cog_sum)
mcs_2_5_cog_asd <- cog_list %>% reduce(full_join, by= 'cmid')

```



# add developmental milestones
```{r}

mcs1_devmile <- dplyr::select(mcs1_parent_cm_interview, c("cmid","AELIG00","ACSMIL00","ACSITU00","ACSTAN00","ACHAND00","ACGRAB00","ACPICK00","ACPTOY00",
"ACWALK00","ACGIVE00","ACWAVE00","ACARMS00","ACNODS00","ACMOVE00"))

mcs1_asd_devmile <- mcs1_devmile %>% filter(AELIG00 == "1") %>% filter(cmid %in% asd_sample_diag_loose$cmid) %>% filter_at(vars(-cmid, -AELIG00), all_vars( . >- 1)) 


mcs2_devmile <- dplyr::select(mcs2_parent_cm_interview, c("cmid","BELIG00","BPDRDA00","BPCLDA00"))
mcs2_asd_devmile <- mcs2_devmile %>% filter(BELIG00 == "1") %>% filter(cmid %in% asd_sample_diag_loose$cmid) %>% filter_at(vars(-cmid, -BELIG00),all_vars( . > -1 & . < 4))

mcs3_devmile <- dplyr::select(mcs3_parent_cm_interview, c("cmid","CELIG00","CPSQCO00","CPDRSS00")) 
mcs3_asd_devmile <- mcs3_devmile %>% filter(CELIG00 == "1") %>% filter(cmid %in% asd_sample_diag_loose$cmid) %>% filter_at(vars(-cmid, -CELIG00), all_vars(. <3 &  . > -1))
mcs_asd_loose_devmile <- merge(merge(mcs1_asd_devmile,mcs2_asd_devmile, by = "cmid", all = T),mcs3_asd_devmile, by = "cmid", all = T)
  
 
mcs_asd_loose_devmile <- subset(mcs_asd_loose_devmile, select=-c(AELIG00, BELIG00, CELIG00))
# sweep1: 1 = often; 2 = Once or Twice; 3 = Not yet
# Sweep2: 1 = always; 2 = sometimes; 3 = never; 4 = dk
# sweep3: 1 = yes; 2 = no; 3 = dk
# PNUM00 == 1 to only keep main carer answer

```

# Analyses before imputation
## Extract SDQs (parent-report) aacross sweeps
```{r}
mcs2_SDQ <- mcs2_cm_derived %>% filter(cmid %in% asd_sample_diag_loose$cmid) %>% dplyr::select(MCSID, cmid, BEMOTION,BCONDUCT,BHYPER,BPEER,BPROSOC,BEBDTOT) %>% mutate_all(., ~ifelse(. %in% c(-1,-2,-8,-9), NA, .)) 

mcs3_SDQ <- mcs3_cm_derived %>% filter(cmid %in% asd_sample_diag_loose$cmid) %>% dplyr::select(MCSID, cmid, CEMOTION,CCONDUCT,CHYPER,CPEER,CPROSOC,CEBDTOT)%>% mutate_all(., ~ifelse(. %in% c(-1,-2,-8,-9), NA, .)) 

mcs4_SDQ <- mcs4_cm_derived %>% filter(cmid %in% asd_sample_diag_loose$cmid) %>% dplyr::select(MCSID, cmid, DDEMOTION,DDCONDUCT,DDHYPER,DDPEER,DDPROSOC,DDDEBDTOT)%>% mutate_all(., ~ifelse(. %in% c(-1,-2,-8,-9), NA, .)) 
mcs5_SDQ_raw <- mcs5_cm_interview %>% filter(cmid %in% asd_sample_diag_loose$cmid) %>% dplyr::select(MCSID,cmid,EPSDPF00,EPSDRO00,EPSDHS00,EPSDSR00,EPSDTT00,
EPSDSP00,EPSDOR00,EPSDMW00,EPSDHU00,EPSDFS00,
EPSDGF00,EPSDFB00,EPSDUD00,EPSDLC00,EPSDDC00,
EPSDNC00,EPSDKY00,EPSDOA00,EPSDPB00,EPSDVH00,
EPSDST00,EPSDCS00,EPSDGB00,EPSDFE00,EPSDTE00) 
mcs5_SDQ_raw_rc <- mcs5_SDQ_raw %>% dplyr::mutate(across(EPSDPF00:EPSDTE00, ~as.numeric(case_when(
    . == 1 ~ 0,
    . == 2 ~ 1,
    . == 3 ~ 2,
    . %in% c(4,-1,-9) ~ NA
  )))) %>% dplyr::mutate(across(c(EPSDOR00,EPSDST00,EPSDTE00,EPSDGF00,EPSDLC00), ~ 2-.))
mcs5_SDQ <- mcs5_SDQ_raw_rc %>%
  dplyr::mutate(
    EEMOTION = rowSums(dplyr::select(., EPSDHS00,EPSDMW00,EPSDUD00,EPSDNC00,EPSDFE00)),
    ECONDUCT = rowSums(dplyr::select(.,EPSDTT00,EPSDFB00,EPSDOA00,EPSDCS00,EPSDOR00)),
    EHYPER = rowSums(dplyr::select(., EPSDRO00,EPSDFS00,EPSDDC00,EPSDST00,EPSDTE00)),
    EPEER = rowSums(dplyr::select(.,EPSDSP00,EPSDPB00,EPSDGB00,EPSDGF00,EPSDLC00)),
    EPROSOC = rowSums(dplyr::select(.,EPSDPF00,EPSDSR00,EPSDHU00,EPSDKY00,EPSDVH00)),
    EEBDTOT = rowSums(across(c(EEMOTION, ECONDUCT, EHYPER, EPEER))))
mcs5_SDQ <- mcs5_SDQ %>% dplyr::select(MCSID,cmid, EEMOTION, ECONDUCT,EHYPER,EPEER,EPROSOC,EEBDTOT)
mcs6_SDQ <- mcs6_cm_derived %>% filter(cmid %in% asd_sample_diag_loose$cmid) %>% dplyr::select(MCSID, cmid, FEMOTION,FCONDUCT,FHYPER,FPEER,FPROSOC,FEBDTOT)%>% mutate_all(., ~ifelse(. %in% c(-1,-2,-8,-9), NA, .)) 
mcs7_SDQ <- mcs7_cm_derived %>% filter(cmid %in% asd_sample_diag_loose$cmid) %>% dplyr::select(MCSID, cmid, GEMOTION,GCONDUCT,GHYPER,GPEER,GPROSOC,GEBDTOT)%>% mutate_all(., ~ifelse(. %in% c(-1,-2,-8,-9), NA, .)) 


```
```{r}
asd_loose_SDQ_list <- list(mcs2_SDQ,mcs3_SDQ,mcs4_SDQ,mcs5_SDQ,mcs6_SDQ,mcs7_SDQ)
asd_loose_SDQ <- unique(Reduce(function(x, y) merge(x, y, by = c('MCSID', 'cmid'), all = TRUE), asd_loose_SDQ_list))
asd_loose_SDQ_complete<- asd_loose_SDQ %>% na.omit()
```

```{r}
mcar_test(asd_loose_SDQ) # missing completely at random
asd_loose_SDQ <- merge(mcs_sex[c(1:2,5)], asd_loose_SDQ, by = c("MCSID","cmid"))
#asd_loose_SDQ <- asd_loose_SDQ[rowSums(is.na(asd_loose_SDQ[, 4:39])) < 35, ] # remove all NA rows
asd_loose_SDQ <- merge(asd_loose_SDQ, asd_sample_diag_loose[c(1:2,10)],  by = c("MCSID","cmid")) %>% dplyr::mutate(group = case_when(
  diag.age %in% c(5,7,11) ~ "Early",
  diag.age == 14 ~ "Late"
))

asd_loose_SDQ_complete <- merge(mcs_sex[c(1:2,5)], asd_loose_SDQ_complete,  by = c("MCSID","cmid"), all.x = F, all.y = T)
asd_loose_SDQ_complete <- merge(asd_loose_SDQ_complete, asd_sample_diag_loose[c(1:2,10)],  by = c("MCSID","cmid")) %>% dplyr::mutate(group = case_when(
  diag.age %in% c(5,7,11) ~ "Early",
  diag.age == 14 ~ "Late"
))

```




```{r}

sex_ratio_diag_age <- asd_loose_SDQ_complete %>%
  group_by(diag.age, sex) %>%
  dplyr::summarize(count = n())
sex_ratio_diag_age

sex_ratio_diag_age <-  sex_ratio_diag_age%>%
  dplyr::mutate(percentage = count / sum(count) * 100)
sex_ratio_diag_age$diag.age <- as.factor(sex_ratio_diag_age$diag.age)
sex_ratio_diag_age$sex <- as.factor(sex_ratio_diag_age$sex)
# Create the stacked bar chart using ggplot2
viridis_colors <- viridis::viridis_pal(option = "rocket")(length(unique(sex_ratio_diag_age$sex)))

ggplot(sex_ratio_diag_age, aes(x = diag.age, y = percentage, fill = sex)) +
  geom_col(position = "stack") +
  labs(title = "Diagnosed Autism by Age Group and Sex",
       x = "diagnosis age",
       y = "percentage",
       fill = "Sex") + scale_fill_manual(values = setNames(viridis_colors, unique(sex_ratio_diag_age$sex)), 
                    labels = c("Male", "Female"),
                    guide = guide_legend(title = "Sex")) +theme_classic()
```
```{r}
asd_loose_complete_for_figure<- asd_loose_SDQ_complete_gmm %>% dplyr::mutate(Sex =case_when(
  sex == 1 ~ "Male",
  sex == 2 ~ "Female"))
xtab <- xtabs(~ diag.age + Sex,data = asd_loose_complete_for_figure)
xtab

mosaicplot(
  xtab,
  main = NULL,
  color = c("#FB9A99","#A6CEE3"),  # Specify custom colors
  #sub = "Custom Subtitle",
  xlab = "Diagnosis age group",
  ylab = "Sex",
    # Specify custom labels
  cex.axis = 1.2, las = 1  # Adjust axis label size
)
#mosaicplot(xtab, color = TRUE, main = "Age Group by Gender")


```


## LGCM
```{r}
library(data.table)
# No diagnosis
MCS_no_diag <- read.csv("/Users/zhangxinhe/Documents/who recieves a diagnosis/MCS/MCS_SDQ_control.csv") # 6047 in total
MCS_no_diag$sex_num <- ifelse(MCS_no_diag$Sex == "Male", 1,2)
MCS_no_diag$grp <- "no_diag"
MCS_no_diag$grp_num <- 3
MCS_sdq_no_diag <- MCS_no_diag[,c(1:21,34:39,22:33,40:45)]
MCS_no_diag_sdq_ttl <- MCS_sdq_no_diag[,c(1,9,15,21,27,33,39,42)]

MCS_no_diag_sdq_ttl_long <- melt(setDT(MCS_no_diag_sdq_ttl), id.vars = c("MCSID","Sex"), variable.name = "sweep")

MCS_no_diag_ttl_summary <- MCS_no_diag_sdq_ttl_long %>%
   dplyr::group_by(sweep) %>%
   dplyr::summarise(
    sd = sd(value),
    ttl_mean = mean(value),
    se = plotrix::std.error(value)
  )
MCS_no_diag_ttl_summary$group <- "no diag"

# Emotional symptoms
MCS_no_diag_sdq_emo <- MCS_sdq_no_diag[,c(1,4,10,16,22,28,34,42)]

MCS_no_diag_sdq_emo_long <- melt(setDT(MCS_no_diag_sdq_emo), id.vars = c("MCSID","Sex"), variable.name = "sweep")

MCS_no_diag_emo_summary <- MCS_no_diag_sdq_emo_long %>%
   dplyr::group_by(sweep) %>%
   dplyr::summarise(
    sd = sd(value),
    emo_mean = mean(value),
    se = plotrix::std.error(value)
  )
MCS_no_diag_emo_summary$group <- "no diag"

# Conduct problems

MCS_no_diag_sdq_con <- MCS_sdq_no_diag[,c(1,5,11,17,23,29,35,42)]

MCS_no_diag_sdq_con_long <- melt(setDT(MCS_no_diag_sdq_con), id.vars = c("MCSID","Sex"), variable.name = "sweep")

MCS_no_diag_con_summary <- MCS_no_diag_sdq_con_long %>%
   dplyr::group_by(sweep) %>%
   dplyr::summarise(
    sd = sd(value),
    con_mean = mean(value),
    se = plotrix::std.error(value)
  )
MCS_no_diag_con_summary$group <- "no diag"


# Hyperactivity -inattention
MCS_no_diag_sdq_hyp <- MCS_sdq_no_diag[,c(1,6,12,18,24,30,36,42)]

MCS_no_diag_sdq_hyp_long <- melt(setDT(MCS_no_diag_sdq_hyp), id.vars = c("MCSID","Sex"), variable.name = "sweep")

MCS_no_diag_hyp_summary <- MCS_no_diag_sdq_hyp_long %>%
   dplyr::group_by(sweep) %>%
   dplyr::summarise(
    sd = sd(value),
    hyp_mean = mean(value),
    se = plotrix::std.error(value)
  )
MCS_no_diag_hyp_summary$group <- "no diag"


# Peer relationship problems
MCS_no_diag_sdq_peer <- MCS_sdq_no_diag[,c(1,7,13,19,25,31,37,42)]

MCS_no_diag_sdq_peer_long <- melt(setDT(MCS_no_diag_sdq_peer), id.vars = c("MCSID","Sex"), variable.name = "sweep")

MCS_no_diag_peer_summary <- MCS_no_diag_sdq_peer_long %>%
   dplyr::group_by(sweep) %>%
   dplyr::summarise(
    sd = sd(value),
    peer_mean = mean(value),
    se = plotrix::std.error(value)
  )
MCS_no_diag_peer_summary$group <- "no diag"


# Prosocial behaviour
MCS_no_diag_sdq_pro <- MCS_sdq_no_diag[,c(1,8,14,20,26,32,38,42)]

MCS_no_diag_sdq_pro_long <- melt(setDT(MCS_no_diag_sdq_pro), id.vars = c("MCSID","Sex"), variable.name = "sweep")

MCS_no_diag_pro_summary <- MCS_no_diag_sdq_pro_long %>%
   dplyr::group_by(sweep) %>%
   dplyr::summarise(
    sd = sd(value),
    pro_mean = mean(value),
    se = plotrix::std.error(value)
  )
MCS_no_diag_pro_summary$group <- "no diag"
```

```{r}
library(lavaan)
mcs_loose_complete_agestr_ttl <- "
int =~ 1*BEBDTOT + 1*CEBDTOT + 1*DDDEBDTOT + 1*EEBDTOT + 1*FEBDTOT + 1*GEBDTOT
slp =~ 3*BEBDTOT + 5*CEBDTOT + 7*DDDEBDTOT + 11*EEBDTOT + 14*FEBDTOT + 17*GEBDTOT

# the parametres for slope reflect the designed ages at corresponding sweeps
"

loose_com_ttl_fit <- growth(mcs_loose_complete_agestr_ttl, data = asd_loose_SDQ_complete,  missing = "fiml", estimator = "ml", fixed.x = F)
fit_mcs_loose_complete_agestr_ttl <- growth(mcs_loose_complete_agestr_ttl, data = asd_loose_SDQ_complete, group = "group", missing = "fiml", estimator = "ml", fixed.x = F)
fit_mcs_agestr_ttl_no_diag <- growth(mcs_loose_complete_agestr_ttl, data =MCS_no_diag_sdq_ttl ,  missing = "fiml", estimator = "ml", fixed.x = F)
summary(fit_mcs_agestr_ttl_no_diag)
fit_mcs_loose_complete_sexstr_ttl <- growth(mcs_loose_complete_agestr_ttl, data = asd_loose_SDQ_complete, group = "sex", missing = "fiml", estimator = "ml", fixed.x = F)
#summary(fit_mcs_loose_complete_agestr_ttl)
mcsb_ttl_anova_sex <- anova(loose_com_ttl_fit,fit_mcs_loose_complete_sexstr_ttl)
mcsb_ttl_anova_age <- anova(loose_com_ttl_fit,fit_mcs_loose_complete_agestr_ttl)
mcsb_anova_ttl_age_results<- data.frame(mcsb_ttl_anova_age)
mcsb_anova_ttl_sex_results<- data.frame(mcsb_ttl_anova_sex)
mcsb_anova_ttl <- rbind(mcsb_anova_ttl_age_results,mcsb_anova_ttl_sex_results)
mcsb_anova_ttl
```

```{r}

mcs_loose_complete_agestr_emo <- "
int =~ 1*BEMOTION + 1*CEMOTION + 1*DDEMOTION + 1*EEMOTION + 1*FEMOTION + 1*GEMOTION
slp =~ 3*BEMOTION + 5*CEMOTION + 7*DDEMOTION + 11*EEMOTION + 14*FEMOTION + 17*GEMOTION

# the parametres for slope reflect the designed ages at corresponding sweeps
"
loose_com_emo_fit <- growth(mcs_loose_complete_agestr_emo, data = asd_loose_SDQ_complete,  missing = "fiml", estimator = "ml", fixed.x = F)
fit_mcs_loose_complete_agestr_emo <- growth(mcs_loose_complete_agestr_emo, data = asd_loose_SDQ_complete, group = "group", missing = "fiml", estimator = "ml", fixed.x = F)

fit_mcs_loose_complete_sexstr_emo <- growth(mcs_loose_complete_agestr_emo, data = asd_loose_SDQ_complete, group = "sex", missing = "fiml", estimator = "ml", fixed.x = F)
#summary(fit_mcs_loose_complete_agestr_emo)
mcsb_emo_anova_sex <- anova(loose_com_emo_fit,fit_mcs_loose_complete_sexstr_emo)
mcsb_emo_anova_age <- anova(loose_com_emo_fit,fit_mcs_loose_complete_agestr_emo)
mcsb_anova_emo_age_results<- data.frame(mcsb_emo_anova_age)
mcsb_anova_emo_sex_results<- data.frame(mcsb_emo_anova_sex)
mcsb_anova_emo <- rbind(mcsb_anova_emo_age_results,mcsb_anova_emo_sex_results)
mcsb_anova_emo
```


```{r}
mcs_loose_complete_agestr_con <- "
int =~ 1*BCONDUCT + 1*CCONDUCT + 1*DDCONDUCT + 1*ECONDUCT + 1*FCONDUCT + 1*GCONDUCT
slp =~ 3*BCONDUCT + 5*CCONDUCT + 7*DDCONDUCT + 11*ECONDUCT + 14*FCONDUCT + 17*GCONDUCT

# the parametres for slope reflect the designed ages at corresponding sweeps
"
loose_com_con_fit <- growth(mcs_loose_complete_agestr_con, data = asd_loose_SDQ_complete,  missing = "fiml", estimator = "ml", fixed.x = F)
fit_mcs_loose_complete_agestr_con <- growth(mcs_loose_complete_agestr_con, data = asd_loose_SDQ_complete, group = "group", missing = "fiml", estimator = "ml", fixed.x = F)

fit_mcs_loose_complete_sexstr_con <- growth(mcs_loose_complete_agestr_con, data = asd_loose_SDQ_complete, group = "sex", missing = "fiml", estimator = "ml", fixed.x = F)
#summary(fit_mcs_loose_complete_agestr_con)
mcsb_con_anova_sex <- anova(loose_com_con_fit,fit_mcs_loose_complete_sexstr_con)
mcsb_con_anova_age <- anova(loose_com_con_fit,fit_mcs_loose_complete_agestr_con)
mcsb_anova_con_age_results<- data.frame(mcsb_con_anova_age)
mcsb_anova_con_sex_results<- data.frame(mcsb_con_anova_sex)
mcsb_anova_con <- rbind(mcsb_anova_con_age_results,mcsb_anova_con_sex_results)
mcsb_anova_con

```
```{r}

mcs_loose_complete_agestr_hyp <- "
int =~ 1*BHYPER + 1*CHYPER + 1*DDHYPER + 1*EHYPER + 1*FHYPER + 1*GHYPER
slp =~ 3*BHYPER + 5*CHYPER + 7*DDHYPER + 11*EHYPER + 14*FHYPER + 17*GHYPER

# the parametres for slope reflect the designed ages at corresponding sweeps
"
loose_com_hyp_fit <- growth(mcs_loose_complete_agestr_hyp, data = asd_loose_SDQ_complete,  missing = "fiml", estimator = "ml", fixed.x = F)
fit_mcs_loose_complete_agestr_hyp <- growth(mcs_loose_complete_agestr_hyp, data = asd_loose_SDQ_complete, group = "group", missing = "fiml", estimator = "ml", fixed.x = F)

fit_mcs_loose_complete_sexstr_hyp <- growth(mcs_loose_complete_agestr_hyp, data = asd_loose_SDQ_complete, group = "sex", missing = "fiml", estimator = "ml", fixed.x = F)
#summary(fit_mcs_loose_complete_agestr_hyp)
mcsb_hyp_anova_sex <- anova(loose_com_hyp_fit,fit_mcs_loose_complete_sexstr_hyp)
mcsb_hyp_anova_age <- anova(loose_com_hyp_fit,fit_mcs_loose_complete_agestr_hyp)
mcsb_anova_hyp_age_results<- data.frame(mcsb_hyp_anova_age)
mcsb_anova_hyp_sex_results<- data.frame(mcsb_hyp_anova_sex)
mcsb_anova_hyp <- rbind(mcsb_anova_hyp_age_results,mcsb_anova_hyp_sex_results)
mcsb_anova_hyp

```
```{r}

mcs_loose_complete_agestr_peer <- "
int =~ 1*BPEER + 1*CPEER + 1*DDPEER + 1*EPEER + 1*FPEER + 1*GPEER
slp =~ 3*BPEER + 5*CPEER + 7*DDPEER + 11*EPEER + 14*FPEER + 17*GPEER

# the parametres for slope reflect the designed ages at corresponding sweeps
"
loose_com_peer_fit <- growth(mcs_loose_complete_agestr_peer, data = asd_loose_SDQ_complete,  missing = "fiml", estimator = "ml", fixed.x = F)
fit_mcs_loose_complete_agestr_peer <- growth(mcs_loose_complete_agestr_peer, data = asd_loose_SDQ_complete, group = "group", missing = "fiml", estimator = "ml", fixed.x = F)

fit_mcs_loose_complete_sexstr_peer <- growth(mcs_loose_complete_agestr_peer, data = asd_loose_SDQ_complete, group = "sex", missing = "fiml", estimator = "ml", fixed.x = F)
#summary(fit_mcs_loose_complete_agestr_peer)
mcsb_peer_anova_sex <- anova(loose_com_peer_fit,fit_mcs_loose_complete_sexstr_peer)
mcsb_peer_anova_age <- anova(loose_com_peer_fit,fit_mcs_loose_complete_agestr_peer)
mcsb_anova_peer_age_results<- data.frame(mcsb_peer_anova_age)
mcsb_anova_peer_sex_results<- data.frame(mcsb_peer_anova_sex)
mcsb_anova_peer <- rbind(mcsb_anova_peer_age_results,mcsb_anova_peer_sex_results)
mcsb_anova_peer

```
```{r}

mcs_loose_complete_agestr_pro <- "
int =~ 1*BPROSOC + 1*CPROSOC + 1*DDPROSOC + 1*EPROSOC + 1*FPROSOC + 1*GPROSOC
slp =~ 3*BPROSOC + 5*CPROSOC + 7*DDPROSOC + 11*EPROSOC + 14*FPROSOC + 17*GPROSOC

# the parametres for slope reflect the designed ages at corresponding sweeps
"
pro_col <- c("BPROSOC","CPROSOC","DDPROSOC","EPROSOC","FPROSOC","GPROSOC")
asd_loose_SDQ_complete_nopro0 <- asd_loose_SDQ_complete %>%
  filter(rowSums(apply(dplyr::select(.,pro_col), 2, function(x) x == 0)) == 0)
fit_mcs_loose_complete_agestr_pro <- growth(mcs_loose_complete_agestr_pro, data = asd_loose_SDQ_complete, group = "group", missing = "fiml", estimator = "ml", fixed.x = F)

fit_mcs_loose_complete_agestr_pro_no0 <- growth(mcs_loose_complete_agestr_pro, data = asd_loose_SDQ_complete_nopro0, group = "group", missing = "fiml", estimator = "ml", fixed.x = F)
#summary(fit_mcs_loose_complete_agestr_pro)

loose_com_pro_fit <- growth(mcs_loose_complete_agestr_pro, data = asd_loose_SDQ_complete,  missing = "fiml", estimator = "ml", fixed.x = F)
fit_mcs_loose_complete_agestr_pro <- growth(mcs_loose_complete_agestr_pro, data = asd_loose_SDQ_complete, group = "group", missing = "fiml", estimator = "ml", fixed.x = F)

fit_mcs_loose_complete_sexstr_pro <- growth(mcs_loose_complete_agestr_pro, data = asd_loose_SDQ_complete, group = "sex", missing = "fiml", estimator = "ml", fixed.x = F)
#summary(fit_mcs_loose_complete_agestr_pro)
mcsb_pro_anova_sex <- anova(loose_com_pro_fit,fit_mcs_loose_complete_sexstr_pro)
mcsb_pro_anova_age <- anova(loose_com_pro_fit,fit_mcs_loose_complete_agestr_pro)
mcsb_anova_pro_age_results<- data.frame(mcsb_pro_anova_age)
mcsb_anova_pro_sex_results<- data.frame(mcsb_pro_anova_sex)
mcsb_anova_pro <- rbind(mcsb_anova_pro_age_results,mcsb_anova_pro_sex_results)
mcsb_anova_pro
```
```{r}
est_fit_mcs_loose_complete_agestr_ttl <- parameterEstimates(fit_mcs_loose_complete_agestr_ttl) %>% filter(grepl("^(int|slp)$", lhs) & op == "~1")
results_loose_complete_agestr_ttl <- est_fit_mcs_loose_complete_agestr_ttl %>%
  dplyr::select(lhs,group, est, ci.lower, ci.upper, pvalue) %>%
  mutate(Estimates = paste(round(est, 2), " [", round(ci.lower, 2), ", ", round(ci.upper, 2), "]"),
         p_value = round(pvalue,3)) %>%
  dplyr::select(lhs,group,Estimates, p_value)


est_fit_mcs_loose_complete_agestr_emo <- parameterEstimates(fit_mcs_loose_complete_agestr_emo) %>% filter(grepl("int|slp", lhs) & op == "~1")
results_loose_complete_agestr_emo <- est_fit_mcs_loose_complete_agestr_emo %>%
  dplyr::select(lhs,group, est, ci.lower, ci.upper, pvalue) %>%
  mutate(Estimates = paste(round(est, 2), " [", round(ci.lower, 2), ", ", round(ci.upper, 2), "]"),
         p_value = round(pvalue,3)) %>%
  dplyr::select(lhs,group,Estimates, p_value)


est_fit_mcs_loose_complete_agestr_con <- parameterEstimates(fit_mcs_loose_complete_agestr_con) %>% filter(grepl("int|slp", lhs)& op == "~1")
results_loose_complete_agestr_con <- est_fit_mcs_loose_complete_agestr_con %>%
  dplyr::select(lhs,group, est, ci.lower, ci.upper, pvalue) %>%
  mutate(Estimates = paste(round(est, 2), " [", round(ci.lower, 2), ", ", round(ci.upper, 2), "]"),
         p_value = round(pvalue,3)) %>%
  dplyr::select(lhs,group,Estimates, p_value)



est_fit_mcs_loose_complete_agestr_hyp <- parameterEstimates(fit_mcs_loose_complete_agestr_hyp) %>% filter(grepl("int|slp", lhs)& op == "~1")
results_loose_complete_agestr_hyp <- est_fit_mcs_loose_complete_agestr_hyp %>%
  dplyr::select(lhs,group, est, ci.lower, ci.upper, pvalue) %>%
  mutate(Estimates = paste(round(est, 2), " [", round(ci.lower, 2), ", ", round(ci.upper, 2), "]"),
         p_value = round(pvalue,3)) %>%
  dplyr::select(lhs,group,Estimates, p_value)



est_fit_mcs_loose_complete_agestr_peer <- parameterEstimates(fit_mcs_loose_complete_agestr_peer) %>% filter(grepl("int|slp", lhs)& op == "~1")
results_loose_complete_agestr_peer <- est_fit_mcs_loose_complete_agestr_peer %>%
  dplyr::select(lhs,group, est, ci.lower, ci.upper, pvalue) %>%
  mutate(Estimates = paste(round(est, 2), " [", round(ci.lower, 2), ", ", round(ci.upper, 2), "]"),
         p_value = round(pvalue,3)) %>%
  dplyr::select(lhs,group,Estimates, p_value)



est_fit_mcs_loose_complete_agestr_pro <- parameterEstimates(fit_mcs_loose_complete_agestr_pro) %>% filter(grepl("int|slp", lhs)& op == "~1")
results_loose_complete_agestr_pro <- est_fit_mcs_loose_complete_agestr_pro %>%
  dplyr::select(lhs,group, est, ci.lower, ci.upper, pvalue) %>%
  mutate(Estimates = paste(round(est, 2), " [", round(ci.lower, 2), ", ", round(ci.upper, 2), "]"),
         p_value = round(pvalue,3)) %>%
  dplyr::select(lhs,group,Estimates, p_value)

loose_complete_agestr_results_results_table <- rbind(results_loose_complete_agestr_ttl,results_loose_complete_agestr_emo,results_loose_complete_agestr_con,results_loose_complete_agestr_hyp,results_loose_complete_agestr_peer, results_loose_complete_agestr_pro)
loose_complete_agestr_results_results_table

est_fit_mcs_loose_complete_agestr_pro_no0 <- parameterEstimates(fit_mcs_loose_complete_agestr_pro_no0) %>% filter(grepl("int|slp", lhs)& op == "~1")
results_loose_complete_agestr_pro_no0 <- est_fit_mcs_loose_complete_agestr_pro_no0 %>%
  dplyr::select(lhs,group, est, ci.lower, ci.upper, pvalue) %>%
  mutate(Estimates = paste(round(est, 2), " [", round(ci.lower, 2), ", ", round(ci.upper, 2), "]"),
         p_value = round(pvalue,3)) %>%
  dplyr::select(lhs,group,Estimates, p_value)
results_loose_complete_agestr_pro_no0
```


```{r}

mcs_loose_complete_agestr_ttl_adj_2 <- "
int =~ 1*BEBDTOT + 1*CEBDTOT + 1*DDDEBDTOT + 1*EEBDTOT + 1*FEBDTOT + 1*GEBDTOT
slp =~ 3*BEBDTOT + 5*CEBDTOT + 7*DDDEBDTOT + 11*EEBDTOT + 14*FEBDTOT + 17*GEBDTOT
qua =~ 9*BEBDTOT + 25*CEBDTOT + 49*DDDEBDTOT + 121*EEBDTOT + 196*FEBDTOT + 289*GEBDTOT

"
loose_com_ttl_fit_2 <- growth(mcs_loose_complete_agestr_ttl_adj_2, data = asd_loose_SDQ_complete, missing = "fiml", estimator = "ml", fixed.x = F)
fit_mcs_loose_complete_agestr_ttl_adj_2 <- growth(mcs_loose_complete_agestr_ttl_adj_2, data = asd_loose_SDQ_complete, group = "group", missing = "fiml", estimator = "ml", fixed.x = F)
summary(fit_mcs_loose_complete_agestr_ttl_adj_2)
fit_mcs_loose_complete_sexstr_ttl_adj_2 <- growth(mcs_loose_complete_agestr_ttl_adj_2, data = asd_loose_SDQ_complete, group = "sex", missing = "fiml", estimator = "ml", fixed.x = F)

est_fit_mcs_loose_complete_agestr_ttl_adj_2 <- parameterEstimates(fit_mcs_loose_complete_agestr_ttl_adj_2) %>% filter(grepl("int|slp|qua",lhs) & op == "~1")
results_fit_mcs_loose_complete_agestr_ttl_adj_2 <- est_fit_mcs_loose_complete_agestr_ttl_adj_2 %>%
  dplyr::select(lhs, group, est, ci.lower, ci.upper, pvalue) %>%
 mutate(Estimates = sprintf("%.2f [%0.2f, %0.2f]", est, ci.lower, ci.upper),
         p_value = sprintf("%.3f", pvalue)) %>%
  dplyr::select(lhs,group,Estimates, p_value)
results_fit_mcs_loose_complete_agestr_ttl_adj_2

```

```{r}

mcs_loose_complete_agestr_emo_adj_2 <- "
int =~ 1*BEMOTION + 1*CEMOTION + 1*DDEMOTION + 1*EEMOTION + 1*FEMOTION + 1*GEMOTION
slp =~ 3*BEMOTION + 5*CEMOTION + 7*DDEMOTION + 11*EEMOTION + 14*FEMOTION + 17*GEMOTION
qua =~ 9*BEMOTION + 25*CEMOTION + 49*DDEMOTION + 121*EEMOTION + 196*FEMOTION + 289*GEMOTION

"
mcs_loose_complete_agestr_con_adj_2 <- "
int =~ 1*BCONDUCT + 1*CCONDUCT + 1*DDCONDUCT + 1*ECONDUCT + 1*FCONDUCT + 1*GCONDUCT
slp =~ 3*BCONDUCT + 5*CCONDUCT + 7*DDCONDUCT + 11*ECONDUCT + 14*FCONDUCT + 17*GCONDUCT
qua =~ 9*BCONDUCT + 25*CCONDUCT + 49*DDCONDUCT + 121*ECONDUCT + 196*FCONDUCT + 289*GCONDUCT

"

mcs_loose_complete_agestr_hyp_adj_2 <- "
int =~ 1*BHYPER + 1*CHYPER + 1*DDHYPER + 1*EHYPER + 1*FHYPER + 1*GHYPER
slp =~ 3*BHYPER + 5*CHYPER + 7*DDHYPER + 11*EHYPER + 14*FHYPER + 17*GHYPER
qua =~ 9*BHYPER + 25*CHYPER + 49*DDHYPER + 121*EHYPER + 196*FHYPER + 289*GHYPER

"

mcs_loose_complete_agestr_peer_adj_2 <- "
int =~ 1*BPEER + 1*CPEER + 1*DDPEER + 1*EPEER + 1*FPEER + 1*GPEER
slp =~ 3*BPEER + 5*CPEER + 7*DDPEER + 11*EPEER + 14*FPEER + 17*GPEER
qua =~ 9*BPEER + 25*CPEER + 49*DDPEER + 121*EPEER + 196*FPEER + 289*GPEER

"

mcs_loose_complete_agestr_pro_adj_2 <- "
int =~ 1*BPROSOC + 1*CPROSOC + 1*DDPROSOC + 1*EPROSOC + 1*FPROSOC + 1*GPROSOC
slp =~ 3*BPROSOC + 5*CPROSOC + 7*DDPROSOC + 11*EPROSOC + 14*FPROSOC + 17*GPROSOC
qua =~ 9*BPROSOC + 25*CPROSOC + 49*DDPROSOC + 121*EPROSOC + 196*FPROSOC + 289*GPROSOC

"

fit_mcs_loose_complete_agestr_emo_adj_2 <- growth(mcs_loose_complete_agestr_emo_adj_2, data = asd_loose_SDQ_complete, group = "group", missing = "fiml", estimator = "ml", fixed.x = F)
summary(fit_mcs_loose_complete_agestr_emo_adj_2)

est_fit_mcs_loose_complete_agestr_emo_adj_2 <- parameterEstimates(fit_mcs_loose_complete_agestr_emo_adj_2) %>% filter(grepl("int|slp|qua",lhs) & op == "~1")
results_fit_mcs_loose_complete_agestr_emo_adj_2 <- est_fit_mcs_loose_complete_agestr_emo_adj_2 %>%
  dplyr::select(lhs, group, est, ci.lower, ci.upper, pvalue) %>%
 mutate(Estimates = sprintf("%.2f [%0.2f, %0.2f]", est, ci.lower, ci.upper),
         p_value = sprintf("%.3f", pvalue)) %>%
  dplyr::select(lhs,group,Estimates, p_value)
results_fit_mcs_loose_complete_agestr_emo_adj_2


fit_mcs_loose_complete_agestr_con_adj_2 <- growth(mcs_loose_complete_agestr_con_adj_2, data = asd_loose_SDQ_complete, group = "group", missing = "fiml", estimator = "ml", fixed.x = F)
summary(fit_mcs_loose_complete_agestr_con_adj_2)

est_fit_mcs_loose_complete_agestr_con_adj_2 <- parameterEstimates(fit_mcs_loose_complete_agestr_con_adj_2) %>% filter(grepl("int|slp|qua",lhs) & op == "~1")
results_fit_mcs_loose_complete_agestr_con_adj_2 <- est_fit_mcs_loose_complete_agestr_con_adj_2 %>%
  dplyr::select(lhs, group, est, ci.lower, ci.upper, pvalue) %>%
 mutate(Estimates = sprintf("%.2f [%0.2f, %0.2f]", est, ci.lower, ci.upper),
         p_value = sprintf("%.3f", pvalue)) %>%
  dplyr::select(lhs,group,Estimates, p_value)
results_fit_mcs_loose_complete_agestr_con_adj_2


fit_mcs_loose_complete_agestr_hyp_adj_2 <- growth(mcs_loose_complete_agestr_hyp_adj_2, data = asd_loose_SDQ_complete, group = "group", missing = "fiml", estimator = "ml", fixed.x = F)
summary(fit_mcs_loose_complete_agestr_hyp_adj_2)

est_fit_mcs_loose_complete_agestr_hyp_adj_2 <- parameterEstimates(fit_mcs_loose_complete_agestr_hyp_adj_2) %>% filter(grepl("int|slp|qua",lhs) & op == "~1")
results_fit_mcs_loose_complete_agestr_hyp_adj_2 <- est_fit_mcs_loose_complete_agestr_hyp_adj_2 %>%
  dplyr::select(lhs, group, est, ci.lower, ci.upper, pvalue) %>%
 mutate(Estimates = sprintf("%.2f [%0.2f, %0.2f]", est, ci.lower, ci.upper),
         p_value = sprintf("%.3f", pvalue)) %>%
  dplyr::select(lhs,group,Estimates, p_value)
results_fit_mcs_loose_complete_agestr_hyp_adj_2


fit_mcs_loose_complete_agestr_peer_adj_2 <- growth(mcs_loose_complete_agestr_peer_adj_2, data = asd_loose_SDQ_complete, group = "group", missing = "fiml", estimator = "ml", fixed.x = F)
summary(fit_mcs_loose_complete_agestr_peer_adj_2)

est_fit_mcs_loose_complete_agestr_peer_adj_2 <- parameterEstimates(fit_mcs_loose_complete_agestr_peer_adj_2) %>% filter(grepl("int|slp|qua",lhs) & op == "~1")
results_fit_mcs_loose_complete_agestr_peer_adj_2 <- est_fit_mcs_loose_complete_agestr_peer_adj_2 %>%
  dplyr::select(lhs, group, est, ci.lower, ci.upper, pvalue) %>%
 mutate(Estimates = sprintf("%.2f [%0.2f, %0.2f]", est, ci.lower, ci.upper),
         p_value = sprintf("%.3f", pvalue)) %>%
  dplyr::select(lhs,group,Estimates, p_value)
results_fit_mcs_loose_complete_agestr_peer_adj_2

fit_mcs_loose_complete_agestr_pro_adj_2 <- growth(mcs_loose_complete_agestr_pro_adj_2, data = asd_loose_SDQ_complete, group = "group", missing = "fiml", estimator = "ml", fixed.x = F)
summary(fit_mcs_loose_complete_agestr_pro_adj_2)

est_fit_mcs_loose_complete_agestr_pro_adj_2 <- parameterEstimates(fit_mcs_loose_complete_agestr_pro_adj_2) %>% filter(grepl("int|slp|qua",lhs) & op == "~1")
results_fit_mcs_loose_complete_agestr_pro_adj_2 <- est_fit_mcs_loose_complete_agestr_pro_adj_2 %>%
  dplyr::select(lhs, group, est, ci.lower, ci.upper, pvalue) %>%
 mutate(Estimates = sprintf("%.2f [%0.2f, %0.2f]", est, ci.lower, ci.upper),
         p_value = sprintf("%.3f", pvalue)) %>%
  dplyr::select(lhs,group,Estimates, p_value)
results_fit_mcs_loose_complete_agestr_pro_adj_2

```

## cubic 
```{r, eval=FALSE}
mcs_loose_agestr_ttl_adj_3 <- "
int =~ 1*BEBDTOT + 1*CEBDTOT + 1*DDDEBDTOT + 1*EEBDTOT + 1*FEBDTOT + 1*GEBDTOT
slp =~ .3*BEBDTOT + .5*CEBDTOT + .7*DDDEBDTOT + 1.1*EEBDTOT + 1.4*FEBDTOT + 1.7*GEBDTOT
qua =~ .09*BEBDTOT + .25*CEBDTOT + .49*DDDEBDTOT + 1.21*EEBDTOT + 1.96*FEBDTOT + 2.89*GEBDTOT
cub =~ .027*BEBDTOT + .125*CEBDTOT + .343*DDDEBDTOT + 1.331*EEBDTOT + 2.744*FEBDTOT + 4.913*GEBDTOT
# the parametres for slope reflect the designed ages at corresponding sweeps
"


fit_mcs_loose_agestr_ttl_adj_3 <- growth(mcs_loose_agestr_ttl_adj_3, data = asd_loose_SDQ_complete, group = "group", missing = "fiml", estimator = "ml", fixed.x = F)
summary(fit_mcs_loose_agestr_ttl_adj_3)

```
```{r, eval = False}
# fitting the data in general, without grouping
fitMeasures(loose_com_ttl_fit,c("rmsea","chisq","pvalue","cfi","tli","aic","bic"))

fitMeasures(loose_com_ttl_fit_2, c("rmsea","chisq","pvalue","cfi","tli","aic","bic"))

```

```{r}
fitMeasures(fit_mcs_loose_complete_agestr_ttl,c("rmsea","chisq","pvalue","cfi","tli","aic","bic"))
fitMeasures(fit_mcs_loose_complete_agestr_ttl_adj_2, c("rmsea","chisq","pvalue","cfi","tli","aic","bic"))

```




```{r}
library(data.table)
# Early 
mcs_asd_loose_complete_early <- asd_loose_SDQ_complete[asd_loose_SDQ_complete$group == "Early",]
mcs_asd_loose_complete_late <- asd_loose_SDQ_complete[asd_loose_SDQ_complete$group == "Late",]
mcs_asd_loose_complete_early_ttl <- mcs_asd_loose_complete_early[,c(2,3,9,15,21,27,33,39)]

mcs_asd_loose_complete_early_ttl_long <- data.table::melt(setDT(mcs_asd_loose_complete_early_ttl), id.vars = c("cmid","sex"), variable.name = "sweep")

mcs_asd_loose_complete_early_ttl_summary <- mcs_asd_loose_complete_early_ttl_long %>%
  dplyr::group_by(sweep) %>%
  dplyr::summarise(
    sd = sd(value, na.rm = TRUE),
    ttl_mean = mean(value, na.rm = TRUE),
    se = plotrix::std.error(value)
  )
mcs_asd_loose_complete_early_ttl_summary$group <- "early"

# Late

mcs_asd_loose_complete_late_ttl <- mcs_asd_loose_complete_late[,c(2,3,9,15,21,27,33,39)]

mcs_asd_loose_complete_late_ttl_long <- melt(setDT(mcs_asd_loose_complete_late_ttl), id.vars = c("cmid","sex"), variable.name = "sweep")

mcs_asd_loose_complete_late_ttl_summary <- mcs_asd_loose_complete_late_ttl_long %>%
   dplyr::group_by(sweep) %>%
   dplyr::summarise(
    sd = sd(value, na.rm = TRUE),
    ttl_mean = mean(value, na.rm = TRUE),
    se = plotrix::std.error(value)
  )
mcs_asd_loose_complete_late_ttl_summary$group <- "late"

```
```{r}
mcs_asd_loose_complete_early_ttl_summary$lb = mcs_asd_loose_complete_early_ttl_summary$ttl_mean - 1.96*mcs_asd_loose_complete_early_ttl_summary$se
mcs_asd_loose_complete_early_ttl_summary$ub = mcs_asd_loose_complete_early_ttl_summary$ttl_mean + 1.96*mcs_asd_loose_complete_early_ttl_summary$se
mcs_asd_loose_complete_late_ttl_summary$lb = mcs_asd_loose_complete_late_ttl_summary$ttl_mean - 1.96*mcs_asd_loose_complete_late_ttl_summary$se
mcs_asd_loose_complete_late_ttl_summary$ub = mcs_asd_loose_complete_late_ttl_summary$ttl_mean + 1.96*mcs_asd_loose_complete_late_ttl_summary$se
MCS_no_diag_ttl_summary$lb = 
  MCS_no_diag_ttl_summary$ttl_mean - 
  1.96*MCS_no_diag_ttl_summary$se
MCS_no_diag_ttl_summary$ub = 
  MCS_no_diag_ttl_summary$ttl_mean + 
  1.96*MCS_no_diag_ttl_summary$se
mcs_loose_complete_sdq_total_mean_full <- rbind(mcs_asd_loose_complete_early_ttl_summary, mcs_asd_loose_complete_late_ttl_summary,MCS_no_diag_ttl_summary)
mcs_loose_complete_sdq_total_mean_full <- mcs_loose_complete_sdq_total_mean_full %>% dplyr::mutate(sweep.age = case_when(
  sweep == "BEBDTOT" ~ 3,
  sweep == "CEBDTOT" ~ 5,
  sweep == "DDDEBDTOT" ~ 7,
   sweep == "EEBDTOT" ~ 11,
   sweep == "FEBDTOT" ~ 14,
   sweep == "GEBDTOT" ~ 17,
))

```

```{r}
p <- ggplot(mcs_loose_complete_sdq_total_mean_full, aes(x = as.numeric(sweep.age), y = ttl_mean, colour = group)) + geom_line(data = mcs_loose_complete_sdq_total_mean_full, aes(x = as.numeric(sweep.age), y = ttl_mean, colour = group)) + geom_point() 
p



breaks = seq(min(as.numeric(mcs_loose_complete_sdq_total_mean_full$sweep)),max(as.numeric(mcs_loose_complete_sdq_total_mean_full$sweep)), length.out = 6)

mcs_loose_full_ttl_in_display <- p+geom_ribbon(data = mcs_loose_complete_sdq_total_mean_full, aes(x = as.numeric(sweep.age),ymin = lb, ymax = ub), linetype = 2, alpha = 0.2) + scale_x_continuous(breaks = as.numeric(age) ,labels= age) + labs(y = "MCS Broader SDQ Total Score", x = "Age (years)")  + theme_classic() + scale_colour_manual(values = my_colors)+ theme(legend.position = "none")
mcs_loose_full_ttl_in_display
```




```{r}
pred_lgm_qua_early_loose_complete <- as.data.frame(predict(fit_mcs_loose_complete_agestr_ttl_adj_2)$"Early")

pred_lgm_qua_late_loose_complete <- as.data.frame(predict(fit_mcs_loose_complete_agestr_ttl_adj_2)$"Late")


pred_lgm_long_qua_early_loose_complete <- map(c(3,5,7,11,14,17), # loop over time
                     function(x) pred_lgm_qua_early_loose_complete[, 1] + x * pred_lgm_qua_early_loose_complete[, 2] + x^2 * pred_lgm_qua_early_loose_complete[,3]) %>% 
  reduce(cbind) %>% # bring together the wave predictions 
  as.data.frame() %>% # make data frame
  setNames(c(3,5,7,11,14,17)) %>% # give names to variables
  dplyr::mutate(id = row_number()) %>% # make unique id
  gather(-id, key = Sweep, value = pred) %>% dplyr::mutate(group = "early")

pred_lgm_long_qua_late_loose_complete <- map(c(3,5,7,11,14,17), # loop over time
                     function(x) pred_lgm_qua_late_loose_complete[, 1] + x * pred_lgm_qua_late_loose_complete[, 2] + x^2 * pred_lgm_qua_late_loose_complete[,3]) %>% 
  reduce(cbind) %>% # bring together the wave predictions 
  as.data.frame() %>% # make data frame
  setNames(c(3,5,7,11,14,17)) %>% # give names to variables
  dplyr::mutate(id = row_number()) %>% # make unique id
  gather(-id, key = Sweep, value = pred) %>% dplyr::mutate(group = "late")


## load the linear coefficients
pred_lgm_lin_early_loose_complete <- as.data.frame(predict(fit_mcs_loose_complete_agestr_ttl)$"Early")
pred_lgm_lin_no_diag_loose_complete <- as.data.frame(predict(fit_mcs_agestr_ttl_no_diag))
pred_lgm_lin_late_loose_complete <- as.data.frame(predict(fit_mcs_loose_complete_agestr_ttl)$"Late")

pred_lgm_long_lin_early_loose_complete <- map(c(3,5,7,11,14,17), # loop over time
                     function(x) pred_lgm_lin_early_loose_complete[, 1] + x * pred_lgm_lin_early_loose_complete[, 2] ) %>% 
  reduce(cbind) %>% # bring together the wave predictions 
  as.data.frame() %>% # make data frame
  setNames(c(3,5,7,11,14,17)) %>% # give names to variables
  dplyr::mutate(id = row_number()) %>% # make unique id
  gather(-id, key = Sweep, value = pred) %>% dplyr::mutate(group = "early")

pred_lgm_long_lin_late_loose_complete <- map(c(3,5,7,11,14,17), # loop over time
                     function(x) pred_lgm_lin_late_loose_complete[, 1] + x * pred_lgm_lin_late_loose_complete[, 2]) %>% 
  reduce(cbind) %>% # bring together the wave predictions 
  as.data.frame() %>% # make data frame
  setNames(c(3,5,7,11,14,17)) %>% # give names to variables
  dplyr::mutate(id = row_number()) %>% # make unique id
  gather(-id, key = Sweep, value = pred) %>% dplyr::mutate(group = "late")

pred_lgm_long_lin_no_diag_loose_complete <- map(c(3,5,7,11,14,17), # loop over time
                     function(x) pred_lgm_lin_no_diag_loose_complete[, 1] + x * pred_lgm_lin_no_diag_loose_complete[, 2]) %>% 
  reduce(cbind) %>% # bring together the wave predictions 
  as.data.frame() %>% # make data frame
  setNames(c(3,5,7,11,14,17)) %>% # give names to variables
  dplyr::mutate(id = row_number()) %>% # make unique id
  gather(-id, key = Sweep, value = pred) %>% dplyr::mutate(group = "no diag")



colnames(mcs_loose_complete_sdq_total_mean_full)[8] <- "Sweep"
# Plot


my_colors <- brewer.pal(12, "Paired")[c(2,8,4)]

mcs_loose_ttl_plot <- ggplot(mcs_loose_complete_sdq_total_mean_full, aes(x = as.numeric(Sweep), y = ttl_mean, colour = group)) + geom_line(data = mcs_loose_complete_sdq_total_mean_full, aes(x = as.numeric(Sweep), y = ttl_mean, colour = group)) + geom_point()  + geom_ribbon(data = mcs_loose_complete_sdq_total_mean_full, aes(x = as.numeric(Sweep),ymin = lb, ymax = ub), linetype = 2, alpha = 0.2) + scale_x_continuous(breaks = as.numeric(mcs_loose_complete_sdq_total_mean_full$Sweep),labels= mcs_loose_complete_sdq_total_mean_full$Sweep) + labs(y = "MCS Broader SDQ Total Score", x = "Age (years)") + theme_classic() + scale_colour_manual(values = my_colors)+ theme(legend.position = "none")
mcs_loose_ttl_plot



mcs_loose_ttl_plot
ggplot(mcs_loose_complete_sdq_total_mean_full, aes(x = as.numeric(Sweep), y = ttl_mean, colour = group)) + geom_line(data = mcs_loose_complete_sdq_total_mean_full, aes(x = as.numeric(Sweep), y = ttl_mean, colour = group)) + geom_point()  + geom_ribbon(data = mcs_loose_complete_sdq_total_mean_full, aes(x = as.numeric(Sweep),ymin = lb, ymax = ub), linetype = 4, alpha = 0.2) +
  stat_summary(
    data = pred_lgm_long_lin_early_loose_complete,
    aes(x = as.numeric(Sweep), y = pred,  linetype = "linear", colour = "early"),
    fun = mean,
    geom = "line",
    size = 1
  ) +
  stat_summary(
    data = pred_lgm_long_lin_late_loose_complete,
    aes(x = as.numeric(Sweep), y = pred,  linetype = "linear", colour = "late"),
    fun = mean,
    geom = "line",
    size = 1
  ) +
   stat_summary(
    data = pred_lgm_long_lin_no_diag_loose_complete,
    aes(x = as.numeric(Sweep), y = pred,  linetype = "linear", colour = "no diag"),
    fun = mean,
    geom = "line",
    size = 1
  ) +
stat_summary(
    data = pred_lgm_long_qua_early_loose_complete,
    aes(x = as.numeric(Sweep), y = pred,  linetype = "quadratic", colour = "early"),
    fun = mean,
    geom = "line",
    size = 1
  ) +
stat_summary(
    data = pred_lgm_long_qua_late_loose_complete,
    aes(x = as.numeric(Sweep), y = pred,  linetype = "quadratic", colour = "late"),
    fun = mean,
    geom = "line",
    size = 1
  ) +
  theme_classic() + scale_colour_manual(values = my_colors)+
  labs(y = "MCS SDQ Total Score", x = "Age (years)")  

```

```{r}
library(data.table)
# Early 
mcs_asd_loose_complete_early_emo <- mcs_asd_loose_complete_early[,c(2,3,4,10,16,22,28,34)]

mcs_asd_loose_complete_early_emo_long <- data.table::melt(setDT(mcs_asd_loose_complete_early_emo), id.vars = c("cmid","sex"), variable.name = "sweep")

mcs_asd_loose_complete_early_emo_summary <- mcs_asd_loose_complete_early_emo_long %>%
  dplyr::group_by(sweep) %>%
  dplyr::summarise(
    sd = sd(value, na.rm = TRUE),
    emo_mean = mean(value, na.rm = TRUE),
    se = plotrix::std.error(value)
  )
mcs_asd_loose_complete_early_emo_summary$group <- "early"

# Late

mcs_asd_loose_complete_late_emo <- mcs_asd_loose_complete_late[,c(2,3,4,10,16,22,28,34)]

mcs_asd_loose_complete_late_emo_long <- melt(setDT(mcs_asd_loose_complete_late_emo), id.vars = c("cmid","sex"), variable.name = "sweep")

mcs_asd_loose_complete_late_emo_summary <- mcs_asd_loose_complete_late_emo_long %>%
   dplyr::group_by(sweep) %>%
   dplyr::summarise(
    sd = sd(value, na.rm = TRUE),
    emo_mean = mean(value, na.rm = TRUE),
    se = plotrix::std.error(value)
  )
mcs_asd_loose_complete_late_emo_summary$group <- "late"


mcs_asd_loose_complete_early_emo_summary$lb = mcs_asd_loose_complete_early_emo_summary$emo_mean - 1.96*mcs_asd_loose_complete_early_emo_summary$se
mcs_asd_loose_complete_early_emo_summary$ub = mcs_asd_loose_complete_early_emo_summary$emo_mean + 1.96*mcs_asd_loose_complete_early_emo_summary$se
mcs_asd_loose_complete_late_emo_summary$lb = mcs_asd_loose_complete_late_emo_summary$emo_mean - 1.96*mcs_asd_loose_complete_late_emo_summary$se
mcs_asd_loose_complete_late_emo_summary$ub = mcs_asd_loose_complete_late_emo_summary$emo_mean + 1.96*mcs_asd_loose_complete_late_emo_summary$se
MCS_no_diag_emo_summary$lb = 
  MCS_no_diag_emo_summary$emo_mean - 
  1.96*MCS_no_diag_emo_summary$se
MCS_no_diag_emo_summary$ub = 
  MCS_no_diag_emo_summary$emo_mean + 
  1.96*MCS_no_diag_emo_summary$se
mcs_loose_complete_sdq_emo_mean_full <- rbind(mcs_asd_loose_complete_early_emo_summary, mcs_asd_loose_complete_late_emo_summary,MCS_no_diag_emo_summary)
mcs_loose_complete_sdq_emo_mean_full <- mcs_loose_complete_sdq_emo_mean_full %>% dplyr::mutate(sweep.age = case_when(
  sweep == "BEMOTION" ~ 3,
  sweep == "CEMOTION" ~ 5,
  sweep == "DDEMOTION" ~ 7,
   sweep == "EEMOTION" ~ 11,
   sweep == "FEMOTION" ~ 14,
   sweep == "GEMOTION" ~ 17,
))

```

```{r}

p <- ggplot(mcs_loose_complete_sdq_emo_mean_full, aes(x = as.numeric(sweep.age), y = emo_mean, colour = group)) + geom_line(data = mcs_loose_complete_sdq_emo_mean_full, aes(x = as.numeric(sweep.age), y = emo_mean, colour = group)) + geom_point() 
p



breaks = seq(min(as.numeric(mcs_loose_complete_sdq_emo_mean_full$sweep)),max(as.numeric(mcs_loose_complete_sdq_emo_mean_full$sweep)), length.out = 6)

mcs_loose_full_emo_in_display <- p+geom_ribbon(data = mcs_loose_complete_sdq_emo_mean_full, aes(x = as.numeric(sweep.age),ymin = lb, ymax = ub), linetype = 2, alpha = 0.2) + scale_x_continuous(breaks = as.numeric(age) ,labels= age) + labs(y = "MCS Broader SDQ Emotional Sypmtoms Score", x = "Age (years)")  + theme_classic() + scale_colour_manual(values = my_colors)+ theme(legend.position = "none")


mcs_loose_full_emo_in_display

```


```{r}

# Early 
mcs_asd_loose_complete_early_con <- mcs_asd_loose_complete_early[,c(2,3,5,11,17,23,29,35)]

mcs_asd_loose_complete_early_con_long <- data.table::melt(setDT(mcs_asd_loose_complete_early_con), id.vars = c("cmid","sex"), variable.name = "sweep")

mcs_asd_loose_complete_early_con_summary <- mcs_asd_loose_complete_early_con_long %>%
  dplyr::group_by(sweep) %>%
  dplyr::summarise(
    sd = sd(value, na.rm = TRUE),
    con_mean = mean(value, na.rm = TRUE),
    se = plotrix::std.error(value)
  )
mcs_asd_loose_complete_early_con_summary$group <- "early"

# Late

mcs_asd_loose_complete_late_con <- mcs_asd_loose_complete_late[,c(2,3,5,11,17,23,29,35)]

mcs_asd_loose_complete_late_con_long <- melt(setDT(mcs_asd_loose_complete_late_con), id.vars = c("cmid","sex"), variable.name = "sweep")

mcs_asd_loose_complete_late_con_summary <- mcs_asd_loose_complete_late_con_long %>%
   dplyr::group_by(sweep) %>%
   dplyr::summarise(
    sd = sd(value, na.rm = TRUE),
    con_mean = mean(value, na.rm = TRUE),
    se = plotrix::std.error(value)
  )
mcs_asd_loose_complete_late_con_summary$group <- "late"


mcs_asd_loose_complete_early_con_summary$lb = mcs_asd_loose_complete_early_con_summary$con_mean - 1.96*mcs_asd_loose_complete_early_con_summary$se
mcs_asd_loose_complete_early_con_summary$ub = mcs_asd_loose_complete_early_con_summary$con_mean + 1.96*mcs_asd_loose_complete_early_con_summary$se
mcs_asd_loose_complete_late_con_summary$lb = mcs_asd_loose_complete_late_con_summary$con_mean - 1.96*mcs_asd_loose_complete_late_con_summary$se
mcs_asd_loose_complete_late_con_summary$ub = mcs_asd_loose_complete_late_con_summary$con_mean + 1.96*mcs_asd_loose_complete_late_con_summary$se
MCS_no_diag_con_summary$lb = 
  MCS_no_diag_con_summary$con_mean - 
  1.96*MCS_no_diag_con_summary$se
MCS_no_diag_con_summary$ub = 
  MCS_no_diag_con_summary$con_mean + 
  1.96*MCS_no_diag_con_summary$se
mcs_loose_complete_sdq_con_mean_full <- rbind(mcs_asd_loose_complete_early_con_summary, mcs_asd_loose_complete_late_con_summary,MCS_no_diag_con_summary)
mcs_loose_complete_sdq_con_mean_full <- mcs_loose_complete_sdq_con_mean_full %>% dplyr::mutate(sweep.age = case_when(
  sweep == "BCONDUCT" ~ 3,
  sweep == "CCONDUCT" ~ 5,
  sweep == "DDCONDUCT" ~ 7,
   sweep == "ECONDUCT" ~ 11,
   sweep == "FCONDUCT" ~ 14,
   sweep == "GCONDUCT" ~ 17,
))

```

```{r}

p <- ggplot(mcs_loose_complete_sdq_con_mean_full, aes(x = as.numeric(sweep.age), y = con_mean, colour = group)) + geom_line(data = mcs_loose_complete_sdq_con_mean_full, aes(x = as.numeric(sweep.age), y = con_mean, colour = group)) + geom_point() 
p



breaks = seq(min(as.numeric(mcs_loose_complete_sdq_con_mean_full$sweep)),max(as.numeric(mcs_loose_complete_sdq_con_mean_full$sweep)), length.out = 6)

mcs_loose_full_con_in_display <- p+geom_ribbon(data = mcs_loose_complete_sdq_con_mean_full, aes(x = as.numeric(sweep.age),ymin = lb, ymax = ub), linetype = 2, alpha = 0.2) + scale_x_continuous(breaks = as.numeric(age) ,labels= age) + labs(y = "MCS Broader SDQ Conduct Problems Score", x = "Age (years)")  + theme_classic() + scale_colour_manual(values = my_colors)+ theme(legend.position = "none")


mcs_loose_full_con_in_display

```


```{r}

# Early 
mcs_asd_loose_complete_early_hyp <- mcs_asd_loose_complete_early[,c(2,3,6,12,18,24,30,36)]

mcs_asd_loose_complete_early_hyp_long <- data.table::melt(setDT(mcs_asd_loose_complete_early_hyp), id.vars = c("cmid","sex"), variable.name = "sweep")

mcs_asd_loose_complete_early_hyp_summary <- mcs_asd_loose_complete_early_hyp_long %>%
  dplyr::group_by(sweep) %>%
  dplyr::summarise(
    sd = sd(value, na.rm = TRUE),
    hyp_mean = mean(value, na.rm = TRUE),
    se = plotrix::std.error(value)
  )
mcs_asd_loose_complete_early_hyp_summary$group <- "early"

# Late

mcs_asd_loose_complete_late_hyp <- mcs_asd_loose_complete_late[,c(2,3,6,12,18,24,30,36)]

mcs_asd_loose_complete_late_hyp_long <- melt(setDT(mcs_asd_loose_complete_late_hyp), id.vars = c("cmid","sex"), variable.name = "sweep")

mcs_asd_loose_complete_late_hyp_summary <- mcs_asd_loose_complete_late_hyp_long %>%
   dplyr::group_by(sweep) %>%
   dplyr::summarise(
    sd = sd(value, na.rm = TRUE),
    hyp_mean = mean(value, na.rm = TRUE),
    se = plotrix::std.error(value)
  )
mcs_asd_loose_complete_late_hyp_summary$group <- "late"


mcs_asd_loose_complete_early_hyp_summary$lb = mcs_asd_loose_complete_early_hyp_summary$hyp_mean - 1.96*mcs_asd_loose_complete_early_hyp_summary$se
mcs_asd_loose_complete_early_hyp_summary$ub = mcs_asd_loose_complete_early_hyp_summary$hyp_mean + 1.96*mcs_asd_loose_complete_early_hyp_summary$se
mcs_asd_loose_complete_late_hyp_summary$lb = mcs_asd_loose_complete_late_hyp_summary$hyp_mean - 1.96*mcs_asd_loose_complete_late_hyp_summary$se
mcs_asd_loose_complete_late_hyp_summary$ub = mcs_asd_loose_complete_late_hyp_summary$hyp_mean + 1.96*mcs_asd_loose_complete_late_hyp_summary$se
MCS_no_diag_hyp_summary$lb = 
  MCS_no_diag_hyp_summary$hyp_mean - 
  1.96*MCS_no_diag_hyp_summary$se
MCS_no_diag_hyp_summary$ub = 
  MCS_no_diag_hyp_summary$hyp_mean + 
  1.96*MCS_no_diag_hyp_summary$se
mcs_loose_complete_sdq_hyp_mean_full <- rbind(mcs_asd_loose_complete_early_hyp_summary, mcs_asd_loose_complete_late_hyp_summary,MCS_no_diag_hyp_summary)
mcs_loose_complete_sdq_hyp_mean_full <- mcs_loose_complete_sdq_hyp_mean_full %>% dplyr::mutate(sweep.age = case_when(
  sweep == "BHYPER" ~ 3,
  sweep == "CHYPER" ~ 5,
  sweep == "DDHYPER" ~ 7,
   sweep == "EHYPER" ~ 11,
   sweep == "FHYPER" ~ 14,
   sweep == "GHYPER" ~ 17,
))

```

```{r}

p <- ggplot(mcs_loose_complete_sdq_hyp_mean_full, aes(x = as.numeric(sweep.age), y = hyp_mean, colour = group)) + geom_line(data = mcs_loose_complete_sdq_hyp_mean_full, aes(x = as.numeric(sweep.age), y = hyp_mean, colour = group)) + geom_point() 
p



breaks = seq(min(as.numeric(mcs_loose_complete_sdq_hyp_mean_full$sweep)),max(as.numeric(mcs_loose_complete_sdq_hyp_mean_full$sweep)), length.out = 6)

mcs_loose_full_hyp_in_display <- p+geom_ribbon(data = mcs_loose_complete_sdq_hyp_mean_full, aes(x = as.numeric(sweep.age),ymin = lb, ymax = ub), linetype = 2, alpha = 0.2) + scale_x_continuous(breaks = as.numeric(age) ,labels= age) + labs(y = "MCS Broader SDQ Hyperactivity-Inattention Score", x = "Age (years)")  + theme_classic() + scale_colour_manual(values = my_colors)+ theme(legend.position = "none")


mcs_loose_full_hyp_in_display

```


```{r}

# Early 
mcs_asd_loose_complete_early_peer <- mcs_asd_loose_complete_early[,c(2,3,7,13,19,25,31,37)]

mcs_asd_loose_complete_early_peer_long <- data.table::melt(setDT(mcs_asd_loose_complete_early_peer), id.vars = c("cmid","sex"), variable.name = "sweep")

mcs_asd_loose_complete_early_peer_summary <- mcs_asd_loose_complete_early_peer_long %>%
  dplyr::group_by(sweep) %>%
  dplyr::summarise(
    sd = sd(value, na.rm = TRUE),
    peer_mean = mean(value, na.rm = TRUE),
    se = plotrix::std.error(value)
  )
mcs_asd_loose_complete_early_peer_summary$group <- "early"

# Late

mcs_asd_loose_complete_late_peer <- mcs_asd_loose_complete_late[,c(2,3,7,13,19,25,31,37)]

mcs_asd_loose_complete_late_peer_long <- melt(setDT(mcs_asd_loose_complete_late_peer), id.vars = c("cmid","sex"), variable.name = "sweep")

mcs_asd_loose_complete_late_peer_summary <- mcs_asd_loose_complete_late_peer_long %>%
   dplyr::group_by(sweep) %>%
   dplyr::summarise(
    sd = sd(value, na.rm = TRUE),
    peer_mean = mean(value, na.rm = TRUE),
    se = plotrix::std.error(value)
  )
mcs_asd_loose_complete_late_peer_summary$group <- "late"


mcs_asd_loose_complete_early_peer_summary$lb = mcs_asd_loose_complete_early_peer_summary$peer_mean - 1.96*mcs_asd_loose_complete_early_peer_summary$se
mcs_asd_loose_complete_early_peer_summary$ub = mcs_asd_loose_complete_early_peer_summary$peer_mean + 1.96*mcs_asd_loose_complete_early_peer_summary$se
mcs_asd_loose_complete_late_peer_summary$lb = mcs_asd_loose_complete_late_peer_summary$peer_mean - 1.96*mcs_asd_loose_complete_late_peer_summary$se
mcs_asd_loose_complete_late_peer_summary$ub = mcs_asd_loose_complete_late_peer_summary$peer_mean + 1.96*mcs_asd_loose_complete_late_peer_summary$se
MCS_no_diag_peer_summary$lb = 
  MCS_no_diag_peer_summary$peer_mean - 
  1.96*MCS_no_diag_peer_summary$se
MCS_no_diag_peer_summary$ub = 
  MCS_no_diag_peer_summary$peer_mean + 
  1.96*MCS_no_diag_peer_summary$se
mcs_loose_complete_sdq_peer_mean_full <- rbind(mcs_asd_loose_complete_early_peer_summary, mcs_asd_loose_complete_late_peer_summary,MCS_no_diag_peer_summary)
mcs_loose_complete_sdq_peer_mean_full <- mcs_loose_complete_sdq_peer_mean_full %>% dplyr::mutate(sweep.age = case_when(
  sweep == "BPEER" ~ 3,
  sweep == "CPEER" ~ 5,
  sweep == "DDPEER" ~ 7,
   sweep == "EPEER" ~ 11,
   sweep == "FPEER" ~ 14,
   sweep == "GPEER" ~ 17,
))

```

```{r}

p <- ggplot(mcs_loose_complete_sdq_peer_mean_full, aes(x = as.numeric(sweep.age), y = peer_mean, colour = group)) + geom_line(data = mcs_loose_complete_sdq_peer_mean_full, aes(x = as.numeric(sweep.age), y = peer_mean, colour = group)) + geom_point() 
p



breaks = seq(min(as.numeric(mcs_loose_complete_sdq_peer_mean_full$sweep)),max(as.numeric(mcs_loose_complete_sdq_peer_mean_full$sweep)), length.out = 6)

mcs_loose_full_peer_in_display <- p+geom_ribbon(data = mcs_loose_complete_sdq_peer_mean_full, aes(x = as.numeric(sweep.age),ymin = lb, ymax = ub), linetype = 2, alpha = 0.2) + scale_x_continuous(breaks = as.numeric(age) ,labels= age) + labs(y = "MCS Broader SDQ Peer Relationship Problems Score", x = "Age (years)")  + theme_classic() + scale_colour_manual(values = my_colors)+ theme(legend.position = "none")


mcs_loose_full_peer_in_display

```


```{r}

# Early 
mcs_asd_loose_complete_early_pro <- mcs_asd_loose_complete_early[,c(2,3,8,14,20,26,32,38)]

mcs_asd_loose_complete_early_pro_long <- data.table::melt(setDT(mcs_asd_loose_complete_early_pro), id.vars = c("cmid","sex"), variable.name = "sweep")

mcs_asd_loose_complete_early_pro_summary <- mcs_asd_loose_complete_early_pro_long %>%
  dplyr::group_by(sweep) %>%
  dplyr::summarise(
    sd = sd(value, na.rm = TRUE),
    pro_mean = mean(value, na.rm = TRUE),
    se = plotrix::std.error(value)
  )
mcs_asd_loose_complete_early_pro_summary$group <- "early"

# Late

mcs_asd_loose_complete_late_pro <- mcs_asd_loose_complete_late[,c(2,3,8,14,20,26,32,38)]

mcs_asd_loose_complete_late_pro_long <- melt(setDT(mcs_asd_loose_complete_late_pro), id.vars = c("cmid","sex"), variable.name = "sweep")

mcs_asd_loose_complete_late_pro_summary <- mcs_asd_loose_complete_late_pro_long %>%
   dplyr::group_by(sweep) %>%
   dplyr::summarise(
    sd = sd(value, na.rm = TRUE),
    pro_mean = mean(value, na.rm = TRUE),
    se = plotrix::std.error(value)
  )
mcs_asd_loose_complete_late_pro_summary$group <- "late"


mcs_asd_loose_complete_early_pro_summary$lb = mcs_asd_loose_complete_early_pro_summary$pro_mean - 1.96*mcs_asd_loose_complete_early_pro_summary$se
mcs_asd_loose_complete_early_pro_summary$ub = mcs_asd_loose_complete_early_pro_summary$pro_mean + 1.96*mcs_asd_loose_complete_early_pro_summary$se
mcs_asd_loose_complete_late_pro_summary$lb = mcs_asd_loose_complete_late_pro_summary$pro_mean - 1.96*mcs_asd_loose_complete_late_pro_summary$se
mcs_asd_loose_complete_late_pro_summary$ub = mcs_asd_loose_complete_late_pro_summary$pro_mean + 1.96*mcs_asd_loose_complete_late_pro_summary$se
MCS_no_diag_pro_summary$lb = 
  MCS_no_diag_pro_summary$pro_mean - 
  1.96*MCS_no_diag_pro_summary$se
MCS_no_diag_pro_summary$ub = 
  MCS_no_diag_pro_summary$pro_mean + 
  1.96*MCS_no_diag_pro_summary$se
mcs_loose_complete_sdq_pro_mean_full <- rbind(mcs_asd_loose_complete_early_pro_summary, mcs_asd_loose_complete_late_pro_summary,MCS_no_diag_pro_summary)
mcs_loose_complete_sdq_pro_mean_full <- mcs_loose_complete_sdq_pro_mean_full %>% dplyr::mutate(sweep.age = case_when(
  sweep == "BPROSOC" ~ 3,
  sweep == "CPROSOC" ~ 5,
  sweep == "DDPROSOC" ~ 7,
   sweep == "EPROSOC" ~ 11,
   sweep == "FPROSOC" ~ 14,
   sweep == "GPROSOC" ~ 17,
))

```

```{r}

p <- ggplot(mcs_loose_complete_sdq_pro_mean_full, aes(x = as.numeric(sweep.age), y = pro_mean, colour = group)) + geom_line(data = mcs_loose_complete_sdq_pro_mean_full, aes(x = as.numeric(sweep.age), y = pro_mean, colour = group)) + geom_point() 
p



breaks = seq(min(as.numeric(mcs_loose_complete_sdq_pro_mean_full$sweep)),max(as.numeric(mcs_loose_complete_sdq_pro_mean_full$sweep)), length.out = 6)

mcs_loose_full_pro_in_display <- p+geom_ribbon(data = mcs_loose_complete_sdq_pro_mean_full, aes(x = as.numeric(sweep.age),ymin = lb, ymax = ub), linetype = 2, alpha = 0.2) + scale_x_continuous(breaks = as.numeric(age) ,labels= age) + labs(y = "MCS Broader SDQ Prosocial Behaviours Score", x = "Age (years)")  + theme_classic() + scale_colour_manual(values = my_colors)+ theme(legend.position = "none")


mcs_loose_full_pro_in_display

```
```{r}
#this is the final version
pdf(file = "/Users/zhangxinhe/Documents/who recieves a diagnosis/Figures FINAL/mcs_braoder_traj.pdf",width = 10, height = 6)
mcs_loose_ttl_plot
mcs_loose_full_emo_in_display
mcs_loose_full_con_in_display
mcs_loose_full_hyp_in_display
mcs_loose_full_peer_in_display
mcs_loose_full_pro_in_display
dev.off()

```




```{r}
library(data.table)
# Early 
mcs_asd_loose_complete_early_emo <- mcs_asd_loose_complete_early[,c(2,3,4,10,16,22,28,34)]

mcs_asd_loose_complete_early_emo_long <- data.table::melt(setDT(mcs_asd_loose_complete_early_emo), id.vars = c("cmid","sex"), variable.name = "sweep")

mcs_asd_loose_complete_early_emo_summary <- mcs_asd_loose_complete_early_emo_long %>%
  dplyr::group_by(sweep) %>%
  dplyr::summarise(
    sd = sd(value, na.rm = TRUE),
    emo_mean = mean(value, na.rm = TRUE),
    se = plotrix::std.error(value)
  )
mcs_asd_loose_complete_early_emo_summary$group <- "early"

# Late

mcs_asd_loose_complete_late_emo <- mcs_asd_loose_complete_late[,c(2,3,4,10,16,22,28,34)]

mcs_asd_loose_complete_late_emo_long <- melt(setDT(mcs_asd_loose_complete_late_emo), id.vars = c("cmid","sex"), variable.name = "sweep")

mcs_asd_loose_complete_late_emo_summary <- mcs_asd_loose_complete_late_emo_long %>%
   dplyr::group_by(sweep) %>%
   dplyr::summarise(
    sd = sd(value, na.rm = TRUE),
    emo_mean = mean(value, na.rm = TRUE),
    se = plotrix::std.error(value)
  )
mcs_asd_loose_complete_late_emo_summary$group <- "late"


mcs_asd_loose_complete_early_emo_summary$lb = mcs_asd_loose_complete_early_emo_summary$emo_mean - 1.96*mcs_asd_loose_complete_early_emo_summary$se
mcs_asd_loose_complete_early_emo_summary$ub = mcs_asd_loose_complete_early_emo_summary$emo_mean + 1.96*mcs_asd_loose_complete_early_emo_summary$se
mcs_asd_loose_complete_late_emo_summary$lb = mcs_asd_loose_complete_late_emo_summary$emo_mean - 1.96*mcs_asd_loose_complete_late_emo_summary$se
mcs_asd_loose_complete_late_emo_summary$ub = mcs_asd_loose_complete_late_emo_summary$emo_mean + 1.96*mcs_asd_loose_complete_late_emo_summary$se
MCS_no_diag_emo_summary$lb = 
  MCS_no_diag_emo_summary$emo_mean - 
  1.96*MCS_no_diag_emo_summary$se
MCS_no_diag_emo_summary$ub = 
  MCS_no_diag_emo_summary$emo_mean + 
  1.96*MCS_no_diag_emo_summary$se
mcs_loose_complete_sdq_emo_mean_full <- rbind(mcs_asd_loose_complete_early_emo_summary, mcs_asd_loose_complete_late_emo_summary,MCS_no_diag_emo_summary)
mcs_loose_complete_sdq_emo_mean_full <- mcs_loose_complete_sdq_emo_mean_full %>% dplyr::mutate(sweep.age = case_when(
  sweep == "BEMOTION" ~ 3,
  sweep == "CEMOTION" ~ 5,
  sweep == "DDEMOTION" ~ 7,
   sweep == "EEMOTION" ~ 11,
   sweep == "FEMOTION" ~ 14,
   sweep == "GEMOTION" ~ 17,
))

```

```{r}

p <- ggplot(mcs_loose_complete_sdq_emo_mean_full, aes(x = as.numeric(sweep.age), y = emo_mean, colour = group)) + geom_line(data = mcs_loose_complete_sdq_emo_mean_full, aes(x = as.numeric(sweep.age), y = emo_mean, colour = group)) + geom_point() 
p



breaks = seq(min(as.numeric(mcs_loose_complete_sdq_emo_mean_full$sweep)),max(as.numeric(mcs_loose_complete_sdq_emo_mean_full$sweep)), length.out = 6)

mcs_loose_full_emo_in_display <- p+geom_ribbon(data = mcs_loose_complete_sdq_emo_mean_full, aes(x = as.numeric(sweep.age),ymin = lb, ymax = ub), linetype = 2, alpha = 0.2) + scale_x_continuous(breaks = as.numeric(age) ,labels= age) + labs(y = "MCS Broader SDQ Emotional Sypmtoms Score", x = "Age (years)")  + theme_classic() + scale_colour_manual(values = my_colors)+ theme(legend.position = "none")


mcs_loose_full_emo_in_display

```


```{r}
library(data.table)
# Early 
mcs_asd_loose_complete_early_emo <- mcs_asd_loose_complete_early[,c(2,3,4,10,16,22,28,34)]

mcs_asd_loose_complete_early_emo_long <- data.table::melt(setDT(mcs_asd_loose_complete_early_emo), id.vars = c("cmid","sex"), variable.name = "sweep")

mcs_asd_loose_complete_early_emo_summary <- mcs_asd_loose_complete_early_emo_long %>%
  dplyr::group_by(sweep) %>%
  dplyr::summarise(
    sd = sd(value, na.rm = TRUE),
    emo_mean = mean(value, na.rm = TRUE),
    se = plotrix::std.error(value)
  )
mcs_asd_loose_complete_early_emo_summary$group <- "early"

# Late

mcs_asd_loose_complete_late_emo <- mcs_asd_loose_complete_late[,c(2,3,4,10,16,22,28,34)]

mcs_asd_loose_complete_late_emo_long <- melt(setDT(mcs_asd_loose_complete_late_emo), id.vars = c("cmid","sex"), variable.name = "sweep")

mcs_asd_loose_complete_late_emo_summary <- mcs_asd_loose_complete_late_emo_long %>%
   dplyr::group_by(sweep) %>%
   dplyr::summarise(
    sd = sd(value, na.rm = TRUE),
    emo_mean = mean(value, na.rm = TRUE),
    se = plotrix::std.error(value)
  )
mcs_asd_loose_complete_late_emo_summary$group <- "late"


mcs_asd_loose_complete_early_emo_summary$lb = mcs_asd_loose_complete_early_emo_summary$emo_mean - 1.96*mcs_asd_loose_complete_early_emo_summary$se
mcs_asd_loose_complete_early_emo_summary$ub = mcs_asd_loose_complete_early_emo_summary$emo_mean + 1.96*mcs_asd_loose_complete_early_emo_summary$se
mcs_asd_loose_complete_late_emo_summary$lb = mcs_asd_loose_complete_late_emo_summary$emo_mean - 1.96*mcs_asd_loose_complete_late_emo_summary$se
mcs_asd_loose_complete_late_emo_summary$ub = mcs_asd_loose_complete_late_emo_summary$emo_mean + 1.96*mcs_asd_loose_complete_late_emo_summary$se
MCS_no_diag_emo_summary$lb = 
  MCS_no_diag_emo_summary$emo_mean - 
  1.96*MCS_no_diag_emo_summary$se
MCS_no_diag_emo_summary$ub = 
  MCS_no_diag_emo_summary$emo_mean + 
  1.96*MCS_no_diag_emo_summary$se
mcs_loose_complete_sdq_emo_mean_full <- rbind(mcs_asd_loose_complete_early_emo_summary, mcs_asd_loose_complete_late_emo_summary,MCS_no_diag_emo_summary)
mcs_loose_complete_sdq_emo_mean_full <- mcs_loose_complete_sdq_emo_mean_full %>% dplyr::mutate(sweep.age = case_when(
  sweep == "BEMOTION" ~ 3,
  sweep == "CEMOTION" ~ 5,
  sweep == "DDEMOTION" ~ 7,
   sweep == "EEMOTION" ~ 11,
   sweep == "FEMOTION" ~ 14,
   sweep == "GEMOTION" ~ 17,
))

```

```{r}

p <- ggplot(mcs_loose_complete_sdq_emo_mean_full, aes(x = as.integer(sweep.age), y = emo_mean, colour = group)) + geom_line(data = mcs_loose_complete_sdq_emo_mean_full, aes(x = as.integer(sweep.age), y = emo_mean, colour = group)) + geom_point() 
p



breaks = seq(min(as.numeric(mcs_loose_complete_sdq_emo_mean_full$sweep)),max(as.numeric(mcs_loose_complete_sdq_emo_mean_full$sweep)), length.out = 6)

mcs_loose_full_emo_in_display <- p+geom_ribbon(data = mcs_loose_complete_sdq_emo_mean_full, aes(x = as.integer(sweep.age),ymin = lb, ymax = ub), linetype = 2, alpha = 0.2) + scale_x_continuous(breaks = as.integer(age) ,labels= age) + labs(y = "MCS Broader SDQ Emotional Sypmtoms Score", x = "Age (years)")  + theme_classic() + scale_colour_manual(values = my_colors)+ theme(legend.position = "none")


mcs_loose_full_emo_in_display

```
```{r}
library(data.table)
# male 
mcs_asd_loose_complete_male <- asd_loose_SDQ_complete[asd_loose_SDQ_complete$sex == 1,]
mcs_asd_loose_complete_female <- asd_loose_SDQ_complete[asd_loose_SDQ_complete$sex == 2,]
mcs_asd_loose_complete_male_ttl <- mcs_asd_loose_complete_male[,c(2,9,15,21,27,33,39)]

mcs_asd_loose_complete_male_ttl_long <- data.table::melt(setDT(mcs_asd_loose_complete_male_ttl), id.vars = c("cmid"), variable.name = "sweep")

mcs_asd_loose_complete_male_ttl_summary <- mcs_asd_loose_complete_male_ttl_long %>%
  dplyr::group_by(sweep) %>%
  dplyr::summarise(
    sd = sd(value, na.rm = TRUE),
    ttl_mean = mean(value, na.rm = TRUE)
  )
mcs_asd_loose_complete_male_ttl_summary$group <- "male"

# female

mcs_asd_loose_complete_female_ttl <- mcs_asd_loose_complete_female[,c(2,9,15,21,27,33,39)]

mcs_asd_loose_complete_female_ttl_long <- melt(setDT(mcs_asd_loose_complete_female_ttl), id.vars = c("cmid"), variable.name = "sweep")

mcs_asd_loose_complete_female_ttl_summary <- mcs_asd_loose_complete_female_ttl_long %>%
   dplyr::group_by(sweep) %>%
   dplyr::summarise(
    sd = sd(value, na.rm = TRUE),
    ttl_mean = mean(value, na.rm = TRUE)
  )
mcs_asd_loose_complete_female_ttl_summary$group <- "female"

```
```{r}
mcs_asd_loose_complete_male_ttl_summary$lb = mcs_asd_loose_complete_male_ttl_summary$ttl_mean - mcs_asd_loose_complete_male_ttl_summary$sd
mcs_asd_loose_complete_male_ttl_summary$ub = mcs_asd_loose_complete_male_ttl_summary$ttl_mean + mcs_asd_loose_complete_male_ttl_summary$sd
mcs_asd_loose_complete_female_ttl_summary$lb = mcs_asd_loose_complete_female_ttl_summary$ttl_mean - mcs_asd_loose_complete_female_ttl_summary$sd
mcs_asd_loose_complete_female_ttl_summary$ub = mcs_asd_loose_complete_female_ttl_summary$ttl_mean + mcs_asd_loose_complete_female_ttl_summary$sd
MCS_no_diag_ttl_summary$lb = 
  MCS_no_diag_ttl_summary$ttl_mean - 
  MCS_no_diag_ttl_summary$sd
MCS_no_diag_ttl_summary$ub = 
  MCS_no_diag_ttl_summary$ttl_mean + 
  MCS_no_diag_ttl_summary$sd
mcs_loose_complete_sdq_total_mean_full_sex <- rbind(mcs_asd_loose_complete_male_ttl_summary, mcs_asd_loose_complete_female_ttl_summary,MCS_no_diag_ttl_summary)
mcs_loose_complete_sdq_total_mean_full_sex <- mcs_loose_complete_sdq_total_mean_full %>% dplyr::mutate(sweep.age = case_when(
  sweep == "BEBDTOT" ~ 3,
  sweep == "CEBDTOT" ~ 5,
  sweep == "DDDEBDTOT" ~ 7,
   sweep == "EEBDTOT" ~ 11,
   sweep == "FEBDTOT" ~ 14,
   sweep == "GEBDTOT" ~ 17,
))

```


```{r}
pred_lgm_qua_male_loose_complete <- as.data.frame(predict(fit_mcs_loose_complete_sexstr_ttl_adj_2)$"1")

pred_lgm_qua_female_loose_complete <- as.data.frame(predict(fit_mcs_loose_complete_sexstr_ttl_adj_2)$"2")


pred_lgm_long_qua_male_loose_complete <- map(c(3,5,7,11,14,17), # loop over time
                     function(x) pred_lgm_qua_male_loose_complete[, 1] + x * pred_lgm_qua_male_loose_complete[, 2] + x^2 * pred_lgm_qua_male_loose_complete[,3]) %>% 
  reduce(cbind) %>% # bring together the wave predictions 
  as.data.frame() %>% # make data frame
  setNames(c(3,5,7,11,14,17)) %>% # give names to variables
  dplyr::mutate(id = row_number()) %>% # make unique id
  gather(-id, key = Sweep, value = pred) %>% dplyr::mutate(group = "male")

pred_lgm_long_qua_female_loose_complete <- map(c(3,5,7,11,14,17), # loop over time
                     function(x) pred_lgm_qua_female_loose_complete[, 1] + x * pred_lgm_qua_female_loose_complete[, 2] + x^2 * pred_lgm_qua_female_loose_complete[,3]) %>% 
  reduce(cbind) %>% # bring together the wave predictions 
  as.data.frame() %>% # make data frame
  setNames(c(3,5,7,11,14,17)) %>% # give names to variables
  dplyr::mutate(id = row_number()) %>% # make unique id
  gather(-id, key = Sweep, value = pred) %>% dplyr::mutate(group = "female")


## load the linear coefficients
pred_lgm_lin_male_loose_complete <- as.data.frame(predict(fit_mcs_loose_complete_sexstr_ttl)$"1")
pred_lgm_lin_no_diag_loose_complete <- as.data.frame(predict(fit_mcs_agestr_ttl_no_diag))
pred_lgm_lin_female_loose_complete <- as.data.frame(predict(fit_mcs_loose_complete_sexstr_ttl)$"2")

pred_lgm_long_lin_male_loose_complete <- map(c(3,5,7,11,14,17), # loop over time
                     function(x) pred_lgm_lin_male_loose_complete[, 1] + x * pred_lgm_lin_male_loose_complete[, 2] ) %>% 
  reduce(cbind) %>% # bring together the wave predictions 
  as.data.frame() %>% # make data frame
  setNames(c(3,5,7,11,14,17)) %>% # give names to variables
  dplyr::mutate(id = row_number()) %>% # make unique id
  gather(-id, key = Sweep, value = pred) %>% dplyr::mutate(group = "male")

pred_lgm_long_lin_female_loose_complete <- map(c(3,5,7,11,14,17), # loop over time
                     function(x) pred_lgm_lin_female_loose_complete[, 1] + x * pred_lgm_lin_female_loose_complete[, 2]) %>% 
  reduce(cbind) %>% # bring together the wave predictions 
  as.data.frame() %>% # make data frame
  setNames(c(3,5,7,11,14,17)) %>% # give names to variables
  dplyr::mutate(id = row_number()) %>% # make unique id
  gather(-id, key = Sweep, value = pred) %>% dplyr::mutate(group = "female")

pred_lgm_long_lin_no_diag_loose_complete <- map(c(3,5,7,11,14,17), # loop over time
                     function(x) pred_lgm_lin_no_diag_loose_complete[, 1] + x * pred_lgm_lin_no_diag_loose_complete[, 2]) %>% 
  reduce(cbind) %>% # bring together the wave predictions 
  as.data.frame() %>% # make data frame
  setNames(c(3,5,7,11,14,17)) %>% # give names to variables
  dplyr::mutate(id = row_number()) %>% # make unique id
  gather(-id, key = Sweep, value = pred) %>% dplyr::mutate(group = "no diag")



colnames(mcs_loose_complete_sdq_total_mean_full)[7] <- "Sweep"
# Plot

my_colors <- brewer.pal(12, "Paired")[c(5,1,4)]
ggplot(mcs_loose_complete_sdq_total_mean_full_sex, aes(x = as.numeric(sweep.age), y = ttl_mean, colour = group)) + geom_line(data = mcs_loose_complete_sdq_total_mean_full_sex, aes(x = as.numeric(sweep.age), y = ttl_mean, colour = group)) + geom_point()  + geom_ribbon(data = mcs_loose_complete_sdq_total_mean_full_sex, aes(x = as.numeric(sweep.age),ymin = lb, ymax = ub), linetype = 4, alpha = 0.2) +
  stat_summary(
    data = pred_lgm_long_lin_male_loose_complete,
    aes(x = as.numeric(Sweep), y = pred,  linetype = "linear", colour = "male"),
    fun = mean,
    geom = "line",
    size = 1
  ) +
  stat_summary(
    data = pred_lgm_long_lin_female_loose_complete,
    aes(x = as.numeric(Sweep), y = pred,  linetype = "linear", colour = "female"),
    fun = mean,
    geom = "line",
    size = 1
  ) +
   stat_summary(
    data = pred_lgm_long_lin_no_diag_loose_complete,
    aes(x = as.numeric(Sweep), y = pred,  linetype = "linear", colour = "no diag"),
    fun = mean,
    geom = "line",
    size = 1
  ) +
stat_summary(
    data = pred_lgm_long_qua_male_loose_complete,
    aes(x = as.numeric(Sweep), y = pred,  linetype = "quadratic", colour = "male"),
    fun = mean,
    geom = "line",
    size = 1
  ) +
stat_summary(
    data = pred_lgm_long_qua_female_loose_complete,
    aes(x = as.numeric(Sweep), y = pred,  linetype = "quadratic", colour = "female"),
    fun = mean,
    geom = "line",
    size = 1
  ) +
  theme_classic() + scale_colour_manual(values = my_colors) +
  labs(y = "MCS SDQ Total Score", x = "Age (years)")  

```



```{r}
asd_loose_SDQ_complete_gmm <- dplyr::mutate(asd_loose_SDQ_complete, numericID = row_number())

asd_loose_wide_sdq_ttl <- asd_loose_SDQ_complete_gmm[,c("numericID","cmid","sex","diag.age","BEBDTOT","CEBDTOT", "DDDEBDTOT" ,"EEBDTOT","FEBDTOT","GEBDTOT")]
asd_loose_long_sdq_ttl <- melt(setDT(asd_loose_wide_sdq_ttl), id.vars = c("numericID","cmid","sex","diag.age"), variable.name = "sweep")
asd_loose_long_sdq_ttl <- asd_loose_long_sdq_ttl %>%
  mutate(Sweep = case_when(
    sweep == "BEBDTOT" ~ 2,
    sweep == "CEBDTOT" ~ 3,
    sweep == "DDDEBDTOT" ~ 4,
    sweep == "EEBDTOT" ~ 5,
    sweep == "FEBDTOT" ~ 6,
    sweep == "GEBDTOT" ~ 7)
    )

asd_loose_wide_sdq_emo <- asd_loose_SDQ_complete_gmm[,c("numericID","cmid","sex","diag.age","BEMOTION","CEMOTION", "DDEMOTION" ,"EEMOTION","FEMOTION","GEMOTION")]
asd_loose_long_sdq_emo <- melt(setDT(asd_loose_wide_sdq_emo), id.vars = c("numericID","cmid","sex","diag.age"), variable.name = "sweep")
asd_loose_long_sdq_emo <- asd_loose_long_sdq_emo %>%
  mutate(Sweep = case_when(
    sweep == "BEMOTION" ~ 2,
    sweep == "CEMOTION" ~ 3,
    sweep == "DDEMOTION" ~ 4,
    sweep == "EEMOTION" ~ 5,
    sweep == "FEMOTION" ~ 6,
    sweep == "GEMOTION" ~ 7)
    )

asd_loose_wide_sdq_con <- asd_loose_SDQ_complete_gmm[,c("numericID","cmid","sex","diag.age","BCONDUCT","CCONDUCT", "DDCONDUCT" ,"ECONDUCT","FCONDUCT","GCONDUCT")]
asd_loose_long_sdq_con <- melt(setDT(asd_loose_wide_sdq_con), id.vars = c("numericID","cmid","sex","diag.age"), variable.name = "sweep")
asd_loose_long_sdq_con <- asd_loose_long_sdq_con %>%
  mutate(Sweep = case_when(
    sweep == "BCONDUCT" ~ 2,
    sweep == "CCONDUCT" ~ 3,
    sweep == "DDCONDUCT" ~ 4,
    sweep == "ECONDUCT" ~ 5,
    sweep == "FCONDUCT" ~ 6,
    sweep == "GCONDUCT" ~ 7)
    )

asd_loose_wide_sdq_hyp <- asd_loose_SDQ_complete_gmm[,c("numericID","cmid","sex","diag.age","BHYPER","CHYPER", "DDHYPER" ,"EHYPER","FHYPER","GHYPER")]
asd_loose_long_sdq_hyp <- melt(setDT(asd_loose_wide_sdq_hyp), id.vars = c("numericID","cmid","sex","diag.age"), variable.name = "sweep")
asd_loose_long_sdq_hyp <- asd_loose_long_sdq_hyp %>%
  mutate(Sweep = case_when(
    sweep == "BHYPER" ~ 2,
    sweep == "CHYPER" ~ 3,
    sweep == "DDHYPER" ~ 4,
    sweep == "EHYPER" ~ 5,
    sweep == "FHYPER" ~ 6,
    sweep == "GHYPER" ~ 7)
    )

asd_loose_wide_sdq_peer <- asd_loose_SDQ_complete_gmm[,c("numericID","cmid","sex","diag.age","BPEER","CPEER", "DDPEER" ,"EPEER","FPEER","GPEER")]
asd_loose_long_sdq_peer <- melt(setDT(asd_loose_wide_sdq_peer), id.vars = c("numericID","cmid","sex","diag.age"), variable.name = "sweep")
asd_loose_long_sdq_peer <- asd_loose_long_sdq_peer %>%
  mutate(Sweep = case_when(
    sweep == "BPEER" ~ 2,
    sweep == "CPEER" ~ 3,
    sweep == "DDPEER" ~ 4,
    sweep == "EPEER" ~ 5,
    sweep == "FPEER" ~ 6,
    sweep == "GPEER" ~ 7)
    )

asd_loose_wide_sdq_pro <- asd_loose_SDQ_complete_gmm[,c("numericID","cmid","sex","diag.age","BPROSOC","CPROSOC", "DDPROSOC" ,"EPROSOC","FPROSOC","GPROSOC")]
asd_loose_long_sdq_pro <- melt(setDT(asd_loose_wide_sdq_pro), id.vars = c("numericID","cmid","sex","diag.age"), variable.name = "sweep")
asd_loose_long_sdq_pro <- asd_loose_long_sdq_pro %>%
  mutate(Sweep = case_when(
    sweep == "BPROSOC" ~ 2,
    sweep == "CPROSOC" ~ 3,
    sweep == "DDPROSOC" ~ 4,
    sweep == "EPROSOC" ~ 5,
    sweep == "FPROSOC" ~ 6,
    sweep == "GPROSOC" ~ 7)
    )

asd_loose_SDQ_complete_gmm_nopro0 <- dplyr::mutate(asd_loose_SDQ_complete_nopro0, numericID = row_number())
asd_loose_wide_sdq_pro_no0 <- asd_loose_SDQ_complete_gmm_nopro0[,c("numericID","cmid","sex","diag.age","BPROSOC","CPROSOC", "DDPROSOC" ,"EPROSOC","FPROSOC","GPROSOC")]
asd_loose_long_sdq_pro_no0 <- melt(setDT(asd_loose_wide_sdq_pro_no0), id.vars = c("numericID","cmid","sex","diag.age"), variable.name = "sweep")
asd_loose_long_sdq_pro_no0 <- asd_loose_long_sdq_pro_no0 %>%
  mutate(Sweep = case_when(
    sweep == "BPROSOC" ~ 2,
    sweep == "CPROSOC" ~ 3,
    sweep == "DDPROSOC" ~ 4,
    sweep == "EPROSOC" ~ 5,
    sweep == "FPROSOC" ~ 6,
    sweep == "GPROSOC" ~ 7)
    )


```

## Growth Mixture Modelling
# Total
```{r}
library(lcmm)
age <- c("3","5","7","11","14","17")
mcs_ttl_gmm1_loose <- hlme(value ~ Sweep, subject = "numericID", random=~1, ng = 1, data =asd_loose_long_sdq_ttl)
summary(mcs_ttl_gmm1_loose)


mcs_ttl_gmm2_loose <- hlme(value ~ Sweep, subject = "numericID", random=~1,
ng = 2, data = asd_loose_long_sdq_ttl, mixture = ~ Sweep,
nwg=T, B = mcs_ttl_gmm1_loose)
summary(mcs_ttl_gmm2_loose)



mcs_ttl_gmm3_loose <- hlme(value ~ Sweep, subject = "numericID", random=~1,
ng = 3, data = asd_loose_long_sdq_ttl, mixture = ~ Sweep,
nwg=T, B = mcs_ttl_gmm1_loose)
summary(mcs_ttl_gmm3_loose)

mcs_ttl_gmm4_loose <- hlme(value ~ Sweep, subject = "numericID", random=~1,
ng = 4, data = asd_loose_long_sdq_ttl, mixture = ~ Sweep,
nwg=T, B = mcs_ttl_gmm1_loose)
summary(mcs_ttl_gmm4_loose)

# make a table with results for the 3 models:
fit_ind <- summarytable(mcs_ttl_gmm1_loose, mcs_ttl_gmm2_loose,mcs_ttl_gmm3_loose,mcs_ttl_gmm4_loose,which = c("AIC","BIC","SABIC","%class","entropy","npm","loglik"))
```


```{r}

mcs_loose_ttl_people2 <- as.data.frame(mcs_ttl_gmm2_loose$pprob[,1:2])
asd_loose_long_sdq_ttl <- merge(asd_loose_long_sdq_ttl,mcs_loose_ttl_people2, by = "numericID")
total_threeway <- xtabs(~ sex+diag.age+class, data = asd_loose_long_sdq_ttl)
ftable(total_threeway)
asd_loose_long_sdq_ttl <- asd_loose_long_sdq_ttl %>% dplyr::mutate(Sweep.age = case_when(Sweep == 2 ~ 3,Sweep == 3 ~ 5, Sweep == 4 ~ 7, Sweep == 5 ~ 11, Sweep == 6 ~ 14, Sweep == 7 ~ 17 ))

asd_loose_long_sdq_ttl$Sweep.age <- as.numeric(asd_loose_long_sdq_ttl$Sweep.age)
asd_loose_long_sdq_ttl$class <- as.factor(asd_loose_long_sdq_ttl$class)
p_mcs_loose_ttl_gmm2_s <- ggplot(asd_loose_long_sdq_ttl, aes(Sweep.age, value, group=numericID, colour= class)) + geom_smooth(aes(group=numericID, colour=class),size=0.1, se=F) + geom_smooth(aes(group=class), method="loess", size=2, se=T)  + scale_y_continuous(limits = c(0,40)) + scale_x_continuous(breaks = as.numeric(age),labels = age) + labs(x="Age(years)",y="SDQ_ttl",colour="Latent Class") + theme_classic()


my_colors <- brewer.pal(12, "Paired")[c(4,10)]
p_mcs_loose_ttl_gmm2 <- ggplot(asd_loose_long_sdq_ttl, aes(x = Sweep.age, y = value, group = numericID, colour = class)) +
  geom_line(size = 0.1) +
  geom_smooth(aes(group = class), method = "loess", size = 2, se = TRUE) +
  scale_y_continuous(limits = c(0, 40)) +
  scale_x_continuous(breaks = as.numeric(age), labels = age) +
  labs(x = "Age (years)", y = "MCS Broader SDQ Total Score", colour = "Latent Class") +
  scale_colour_manual(values = my_colors)+
  theme_classic() +theme(legend.position =  "none")


suppressWarnings(print(p_mcs_loose_ttl_gmm2))
suppressWarnings(print(p_mcs_loose_ttl_gmm2_s))
```

```{r}
my_colors_stack <- brewer.pal(12, "Paired")[c(4,3,10,9)]
legend_labels <- c("Class 1-Male", "Class 1-Female", "Class 2-Male", "Class 2-Female")

loose_ttl_stack <- ggplot(asd_loose_long_sdq_ttl,  aes(x = factor(diag.age), fill = interaction(sex,class))) +
  geom_bar(position="fill") + scale_y_continuous(labels = scales::percent) +
  labs(x = "Diagnosis Age", y = "Percentage") + scale_fill_manual(values = my_colors_stack, labels = legend_labels, name = "Class - Sex")+
  theme_minimal() + theme(legend.position = "none")

loose_ttl_stack

loose_ttl_stack_n <- loose_ttl_stack +
  geom_text(
    aes(label = after_stat(count)),
    stat = "count",
    position = position_fill(vjust = 0.5),
    size = 3,
    color = "white"
  )
loose_ttl_stack_n
```

# Emo
```{r}
mcs_emo_gmm1_loose <- hlme(value ~ Sweep, subject = "numericID", random=~1, ng = 1, data =asd_loose_long_sdq_emo)
#summary(mcs_emo_gmm1_loose)


mcs_emo_gmm2_loose <- hlme(value ~ Sweep, subject = "numericID", random=~1,
ng = 2, data = asd_loose_long_sdq_emo, mixture = ~ Sweep,
nwg=T, B = mcs_emo_gmm1_loose)
#summary(mcs_emo_gmm2_loose)



mcs_emo_gmm3_loose <- hlme(value ~ Sweep, subject = "numericID", random=~1,
ng = 3, data = asd_loose_long_sdq_emo, mixture = ~ Sweep,
nwg=T, B = mcs_emo_gmm1_loose)
#summary(mcs_emo_gmm3_loose)

mcs_emo_gmm4_loose <- hlme(value ~ Sweep, subject = "numericID", random=~1,
ng = 4, data = asd_loose_long_sdq_emo, mixture = ~ Sweep,
nwg=T, B = mcs_emo_gmm1_loose)
#summary(mcs_emo_gmm4_loose)

# make a table with results for the 4 models:
fit_ind <- summarytable(mcs_emo_gmm1_loose, mcs_emo_gmm2_loose,mcs_emo_gmm3_loose,mcs_emo_gmm4_loose,which = c("AIC","BIC","SABIC","%class","entropy","npm","loglik"))
```


```{r}

mcs_loose_emo_people2 <- as.data.frame(mcs_emo_gmm2_loose$pprob[,1:2])
asd_loose_long_sdq_emo <- merge(asd_loose_long_sdq_emo,mcs_loose_emo_people2, by = "numericID")

asd_loose_long_sdq_emo <- asd_loose_long_sdq_emo %>% dplyr::mutate(Sweep.age = case_when(Sweep == 2 ~ 3,Sweep == 3 ~ 5, Sweep == 4 ~ 7, Sweep == 5 ~ 11, Sweep == 6 ~ 14, Sweep == 7 ~ 17 ))

asd_loose_long_sdq_emo$Sweep.age <- as.numeric(asd_loose_long_sdq_emo$Sweep.age)
asd_loose_long_sdq_emo$class <- as.factor(asd_loose_long_sdq_emo$class)

my_colors <- brewer.pal(12, "Paired")[c(4,10)]
p_mcs_loose_emo_gmm2 <- ggplot(asd_loose_long_sdq_emo, aes(x = Sweep.age, y = value, group = numericID, colour = class)) +
  geom_line(size = 0.1) +
  geom_smooth(aes(group = class), method = "loess", size = 2, se = TRUE) +
  scale_y_continuous(limits = c(0, 10)) +
  scale_x_continuous(breaks = as.numeric(age), labels = age) +
  labs(x = "Age (years)", y = "MCS Broader SDQ Emotional Symptoms Score", colour = "Latent Class") +
  scale_colour_manual(values = my_colors)+
  theme_classic() + theme(legend.position = "none")


suppressWarnings(print(p_mcs_loose_emo_gmm2))

```

```{r}

legend_labels <- c("Class 1-Male", "Class 1-Female", "Class 2-Male", "Class 2-Female")

loose_emo_stack <- ggplot(asd_loose_long_sdq_emo,  aes(x = factor(diag.age), fill = interaction(sex,class))) +
  geom_bar(position="fill") + scale_y_continuous(labels = scales::percent) +
  labs(x = "Diagnosis Age", y = "Percentage") + scale_fill_manual(values = my_colors_stack, labels = legend_labels, name = "Class - Sex")+
  theme_minimal() + theme(legend.position = "none")

loose_emo_stack
```

# Conduct problems
```{r}

mcs_con_gmm1_loose <- hlme(value ~ Sweep, subject = "numericID", random=~1, ng = 1, data =asd_loose_long_sdq_con)
#summary(mcs_con_gmm1_loose)


mcs_con_gmm2_loose <- hlme(value ~ Sweep, subject = "numericID", random=~1,
ng = 2, data = asd_loose_long_sdq_con, mixture = ~ Sweep,
nwg=T, B = mcs_con_gmm1_loose)
#summary(mcs_con_gmm2_loose)



mcs_con_gmm3_loose <- hlme(value ~ Sweep, subject = "numericID", random=~1,
ng = 3, data = asd_loose_long_sdq_con, mixture = ~ Sweep,
nwg=T, B = mcs_con_gmm1_loose)
#summary(mcs_con_gmm3_loose)

mcs_con_gmm4_loose <- hlme(value ~ Sweep, subject = "numericID", random=~1,
ng = 4, data = asd_loose_long_sdq_con, mixture = ~ Sweep,
nwg=T, B = mcs_con_gmm1_loose)
#summary(mcs_con_gmm4_loose)

fit_ind <- summarytable(mcs_con_gmm1_loose, mcs_con_gmm2_loose,mcs_con_gmm3_loose,mcs_con_gmm4_loose,which = c("AIC","BIC","SABIC","%class","entropy","npm","loglik"))
```


```{r}

mcs_loose_con_people2 <- as.data.frame(mcs_con_gmm2_loose$pprob[,1:2])
asd_loose_long_sdq_con2 <- merge(asd_loose_long_sdq_con,mcs_loose_con_people2, by = "numericID")

asd_loose_long_sdq_con2 <- asd_loose_long_sdq_con2 %>% dplyr::mutate(Sweep.age = case_when(Sweep == 2 ~ 3,Sweep == 3 ~ 5, Sweep == 4 ~ 7, Sweep == 5 ~ 11, Sweep == 6 ~ 14, Sweep == 7 ~ 17 ))

asd_loose_long_sdq_con2$Sweep.age <- as.numeric(asd_loose_long_sdq_con2$Sweep.age)
asd_loose_long_sdq_con2$class <- as.factor(asd_loose_long_sdq_con2$class)


my_colors <- brewer.pal(12, "Paired")[c(4,10)]
p_mcs_loose_con_gmm2 <- ggplot(asd_loose_long_sdq_con2, aes(x = Sweep.age, y = value, group = numericID, colour = class)) +
  geom_line(size = 0.1) +
  geom_smooth(aes(group = class), method = "loess", size = 2, se = TRUE) +
  scale_y_continuous(limits = c(0, 10)) +
  scale_x_continuous(breaks = as.numeric(age), labels = age) +
  labs(x = "Age (years)", y = "MCS Broader SDQ Conduct Problems Score", colour = "Latent Class") +
  scale_colour_manual(values = my_colors)+
  theme_classic() + theme(legend.position = "none")


suppressWarnings(print(p_mcs_loose_con_gmm2))

```

```{r}
library(tidyverse)
mcs_loose_con_people3 <- as.data.frame(mcs_con_gmm3_loose$pprob[,1:2])
asd_loose_long_sdq_con3 <- merge(asd_loose_long_sdq_con,mcs_loose_con_people3, by = "numericID") %>% dplyr::mutate(Sweep.age = case_when(Sweep == 2 ~ 3,Sweep == 3 ~ 5, Sweep == 4 ~ 7, Sweep == 5 ~ 11, Sweep == 6 ~ 14, Sweep == 7 ~ 17 ))

asd_loose_long_sdq_con3$Sweep.age <- as.numeric(asd_loose_long_sdq_con3$Sweep.age)
asd_loose_long_sdq_con3$class <- as.factor(asd_loose_long_sdq_con3$class)
#p_mcs_loose_con_gmm3_s <- ggplot(asd_loose_long_sdq_con3, aes(Sweep.age, value, group=numericID, colour= class)) + geom_smooth(aes(group=numericID, colour=class),size=0.1, se=F) + geom_smooth(aes(group=class), method="loess", size=2, se=T)  + scale_y_continuous(limits = c(0,10)) + scale_x_continuous(breaks = as.numeric(age),labels = age) + labs(x="Age(years)",y="SDQ_con",colour="Latent Class") + theme_classic()


my_colors <- brewer.pal(12, "Paired")[c(4,2,10)]
p_mcs_loose_con_gmm3 <- ggplot(asd_loose_long_sdq_con3, aes(x = Sweep.age, y = value, group = numericID, colour = class)) +
  geom_line(size = 0.1) +
  geom_smooth(aes(group = class), method = "loess", size = 2, se = TRUE) +
  scale_y_continuous(limits = c(0, 10)) +
  scale_x_continuous(breaks = as.numeric(age), labels = age) +
  labs(x = "Age (years)", y = "MCS SDQ Conduct Problems Score", colour = "Latent Class") +
  scale_colour_manual(values = my_colors)+
  theme_classic()+ theme(legend.position = "none")


suppressWarnings(print(p_mcs_loose_con_gmm3))
#suppressWarnings(print(p_mcs_loose_con_gmm2_s))
```
```{r}


legend_labels <- c("Class 1-Male", "Class 1-Female", "Class 2-Male", "Class 2-Female")

loose_con_stack2 <- ggplot(asd_loose_long_sdq_con2,  aes(x = factor(diag.age), fill = interaction(sex,class))) +
  geom_bar(position="fill") + scale_y_continuous(labels = scales::percent) +
  labs(x = "Diagnosis Age", y = "Percentage") + scale_fill_manual(values = my_colors_stack, labels = legend_labels, name = "Class - Sex")+
  theme_minimal() + theme(legend.position = "bottom")

loose_con_stack2

my_colors_stack3 <- brewer.pal(12, "Paired")[c(4,3,2,1,10,9)]

legend_labels <- c("Class 1-Male", "Class 1-Female", "Class 2-Male", "Class 2-Female", "Class 3-Male", "Class 3-Female")

loose_con_stack3 <- ggplot(asd_loose_long_sdq_con3,  aes(x = factor(diag.age), fill = interaction(sex,class))) +
  geom_bar(position="fill") + scale_y_continuous(labels = scales::percent) +
  labs(x = "diagnosis age", y = "percentage") + scale_fill_manual(values = my_colors_stack3, labels = legend_labels, name = "Class - Sex")+
  theme_minimal() + theme(legend.position = "bottom")

loose_con_stack3
```


# Hyperactivity
```{r}

mcs_hyp_gmm1_loose <- hlme(value ~ Sweep, subject = "numericID", random=~1, ng = 1, data =asd_loose_long_sdq_hyp)
summary(mcs_hyp_gmm1_loose)


mcs_hyp_gmm2_loose <- hlme(value ~ Sweep, subject = "numericID", random=~1,
ng = 2, data = asd_loose_long_sdq_hyp, mixture = ~ Sweep,
nwg=T, B = mcs_hyp_gmm1_loose)
summary(mcs_hyp_gmm2_loose)



mcs_hyp_gmm3_loose <- hlme(value ~ Sweep, subject = "numericID", random=~1,
ng = 3, data = asd_loose_long_sdq_hyp, mixture = ~ Sweep,
nwg=T, B = mcs_hyp_gmm1_loose)
summary(mcs_hyp_gmm3_loose)

mcs_hyp_gmm4_loose <- hlme(value ~ Sweep, subject = "numericID", random=~1,
ng = 4, data = asd_loose_long_sdq_hyp, mixture = ~ Sweep,
nwg=T, B = mcs_hyp_gmm1_loose)
#summary(mcs_hyp_gmm4_loose)

# make a table with results for the 3 models:
fit_ind <- summarytable(mcs_hyp_gmm1_loose, mcs_hyp_gmm2_loose,mcs_hyp_gmm3_loose,mcs_hyp_gmm4_loose,which = c("AIC","BIC","SABIC","%class","entropy","npm","loglik"))


```


```{r}


mcs_hyp_gmm5_loose <- hlme(value ~ Sweep, subject = "numericID", random=~1,
ng = 5, data = asd_loose_long_sdq_hyp, mixture = ~ Sweep,
nwg=T, B = mcs_hyp_gmm1_loose)
#summary(mcs_hyp_gmm4_loose)

# make a table with results for the 3 models:
fit_ind <- summarytable(mcs_hyp_gmm1_loose, mcs_hyp_gmm2_loose,mcs_hyp_gmm3_loose,mcs_hyp_gmm4_loose,mcs_hyp_gmm5_loose,which = c("AIC","BIC","SABIC","%class","entropy","npm","loglik"))
```


```{r}

mcs_loose_hyp_people2 <- as.data.frame(mcs_hyp_gmm2_loose$pprob[,1:2])
asd_loose_long_sdq_hyp2 <- merge(asd_loose_long_sdq_hyp,mcs_loose_hyp_people2, by = "numericID")

asd_loose_long_sdq_hyp2 <- asd_loose_long_sdq_hyp2 %>% dplyr::mutate(Sweep.age = case_when(Sweep == 2 ~ 3,Sweep == 3 ~ 5, Sweep == 4 ~ 7, Sweep == 5 ~ 11, Sweep == 6 ~ 14, Sweep == 7 ~ 17 ))

asd_loose_long_sdq_hyp2$Sweep.age <- as.numeric(asd_loose_long_sdq_hyp2$Sweep.age)
asd_loose_long_sdq_hyp2$class <- as.factor(asd_loose_long_sdq_hyp2$class)


my_colors <- brewer.pal(12, "Paired")[c(4,10)]
p_mcs_loose_hyp_gmm2 <- ggplot(asd_loose_long_sdq_hyp2, aes(x = Sweep.age, y = value, group = numericID, colour = class)) +
  geom_line(size = 0.1) +
  geom_smooth(aes(group = class), method = "loess", size = 2, se = TRUE) +
  scale_y_continuous(limits = c(0, 10)) +
  scale_x_continuous(breaks = as.numeric(age), labels = age) +
  labs(x = "Age (years)", y = "MCS Broader SDQ Hyperactivity-Inattention Score", colour = "Latent Class") +
  scale_colour_manual(values = my_colors)+
  theme_classic()+ theme(legend.position = "none")


suppressWarnings(print(p_mcs_loose_hyp_gmm2))

```

```{r}

legend_labels <- c("Class 1-Male", "Class 1-Female", "Class 2-Male", "Class 2-Female")

loose_hyp_stack <- ggplot(asd_loose_long_sdq_hyp2,  aes(x = factor(diag.age), fill = interaction(sex,class))) +
  geom_bar(position="fill") + scale_y_continuous(labels = scales::percent) +
  labs(x = "Diagnosis Age", y = "Percentage") + scale_fill_manual(values = my_colors_stack, labels = legend_labels, name = "Class - Sex")+
  theme_minimal()+ theme(legend.position = "none")

loose_hyp_stack
```


# Peer relationship problems
```{r}

mcs_peer_gmm1_loose <- hlme(value ~ Sweep, subject = "numericID", random=~1, ng = 1, data =asd_loose_long_sdq_peer)
#summary(mcs_peer_gmm1_loose)


mcs_peer_gmm2_loose <- hlme(value ~ Sweep, subject = "numericID", random=~1,
ng = 2, data = asd_loose_long_sdq_peer, mixture = ~ Sweep,
nwg=T, B = mcs_peer_gmm1_loose)
summary(mcs_peer_gmm2_loose)



mcs_peer_gmm3_loose <- hlme(value ~ Sweep, subject = "numericID", random=~1,
ng = 3, data = asd_loose_long_sdq_peer, mixture = ~ Sweep,
nwg=T, B = mcs_peer_gmm1_loose)
#summary(mcs_peer_gmm3_loose)

mcs_peer_gmm4_loose <- hlme(value ~ Sweep, subject = "numericID", random=~1,
ng = 4, data = asd_loose_long_sdq_peer, mixture = ~ Sweep,
nwg=T, B = mcs_peer_gmm1_loose)
#summary(mcs_peer_gmm4_loose)


fit_ind <- summarytable(mcs_peer_gmm1_loose, mcs_peer_gmm2_loose,mcs_peer_gmm3_loose,mcs_peer_gmm4_loose,which = c("AIC","BIC","SABIC","%class","entropy","npm","loglik"))
```


```{r}

mcs_loose_peer_people2 <- as.data.frame(mcs_peer_gmm2_loose$pprob[,1:2])
asd_loose_long_sdq_peer2 <- merge(asd_loose_long_sdq_peer,mcs_loose_peer_people2, by = "numericID")

asd_loose_long_sdq_peer2 <- asd_loose_long_sdq_peer2 %>% dplyr::mutate(Sweep.age = case_when(Sweep == 2 ~ 3,Sweep == 3 ~ 5, Sweep == 4 ~ 7, Sweep == 5 ~ 11, Sweep == 6 ~ 14, Sweep == 7 ~ 17 ))

asd_loose_long_sdq_peer2$Sweep.age <- as.numeric(asd_loose_long_sdq_peer2$Sweep.age)
asd_loose_long_sdq_peer2$class <- as.factor(asd_loose_long_sdq_peer2$class)


my_colors <- brewer.pal(12, "Paired")[c(4,10)]
p_mcs_loose_peer_gmm2 <- ggplot(asd_loose_long_sdq_peer2, aes(x = Sweep.age, y = value, group = numericID, colour = class)) +
  geom_line(size = 0.1) +
  geom_smooth(aes(group = class), method = "loess", size = 2, se = TRUE) +
  scale_y_continuous(limits = c(0, 10)) +
  scale_x_continuous(breaks = as.numeric(age), labels = age) +
  labs(x = "Age (years)", y = "MCS Broader SDQ Peer Relationship Problems Score", colour = "Latent Class") +
  scale_colour_manual(values = my_colors)+
  theme_classic() + theme(legend.position = "none")


suppressWarnings(print(p_mcs_loose_peer_gmm2))

```

```{r}

legend_labels <- c("Class 1-Male", "Class 1-Female", "Class 2-Male", "Class 2-Female")

loose_peer_stack <- ggplot(asd_loose_long_sdq_peer2,  aes(x = factor(diag.age), fill = interaction(sex,class))) +
  geom_bar(position="fill") + scale_y_continuous(labels = scales::percent) +
  labs(x = "Diagnosis Age", y = "Percentage") + scale_fill_manual(values = my_colors_stack, labels = legend_labels, name = "Class - Sex")+
  theme_minimal()+ theme(legend.position = "none")

loose_peer_stack
```


# Prosocial behaviours
```{r}

mcs_pro_gmm1_loose <- hlme(value ~ Sweep, subject = "numericID", random=~1, ng = 1, data =asd_loose_long_sdq_pro)
#summary(mcs_pro_gmm1_loose)


mcs_pro_gmm2_loose <- hlme(value ~ Sweep, subject = "numericID", random=~1,
ng = 2, data = asd_loose_long_sdq_pro, mixture = ~ Sweep,
nwg=T, B = mcs_pro_gmm1_loose)
#summary(mcs_pro_gmm2_loose)



mcs_pro_gmm3_loose <- hlme(value ~ Sweep, subject = "numericID", random=~1,
ng = 3, data = asd_loose_long_sdq_pro, mixture = ~ Sweep,
nwg=T, B = mcs_pro_gmm1_loose)
#summary(mcs_pro_gmm3_loose)

mcs_pro_gmm4_loose <- hlme(value ~ Sweep, subject = "numericID", random=~1,
ng = 4, data = asd_loose_long_sdq_pro, mixture = ~ Sweep,
nwg=T, B = mcs_pro_gmm1_loose)
#summary(mcs_pro_gmm4_loose)


fit_ind <- summarytable(mcs_pro_gmm1_loose, mcs_pro_gmm2_loose,mcs_pro_gmm3_loose,mcs_pro_gmm4_loose,which = c("AIC","BIC","SABIC","%class","entropy","npm","loglik"))
```
```{r}

mcs_pro_no0_gmm1_loose <- hlme(value ~ Sweep, subject = "numericID", random=~1, ng = 1, data =asd_loose_long_sdq_pro_no0)
#summary(mcs_pro_no0_gmm1_loose)


mcs_pro_no0_gmm2_loose <- hlme(value ~ Sweep, subject = "numericID", random=~1,
ng = 2, data = asd_loose_long_sdq_pro_no0, mixture = ~ Sweep,
nwg=T, B = mcs_pro_no0_gmm1_loose)
#summary(mcs_pro_no0_gmm2_loose)



mcs_pro_no0_gmm3_loose <- hlme(value ~ Sweep, subject = "numericID", random=~1,
ng = 3, data = asd_loose_long_sdq_pro_no0, mixture = ~ Sweep,
nwg=T, B = mcs_pro_no0_gmm1_loose)
#summary(mcs_pro_no0_gmm3_loose)

mcs_pro_no0_gmm4_loose <- hlme(value ~ Sweep, subject = "numericID", random=~1,
ng = 4, data = asd_loose_long_sdq_pro_no0, mixture = ~ Sweep,
nwg=T, B = mcs_pro_no0_gmm1_loose)
#summary(mcs_pro_no0_gmm4_loose)


fit_ind <- summarytable(mcs_pro_no0_gmm1_loose, mcs_pro_no0_gmm2_loose,mcs_pro_no0_gmm3_loose,mcs_pro_no0_gmm4_loose,which = c("AIC","BIC","SABIC","%class","entropy","npm","loglik"))
```


```{r}

mcs_loose_pro_people2 <- as.data.frame(mcs_pro_gmm2_loose$pprob[,1:2])
asd_loose_long_sdq_pro2 <- merge(asd_loose_long_sdq_pro,mcs_loose_pro_people2, by = "numericID")

asd_loose_long_sdq_pro2 <- asd_loose_long_sdq_pro2 %>% dplyr::mutate(Sweep.age = case_when(Sweep == 2 ~ 3,Sweep == 3 ~ 5, Sweep == 4 ~ 7, Sweep == 5 ~ 11, Sweep == 6 ~ 14, Sweep == 7 ~ 17 ))

asd_loose_long_sdq_pro2$Sweep.age <- as.numeric(asd_loose_long_sdq_pro2$Sweep.age)
asd_loose_long_sdq_pro2$class <- as.factor(asd_loose_long_sdq_pro2$class)

my_colors <- brewer.pal(12, "Paired")[c(4,10)]
p_mcs_loose_pro_gmm2 <- ggplot(asd_loose_long_sdq_pro2, aes(x = Sweep.age, y = value, group = numericID, colour = class)) +
  geom_line(size = 0.1) +
  geom_smooth(aes(group = class), method = "loess", size = 2, se = TRUE) +
  scale_y_continuous(limits = c(0, 10)) +
  scale_x_continuous(breaks = as.numeric(age), labels = age) +
  labs(x = "Age (years)", y = "MCS Broader SDQ Prosocial Behaviours Score", colour = "Latent Class") +
  scale_colour_manual(values = my_colors)+
  theme_classic() + theme(legend.position = "non")


suppressWarnings(print(p_mcs_loose_pro_gmm2))

```

```{r}

legend_labels2 <- c("Class 1-Male", "Class 1-Female", "Class 2-Male", "Class 2-Female")

loose_pro_stack2 <- ggplot(asd_loose_long_sdq_pro2,  aes(x = factor(diag.age), fill = interaction(sex,class))) +
  geom_bar(position="fill") + scale_y_continuous(labels = scales::percent) +
  labs(x = "Diagnosis Age", y = "Percentage") + scale_fill_manual(values = my_colors_stack, labels = legend_labels, name = "Class - Sex")+
  theme_minimal()+ theme(legend.position = "bottom")

loose_pro_stack2
```

```{r}

mcs_loose_pro_people3 <- as.data.frame(mcs_pro_gmm3_loose$pprob[,1:2])
asd_loose_long_sdq_pro3 <- merge(asd_loose_long_sdq_pro,mcs_loose_pro_people3, by = "numericID")

asd_loose_long_sdq_pro3 <- asd_loose_long_sdq_pro3 %>% dplyr::mutate(Sweep.age = case_when(Sweep == 2 ~ 3,Sweep == 3 ~ 5, Sweep == 4 ~ 7, Sweep == 5 ~ 11, Sweep == 6 ~ 14, Sweep == 7 ~ 17 ))

asd_loose_long_sdq_pro3$Sweep.age <- as.numeric(asd_loose_long_sdq_pro3$Sweep.age)
asd_loose_long_sdq_pro3$class <- as.factor(asd_loose_long_sdq_pro3$class)

my_colors <- brewer.pal(12, "Paired")[c(4,10,2)]
p_mcs_loose_pro_gmm3 <- ggplot(asd_loose_long_sdq_pro3, aes(x = Sweep.age, y = value, group = numericID, colour = class)) +
  geom_line(size = 0.1) +
  geom_smooth(aes(group = class), method = "loess", size = 2, se = TRUE) +
  scale_y_continuous(limits = c(0, 10)) +
  scale_x_continuous(breaks = as.numeric(age), labels = age) +
  labs(x = "Age (years)", y = "MCS SDQ Prosocial Score", colour = "Latent Class") +
  scale_colour_manual(values = my_colors)+
  theme_classic()+ theme(legend.position = "none")

suppressWarnings(print(p_mcs_loose_pro_gmm3))

```

```{r}

legend_labels3 <- c("Class 1-Male", "Class 1-Female", "Class 2-Male", "Class 2-Female", "Class 3-Male", "Class 3-Female")
my_colors_stack3 <- brewer.pal(12, "Paired")[c(4,3,10,9,2,1)]
loose_pro_stack3 <- ggplot(asd_loose_long_sdq_pro3,  aes(x = factor(diag.age), fill = interaction(sex,class))) +
  geom_bar(position="fill") + scale_y_continuous(labels = scales::percent) +
  labs(x = "diagnosis age", y = "percentage") + scale_fill_manual(values = my_colors_stack3, labels = legend_labels3, name = "Class - Sex")+
  theme_minimal() + theme(legend.position = "bottom")

loose_pro_stack3
```


```{r}

pdf(file = "/Users/zhangxinhe/Documents/who recieves a diagnosis/Figures FINAL/mcs_braoder_gmm_traj.pdf",width = 10, height = 6)
suppressWarnings(print(p_mcs_loose_ttl_gmm2))
suppressWarnings(print(p_mcs_loose_emo_gmm2))
suppressWarnings(print(p_mcs_loose_con_gmm2))
suppressWarnings(print(p_mcs_loose_hyp_gmm2))
suppressWarnings(print(p_mcs_loose_peer_gmm2))
suppressWarnings(print(p_mcs_loose_pro_gmm2))
dev.off()


```

```{r}

pdf(file = "/Users/zhangxinhe/Documents/who recieves a diagnosis/Figures FINAL/mcs_braoder_gmm_stack_bar.pdf",width = 10, height = 6)
print(loose_ttl_stack)
print(loose_emo_stack)
print(loose_con_stack2)
print(loose_hyp_stack)
print(loose_peer_stack)
print(loose_pro_stack2)
dev.off()


```


```{r}

pdf(file = "/Users/zhangxinhe/Documents/who recieves a diagnosis/Figures FINAL/mcs_braoder_multigrp.pdf",width = 10, height = 6)
print(p_mcs_loose_con_gmm2)
print(loose_con_stack2)
print(p_mcs_loose_con_gmm3)
print(loose_con_stack3)
print(p_mcs_loose_pro_gmm2)
print(loose_pro_stack2)
print(p_mcs_loose_pro_gmm3)
print(loose_pro_stack3)
dev.off()

```
# For sample with no 0 prosocial behaviours reported

```{r}

mcs_loose_pro_no0_people2 <- as.data.frame(mcs_pro_no0_gmm2_loose$pprob[,1:2])
asd_loose_long_sdq_pro2_no0 <- merge(asd_loose_long_sdq_pro_no0,mcs_loose_pro_no0_people2, by = "numericID")

asd_loose_long_sdq_pro2_no0 <- asd_loose_long_sdq_pro2_no0 %>% dplyr::mutate(Sweep.age = case_when(Sweep == 2 ~ 3,Sweep == 3 ~ 5, Sweep == 4 ~ 7, Sweep == 5 ~ 11, Sweep == 6 ~ 14, Sweep == 7 ~ 17 ))

asd_loose_long_sdq_pro2_no0$Sweep.age <- as.numeric(asd_loose_long_sdq_pro2_no0$Sweep.age)
asd_loose_long_sdq_pro2_no0$class <- as.factor(asd_loose_long_sdq_pro2_no0$class)

my_colors <- brewer.pal(12, "Paired")[c(4,10)]
p_mcs_loose_pro_no0_gmm2 <- ggplot(asd_loose_long_sdq_pro2_no0, aes(x = Sweep.age, y = value, group = numericID, colour = class)) +
  geom_line(size = 0.1) +
  geom_smooth(aes(group = class), method = "loess", size = 2, se = TRUE) +
  scale_y_continuous(limits = c(0, 10)) +
  scale_x_continuous(breaks = as.numeric(age), labels = age) +
  labs(x = "Age (years)", y = "MCS SDQ Prosocial Score (no0)", colour = "Latent Class") +
  scale_colour_manual(values = my_colors)+
  theme_classic()


suppressWarnings(print(p_mcs_loose_pro_no0_gmm2))

```

```{r}

legend_labels2 <- c("Class 1-Male", "Class 1-Female", "Class 2-Male", "Class 2-Female")

loose_pro_no0_stack2 <- ggplot(asd_loose_long_sdq_pro2_no0,  aes(x = factor(diag.age), fill = interaction(sex,class))) +
  geom_bar(position="fill") + scale_y_continuous(labels = scales::percent) +
  labs(x = "diagnosis age", y = "percentage") + scale_fill_manual(values = my_colors_stack, labels = legend_labels, name = "Class - Sex")+
  theme_minimal()

```
# Extract group membership for complete SDQ sample (n = 238)
```{r}
mcs_loose_complete_gmm_grp <- cbind(mcs_loose_ttl_people2,mcs_loose_emo_people2$class,mcs_loose_con_people2$class,mcs_loose_con_people3$class,mcs_loose_hyp_people2$class,mcs_loose_peer_people2$class,mcs_loose_pro_people2$class,mcs_loose_pro_people3$class)


mcs_loose_complete_gmm_grp <- cbind(asd_loose_SDQ_complete_gmm$cmid,mcs_loose_complete_gmm_grp)
names(mcs_loose_complete_gmm_grp) <- c("cmid","numericID","ttl2","emo2","con2","con3","hyp2","peer2","pro2","pro3")
mcs_loose_complete_gmm_grp_demo <- merge(asd_loose_SDQ_complete_gmm[c(1,2,40)],merge(asd_loose_demo,mcs_loose_complete_gmm_grp, by = "cmid", all.y = TRUE), by = c("MCSID","cmid"))
```


## Load covariates 
(cognitive ability, ethnicity,maternal age at delivery, emonomic status, area deprivation)
```{r}
mcs_cog <- read.csv("/Users/zhangxinhe/Documents/who recieves a diagnosis/MCS/mcs_ID_identifier.csv")
mcs_cog$cmid <- paste(mcs_cog$mcs_cog_pca.MCSID, mcs_cog$mcs_cog_pca.BCNUM00, sep = "")
mcs_cog <- mcs_cog[,c(2,7,5,6)]
names(mcs_cog)[c(1,3)] <- c("MCSID","cog.PC1")
mcs_loose_asd_cog <- mcs_cog %>% filter(cmid %in% asd_loose_SDQ_complete$cmid) # N = 165, no ID, complete cases


```


```{r}
#mcs2_parent_interview <- read_delim("/Users/zhangxinhe/Documents/who recieves a diagnosis/MCS/MCS_data/UKDA-5350-tab/tab/mcs2_parent_interview.tab")


#mcs2_ses_identifier <- read.csv("/Users/zhangxinhe/Documents/who recieves a diagnosis/MCS/mcs_ses_identifier.csv")
#asd_loose_ses <- mcs2_ses_identifier %>% filter(MCSID %in% mcs_loose_complete_gmm_grp_demo$MCSID)  # no one had complete SES (i.e., including parental educational background)
mcs2_dep_identifier <- read.csv("/Users/zhangxinhe/Documents/who recieves a diagnosis/MCS/mcs_deprivation_identifier.csv") 
mcs_loose_dep <- mcs2_dep_identifier %>% filter(MCSID %in% mcs_loose_complete_gmm_grp_demo$MCSID) %>% dplyr::select(MCSID,PC1)
names(mcs_loose_dep)[2] <- "dep.PC1"
#mcs2_family_derived <- read_delim("/Users/zhangxinhe/Documents/who recieves a diagnosis/MCS/MCS_data/UKDA-5350-tab/tab/mcs2_family_derived.tab")

mcs2_other_ses_identifier <- read.csv("/Users/zhangxinhe/Documents/who recieves a diagnosis/MCS/mcs_other_ses_identifier.csv")
mcs_loose_es <- mcs2_other_ses_identifier %>% filter(MCSID %in% mcs_loose_complete_gmm_grp_demo$MCSID) %>% dplyr::select(MCSID,PC1) 
names(mcs_loose_es)[2] <- "es.PC1"

mcs_loose_covs <- merge(mcs_loose_asd_cog, merge(mcs_loose_dep,mcs_loose_es, by = "MCSID"), by = "MCSID")

mcs_loose_gmm_covs <- merge(mcs_loose_complete_gmm_grp_demo,mcs_loose_covs, by = c("MCSID","cmid"))
```

# Developmental milestones
```{r}
mcs1_parent_cm_interview <- read.delim("/Users/zhangxinhe/Documents/who recieves a diagnosis/MCS/MCS_data/UKDA-4683-tab/tab/mcs1_parent_cm_interview.tab")
mcs1_parent_cm_interview$cmid <- paste(mcs1_parent_cm_interview$MCSID, mcs1_parent_cm_interview$ACNUM00, sep = "")
mcs2_parent_cm_interview <- read.delim("/Users/zhangxinhe/Documents/who recieves a diagnosis/MCS/MCS_data/UKDA-5350-tab/tab/mcs2_parent_cm_interview.tab")
mcs2_parent_cm_interview$cmid <- paste(mcs2_parent_cm_interview$MCSID, mcs2_parent_cm_interview$BCNUM00, sep = "")
mcs3_parent_cm_interview <- read.delim("/Users/zhangxinhe/Documents/who recieves a diagnosis/MCS/MCS_data/UKDA-5795-tab/tab/mcs3_parent_cm_interview.tab")
mcs3_parent_cm_interview$cmid <- paste(mcs3_parent_cm_interview$MCSID, mcs3_parent_cm_interview$CCNUM00, sep = "")
```
```{r}
library(tidyverse)
mcs1_devmile <- dplyr::select(mcs1_parent_cm_interview, c("MCSID","cmid","APNUM00","ACSMIL00","ACSITU00","ACSTAN00","ACHAND00","ACGRAB00","ACPICK00","ACPTOY00",
"ACWALK00","ACGIVE00","ACWAVE00","ACARMS00","ACNODS00","ACMOVE00"))
mcs1_devmile <- mcs1_devmile %>% filter(APNUM00 == "1") %>% filter_at(vars(-MCSID, -APNUM00,-cmid), all_vars( . >- 1))
mcs2_devmile <- dplyr::select(mcs2_parent_cm_interview, c("MCSID","cmid","BPNUM00","BPDRDA00","BPCLDA00"))
mcs2_devmile <- mcs2_devmile %>% filter(BPNUM00 == "1") %>% filter_at(vars(-MCSID, -BPNUM00,-cmid),all_vars( . > -1 & . < 4))
mcs3_devmile <- dplyr::select(mcs3_parent_cm_interview, c("MCSID","cmid","CPNUM00","CPSQCO00","CPDRSS00")) 
mcs3_devmile <- mcs3_devmile %>% filter(CPNUM00 == "1") %>% filter_at(vars(-MCSID, -CPNUM00, -cmid), all_vars(. <3 &  . > -1))
mcs_devmile <- inner_join(inner_join(mcs1_devmile, mcs2_devmile, by = c("MCSID","cmid")), mcs3_devmile, by = c("MCSID","cmid") )
mcs_devmile <- subset(mcs_devmile, select=-c(APNUM00, BPNUM00, CPNUM00))
names(mcs_devmile)[3:ncol(mcs_devmile)] <- c("smile","situp","standup","handtoy", "grab", "holdsmall",
"passtoy","park","givetop","wavebye","extendarm","nodyes","move","dry","clean","square","dress")
# sweep1: 1 = often; 2 = Once or Twice; 3 = Not yet
# Sweep2: 1 = always; 2 = sometimes; 3 = never; 4 = dk
# sweep3: 1 = yes; 2 = no; 3 = dk


mcs_devmile$dryclean <- (mcs_devmile$dry + mcs_devmile$clean)/2

mcs_devmile <- subset(mcs_devmile, select = -c(dry, clean))

mcs_devmile$dryclean <- as.integer(mcs_devmile$dryclean)
mcs_loose_gmm_cov_devmile <- merge(mcs_loose_gmm_covs,mcs_devmile , by= c("MCSID","cmid"))

```


### Regression models 

```{r}

fit_all_cov_procon3 <- lm(diag.age ~ sex + cog.PC1 + eth + mad + es.PC1 + dep.PC1 + ttl2 + emo2 + con3 + hyp2 + peer2 + pro3 , data= mcs_loose_gmm_covs)
summary(fit_all_cov_procon3)
sjPlot::tab_model(fit_all_cov_procon3)
fit_all_cov_procon2 <- lm(diag.age ~ sex + cog.PC1 + eth + mad + es.PC1 + dep.PC1 + ttl2 + emo2 + con2 + hyp2 + peer2 + pro2, data= mcs_loose_gmm_covs)
summary(fit_all_cov_procon2)
tab_model(fit_all_cov_procon2)

library(survival)
model_cox <- coxph(Surv(diag.age) ~ sex + cog.PC1 + eth + mad + es.PC1 + dep.PC1 + ttl2 + emo2 + con2 + hyp2 + peer2 + pro2, data = mcs_loose_gmm_covs)
summary(model_cox)

```


```{r}
mcs_loose_gmm_covs$eth <- ifelse(mcs_loose_gmm_covs$eth == 1, 0,1)
mcs_loose_gmm_covs_s <- mcs_loose_gmm_covs %>%
  mutate_at(c(4:6,8,9,11,12,13,15,16,18:19), funs(c(scale(.))))
fit_all_cov_procon3_s <- lm(diag.age ~ sex + cog.PC1 + eth + mad + es.PC1 + dep.PC1 + ttl2 + emo2 + con3 + hyp2 + peer2 + pro3 , data= mcs_loose_gmm_covs_s)
summary(fit_all_cov_procon3_s)

```


```{r}
library(relaimpo)
calc.relimp(fit_all_cov_procon3_s,type="lmg", diff = TRUE,rela=TRUE)

# Bootstrap Measures of Relative Importance (100 samples)
boot_lmg <- boot.relimp(diag.age ~  sex + cog.PC1 + eth + mad + es.PC1 + dep.PC1 + ttl2 + emo2 + con3 + hyp2 + peer2 + pro3, data = mcs_loose_gmm_covs_s, b = 100, type = c("lmg","first","last","pratt"), rank = TRUE,diff = TRUE, rela = TRUE)


booteval.relimp(boot_lmg) 


```
```{r}

png("mcs_loose_relative_importance_plot.png", width = 1000, height = 600)

plot(booteval.relimp(boot_lmg,sort=TRUE), level = 0.9) # plot result
dev.off()
```



# For those reported non-0 prosocial behaviours only
```{r}
mcs_loose_gmm_covs_prono0 <- mcs_loose_gmm_covs %>% filter(cmid %in% asd_loose_SDQ_complete_nopro0$cmid)

mcs_loose_gmm_covs_prono0 <- mcs_loose_gmm_covs_prono0 %>% dplyr::select(-pro2,-pro3)


mcs_loose_gmm_covs_prono0 <- merge(mcs_loose_gmm_covs_prono0, mcs_loose_pro_no0_people2,by = "numericID")
names(mcs_loose_gmm_covs_prono0)[18] <- "pro2_no0"
```


```{r}
fit_all_cov_prono0 <- lm(diag.age ~ sex + cog.PC1 + eth + mad + es.PC1 + dep.PC1 + ttl2 + emo2 + con3 + hyp2 + peer2 + pro2_no0, data= mcs_loose_gmm_covs_prono0)
summary(fit_all_cov_prono0)

```

```{r}
# calc.relimp(fit_all_cov_prono0,type="lmg", diff = TRUE,rela=TRUE)

# Bootstrap Measures of Relative Importance (100 samples)
boot_prono0 <- boot.relimp(diag.age ~  sex + cog.PC1 + eth + mad + es.PC1 + dep.PC1 + ttl2 + emo2 + con3 + hyp2 + peer2 + pro2_no0, data = mcs_loose_gmm_covs_prono0, b = 100, type = c("lmg","first","last","pratt"), rank = TRUE,diff = TRUE, rela = TRUE)


booteval.relimp(boot_prono0) 

```

```{r}

png("mcs_loose_prono0_relaimp_plot.png", width = 1000, height = 600)

plot(booteval.relimp(boot_lmg_prono0,sort=TRUE), level = 0.9) # plot result
dev.off()

```



## Multilevel mediation analysis
# working with mcs_loose_gmm_covs_s, N = 164

```{r}

library(lavaan)

# Create the mediation model

model_loose_1 <- "
  # direct effects
  diag.age ~ sex +  eth + mad + cog.PC1 + es.PC1 + dep.PC1 + ttl2 + emo2 + con3 + hyp2 + peer2 + pro3"

fit_1 <- lavaan::sem(model_loose_1, data = mcs_loose_gmm_covs)

mcs_loose_fit_cor <- lavInspect(fit_1, what = "cor.all")
misty::dominance.manual(mcs_loose_fit_cor)

lavTech(fit_1, "rsquare", add.labels = T)
```


```{r}
library(tidySEM)
mcs_b_model_2 <- "

  diag.age ~ s*sex + i*cog.PC1 + e*eth + m*mad + se*es.PC1 + de*dep.PC1 + t*ttl2 + em*emo2 + co*con3 + h*hyp2 + p*peer2 + pr*pro3

  ttl2 ~ i1*cog.PC1 + de1*dep.PC1 + se1*es.PC1 + m1*mad + s1*sex + e1*eth
  emo2 ~ i2*cog.PC1 + de2*dep.PC1 + se2*es.PC1 + m2*mad + s2*sex + e2*eth
  con3 ~ i3*cog.PC1 + de3*dep.PC1 + se3*es.PC1 + m3*mad + s3*sex + e3*eth
  hyp2 ~ i4*cog.PC1 + de4*dep.PC1 + se4*es.PC1 + m4*mad + s4*sex+ e4*eth
  peer2 ~ i5*cog.PC1 + de5*dep.PC1 + se5*es.PC1 + m5*mad + s5*sex+ e5*eth
  pro3 ~ i6*cog.PC1 + de6*dep.PC1 + se6*es.PC1 + m6*mad + s6*sex+ e6*eth
  
  
 indirect_ttl2 := i1*t  +de1*t+se1*t+m1*t +s1*t+ e1*t
 indirect_emo2 := i2*em  +de2*em+se2*em+m2*em +s2*em+ e2*em
 indirect_con3 := i3*co  +de3*co+se3*co+m3*co +s3*co+ e3*co
 indirect_hyp2 := i4*h  +de4*h+se4*h+m4*h +s4*h+ e4*h
 indirect_peer2 := i5*p  +de5*p+se5*p+m5*p +s5*p+ e5*p
 indirect_pro3 := i6*pr  +de6*pr+se6*pr+m6*pr +s6*pr+ e6*pr
 
direct := s + i + e +m + se + de
total_indirect := indirect_ttl2 + indirect_emo2 + indirect_con3 + indirect_hyp2 + indirect_peer2 + indirect_pro3
total := direct + total_indirect
  
"
set.seed(060524)
serial_mcsb_fit <- lavaan::sem(mcs_b_model_2, data = mcs_loose_gmm_covs, se = "bootstrap",
    missing = "fiml", bootstrap = 1000)
serial_mcsb_fit_sum <- lavaan::summary(serial_mcsb_fit, standardized = TRUE, rsq = T,
    fit = TRUE, ci = TRUE)
serial_mcsb_fit_ParEsts <- lavaan::parameterEstimates(serial_mcsb_fit, boot.ci.type = "bca.simple",standardized = TRUE)
serial_mcsb_fit_sum
serial_mcsb_fit_ParEsts
write.csv(serial_mcsb_fit_ParEsts, file = "mcsb_level2.csv")
```
 # for one layer, using summary will encounter a bug, so using lavTech or lavInspect 
# see https://github.com/yrosseel/lavaan/issues/290
model_2 <- "
  # direct effects
  diag.age ~ sex + cog.PC1 + eth + mad + es.PC1 + dep.PC1 + ttl2 + emo2 + con3 + hyp2 + peer2 + pro3
  
  
  # mediation paths
  
  ttl2 ~ cog.PC1 + dep.PC1 + es.PC1 + mad + sex + eth
  emo2 ~ cog.PC1 + dep.PC1 + es.PC1 + mad + sex + eth
  con3 ~ cog.PC1 + dep.PC1 + es.PC1 + mad + sex + eth
  hyp2 ~ cog.PC1 + dep.PC1 + es.PC1 + mad + sex+ eth
  peer2 ~ cog.PC1 + dep.PC1 + es.PC1 + mad + sex+ eth
  pro3 ~ cog.PC1 + dep.PC1 + es.PC1 + mad + sex+ eth
"

fit_2 <- lavaan::sem(model_2, data = mcs_loose_gmm_covs_s)

model_3<- "
  # direct effects
  diag.age ~ sex + cog.PC1 + eth + mad + es.PC1 + dep.PC1 + ttl2 + emo2 + con3 + hyp2 + peer2 + pro3
  
  
  # mediation paths
  ttl2 ~ cog.PC1 + dep.PC1 + es.PC1 + mad + sex+ eth
  emo2 ~ cog.PC1 + dep.PC1 + es.PC1 + mad + sex+ eth
  con3 ~ cog.PC1 + dep.PC1 + es.PC1 + mad + sex+ eth
  hyp2 ~ cog.PC1 + dep.PC1 + es.PC1 + mad + sex+ eth
  peer2 ~ cog.PC1 + dep.PC1 + es.PC1 + mad + sex+ eth
  pro3 ~ cog.PC1 + dep.PC1 + es.PC1 + mad + sex+ eth
  cog.PC1 ~ es.PC1 + mad + dep.PC1 + sex+ eth
"

fit_3 <- lavaan::sem(model_3, data = mcs_loose_gmm_covs_s)

model_4 <- "
  # direct effects
  diag.age ~ sex + cog.PC1 + eth + mad + es.PC1 + dep.PC1 + ttl2 + emo2 + con3 + hyp2 + peer2 + pro3
  
  
  # mediation paths
  cog.PC1 ~ es.PC1 + mad + dep.PC1 + sex+ eth
  mad ~ es.PC1 + dep.PC1 + sex+ eth
  ttl2 ~ cog.PC1 + dep.PC1 + es.PC1 + mad + sex+ eth
  emo2 ~ cog.PC1 + dep.PC1 + es.PC1 + mad + sex+ eth
  con3 ~ cog.PC1 + dep.PC1 + es.PC1 + mad+ sex+ eth
  hyp2 ~ cog.PC1 + dep.PC1 + es.PC1 + mad+ sex+ eth
  peer2 ~ cog.PC1 + dep.PC1 + es.PC1 + mad+ sex+ eth
  pro3 ~ cog.PC1 + dep.PC1 + es.PC1 + mad+ sex+ eth"

fit_4 <- lavaan::sem(model_4, data = mcs_loose_gmm_covs_s)
# add a layer of ethnicity?

summary(fit_1)
summary(fit_2,standardized = TRUE, rsquare = TRUE)
summary(fit_3,standardized = TRUE, rsquare = TRUE)
summary(fit_4,standardized = TRUE, rsquare = TRUE)
```
```{r}
mcs_broader_12 <- anova(fit_1,fit_2)
mcs_broader_12 <- anova(fit_2,fit_3,nested = T)
mcs_broader_12
nonnest2::vuongtest(fit_1,fit_4, nested=F)
nonnest2::vuongtest(fit_2,fit_1, nested=F)
nonnest2::vuongtest(fit_2,fit_3, nested=TRUE)
nonnest2::vuongtest(fit_3,fit_4, nested=TRUE)
mcs_broader_13 <- anova(fit_1,fit_3)
mcs_broader_14 <- anova(fit_1,fit_4)
mcs_broader_results <- rbind(mcs_broader_12,mcs_broader_13,mcs_broader_14)
indirect_effects <- parameterEstimates(fit_2, boot = TRUE, boot.ci.type = "bca", boot.n = 1000)
```




```{r}
fit_results_list <- list(
  model1 = as.data.frame(parameterEstimates(fit_1)),
  model2 = as.data.frame(parameterEstimates(fit_2)),
  model3 = as.data.frame(parameterEstimates(fit_3)),
  model4 = as.data.frame(parameterEstimates(fit_4))

)
fit_results_list
```

```{r}
anova(fit_1, fit_2)
anova(fit_2, fit_3)
anova(fit_3, fit_4)

```





# skip this chunk
```{r}
names(mcs2_SDQ) <- c("MCSID","cmid","EMOTION","CONDUCT","HYPER","PEER","PROSOC","TOT")
names(mcs3_SDQ) <- c("MCSID","cmid","EMOTION","CONDUCT","HYPER","PEER","PROSOC","TOT")
names(mcs4_SDQ) <- c("MCSID","cmid","EMOTION","CONDUCT","HYPER","PEER","PROSOC","TOT")
names(mcs5_SDQ) <- c("MCSID","cmid","EMOTION","CONDUCT","HYPER","PEER","PROSOC","TOT")
names(mcs6_SDQ) <- c("MCSID","cmid","EMOTION","CONDUCT","HYPER","PEER","PROSOC","TOT")
names(mcs7_SDQ) <- c("MCSID","cmid","EMOTION","CONDUCT","HYPER","PEER","PROSOC","TOT")
mcs2_SDQ$sweep <- 2
mcs3_SDQ$sweep <- 3
mcs4_SDQ$sweep <- 4
mcs5_SDQ$sweep <- 5
mcs6_SDQ$sweep <- 6
mcs7_SDQ$sweep <- 7
asd_loose_SDQ_long <- rbind(mcs2_SDQ,mcs3_SDQ,mcs4_SDQ,mcs5_SDQ,mcs6_SDQ,mcs7_SDQ)
```




### Stop here
```{r}
# impute subscales without total score
asd_loose_demo <- merge(mcs_sex[c(1,2,5)], mcs_eth_mad[c(1:2,6,11)], by = c("MCSID","cmid"))

set.seed(123)

data_split <- createDataPartition(y=asd_loose_demo$eth, p=0.8, list=F)
train_sample <- asd_loose_demo[-data_split,]
test_sample <- asd_loose_demo[data_split,]
train <- asd_loose_SDQ[asd_loose_SDQ$cmid %in% train_sample$cmid,]
test <- asd_loose_SDQ[asd_loose_SDQ$cmid %in% test_sample$cmid,]
```

```{r}
cv_sft <- function(y,
                   N = 10,
                   len = 20) {
  y <- as.matrix(y)
  Y2 <- y
  Y2[is.na(Y2)] <- 0
  d <- dim(y)
  n <- d[1]
  p <- d[2]
  m <- sum(!is.na(y))
  lambda1.max <- max(svd(Y2)$d)
  lambda1.min <- 1e-3*lambda1.max
  grid.lambda1 <-
    exp(seq(log(lambda1.min), log(lambda1.max), length.out = len))
  ylist <-
    lapply(1:N, function(k)
      produce_NA(as.matrix(y), perc.missing = 0.2))$data.incomp
  res.cv <- lapply(1:N, function(k) {
    sapply(1:len,
           function(i) {
             yy <-produce_NA(as.matrix(y), perc.missing = 0.2)$data.incomp
             res <-
               softImpute(as.matrix(yy),
                          lambda = grid.lambda1[i], maxit = 1000, rank.max =  )
             u <- res$u
             d <- res$d
             v <- res$v
             if (is.null(dim(u))) {
               res <- d * u %*% t(v)
             } else {
               res <- u %*% diag(d) %*% t(v)
             }
             imp <- as.matrix(yy)
             imp[is.na(yy)] <- res[is.na(yy)]
             return(sqrt(sum((res - y) ^ 2, na.rm = T)))
           })
    
  })
  res.cv <- colMeans(do.call(rbind, res.cv))
  l <- which.min(res.cv)
  lambda <- grid.lambda1[l]
  return(lambda)
}

asd_loose_SDQ_subscale <- asd_loose_SDQ[,c(3:7,9:13,15:19,21:25,27:31,33:37)] 

lambda_sft <- cv_sft(asd_loose_SDQ_subscale)
asd_loose_SDQ_subscale <- as.matrix(asd_loose_SDQ_subscale)
sft <- softImpute(x = asd_loose_SDQ_subscale, lambda = lambda_sft)
train_sft <- sft$u %*% diag(sft$d) %*% t(sft$v)
train_sft[which(!is.na(asd_loose_SDQ_subscale))] <- asd_loose_SDQ_subscale[which(!is.na(asd_loose_SDQ_subscale))]
head(train_sft)
```


##### Run from here

```{r}
library(naniar)
asd_loose_SDQ_subscale <- dplyr::select(asd_loose_SDQ, -contains("BDTOT"))
vis_miss(asd_loose_SDQ)
gg_miss_var(as.data.frame(asd_loose_SDQ_subscale), show_pct = TRUE)
asd_loose_SDQ %>% 
  gg_miss_var(show_pct = TRUE, facet = diag.age)
asd_loose_SDQ %>% 
  gg_miss_var(show_pct = TRUE, facet = sex)

```

# Attach other covs 
```{r}

asd_loose_SDQ_tip <- merge(merge(merge(merge(merge(merge(asd_loose_SDQ,mcs_eth_mad[,c(1,2,6,11)],by = c("MCSID","cmid"),all = T), mcs_asd_dep, by = "MCSID", all = T), mcs_asd_iq, by = "cmid", all = T),mcs_asd_ses, by = "MCSID", all = T) ,mcs_2_5_cog_asd, by = "cmid",all = T),mcs_asd_loose_devmile, by = "cmid", all =T)

asd_loose_SDQ_tip_subscale <- dplyr::select(asd_loose_SDQ_tip, -contains("BDTOT"))
missing_per <- gg_miss_var(as.data.frame(asd_loose_SDQ_tip_subscale), show_pct = TRUE)
missing_per
missing_per_diagage <- gg_miss_var(as.data.frame(asd_loose_SDQ_tip_subscale),facet = diag.age, show_pct = TRUE)
missing_per_diagage
missing_per_diag <- gg_miss_var(as.data.frame(asd_loose_SDQ_tip_subscale),facet = group, show_pct = TRUE)
missing_per_diag
missing_per_sex <- gg_miss_var(as.data.frame(asd_loose_SDQ_tip_subscale),facet = sex, show_pct = TRUE)
missing_per_sex
missing_per_country <- gg_miss_var(as.data.frame(asd_loose_SDQ_tip_subscale),facet = ccountry, show_pct = TRUE)
missing_per_country

```

```{r}

corr_data <- asd_loose_SDQ_tip_subscale[,c(4:33,36:76)]
corr_data <- lapply(corr_data, as.integer)
ordered_factor_cols <- sapply(corr_data, function(x) is.ordered(x) && is.factor(x) && is.character(x))
corr_data[ordered_factor_cols] <- lapply(train[ordered_factor_cols], as.integer)

corrs_raw <- qgraph::cor_auto(corr_data)
#corrs <- caret::findCorrelation(corrs_raw)
# can edit this to filter correlations we prefer
corrs_raw
heatmap <- heatmap(corrs_raw, col = cm.colors(256))
library(ggplot2)
corrs_reshape <- reshape2::melt(corrs_raw)
heatmap2 <- ggplot(data = corrs_reshape, aes(x=Var1, y=Var2, fill=value)) + 
  geom_tile()+  scale_fill_distiller(palette = "RdPu") + theme_classic()
heatmap2
```

# Spliting into training and testing
```{r}
library(nbpMatching)
# create a covariate matrix
set.seed(7878)
covs <- c("cmid","sex","diag.age","eth","mad","ccountry","ACSMIL00","ACGRAB00")
# smile and grab are two developmental milestones that have extremely skewed distributions
covmatrix <- asd_loose_SDQ_tip_subscale[,covs]
cov_complete <- covmatrix %>% na.omit()

# To create non-biparite matching among complete entries
# create distances
com.dist <- gendistance(cov_complete, idcol="cmid")
# create distancematrix object
com.mdm <- distancematrix(com.dist)
# create matches
com.match <- nonbimatch(com.mdm)
# review quality of matches
com.qom <- qom(com.dist$cov, com.match$matches)


# To create matching among entries with NAs but only on sex,diag.age, and ethnicity
covs_simple <- c("cmid","sex","diag.age","eth")
cov_missing <- covmatrix[!complete.cases(covmatrix), covs_simple]
miss.dist <- gendistance(cov_missing, idcol="cmid")
miss.mdm <- distancematrix(miss.dist)
miss.match <- nonbimatch(miss.mdm)
miss.qom <- qom(miss.dist$cov, miss.match$matches)

group1 = c(com.match$halves$Group1.ID, miss.match$halves$Group1.ID)
group2 = c(com.match$halves$Group2.ID, miss.match$halves$Group2.ID)


covmatrix <- covmatrix %>% 
  mutate(match_group = case_when(
    cmid %in% group1 ~ 1,
    cmid %in% group2 ~ 2
  ) 
)

library(tableone)
# to create a big table to check matching qualities 
cat = c("sex", "eth","diag.age", "mad","ccountry") 
tab <- CreateTableOne(vars = cat, data = imp_data, factorVars = cat , strata = "sex", addOverall = T)

table1 <- print(tab, quote = FALSE, noSpaces = TRUE, printToggle = FALSE, missing = T)
table1
```

```{r}
train <- asd_loose_SDQ_tip_subscale[asd_loose_SDQ_tip_subscale$cmid %in% covmatrix$cmid[covmatrix$match_group ==1],]
test <- asd_loose_SDQ_tip_subscale[asd_loose_SDQ_tip_subscale$cmid %in% covmatrix$cmid[covmatrix$match_group ==2],]

```

# Train
```{r}

corr_train <- train[,c(4:34,36:76)] %>% dplyr::select(-c("dep_PC1","IQ_PC1","ses_PC1"))
corr_train <- lapply(corr_train, as.integer)

corrs_train_raw <- qgraph::cor_auto(corr_train)
#corrs <- caret::findCorrelation(corrs_raw)
# can edit this to filter correlations we prefer
corrs_train_raw
heatmap <- heatmap(corrs_train_raw, col = cm.colors(256))
library(ggplot2)
corrs_train_reshape <- reshape2::melt(corrs_train_raw)
heatmap2 <- ggplot(data = corrs_train_reshape, aes(x=Var1, y=Var2, fill=value)) + 
  geom_tile()+  scale_fill_distiller(palette = "RdPu") + theme_classic()
heatmap2

```

# Masking
```{r}
# remove PC1 scores
train_npc <- train[,!names(train) %in% c("MCSID","dep_PC1","IQ_PC1","ses_PC1","group")]

mask <- function(data, id_column, columns_to_mask) {
  # Create a list to store masked datasets for each missingness level
  masked_datasets <- list()
   
    for (missingness_level in c(1, 5, 10, 20, 50)) {
     masked_data <- data
      for (col in columns_to_mask) {
      # Calculate the number of missing values to introduce per individual
      n_missing <- floor(missingness_level / 100 * sum(!is.na(data[, col])))
      
      # Sample indices to mask for each individual
      masked_indices <- sample(which(!is.na(data[,col])), n_missing, replace = F)
      
      # Create a copy of the original dataset and mask the selected indices
      
      masked_data[masked_indices, col] <- NA
      
      # Store the masked dataset in the list
      masked_datasets[[paste0("mis_", missingness_level)]] <- masked_data
    }
   } 
  return(masked_datasets)
}
# Specify the columns to mask
columns_to_mask <- c(3:32,34:71)
set.seed(0408)
# Call the function to introduce missingness
masked_datasets <- mask(data = train_npc, id_column = "cmid", columns_to_mask = columns_to_mask)

# Access the datasets with missingness introduced for each column and missingness level
# For example, access the dataset with missingness introduced to column "column1" at 5% missingness level
train_npc_mis1 <- masked_datasets[["mis_1"]]
train_npc_mis5 <- masked_datasets[["mis_5"]]
train_npc_mis10 <- masked_datasets[["mis_10"]]
train_npc_mis20 <- masked_datasets[["mis_20"]]
train_npc_mis50 <- masked_datasets[["mis_50"]]
```

```{r, echo = T}
# test if the function did the job
mis1_per <- gg_miss_var(as.data.frame(train_npc_mis1), show_pct = TRUE)
mis1_per
mis10_per <- gg_miss_var(as.data.frame(train_npc_mis10), show_pct = TRUE)
mis10_per
mis50_per <- gg_miss_var(as.data.frame(train_npc_mis50), show_pct = TRUE)
mis50_per

```

# Apply different imputations methods on each masked and unmasked training sample





```{r}
#library(softImpute)
#train_npc_sft <- apply(as.matrix(train_npc[-1]) ,2,as.numeric)
#fits = softImpute(train_npc_sft,trace = T)
train_npc_mis1_sft <- apply(as.matrix(train_npc_mis1[-1]) ,2,as.numeric)
percent_of_missing1 <- 1:70
  for (i in percent_of_missing1) {
    percent_of_missing1[i] <- 100 * (sum(is.na(train_npc_mis1_sft[, i])) / nrow(train_npc_mis1_sft))
  }

train_npc_mis5_sft <- apply(as.matrix(train_npc_mis5[-1]) ,2,as.numeric)
percent_of_missing5 <- 1:70
  for (i in percent_of_missing5) {
    percent_of_missing5[i] <- 100 * (sum(is.na(train_npc_mis5_sft[, i])) / nrow(train_npc_mis5_sft))
  }

train_npc_mis10_sft <- apply(as.matrix(train_npc_mis10[-1]) ,2,as.numeric)
percent_of_missing10 <- 1:70
  for (i in percent_of_missing10) {
    percent_of_missing10[i] <- 100 * (sum(is.na(train_npc_mis10_sft[, i])) / nrow(train_npc_mis10_sft))
  }

train_npc_mis20_sft <- apply(as.matrix(train_npc_mis20[-1]) ,2,as.numeric)
percent_of_missing20 <- 1:70
  for (i in percent_of_missing20) {
    percent_of_missing20[i] <- 100 * (sum(is.na(train_npc_mis20_sft[, i])) / nrow(train_npc_mis20_sft))
  }

train_npc_mis50_sft <- apply(as.matrix(train_npc_mis50[-1]) ,2,as.numeric)
percent_of_missing50 <- 1:70
  for (i in percent_of_missing50) {
    percent_of_missing50[i] <- 100 * (sum(is.na(train_npc_mis50_sft[, i])) / nrow(train_npc_mis50_sft))
  }

col_type = c("character","integer","integer","integer","integer","integer","integer","integer","integer","integer","integer","integer","integer","integer","integer","integer","integer","integer","integer","integer","integer","integer","integer","integer","integer","integer","integer","integer","integer","integer","integer","integer","integer","integer","integer","integer","integer","integer","integer","integer","integer","integer","integer","integer","integer","integer","integer","integer","integer","integer","integer","integer","integer","integer","integer","integer","integer","integer","integer","integer","integer","integer","integer","integer","integer","integer","integer","integer","integer","integer")

sft_imp_data1 <- NADIA::autotune_softImpute(train_npc_mis1_sft, percent_of_missing1, col_type)
sft_imp_data5 <- NADIA::autotune_softImpute(train_npc_mis5_sft, percent_of_missing5, col_type)
sft_imp_data10 <- NADIA::autotune_softImpute(train_npc_mis10_sft, percent_of_missing10, col_type)
sft_imp_data20 <- NADIA::autotune_softImpute(train_npc_mis20_sft, percent_of_missing20, col_type)
sft_imp_data50 <- NADIA::autotune_softImpute(train_npc_mis50_sft, percent_of_missing50, col_type)
corrs_imp <- qgraph::cor_auto(sft_imp_data1[2:70])
heatmap(corrs_imp, col = cm.colors(256))
r_squared1<- sapply(1:ncol(train_npc_sft), function(i) summary(lm(sft_imp_data1[, i] ~ train_npc_sft[, i]))$r.squared)
r_squared5<- sapply(1:ncol(train_npc_sft), function(i) summary(lm(sft_imp_data5[, i] ~ train_npc_sft[, i]))$r.squared)
r_squared10<-sapply(1:ncol(train_npc_sft), function(i) summary(lm(sft_imp_data10[, i] ~ train_npc_sft[, i]))$r.squared)
r_squared20<- sapply(1:ncol(train_npc_sft), function(i) summary(lm(sft_imp_data20[, i] ~ train_npc_sft[, i]))$r.squared)
r_squared50<- sapply(1:ncol(train_npc_sft), function(i) summary(lm(sft_imp_data50[, i] ~ train_npc_sft[, i]))$r.squared)
mean(r_squared1)
mean(r_squared5)
mean(r_squared10)
mean(r_squared20)
mean(r_squared50)
#r2 <- cbind(r_squared1,r_squared5,r_squared10,r_squared20,r_squared50)
```

###### FINAL decided on softimpute
```{r}
asd_for_imp <- asd_loose_SDQ_tip_subscale[,!names(asd_loose_SDQ_tip_subscale) %in% c("MCSID","dep_PC1","IQ_PC1","ses_PC1","group")]

asd_npc_mis_sft <- apply(as.matrix(asd_for_imp[-1]) ,2,as.numeric)
percent_of_missing <- 1:70
  for (i in percent_of_missing) {
    percent_of_missing1[i] <- 100 * (sum(is.na(asd_npc_mis_sft[, i])) / nrow(asd_npc_mis_sft))
  }

imp_raw_sft <- softImpute(asd_npc_mis_sft,rank.max=3,lambda=1.9,trace=TRUE,type="svd")
imp_raw_sft_data <- as.data.frame(complete(asd_npc_mis_sft,imp_raw_sft))
imp_data <- NADIA::autotune_softImpute(asd_npc_mis_sft, percent_of_missing, col_type)
imp_data <- cbind(asd_for_imp$cmid,imp_data)
names(imp_data)[1] <- "cmid"


imp_raw_sft_data <- cbind(asd_for_imp$cmid,imp_raw_sft_data)
names(imp_raw_sft_data)[1] <- "cmid"
```





# Test imputation quality
```{r}
# Load necessary library
library(ggplot2)

# Function to plot density curves for original and imputed datasets
plot_density <- function(asd_for_imp, imp_data, variable_name) {
  # Create a ggplot object for the original data
  original_plot <- ggplot(asd_for_imp, aes(x = variable_name, fill = "Original")) +
    geom_density(alpha = 0.5) +
    labs(title = paste("Density Plot of", variable_name),
         fill = "Dataset")

  # Create a ggplot object for the imputed data
  imputed_plot <- ggplot(imp_data, aes(x = variable_name, fill = "Imputed")) +
    geom_density(alpha = 0.5) +
    labs(title = paste("Density Plot of", variable_name),
         fill = "Dataset")

  combined_plot <- original_plot + imputed_plot +
    theme_classic() +
    theme(plot.title = element_text(hjust = 0.5))

  return(combined_plot)
}



plot_density(asd_for_imp, imp_data, "BEMOTION")
# Apply the function to all variables
for (variable_name in names(asd_for_imp)) {
  plots <- plot_density(asd_for_imp, imp_data, variable_name)
  original_plot <- plots[[1]]
  imputed_plot <- plots[[2]]
  
  # Print plots
  print(original_plot)
  print(imputed_plot)
}


```





```{r}
# Initialize a list to store the results
ks_results <- data.frame()

# Select columns from asd_for_imp and imp_data
columns <- names(asd_for_imp)[c(3:32)]

ks_results <- Map(function(x, y) {
  result <- ks.test(x, y)
  c(KS_statistic = result$statistic, p_value = result$p.value)
}, asd_for_imp[columns], imp_data[columns])

# Combine results into a data frame
ks_results_df <- do.call(rbind, ks_results)

# Add column names
rownames(ks_results_df) <- columns
ks_results_df <- as.data.frame(ks_results_df )
# Print the results data frame
print(ks_results_df)


ks_results_cov <- data.frame()

# Select columns from asd_for_imp and imp_data


columns <- names(asd_for_imp)[c(34:71)]
asd_for_imp[columns] <- lapply(asd_for_imp[columns], function(col) as.numeric(as.character(col)))
imp_data[columns] <- lapply(imp_data[columns], function(col) as.numeric(as.character(col)))
ks_results_cov <- Map(function(x, y) {
  result <- ks.test(x, y)
  c(KS_statistic = result$statistic, p_value = result$p.value)
}, asd_for_imp[columns], imp_data[columns])

# Combine results into a data frame
ks_cov_results_df <- do.call(rbind, ks_results_cov)

# Add column names
rownames(ks_cov_results_df) <- columns

# Print the results data frame
print(ks_cov_results_df)
```
# median imputation
```{r}
asd_for_imp[2:71] <- lapply(asd_for_imp[2:71], as.integer)
median_raw <- impute_median(asd_for_imp ,type = "columnwise")
median_raw
median_raw$data <- "median"
median_imp_data <- median_raw %>% mutate_at(2:71, as.numeric)

```



```{r}
asd_for_imp$data <- "Original"
imp_raw_sft_data$data <- "Imputed"

data_plot <- rbind(asd_for_imp,imp_raw_sft_data)
data_plot_median <- rbind(asd_for_imp,median_imp_data)
data_plot$sex <- as.character(data_plot$sex)
data_plot_median$sex <- as.character(data_plot_median$sex)

data_plot[3:71] <- lapply(data_plot[3:71],as.integer)
p1 <- ggplot(data = data_plot, aes(x=BEMOTION, linetype = data)) +theme(legend.title=element_blank())+theme(legend.position = "bottom") +scale_linetype_manual(values = c("original" = "solid","imputed" = "dashed"))+
  geom_density(alpha=.5) +
  labs(x="Emotion")
p1
data_plot_median[3:71] <- lapply(data_plot_median[3:71],as.integer)



density_comp <- function(data, variable_names) {
  # Create an empty list to store individual plots
  plots_list <- list()
  
  # Generate density plots for each variable
  for (variable_name in variable_names) {
    plot <- suppressWarnings(
    ggplot(data, aes_string(x = variable_name, linetype = "data", na.rm = T)) +
      geom_density(alpha = 0.1) +
      scale_linetype_manual(values = c("original" = "solid", "imputed" = "dashed"), guide = "none") + 
      labs(x = variable_name, y = "")) + theme_classic()
    
    plots_list[[variable_name]] <- plot
  }
  
  # Combine individual plots into one big plot using cowplot
  combined_plot <- cowplot::plot_grid(plotlist = plots_list, ncol = 5)
  legend <- get_legend(p1) # Extract legend from any of the plots
  combined_plot_with_legend <- cowplot::plot_grid(combined_plot, legend, ncol = 1,rel_heights = c(5, 0.5))
  
  return(combined_plot_with_legend)
}

# Example usage: Plot density curves for multiple variables
variable_names <- names(data_plot)[3:32]
comp_subscale <- suppressWarnings(density_comp(data_plot, variable_names))
print(comp_subscale)
comp_subscale_median <- suppressWarnings(density_comp(data_plot_median, variable_names))
print(comp_subscale_median)


names(data_plot)[34:71] <- c("eth","mad","country","dep_overall","dep_income",       "dep_employment", "dep_healthdisability", "dep_eduskilltrain","OECD","employment_status","OECD_60bar","housing_tenure","Bschool_readiness","Bnaming_vocab","Cnaming_vocab","Cpattern_constr","Cpic_sim","Dpattern_constr","Dword_read","Dmaths","ECANTAB","smile","sitsup","stands","hand","grab","hold","pass","playground","givetoy","wavebye","arm","nodyes","move","dry","clean","drawsquare","dress")
cov_variable_names <- names(data_plot)[34:71]
comp_covs <- suppressWarnings(density_comp(data_plot, cov_variable_names))
print(comp_covs)
```
```{r}
# Initialize a list to store the results
ks_results_median <- data.frame()

# Select columns from asd_for_imp and imp_data
columns <- names(asd_for_imp)[c(3:32)]

ks_results_median <- Map(function(x, y) {
  result <- ks.test(x, y)
  c(KS_statistic = result$statistic, p_value = result$p.value)
}, asd_for_imp[columns], median_imp_data[columns])

# Combine results into a data frame
ks_results_median_df <- do.call(rbind, ks_results_median)

# Add column names
rownames(ks_results_median_df) <- columns
ks_results_median_df <- as.data.frame(ks_results_median_df )
# Print the results data frame
print(ks_results_df)
```
```{r}
# Display the combined plot
pdf("comp_density_sub.pdf",width = 20,height = 15)
print(comp_subscale)
dev.off()
```
```{r}
pdf("comp_density_covs.pdf",width = 20,height = 15)
print(comp_covs)
dev.off()
```

```{r}
correlation_results1 <- psych::corr.test(train_npc_sft, sft_imp_data1)
correlation_matrix1 <- correlation_results1$r
heatmap(correlation_matrix1)
correlation_results5 <- psych::corr.test(train_npc_sft, sft_imp_data5)
correlation_matrix5 <- correlation_results5$r
heatmap(correlation_matrix5)
correlation_results10 <- psych::corr.test(train_npc_sft, sft_imp_data10)
correlation_matrix10 <- correlation_results10$r
heatmap(correlation_matrix10)
correlation_results20 <- psych::corr.test(train_npc_sft, sft_imp_data20)
correlation_matrix20 <- correlation_results20$r
heatmap(correlation_matrix20)
correlation_results50 <- psych::corr.test(train_npc_sft, sft_imp_data50)
correlation_matrix50 <- correlation_results50$r
heatmap(correlation_matrix50)
```


```{r}
library(missMethods)

train_median1 <- impute_median(train_npc_mis1_sft,type = "columnwise")
train_median5 <- impute_median(train_npc_mis5_sft,type = "columnwise")
train_median10 <- impute_median(train_npc_mis10_sft,type = "columnwise")
train_median20 <- impute_median(train_npc_mis20_sft,type = "columnwise")
train_median50 <- impute_median(train_npc_mis50_sft,type = "columnwise")
median_r_squared1<- sapply(1:ncol(train_npc_sft), function(i) summary(lm(train_median1[, i] ~ train_npc_sft[, i]))$r.squared)
median_r_squared5<- sapply(1:ncol(train_npc_sft), function(i) summary(lm(train_median5[, i] ~ train_npc_sft[, i]))$r.squared)
median_r_squared10<-sapply(1:ncol(train_npc_sft), function(i) summary(lm(train_median10[, i] ~ train_npc_sft[, i]))$r.squared)
median_r_squared20<- sapply(1:ncol(train_npc_sft), function(i) summary(lm(train_median20[, i] ~ train_npc_sft[, i]))$r.squared)
median_r_squared50<- sapply(1:ncol(train_npc_sft), function(i) summary(lm(train_median50[, i] ~ train_npc_sft[, i]))$r.squared)
median(median_r_squared1)
median(median_r_squared5)
median(median_r_squared10)
median(median_r_squared20)
median(median_r_squared50)
```

# reshape data for longitudinal imputation
```{r}
library(reshape2)
train_emo <- train_npc[,c("cmid","BEMOTION","CEMOTION","DDEMOTION","EEMOTION","FEMOTION","GEMOTION")]
train_emo_long <- melt(setDT(train_emo), id.vars = "cmid", variable.name = "sweep")
train_emo_long <- train_emo_long %>%
  mutate(Sweep = case_when(
    sweep == "BEMOTION" ~ 2,
    sweep == "CEMOTION" ~ 3,
    sweep == "DDEMOTION" ~ 4,
    sweep == "EEMOTION" ~ 5,
    sweep == "FEMOTION" ~ 6,
    sweep == "GEMOTION" ~ 7)
    ) %>% select(-sweep)
colnames(train_emo_long)[which(colnames(train_emo_long) == "value")] <- "EMOTION"

train_con <- train_npc[,c("cmid","BCONDUCT","CCONDUCT","DDCONDUCT","ECONDUCT","FCONDUCT","GCONDUCT")]
train_con_long <- melt(setDT(train_con), id.vars = "cmid", variable.name = "sweep")
train_con_long <- train_con_long %>%
  mutate(Sweep = case_when(
    sweep == "BCONDUCT" ~ 2,
    sweep == "CCONDUCT" ~ 3,
    sweep == "DDCONDUCT" ~ 4,
    sweep == "ECONDUCT" ~ 5,
    sweep == "FCONDUCT" ~ 6,
    sweep == "GCONDUCT" ~ 7)
    )%>% select(-sweep)
colnames(train_con_long)[which(colnames(train_con_long) == "value")] <- "CONDUCT"

train_hyper <- train_npc[,c("cmid","BHYPER","CHYPER","DDHYPER","EHYPER","FHYPER","GHYPER")]
train_hyper_long <- melt(setDT(train_hyper), id.vars = "cmid", variable.name = "sweep")
train_hyper_long <- train_hyper_long %>%
  mutate(Sweep = case_when(
    sweep == "BHYPER" ~ 2,
    sweep == "CHYPER" ~ 3,
    sweep == "DDHYPER" ~ 4,
    sweep == "EHYPER" ~ 5,
    sweep == "FHYPER" ~ 6,
    sweep == "GHYPER" ~ 7)
    )%>% select(-sweep)
colnames(train_hyper_long)[which(colnames(train_hyper_long) == "value")] <- "HYPER"

train_peer <- train_npc[,c("cmid","BPEER","CPEER","DDPEER","EPEER","FPEER","GPEER")]
train_peer_long <- melt(setDT(train_peer), id.vars = "cmid", variable.name = "sweep")
train_peer_long <- train_peer_long %>%
  mutate(Sweep = case_when(
    sweep == "BPEER" ~ 2,
    sweep == "CPEER" ~ 3,
    sweep == "DDPEER" ~ 4,
    sweep == "EPEER" ~ 5,
    sweep == "FPEER" ~ 6,
    sweep == "GPEER" ~ 7)
    )%>% select(-sweep)
colnames(train_peer_long)[which(colnames(train_peer_long) == "value")] <- "PEER"

train_pro <- train_npc[,c("cmid","BPROSOC","CPROSOC","DDPROSOC","EPROSOC","FPROSOC","GPROSOC")]
train_pro_long <- melt(setDT(train_pro), id.vars = "cmid", variable.name = "sweep")
train_pro_long <- train_pro_long %>%
  mutate(Sweep = case_when(
    sweep == "BPROSOC" ~ 2,
    sweep == "CPROSOC" ~ 3,
    sweep == "DDPROSOC" ~ 4,
    sweep == "EPROSOC" ~ 5,
    sweep == "FPROSOC" ~ 6,
    sweep == "GPROSOC" ~ 7)
    )%>% select(-sweep)
colnames(train_pro_long)[which(colnames(train_pro_long) == "value")] <- "PROSOC"

```


```{r}
subscale_list <- list(train_emo_long,train_con_long,train_hyper_long,train_peer_long,train_pro_long)
merge_dfs <- function(list_of_dfs, merge_by_cols) {
  Reduce(function(x, y) merge(x, y, by = merge_by_cols, all = TRUE), list_of_dfs)
}
merge_by_cols <- c("cmid","Sweep")
train_npc_subscale_long <- merge_dfs(subscale_list,merge_by_cols)

subscale <- c("EMOTION","CONDUCT","HYPER","PEER","PROSOC")
cov_to_keep <- names(train_npc)[!grepl(paste(subscale, collapse = "|"), names(train_npc))]
train_npc_covs <- train_npc %>% dplyr::select(all_of(cov_to_keep))
train_npc_long <- merge(train_npc_subscale_long, train_npc_covs, by = "cmid", all = TRUE)
```


```{r}
library(naniar)
naniar::gg_miss_upset(train_npc_long)
naniar::gg_miss_upset(train_npc_subscale_long, nintersects = NA)
naniar::gg_miss_upset(train_npc[3:34],nintersects = NA)
n_var_miss(train_npc[,3:34])
subscale_missing <-gg_miss_upset(train_npc[,3:34],nsets =n_var_miss(train_npc[3:34]))
```
```{r}
pdf("/Users/zhangxinhe/Documents/who recieves a diagnosis/MCS/asd_longitudinal_missing.pdf")
print(subscale_missing)
dev.off()
```

```{r}
subscales <- names(train_npc_long)[grepl(paste(subscale, collapse = "|"), names(train_npc_long))]
covs <- cov_to_keep[-1]

par(mfrow=c(2,3))
#for(i in covs){hist(train_npc_long[,i],xlab=i,main="")}
for(i in subscales){hist(train_npc_long[,i],xlab=i,main="")}

```

```{r}
library(lme4)
emo_fit <- lmer(EMOTION ~ Sweep+sex+diag.age+eth+mad+ccountry+Overall+Income+          
Employment+HealthDisability+EduSkillTrain+BOECDSC0+       
BDCWRK00+BDOEDP00+BDROOW00+BDSRCS00+ BDBASA00+CCNVABIL+CCPCABIL+CCPSABIL+  DCPCAB00+DCWRAB00+DCMATHS7SA+ECDTOT00+   ACSMIL00+ACSITU00+ACSTAN00+ACHAND00+ACGRAB00+ACPICK00+ACPTOY00+ACWALK00+ACGIVE00+ACWAVE00+ACARMS00+ACNODS00+ ACMOVE00+BPDRDA00+BPCLDA00+CPSQCO00+ CPDRSS00+ (Sweep|cmid),data = train_npc_long)       

con_fit <- lmer(CONDUCT ~ Sweep+sex+diag.age+eth+mad+ccountry+Overall+Income+          
Employment+HealthDisability+EduSkillTrain+BOECDSC0+       
BDCWRK00+BDOEDP00+BDROOW00+BDSRCS00+ BDBASA00+CCNVABIL+CCPCABIL+CCPSABIL+  DCPCAB00+DCWRAB00+DCMATHS7SA+ECDTOT00+   ACSMIL00+ACSITU00+ACSTAN00+ACHAND00+ACGRAB00+ACPICK00+ACPTOY00+ACWALK00+ACGIVE00+ACWAVE00+ACARMS00+ACNODS00+ ACMOVE00+BPDRDA00+BPCLDA00+CPSQCO00+ CPDRSS00+ (Sweep|cmid),data = train_npc_long)  

hyp_fit <- lmer(HYPER ~ Sweep+sex+diag.age+eth+mad+ccountry+Overall+Income+     
Employment+HealthDisability+EduSkillTrain+BOECDSC0+       
BDCWRK00+BDOEDP00+BDROOW00+BDSRCS00+ BDBASA00+CCNVABIL+CCPCABIL+CCPSABIL+  DCPCAB00+DCWRAB00+DCMATHS7SA+ECDTOT00+   ACSMIL00+ACSITU00+ACSTAN00+ACHAND00+ACGRAB00+ACPICK00+ACPTOY00+ACWALK00+ACGIVE00+ACWAVE00+ACARMS00+ACNODS00+ ACMOVE00+BPDRDA00+BPCLDA00+CPSQCO00+ CPDRSS00+ (Sweep|cmid),data = train_npc_long)   

peer_fit <- lmer(PEER ~ Sweep+sex+diag.age+eth+mad+ccountry+Overall+Income+          
Employment+HealthDisability+EduSkillTrain+BOECDSC0+       
BDCWRK00+BDOEDP00+BDROOW00+BDSRCS00+ BDBASA00+CCNVABIL+CCPCABIL+CCPSABIL+  DCPCAB00+DCWRAB00+DCMATHS7SA+ECDTOT00+   ACSMIL00+ACSITU00+ACSTAN00+ACHAND00+ACGRAB00+ACPICK00+ACPTOY00+ACWALK00+ACGIVE00+ACWAVE00+ACARMS00+ACNODS00+ ACMOVE00+BPDRDA00+BPCLDA00+CPSQCO00+ CPDRSS00+ (Sweep|cmid),data = train_npc_long)   

pro_fit <- lmer(PROSOC ~ Sweep+sex+diag.age+eth+mad+ccountry+Overall+Income+          
Employment+HealthDisability+EduSkillTrain+BOECDSC0+       
BDCWRK00+BDOEDP00+BDROOW00+BDSRCS00+ BDBASA00+CCNVABIL+CCPCABIL+CCPSABIL+  DCPCAB00+DCWRAB00+DCMATHS7SA+ECDTOT00+   ACSMIL00+ACSITU00+ACSTAN00+ACHAND00+ACGRAB00+ACPICK00+ACPTOY00+ACWALK00+ACGIVE00+ACWAVE00+ACARMS00+ACNODS00+ ACMOVE00+BPDRDA00+BPCLDA00+CPSQCO00+ CPDRSS00+ (Sweep|cmid),data = train_npc_long)   

r_emo <- ranef(emo_fit)$cmid
names(r_emo) <- paste0("r_emo", 1:2)
r_con <- ranef(con_fit)$cmid
names(r_con) <- paste0("r_con", 1:2)
r_hyp <- ranef(hyp_fit)$cmid
names(r_hyp) <- paste0("r_hyp", 1:2)
r_peer <- ranef(peer_fit)$cmid
names(r_peer) <- paste0("r_peer", 1:2)
r_pro <- ranef(pro_fit)$cmid
names(r_pro) <- paste0("r_pro", 1:2)



```
```{r}

mice_1 <- mice(train_npc_long,method = "rf")
mod_mice <- with(mice_1,lmer(EMOTION ~ Sweep+sex+diag.age+eth+mad+ccountry+Overall+Income+          
Employment+HealthDisability+EduSkillTrain+BOECDSC0+       
BDCWRK00+BDOEDP00+BDROOW00+BDSRCS00+ BDBASA00+CCNVABIL+CCPCABIL+CCPSABIL+  DCPCAB00+DCWRAB00+DCMATHS7SA+ECDTOT00+   ACSMIL00+ACSITU00+ACSTAN00+ACHAND00+ACGRAB00+ACPICK00+ACPTOY00+ACWALK00+ACGIVE00+ACWAVE00+ACARMS00+ACNODS00+ ACMOVE00+BPDRDA00+BPCLDA00+CPSQCO00+ CPDRSS00+ (Sweep|cmid)))
library(broom.mixed)
summary(pool(mod_mice), conf.int = TRUE)

```



```{r}
{
  raw_data <- asd_loose_SDQ_subscale

  col_type <- 1:ncol(raw_data)
  for (i in col_type) {
    col_type[i] <- class(raw_data[, i])
  }

  percent_of_missing <- 1:ncol(raw_data)
  for (i in percent_of_missing) {
    percent_of_missing[i] <- 100 * (sum(is.na(raw_data[, i])) / nrow(raw_data))
  }
  col_no_miss <- colnames(raw_data)[percent_of_missing == 0]
  col_miss <- colnames(raw_data)[percent_of_missing > 0]
  mice_imp_data <- NADIA::autotune_mice(raw_data, optimize = FALSE, iter = 2,
   col_type = col_type, percent_of_missing = percent_of_missing,
   col_no_miss = col_no_miss, col_miss = col_miss)

  # Check if all missing value was imputed
  sum(is.na(mice_imp_data)) == 0
  # TRUE
}

```

```{r}
#source_url('https://raw.githubusercontent.com/R-miss-tastic/website/master/static/how-to/generate/amputation.R')

MSE <- function(X, Xtrue, mask) {
  return(sqrt(sum((as.matrix(X) * mask - as.matrix(Xtrue) * mask) ^ 2) / sum(mask)))
}

HowToImpute <- function(X , perc.list , mecha.list , nbsim){
  
  perc_mecha.matrix <- matrix(perc.list, nrow = length(mecha.list) * length(perc.list), ncol = 2)
  perc_mecha.matrix[, 2] <- as.vector(sapply(mecha.list, rep, length(perc.list)))
  results.all <- apply(perc_mecha.matrix, 1, function(perc_mecha) { 
    
    perc <- as.numeric(perc_mecha[1])
    mecha <- perc_mecha[2]
    
    results.couple <- lapply(1:nbsim, function(iter){
      XproduceNA <- produce_NA(as.matrix(X), mechanism = mecha, perc.missing = perc)
      
      XNA <- as.matrix(as.data.frame(XproduceNA$data.incomp))
      
      ## Mean
      X.mean <- imputeMean(XNA)
      
      ## MICE
      temp <- mice(XNA, printFlag = FALSE, method = "pmm", remove.collinear = FALSE) # for the predictive mean matching method
      IMP <- 0
      for (i in 1:5) { IMP <- IMP + mice::complete(temp, i)}
      X.mice  <-  IMP/5  #5 is the default number of multiple imputations
      
      ## PCA
      ncp.pca <- estim_ncpPCA(XNA)$ncp
      pca <- imputePCA(XNA, ncp = ncp.pca)
      X.pca <- pca$comp
      
      ## SoftImpute
      lambda_sft <- cv_sft(XNA)
      sft <- softImpute(x = XNA, lambda = lambda_sft, rank.max = min(10,ncol(XNA)-1))
      X.sft <- sft$u %*% diag(sft$d) %*% t(sft$v)
      X.sft[which(!is.na(XNA))] <- XNA[which(!is.na(XNA))]
      
      ## RandomForest
      forest <- missForest(XNA, verbose = FALSE)
      X.forest<- forest$ximp
      
      
      mse <- sapply(list( X.pca, X.forest,  X.mice, X.sft,  X.mean), MSE, Xtrue = as.data.frame(X), mask = is.na(XNA))
      
      cbind.data.frame(mse)
      
    })
    
    results <- Reduce("+", results.couple) / length(results.couple)
    rownames(results) <- c("X.pca", "X.forest",  "X.mice", "X.soft", "X.mean")
    return(results)
  })
  names(results.all) <- paste0(perc_mecha.matrix[,1], " ", perc_mecha.matrix[,2])
  
  resdf <- as.data.frame(results.all)
  colnames(resdf) <- paste0(perc_mecha.matrix[,1], " ", perc_mecha.matrix[,2])
  
  return(resdf)
}
```

```{r}

HowToImpute_real <- function(datasets_list, perc , mecha , nbsim, names_dataset){
  plotdf_fin <- NULL
  for (dat in 1:length(datasets_list)){
      res = HowToImpute(datasets_list[[dat]],perc,mecha,nbsim)
      names(res) = names_dataset[[dat]]
      if (dat==1){
        resdf = res
      }else{
        resdf = cbind.data.frame(resdf,res)
      }
      plotdf <- do.call(c,res)
      plotdf <- as.data.frame(plotdf)
      names(plotdf) <- 'mse'
      Methods <- rep(c("PCA", "RandomForest",  "Mice", "SoftImpute",  "Mean"))
      plotdf <- cbind(plotdf, Methods)
      Datasets <- rep(names_dataset[dat],5)
      plotdf <- cbind(plotdf, Datasets)
      if (is.null(plotdf_fin)){
        plotdf_fin <- plotdf
      }else{
        plotdf_fin <- rbind(plotdf_fin,plotdf)
      }
  }
  return(list(plot=plotdf_fin,res=resdf))
}


```


```{r}
library(mice)
library(missMDA)
library(softImpute)
library(missForest)
asd_loose_SDQ_complete_subscale <- dplyr::select(asd_loose_SDQ_complete, - contains("TOT"))
datasets_list <- list(asd_loose_SDQ_complete_subscale[,4:33])
names_dataset <- c("asd_complete_subscale")
howimp_real <-  HowToImpute_real(
                  datasets_list = datasets_list,
                  perc = 0.2,
                  mech = "MCAR",
                  nbsim = 2, names_dataset = names_dataset
                  )
                
plotdf_fin <- howimp_real$plot
res <- howimp_real$res
plotdf_fin
res
ggplot(data=plotdf_fin, aes(x =Datasets, y = mse, fill=Methods)) + geom_bar(stat="identity", position=position_dodge2(width = 1.01,preserve = "single"))


MCS_no_diag <- read.csv("/Users/zhangxinhe/Documents/who recieves a diagnosis/MCS/MCS_SDQ_control.csv") # 6047 in total
MCS_no_diag$sex_num <- ifelse(MCS_no_diag$Sex == "Male", 1,2)
MCS_no_diag$grp <- "no_diag"
MCS_no_diag$grp_num <- 3
#MCS_sdq_no_diag <- MCS_no_diag[,c(1:21,34:39,22:33,40:45)]
mcs_no_diag_subscales<- dplyr::select(MCS_no_diag, -contains("TOT"))

datasets_list <- list(asd_loose_SDQ_complete_subscale[,4:33], mcs_no_diag_subscales[,4:33])
names_dataset <- c("asd_complete_subscale","no_diagnosis_subscale")
howimp_real <-  HowToImpute_real(
                  datasets_list = datasets_list,
                  perc = 0.2,
                  mech = "MCAR",
                  nbsim = 2, names_dataset = names_dataset
                  )
                
plotdf_fin <- howimp_real$plot
res <- howimp_real$res
plotdf_fin
res
library(viridis)
ggplot(data=plotdf_fin, aes(x =Datasets, y = mse, fill=Methods)) + geom_bar(stat="identity", position=position_dodge2(width = 1.01,preserve = "single"))+ scale_color_viridis(discrete = TRUE, option = "D")+
  scale_fill_viridis(discrete = TRUE) 

```


# View the missing pattern using MICE package functions
```{r}


md <- md.pattern(asd_loose_SDQ_tip)
sum(md)
```


##### MICE


```{r}
imp <- mice(asd_loose_SDQ_tip,method = "rf")
attributes(imp)
imp$imp
imp$nmis
imp_data <- mice::complete(imp,"broad")
fx <- fluxplot(asd_loose_SDQ_tip)
fx
imp$method
plot(imp)



imp_seed <- mice(asd_loose_SDQ_subscale,seed = 123,maxit = 40, print = F)
plot(imp_seed)
```

## LGCM
```{r}
soft_imp_data <- cbind(asd_loose_SDQ[c(1:3,40,41)], sft_imp_data)
soft_imp_data <- soft_imp_data %>% dplyr::mutate(dplyr::select(.,BEBDTOT = rowSums(BEMOTION, BCONDUCT,BHYPER,BPEER)), CEBDTOT = rowSums(CEMOTION,CCONDUCT,CHYPER,CPEER), DDDEBDTOT = rowSums(DDEMOTION,DDCONDUCT,DDHYPER,DDPEER), EEBDTOT = rowSums(EEMOTION,ECONDUCT,EHYPER,EPEER), FEBDTOT = rowSums(FEMOTION,FCONDUCT,FHYPER,FPEER), GEBDTOT = rowSums(GEMOTION,GCONDUCT,GHYPER,GPEEER))
mcs_imp_agestr_ttl <- "
int =~ 1*BEBDTOT + 1*CEBDTOT + 1*DDDEBDTOT + 1*EEBDTOT + 1*FEBDTOT + 1*GEBDTOT
slp =~ 3*BEBDTOT + 5*CEBDTOT + 7*DDDEBDTOT + 11*EEBDTOT + 14*FEBDTOT + 17*GEBDTOT

# the parametres for slope reflect the designed ages at corresponding sweeps
"


fit_mcs_imp_agestr_ttl <- growth(mcs_imp_agestr_ttl, data = asd_imp_SDQ, group = "group", missing = "fiml", estimator = "ml", fixed.x = F)
fit_mcs_imp_agestr_ttl_r <- growth(mcs_imp_agestr_ttl, data = asd_imp_SDQ, group = "group", missing = "fiml", estimator = "mlr", fixed.x = F)

summary(fit_mcs_imp_agestr_ttl)
summary(fit_mcs_imp_agestr_ttl_r)

```
```{r}

mcs_loose_agestr_ttl_adj_2 <- "
int =~ 1*BEBDTOT + 1*CEBDTOT + 1*DDDEBDTOT + 1*EEBDTOT + 1*FEBDTOT + 1*GEBDTOT
slp =~ 3*BEBDTOT + 5*CEBDTOT + 7*DDDEBDTOT + 11*EEBDTOT + 14*FEBDTOT + 17*GEBDTOT
qua =~ 9*BEBDTOT + 25*CEBDTOT + 49*DDDEBDTOT + 121*EEBDTOT + 196*FEBDTOT + 289*GEBDTOT
# GEBDTOT ~~ 1*GEBDTOT
# the parametres for slope reflect the designed ages at corresponding sweeps
"

fit_mcs_loose_agestr_ttl_adj_2 <- growth(mcs_loose_agestr_ttl_adj_2, data = asd_loose_SDQ, group = "group", missing = "fiml", estimator = "ml", fixed.x = F)
summary(fit_mcs_loose_agestr_ttl_adj_2)
# removed group = "grp_num" , 
```

## cubic 

```{r}
mcs_loose_agestr_ttl_adj_3 <- "
int =~ 1*BEBDTOT + 1*CEBDTOT + 1*DDDEBDTOT + 1*EEBDTOT + 1*FEBDTOT + 1*GEBDTOT
slp =~ .3*BEBDTOT + .5*CEBDTOT + .7*DDDEBDTOT + 1.1*EEBDTOT + 1.4*FEBDTOT + 1.7*GEBDTOT
qua =~ .09*BEBDTOT + .25*CEBDTOT + .49*DDDEBDTOT + 1.21*EEBDTOT + 1.96*FEBDTOT + 2.89*GEBDTOT
cub =~ .027*BEBDTOT + .125*CEBDTOT + .343*DDDEBDTOT + 1.331*EEBDTOT + 2.744*FEBDTOT + 4.913*GEBDTOT
# the parametres for slope reflect the designed ages at corresponding sweeps
"


fit_mcs_loose_agestr_ttl_adj_3 <- growth(mcs_loose_agestr_ttl_adj_3, data = asd_loose_SDQ, group = "group", missing = "fiml", estimator = "ml", fixed.x = F)
summary(fit_mcs_loose_agestr_ttl_adj_2)

```
```{r}
fitMeasures(mcs_ttl_fit_adj,c("rmsea","chisq","pvalue","cfi","tli","aic","bic"))
fitMeasures(mcs_agestr_ttl_fit_adj,c("rmsea","chisq","pvalue","cfi","tli","aic","bic"))
fitMeasures(mcs_agestr_ttl_fit_adj_2, c("rmsea","chisq","pvalue","cfi","tli","aic","bic"))
fitMeasures(mcs_agestr_ttl_fit_adj_3, c("rmsea","chisq","pvalue","cfi","tli","aic","bic"))

```

```{r}
fitMeasures(fit_mcs_loose_agestr_ttl_adj,c("rmsea","chisq","pvalue","cfi","tli","aic","bic"))
fitMeasures(fit_mcs_loose_agestr_ttl_adj_2, c("rmsea","chisq","pvalue","cfi","tli","aic","bic"))
fitMeasures(fit_mcs_loose_agestr_ttl_adj_3, c("rmsea","chisq","pvalue","cfi","tli","aic","bic"))
```



```{r}
# Early 
mcs_asd_loose_early <- asd_loose_SDQ[asd_loose_SDQ$group == "Early",]
mcs_asd_loose_late <- asd_loose_SDQ[asd_loose_SDQ$group == "Late",]
mcs_asd_loose_early_ttl <- mcs_asd_loose_early[,c(2,3,9,15,21,27,33,39)]

mcs_asd_loose_early_ttl_long <- melt(setDT(mcs_asd_loose_early_ttl), id.vars = c("cmid","sex"), variable.name = "sweep")

mcs_asd_loose_early_ttl_summary <- mcs_asd_loose_early_ttl_long %>%
  dplyr::group_by(sweep) %>%
  dplyr::summarise(
    sd = sd(value, na.rm = TRUE),
    ttl_mean = mean(value, na.rm = TRUE)
  )
mcs_asd_loose_early_ttl_summary$group <- "early"

# Late

mcs_asd_loose_late_ttl <- mcs_asd_loose_late[,c(2,3,9,15,21,27,33,39)]

mcs_asd_loose_late_ttl_long <- melt(setDT(mcs_asd_loose_late_ttl), id.vars = c("cmid","sex"), variable.name = "sweep")

mcs_asd_loose_late_ttl_summary <- mcs_asd_loose_late_ttl_long %>%
   dplyr::group_by(sweep) %>%
   dplyr::summarise(
    sd = sd(value, na.rm = TRUE),
    ttl_mean = mean(value, na.rm = TRUE)
  )
mcs_asd_loose_late_ttl_summary$group <- "late"

# No diagnosis
MCS_no_diag <- read.csv("/Users/zhangxinhe/Documents/who recieves a diagnosis/MCS/MCS_SDQ_control.csv") # 6047 in total
MCS_no_diag$sex_num <- ifelse(MCS_no_diag$Sex == "Male", 1,2)
MCS_no_diag$grp <- "no_diag"
MCS_no_diag$grp_num <- 3
MCS_sdq_no_diag <- MCS_no_diag[,c(1:21,34:39,22:33,40:45)]
MCS_no_diag_sdq_ttl <- MCS_sdq_no_diag[,c(1,9,15,21,27,33,39,42)]

MCS_no_diag_sdq_ttl_long <- melt(setDT(MCS_no_diag_sdq_ttl), id.vars = c("MCSID","Sex"), variable.name = "sweep")

MCS_no_diag_ttl_summary <- MCS_no_diag_sdq_ttl_long %>%
   dplyr::group_by(sweep) %>%
   dplyr::summarise(
    sd = sd(value),
    ttl_mean = mean(value)
  )
MCS_no_diag_ttl_summary$group <- "no_diag"
```
```{r}
mcs_asd_loose_early_ttl_summary$lb = mcs_asd_loose_early_ttl_summary$ttl_mean - mcs_asd_loose_early_ttl_summary$sd
mcs_asd_loose_early_ttl_summary$ub = mcs_asd_loose_early_ttl_summary$ttl_mean + mcs_asd_loose_early_ttl_summary$sd
mcs_asd_loose_late_ttl_summary$lb = mcs_asd_loose_late_ttl_summary$ttl_mean - mcs_asd_loose_late_ttl_summary$sd
mcs_asd_loose_late_ttl_summary$ub = mcs_asd_loose_late_ttl_summary$ttl_mean + mcs_asd_loose_late_ttl_summary$sd

mcs_loose_sdq_total_mean_full <- full_join(mcs_asd_loose_early_ttl_summary, mcs_asd_loose_late_ttl_summary)
mcs_loose_sdq_total_mean_full <- mcs_loose_sdq_total_mean_full %>% dplyr::mutate(sweep.age = case_when(
  sweep == "BEBDTOT" ~ 3,
  sweep == "CEBDTOT" ~ 5,
  sweep == "DDDEBDTOT" ~ 7,
   sweep == "EEBDTOT" ~ 11,
   sweep == "FEBDTOT" ~ 14,
   sweep == "GEBDTOT" ~ 17,
))

```


```{r}
pred_lgm_qua_early_loose <- as.data.frame(predict(fit_mcs_loose_agestr_ttl_adj_2)$"Early")

pred_lgm_qua_late_loose <- as.data.frame(predict(fit_mcs_loose_agestr_ttl_adj_2)$"Late")


pred_lgm_long_qua_early_loose <- map(c(3,5,7,11,14,17), # loop over time
                     function(x) pred_lgm_qua_early_loose[, 1] + x * pred_lgm_qua_early_loose[, 2] + x^2 * pred_lgm_qua_early_loose[,3]) %>% 
  reduce(cbind) %>% # bring together the wave predictions 
  as.data.frame() %>% # make data frame
  setNames(c(3,5,7,11,14,17)) %>% # give names to variables
  dplyr::mutate(id = row_number()) %>% # make unique id
  gather(-id, key = Sweep, value = pred) %>% dplyr::mutate(group = "early")

pred_lgm_long_qua_late_loose <- map(c(3,5,7,11,14,17), # loop over time
                     function(x) pred_lgm_qua_late_loose[, 1] + x * pred_lgm_qua_late_loose[, 2] + x^2 * pred_lgm_qua_late_loose[,3]) %>% 
  reduce(cbind) %>% # bring together the wave predictions 
  as.data.frame() %>% # make data frame
  setNames(c(3,5,7,11,14,17)) %>% # give names to variables
  dplyr::mutate(id = row_number()) %>% # make unique id
  gather(-id, key = Sweep, value = pred) %>% dplyr::mutate(group = "late")


## load the linear coefficients
pred_lgm_lin_early_loose <- as.data.frame(predict(fit_mcs_loose_agestr_ttl)$"Early")
pred_lgm_lin_late_loose <- as.data.frame(predict(fit_mcs_loose_agestr_ttl)$"Late")

pred_lgm_long_lin_early_loose <- map(c(3,5,7,11,14,17), # loop over time
                     function(x) pred_lgm_lin_early_loose[, 1] + x * pred_lgm_lin_early_loose[, 2] ) %>% 
  reduce(cbind) %>% # bring together the wave predictions 
  as.data.frame() %>% # make data frame
  setNames(c(3,5,7,11,14,17)) %>% # give names to variables
  dplyr::mutate(id = row_number()) %>% # make unique id
  gather(-id, key = Sweep, value = pred) %>% dplyr::mutate(group = "early")

pred_lgm_long_lin_late_loose <- map(c(3,5,7,11,14,17), # loop over time
                     function(x) pred_lgm_lin_late_loose[, 1] + x * pred_lgm_lin_late_loose[, 2]) %>% 
  reduce(cbind) %>% # bring together the wave predictions 
  as.data.frame() %>% # make data frame
  setNames(c(3,5,7,11,14,17)) %>% # give names to variables
  dplyr::mutate(id = row_number()) %>% # make unique id
  gather(-id, key = Sweep, value = pred) %>% dplyr::mutate(group = "late")



colnames(mcs_loose_sdq_total_mean_full)[7] <- "Sweep"
# Plot
ggplot(mcs_loose_sdq_total_mean_full, aes(x = as.numeric(Sweep), y = ttl_mean, colour = group)) + geom_line(data = mcs_loose_sdq_total_mean_full, aes(x = as.numeric(Sweep), y = ttl_mean, colour = group)) + geom_point()  + geom_ribbon(data = mcs_loose_sdq_total_mean_full, aes(x = as.numeric(Sweep),ymin = lb, ymax = ub), linetype = 4, alpha = 0.2) + 
  stat_summary(
    data = pred_lgm_long_lin_early_loose,
    aes(x = as.numeric(Sweep), y = pred,  linetype = "linear", colour = "early"),
    fun = mean,
    geom = "line",
    size = 1
  ) +
  stat_summary(
    data = pred_lgm_long_lin_late_loose,
    aes(x = as.numeric(Sweep), y = pred,  linetype = "linear", colour = "late"),
    fun = mean,
    geom = "line",
    size = 1
  ) +
stat_summary(
    data = pred_lgm_long_qua_early_loose,
    aes(x = as.numeric(Sweep), y = pred,  linetype = "quadratic", colour = "early"),
    fun = mean,
    geom = "line",
    size = 1
  ) +
stat_summary(
    data = pred_lgm_long_qua_late_loose,
    aes(x = as.numeric(Sweep), y = pred,  linetype = "quadratic", colour = "late"),
    fun = mean,
    geom = "line",
    size = 1
  ) +
  theme_bw() +
  labs(y = "SDQ total", x = "Age") 

```
```{r}
asd_loose_SDQ_gmm <- dplyr::mutate(asd_loose_SDQ, numericID = row_number())
asd_loose_wide_sdq_ttl <- asd_loose_SDQ_gmm[,c("numericID","cmid","sex","diag.age","BEBDTOT","CEBDTOT", "DDDEBDTOT" ,"EEBDTOT","FEBDTOT","GEBDTOT")]
asd_loose_long_sdq_ttl <- melt(setDT(asd_loose_wide_sdq_ttl), id.vars = c("numericID","cmid","sex","diag.age"), variable.name = "sweep")
asd_loose_long_sdq_ttl <- asd_loose_long_sdq_ttl %>%
  mutate(Sweep = case_when(
    sweep == "BEBDTOT" ~ 2,
    sweep == "CEBDTOT" ~ 3,
    sweep == "DDDEBDTOT" ~ 4,
    sweep == "EEBDTOT" ~ 5,
    sweep == "FEBDTOT" ~ 6,
    sweep == "GEBDTOT" ~ 7)
    )

```

## Growth Mixture Modelling

```{r}
library(lcmm)
age <- c("3","5","7","11","14","17")
mcs_ttl_gmm1_loose <- hlme(value ~ Sweep, subject = "numericID", random=~1, ng = 1, data =asd_loose_long_sdq_ttl)
summary(mcs_ttl_gmm1_loose)


mcs_ttl_gmm2_loose <- hlme(value ~ Sweep, subject = "numericID", random=~1,
ng = 2, data = asd_loose_long_sdq_ttl, mixture = ~ Sweep,
nwg=T, B = mcs_ttl_gmm1_loose)
summary(mcs_ttl_gmm2_loose)



mcs_ttl_gmm3_loose <- hlme(value ~ Sweep, subject = "numericID", random=~1,
ng = 3, data = asd_loose_long_sdq_ttl, mixture = ~ Sweep,
nwg=T, B = mcs_ttl_gmm1_loose)
summary(mcs_ttl_gmm3_loose)

mcs_ttl_gmm4_loose <- hlme(value ~ Sweep, subject = "numericID", random=~1,
ng = 4, data = asd_loose_long_sdq_ttl, mixture = ~ Sweep,
nwg=T, B = mcs_ttl_gmm1_loose)
summary(mcs_ttl_gmm4_loose)

# make a table with results for the 3 models:
fit_ind <- summarytable(mcs_ttl_gmm1_loose, mcs_ttl_gmm2_loose,mcs_ttl_gmm3_loose,mcs_ttl_gmm4_loose,which = c("AIC","BIC","SABIC","%class","entropy","npm","loglik"))
```
```{r}

mcs_loose_ttl_people2 <- as.data.frame(mcs_ttl_gmm2_loose$pprob[,1:2])
asd_loose_long_sdq_ttl <- merge(asd_loose_long_sdq_ttl,mcs_loose_ttl_people2, by = "numericID")

asd_loose_long_sdq_ttl <- asd_loose_long_sdq_ttl %>% dplyr::mutate(Sweep.age = case_when(Sweep == 2 ~ 3,                                                                          Sweep == 3 ~ 5, Sweep == 4 ~ 7, Sweep == 5 ~ 11, Sweep == 6 ~ 14, Sweep == 7 ~ 17 ))

asd_loose_long_sdq_ttl$Sweep.age <- as.numeric(asd_loose_long_sdq_ttl$Sweep.age)
asd_loose_long_sdq_ttl$class <- as.factor(asd_loose_long_sdq_ttl$class)
p_mcs_loose_ttl_gmm2_s <- ggplot(asd_loose_long_sdq_ttl, aes(Sweep.age, value, group=numericID, colour= class)) + geom_smooth(aes(group=numericID, colour=class),size=0.5, se=F) + geom_smooth(aes(group=class), method="loess", size=2, se=T)  + scale_y_continuous(limits = c(0,40)) + scale_x_continuous(breaks = as.numeric(age),labels = age) + labs(x="Age(years)",y="SDQ_ttl",colour="Latent Class") 


p_mcs_loose_ttl_gmm2 <- ggplot(asd_loose_long_sdq_ttl, aes(Sweep.age, value, group=numericID, colour=class)) + geom_line(size = 0.2) + geom_smooth(aes(group=class), method="loess", size=2, se=T)  + scale_y_continuous(limits = c(0,40)) + scale_x_continuous(breaks = as.numeric(age), labels = age) + labs(x="Age(years)",y="MCS SDQ Total Score",colour="Latent Class")


suppressWarnings(print(p_mcs_loose_ttl_gmm2))
suppressWarnings(print(p_mcs_loose_ttl_gmm2_s))
```


```{r}

library(lavaan)

# Create the mediation model

model_1 <- "
  # direct effects
  diag.age ~ a*sex + b*cog.PC1 + c*eth + d*mad + e*es.PC1 + f*dep.PC1 + g*ttl2 + h*emo2 + i*con3 + j*hyp2 + k*peer2 + l*pro3
  "

fit_1 <- lavaan::sem(model_1, data = mcs_loose_gmm_covs_s)
lavTech(fit_1, "rsquare", add.labels = T)
summary(fit_1)
```
 # for one layer, using summary will encounter a bug, so using lavTech or lavInspect 
# see https://github.com/yrosseel/lavaan/issues/290

```{r}
library(tidySEM)
model_2 <- "

  diag.age ~ s*sex + i*cog.PC1 + e*eth + m*mad + se*es.PC1 + de*dep.PC1 + t*ttl2 + em*emo2 + co*con3 + h*hyp2 + p*peer2 + pr*pro3

  ttl2 ~ s1*sex +i1*cog.PC1+ e1*eth +m1*mad +se1*es.PC1 + de1*dep.PC1
  emo2 ~ s2*sex +i2*cog.PC1+ e2*eth +m2*mad +se2*es.PC1 + de2*dep.PC1
  con3 ~ s3*sex +i3*cog.PC1+ e3*eth +m3*mad +se3*es.PC1 + de3*dep.PC1
  hyp2 ~ s4*sex +i4*cog.PC1+ e4*eth +m4*mad +se4*es.PC1 + de4*dep.PC1
  peer2 ~ s5*sex +i5*cog.PC1+ e5*eth +m5*mad +se5*es.PC1 + de5*dep.PC1
  pro3 ~ s6*sex +i6*cog.PC1+ e6*eth +m6*mad +se6*es.PC1 + de6*dep.PC1
  
  
 indirect_ttl2 := i1*t  +de1*t+se1*t+m1*t +s1*t+ e1*t
 indirect_emo2 := i2*em  +de2*em+se2*em+m2*em +s2*em+ e2*em
 indirect_con3 := i3*co  +de3*co+se3*co+m3*co +s3*co+ e3*co
 indirect_hyp2 := i4*h  +de4*h+se4*h+m4*h +s4*h+ e4*h
 indirect_peer2 := i5*p  +de5*p+se5*p+m5*p +s5*p+ e5*p
 indirect_pro3 := i6*pr  +de6*pr+se6*pr+m6*pr +s6*pr+ e6*pr
 
direct := s + i + e +m + se + de
total_indirect := indirect_ttl2 + indirect_emo2 + indirect_con3 + indirect_hyp2 + indirect_peer2 + indirect_pro3
total := direct + total_indirect
  
"
set.seed(060524)
serial_mcs_fit <- lavaan::sem(model_2, data = mcs_loose_gmm_covs_s, se = "bootstrap",
    missing = "fiml", bootstrap = 1000)
serial_mcs_fit_sum <- lavaan::summary(serial_mcs_fit, standardized = TRUE, rsq = T,
    fit = TRUE, ci = TRUE)
serial_mcs_fit_ParEsts <- lavaan::parameterEstimates(serial_mcs_fit, boot.ci.type = "bca.simple",standardized = TRUE)
serial_mcs_fit_sum
serial_mcs_fit_ParEsts
write.csv(serial_mcs_fit_ParEsts, file = "mcs_level2.csv")

model_2 <- "
  # direct effects
  diag.age ~ a*sex + b*cog.PC1 + c*eth + d*mad + e*es.PC1 + f*dep.PC1 + g*ttl2 + h*emo2 + i*con3 + j*hyp2 + k*peer2 + l*pro3
  
  
  # mediation paths
  
  ttl2 ~ a*sex + b*cog.PC1 + c*eth + d*mad + e*es.PC1 + f*dep.PC1 
  emo2 ~ a*sex ++ b*cog.PC1 + c*eth + d*mad + e*es.PC1 + f*dep.PC1 
  con3 ~ a*sex ++ b*cog.PC1 + c*eth + d*mad + e*es.PC1 + f*dep.PC1 
  hyp2 ~a*sex ++ b*cog.PC1 + c*eth + d*mad + e*es.PC1 + f*dep.PC1 
  peer2 ~ a*sex ++ b*cog.PC1 + c*eth + d*mad + e*es.PC1 + f*dep.PC1 
  pro3 ~ a*sex ++ b*cog.PC1 + c*eth + d*mad + e*es.PC1 + f*dep.PC1 
  
  
"

fit_2 <- lavaan::sem(model_2, data = mcs_loose_gmm_covs_s)
summary(fit_2)
```
model_3<- "
  # direct effects
  diag.age ~ a*sex + b*cog.PC1 + c*eth + d*mad + e*es.PC1 + f*dep.PC1 + g*ttl2 + h*emo2 + i*con3 + j*hyp2 + k*peer2 + l*pro3
  
  
  # mediation paths
  
  ttl2 ~ a*sex + b*cog.PC1 + c*eth + d*mad + e*es.PC1 + f*dep.PC1 
  emo2 ~ a*sex + b*cog.PC1 + c*eth + d*mad + e*es.PC1 + f*dep.PC1 
  con3 ~ a*sex + b*cog.PC1 + c*eth + d*mad + e*es.PC1 + f*dep.PC1 
  hyp2 ~a*sex + b*cog.PC1 + c*eth + d*mad + e*es.PC1 + f*dep.PC1 
  peer2 ~ a*sex + b*cog.PC1 + c*eth + d*mad + e*es.PC1 + f*dep.PC1 
  pro3 ~ a*sex + b*cog.PC1 + c*eth + d*mad + e*es.PC1 + f*dep.PC1 
  cog.PC1 ~ e*es.PC1 + d*mad + f*dep.PC1 + a*sex+ b*eth
  indirect := a*b*c*d*e*f
  
"

fit_3 <- lavaan::sem(model_3, data = mcs_loose_gmm_covs_s)
```
model_4 <- "
  # direct effects
  diag.age ~ sex + cog.PC1 + eth + mad + es.PC1 + dep.PC1 + ttl2 + emo2 + con3 + hyp2 + peer2 + pro3
  
  
  # mediation paths
  cog.PC1 ~ es.PC1 + mad + dep.PC1 + sex+ eth
  mad ~ es.PC1 + dep.PC1 + sex+ eth
  ttl2 ~ cog.PC1 + dep.PC1 + es.PC1 + mad + sex+ eth
  emo2 ~ cog.PC1 + dep.PC1 + es.PC1 + mad + sex+ eth
  con3 ~ cog.PC1 + dep.PC1 + es.PC1 + mad+ sex+ eth
  hyp2 ~ cog.PC1 + dep.PC1 + es.PC1 + mad+ sex+ eth
  peer2 ~ cog.PC1 + dep.PC1 + es.PC1 + mad+ sex+ eth
  pro3 ~ cog.PC1 + dep.PC1 + es.PC1 + mad+ sex+ eth"

fit_4 <- lavaan::sem(model_4, data = mcs_loose_gmm_covs_s)
# add a layer of ethnicity?

summary(fit_1)
summary(fit_2,standardized = TRUE, rsquare = TRUE)
summary(fit_3,standardized = TRUE, rsquare = TRUE)
summary(fit_4,standardized = TRUE, rsquare = TRUE)
```