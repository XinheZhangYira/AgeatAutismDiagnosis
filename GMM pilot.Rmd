---
title: "MCS latent curve modelling"
author: "Yira Zhang"
date: '2022-11-27'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(knitr)
library(markdown)
library(tidyverse)
library(ggplot2)
library(tidyr)
library(data.table)
library(lcmm)
library(lavaan)
library(stringr)
```

## Data
# Load prepared data
```{r}
# Cr. Genie
MCS_autism <- read.csv("/Users/zhangxinhe/Documents/who recieves a diagnosis/MCS/MCS_SDQ_autism.csv") # 188 in total
MCS_sdq_autism <- MCS_autism[,c(1:21,34:39,22:33,40:45)] 
MCS_sdq_autism <- dplyr::mutate(MCS_sdq_autism, numericID = row_number())
MCS_adhd <- read.csv("/Users/zhangxinhe/Documents/who recieves a diagnosis/MCS/MCS_SDQ_adhd.csv") # 89 in total
MCS_sdq_adhd <- MCS_adhd[,c(1:21,34:39,22:33,40:45)]
MCS_autism_adhd_both <- read.csv("/Users/zhangxinhe/Documents/who recieves a diagnosis/MCS/MCS_SDQ_both.csv")
MCS_sdq_both <- MCS_autism_adhd_both[,c(1:21,34:39,22:33,40:45)]
MCS_no_diag <- read.csv("/Users/zhangxinhe/Documents/who recieves a diagnosis/MCS/MCS_SDQ_control.csv") # 6047 in total
MCS_sdq_no_diag <- MCS_no_diag[,c(1:21,34:39,22:33,40:45)]

```

```{r}
MCS_sdq_autism <- MCS_sdq_autism %>%
  mutate(diag.age = case_when(
    ASD.Diagnosis.Age == "at W3" ~ 5,
    ASD.Diagnosis.Age == "at W4" ~ 7,
    ASD.Diagnosis.Age == "at W5" ~ 11,
    ASD.Diagnosis.Age == "at W6" ~ 14)
    )
MCS_autism_wide_sdq_total <- MCS_sdq_autism[,c("numericID","MCSID","Sex","diag.age","BEBDTOT","CEBDTOT", "DDDEBDTOT" ,"EEBDTOT","FEBDTOT","GEBDTOT")]
MCS_autism_long_sdq_total <- melt(setDT(MCS_autism_wide_sdq_total), id.vars = c("numericID","MCSID","Sex","diag.age"), variable.name = "sweep")
MCS_autism_long_sdq_total <- MCS_autism_long_sdq_total %>%
  mutate(Sweep = case_when(
    sweep == "BEBDTOT" ~ 2,
    sweep == "CEBDTOT" ~ 3,
    sweep == "DDDEBDTOT" ~ 4,
    sweep == "EEBDTOT" ~ 5,
    sweep == "FEBDTOT" ~ 6,
    sweep == "GEBDTOT" ~ 7)
    )


MCS_autism_wide_sdq_emo <- MCS_sdq_autism[,c("numericID","MCSID","Sex","diag.age","BEMOTION","CEMOTION", "DDEMOTION","EEMOTION","FEMOTION","GEMOTION")]
MCS_autism_long_sdq_emo <- melt(setDT(MCS_autism_wide_sdq_emo), id.vars = c("numericID","MCSID","Sex","diag.age"), variable.name = "sweep")
MCS_autism_long_sdq_emo <- MCS_autism_long_sdq_emo %>%
  mutate(Sweep = case_when(
    sweep == "BEMOTION" ~ 2,
    sweep == "CEMOTION" ~ 3,
    sweep == "DDEMOTION" ~ 4,
    sweep == "EEMOTION" ~ 5,
    sweep == "FEMOTION" ~ 6,
    sweep == "GEMOTION" ~ 7)
    )


MCS_autism_wide_sdq_con <- MCS_sdq_autism[,c("numericID","MCSID","Sex","diag.age","BCONDUCT","CCONDUCT","DDCONDUCT","ECONDUCT","FCONDUCT","GCONDUCT")]
MCS_autism_long_sdq_con <- melt(setDT(MCS_autism_wide_sdq_con), id.vars = c("numericID","MCSID","Sex","diag.age"), variable.name = "sweep")
MCS_autism_long_sdq_con <- MCS_autism_long_sdq_con %>%
  mutate(Sweep = case_when(
    sweep == "BCONDUCT" ~ 2,
    sweep == "CCONDUCT" ~ 3,
    sweep == "DDCONDUCT" ~ 4,
    sweep == "ECONDUCT" ~ 5,
    sweep == "FCONDUCT" ~ 6,
    sweep == "GCONDUCT" ~ 7)
    )


MCS_autism_wide_sdq_hyp <- MCS_sdq_autism[,c("numericID","MCSID","Sex","diag.age","BHYPER","CHYPER","DDHYPER","EHYPER","FHYPER","GHYPER")]
MCS_autism_long_sdq_hyp <- melt(setDT(MCS_autism_wide_sdq_hyp), id.vars = c("numericID","MCSID","Sex","diag.age"), variable.name = "sweep")
MCS_autism_long_sdq_hyp <- MCS_autism_long_sdq_hyp %>%
  mutate(Sweep = case_when(
    sweep == "BHYPER" ~ 2,
    sweep == "CHYPER" ~ 3,
    sweep == "DDHYPER" ~ 4,
    sweep == "EHYPER" ~ 5,
    sweep == "FHYPER" ~ 6,
    sweep == "GHYPER" ~ 7)
    )


MCS_autism_wide_sdq_peer <- MCS_sdq_autism[,c("numericID","MCSID","Sex","diag.age","BPEER","CPEER","DDPEER","EPEER","FPEER","GPEER")]
MCS_autism_long_sdq_peer <- melt(setDT(MCS_autism_wide_sdq_peer), id.vars = c("numericID","MCSID","Sex","diag.age"), variable.name = "sweep")
MCS_autism_long_sdq_peer <- MCS_autism_long_sdq_peer %>%
  mutate(Sweep = case_when(
    sweep == "BPEER" ~ 2,
    sweep == "CPEER" ~ 3,
    sweep == "DDPEER" ~ 4,
    sweep == "EPEER" ~ 5,
    sweep == "FPEER" ~ 6,
    sweep == "GPEER" ~ 7)
    )


MCS_autism_wide_sdq_pro <- MCS_sdq_autism[,c("numericID","MCSID","Sex","diag.age","BPROSOC","CPROSOC","DDPROSOC","EPROSOC","FPROSOC","GPROSOC")]
MCS_autism_long_sdq_pro <- melt(setDT(MCS_autism_wide_sdq_pro), id.vars = c("numericID","MCSID","Sex","diag.age"), variable.name = "sweep")
MCS_autism_long_sdq_pro <- MCS_autism_long_sdq_pro %>%
  mutate(Sweep = case_when(
    sweep == "BPROSOC" ~ 2,
    sweep == "CPROSOC" ~ 3,
    sweep == "DDPROSOC" ~ 4,
    sweep == "EPROSOC" ~ 5,
    sweep == "FPROSOC" ~ 6,
    sweep == "GPROSOC" ~ 7)
    )
age <- c("3","5","7","11","14","17")
```

## Growth Mixture Modelling

# SDQ total
```{r}

mcs_ttl_gmm1 <- hlme(value ~ Sweep, subject = "numericID", random=~1, ng = 1, data =
MCS_autism_long_sdq_total)
summary(mcs_ttl_gmm1)


mcs_ttl_gmm2 <- hlme(value ~ Sweep, subject = "numericID", random=~1,
ng = 2, data = MCS_autism_long_sdq_total, mixture = ~ Sweep, classmb =~ diag.age,
nwg=T, B = mcs_ttl_gmm1)
summary(mcs_ttl_gmm2)
```


mcs_ttl_gmm3 <- hlme(value ~ Sweep, subject = "numericID", random=~1,
ng = 3, data = MCS_autism_long_sdq_total, mixture = ~ Sweep,classmb =~ diag.age,
nwg=T, B = mcs_ttl_gmm1)
summary(mcs_ttl_gmm3)

mcs_ttl_gmm4 <- hlme(value ~ Sweep, subject = "numericID", random=~1,
ng = 4, data = MCS_autism_long_sdq_total, mixture = ~ Sweep,classmb =~ diag.age,
nwg=T, B = mcs_ttl_gmm1)
summary(mcs_ttl_gmm4)

# make a table with results for the 3 models:
fit_ind <- summarytable(mcs_ttl_gmm1, mcs_ttl_gmm2, mcs_ttl_gmm3, mcs_ttl_gmm4)




```{r}
age <- c("3","5","7","11","14","17")
MCS_autism_long_sdq_total$numericID <- as.character(MCS_autism_long_sdq_total$numericID)
mcs_ttl_people2 <- as.data.frame(mcs_ttl_gmm2$pprob[,1:2])
MCS_autism_long_sdq_total$group_mcs_ttl_gmm2_s <- factor(mcs_ttl_people2$class[sapply(MCS_autism_long_sdq_total$numericID, function(x) which(mcs_ttl_people2$numericID==x))])
p_mcs_ttl_gmm2 <- ggplot(MCS_autism_long_sdq_total , aes(Sweep, value, group=numericID, colour=group_mcs_ttl_gmm2_s)) + geom_line() + geom_smooth(aes(group=group_mcs_ttl_gmm2_s), method="loess", size=2, se=F)  + scale_y_continuous(limits = c(0,40)) + scale_x_continuous(labels = age) + labs(x="Age(years)",y="SDQ_ttl",colour="Latent Class") 
p_mcs_ttl_gmm2_s <- ggplot(MCS_autism_long_sdq_total , aes(Sweep, value, group=numericID, colour=group_mcs_ttl_gmm2_s)) + geom_smooth(aes(group=numericID, colour=group_mcs_ttl_gmm2_s),size=0.5, se=F) + geom_smooth(aes(group=group_mcs_ttl_gmm2_s), method="loess", size=2, se=T)  + scale_y_continuous(limits = c(0,40)) + scale_x_continuous(labels = age) + labs(x="Age(years)",y="SDQ_ttl",colour="Latent Class") 
suppressWarnings(print(p_mcs_ttl_gmm2))
suppressWarnings(print(p_mcs_ttl_gmm2_s))
```

```{r}
age <- c("3","5","7","11","14","17")
mcs_ttl_people3 <- as.data.frame(mcs_ttl_gmm3$pprob[,1:2])
MCS_autism_long_sdq_total$group_mcs_ttl_gmm3 <- factor(mcs_ttl_people3$class[sapply(MCS_autism_long_sdq_total$numericID, function(x) which(mcs_ttl_people3$numericID==x))])
p_mcs_ttl_gmm3 <- ggplot(MCS_autism_long_sdq_total , aes(Sweep, value, group=numericID, colour=group_mcs_ttl_gmm3)) + geom_line() + geom_smooth(aes(group=group_mcs_ttl_gmm3), method="loess", size=2, se=F)  + scale_y_continuous(limits = c(0,40)) + scale_x_continuous(labels = age) + labs(x="Age(years)",y="SDQ_ttl",colour="Latent Class") 
p_mcs_ttl_gmm3_s <- ggplot(MCS_autism_long_sdq_total , aes(Sweep, value, group=numericID, colour=group_mcs_ttl_gmm3)) + geom_smooth(aes(group=numericID, colour=group_mcs_ttl_gmm3),size=0.5, se=F) + geom_smooth(aes(group=group_mcs_ttl_gmm3), method="loess", size=2, se=T)  + scale_y_continuous(limits = c(0,40)) + scale_x_continuous(labels = age) + labs(x="Age(years)",y="SDQ_ttl",colour="Latent Class") 

suppressWarnings(print(p_mcs_ttl_gmm3))
suppressWarnings(print(p_mcs_ttl_gmm3_s))


```

```{r}
mcs_ttl_people4 <- as.data.frame(mcs_ttl_gmm4$pprob[,1:2])
MCS_autism_long_sdq_total$group_mcs_ttl_gmm3_s <- factor(mcs_ttl_people4$class[sapply(MCS_autism_long_sdq_total$numericID, function(x) which(mcs_ttl_people4$numericID==x))])
p_mcs_ttl_gmm4 <- ggplot(MCS_autism_long_sdq_total , aes(Sweep, value, group=numericID, colour=group_mcs_ttl_gmm3_s)) + geom_line() + geom_smooth(aes(group=group_mcs_ttl_gmm3_s), method="loess", size=2, se=F)  + scale_y_continuous(limits = c(0,40)) + scale_x_continuous(labels = age) + labs(x="Age(years)",y="SDQ_ttl",colour="Latent Class") 
p_mcs_ttl_gmm4_s <- ggplot(MCS_autism_long_sdq_total , aes(Sweep, value, group=numericID, colour=group_mcs_ttl_gmm3_s)) + geom_smooth(aes(group=numericID, colour=group_mcs_ttl_gmm3_s),size=0.5, se=F) + geom_smooth(aes(group=group_mcs_ttl_gmm3_s), method="loess", size=2, se=T)  + scale_y_continuous(limits = c(0,40)) + scale_x_continuous(labels = age) + labs(x="Age(years)",y="SDQ_ttl",colour="Latent Class") 

suppressWarnings(print(p_mcs_ttl_gmm4))
suppressWarnings(print(p_mcs_ttl_gmm4_s))

```

# Emotional
```{r}

mcs_emo_gmm1 <- hlme(value ~ Sweep, subject = "numericID", random=~1, ng = 1, data =
MCS_autism_long_sdq_emo)
summary(mcs_emo_gmm1)

mcs_emo_gmm2 <- hlme(value ~ Sweep, subject = "numericID", random=~1,
ng = 2, data = MCS_autism_long_sdq_emo, mixture = ~ Sweep,
nwg=T, B = mcs_emo_gmm1)
summary(mcs_emo_gmm2)
```

mcs_emo_gmm3 <- hlme(value ~ Sweep, subject = "numericID", random=~1,
ng = 3, data = MCS_autism_long_sdq_emo, mixture = ~ Sweep,
nwg=T, B = mcs_emo_gmm1)

mcs_emo_gmm4 <- hlme(value ~ Sweep, subject = "numericID", random=~1,
ng = 4, data = MCS_autism_long_sdq_emo, mixture = ~ Sweep,
nwg=T, B = mcs_emo_gmm1)


# make a table with results for the 3 models:
fit_ind <- summarytable(mcs_emo_gmm1, mcs_emo_gmm2, mcs_emo_gmm3, mcs_emo_gmm4)




```{r}

MCS_autism_long_sdq_emo$numericID <- as.character(MCS_autism_long_sdq_emo$numericID)
mcs_emo_people2 <- as.data.frame(mcs_emo_gmm2$pprob[,1:2])
MCS_autism_long_sdq_emo$group_mcs_emo_gmm2_s <- factor(mcs_emo_people2$class[sapply(MCS_autism_long_sdq_emo$numericID, function(x) which(mcs_emo_people2$numericID==x))])
p_mcs_emo_gmm2 <- ggplot(MCS_autism_long_sdq_emo , aes(Sweep, value, group=numericID, colour=group_mcs_emo_gmm2_s)) + geom_line() + geom_smooth(aes(group=group_mcs_emo_gmm2_s), method="loess", size=2, se=F)  + scale_y_continuous(limits = c(0,10)) + scale_x_continuous(labels = age) + labs(x="Age(years)",y="SDQ_emo",colour="Latent Class") 
p_mcs_emo_gmm2_s <- ggplot(MCS_autism_long_sdq_emo , aes(Sweep, value, group=numericID, colour=group_mcs_emo_gmm2_s)) + geom_smooth(aes(group=numericID, colour=group_mcs_emo_gmm2_s),size=0.5, se=F) + geom_smooth(aes(group=group_mcs_emo_gmm2_s), method="loess", size=2, se=T)  + scale_y_continuous(limits = c(0,10)) + scale_x_continuous(labels = age) + labs(x="Age(years)",y="SDQ_emo",colour="Latent Class") 
suppressWarnings(print(p_mcs_emo_gmm2))
suppressWarnings(print(p_mcs_emo_gmm2_s))
```

```{r}

mcs_emo_people3 <- as.data.frame(mcs_emo_gmm3$pprob[,1:2])
MCS_autism_long_sdq_emo$group_mcs_emo_gmm3 <- factor(mcs_emo_people3$class[sapply(MCS_autism_long_sdq_emo$numericID, function(x) which(mcs_emo_people3$numericID==x))])
p_mcs_emo_gmm3 <- ggplot(MCS_autism_long_sdq_emo , aes(Sweep, value, group=numericID, colour=group_mcs_emo_gmm3)) + geom_line() + geom_smooth(aes(group=group_mcs_emo_gmm3), method="loess", size=2, se=F)  + scale_y_continuous(limits = c(0,10)) + scale_x_continuous(labels = age) + labs(x="Age(years)",y="SDQ_emo",colour="Latent Class") 
p_mcs_emo_gmm3_s <- ggplot(MCS_autism_long_sdq_emo , aes(Sweep, value, group=numericID, colour=group_mcs_emo_gmm3)) + geom_smooth(aes(group=numericID, colour=group_mcs_emo_gmm3),size=0.5, se=F) + geom_smooth(aes(group=group_mcs_emo_gmm3), method="loess", size=2, se=T)  + scale_y_continuous(limits = c(0,10)) + scale_x_continuous(labels = age) + labs(x="Age(years)",y="SDQ_emo",colour="Latent Class") 

suppressWarnings(print(p_mcs_emo_gmm3))
suppressWarnings(print(p_mcs_emo_gmm3_s))


```

```{r}
mcs_emo_people4 <- as.data.frame(mcs_emo_gmm4$pprob[,1:2])
MCS_autism_long_sdq_emo$group_mcs_emo_gmm3_s <- factor(mcs_emo_people4$class[sapply(MCS_autism_long_sdq_emo$numericID, function(x) which(mcs_emo_people4$numericID==x))])
p_mcs_emo_gmm4 <- ggplot(MCS_autism_long_sdq_emo , aes(Sweep, value, group=numericID, colour=group_mcs_emo_gmm3_s)) + geom_line() + geom_smooth(aes(group=group_mcs_emo_gmm3_s), method="loess", size=2, se=F)  + scale_y_continuous(limits = c(0,10)) + scale_x_continuous(labels = age) + labs(x="Age(years)",y="SDQ_emo",colour="Latent Class") 
p_mcs_emo_gmm4_s <- ggplot(MCS_autism_long_sdq_emo , aes(Sweep, value, group=numericID, colour=group_mcs_emo_gmm3_s)) + geom_smooth(aes(group=numericID, colour=group_mcs_emo_gmm3_s),size=0.5, se=F) + geom_smooth(aes(group=group_mcs_emo_gmm3_s), method="loess", size=2, se=T)  + scale_y_continuous(limits = c(0,10)) + scale_x_continuous(labels = age) + labs(x="Age(years)",y="SDQ_emo",colour="Latent Class") 

suppressWarnings(print(p_mcs_emo_gmm4))
suppressWarnings(print(p_mcs_emo_gmm4_s))

```

# Conduct
```{r}

mcs_con_gmm1 <- hlme(value ~ Sweep, subject = "numericID", random=~1, ng = 1, data =
MCS_autism_long_sdq_con)
summary(mcs_con_gmm1)

mcs_con_gmm2 <- hlme(value ~ Sweep, subject = "numericID", random=~1,
ng = 2, data = MCS_autism_long_sdq_con, mixture = ~ Sweep,
nwg=T, B = mcs_con_gmm1)
summary(mcs_con_gmm2)
```
mcs_con_gmm3 <- hlme(value ~ Sweep, subject = "numericID", random=~1,
ng = 3, data = MCS_autism_long_sdq_con, mixture = ~ Sweep,
nwg=T, B = mcs_con_gmm1)

mcs_con_gmm4 <- hlme(value ~ Sweep, subject = "numericID", random=~1,
ng = 4, data = MCS_autism_long_sdq_con, mixture = ~ Sweep,
nwg=T, B = mcs_con_gmm1)


# make a table with results for the 3 models:
fit_ind <- summarytable(mcs_con_gmm1, mcs_con_gmm2, mcs_con_gmm3, mcs_con_gmm4)




```{r}

MCS_autism_long_sdq_con$numericID <- as.character(MCS_autism_long_sdq_con$numericID)
mcs_con_people2 <- as.data.frame(mcs_con_gmm2$pprob[,1:2])
MCS_autism_long_sdq_con$group_mcs_con_gmm2_s <- factor(mcs_con_people2$class[sapply(MCS_autism_long_sdq_con$numericID, function(x) which(mcs_con_people2$numericID==x))])
p_mcs_con_gmm2 <- ggplot(MCS_autism_long_sdq_con , aes(Sweep, value, group=numericID, colour=group_mcs_con_gmm2_s)) + geom_line() + geom_smooth(aes(group=group_mcs_con_gmm2_s), method="loess", size=2, se=F)  + scale_y_continuous(limits = c(0,10)) + scale_x_continuous(labels = age) + labs(x="Age(years)",y="SDQ_con",colour="Latent Class") 
p_mcs_con_gmm2_s <- ggplot(MCS_autism_long_sdq_con , aes(Sweep, value, group=numericID, colour=group_mcs_con_gmm2_s)) + geom_smooth(aes(group=numericID, colour=group_mcs_con_gmm2_s),size=0.5, se=F) + geom_smooth(aes(group=group_mcs_con_gmm2_s), method="loess", size=2, se=T)  + scale_y_continuous(limits = c(0,10)) + scale_x_continuous(labels = age) + labs(x="Age(years)",y="SDQ_con",colour="Latent Class") 
suppressWarnings(print(p_mcs_con_gmm2))
suppressWarnings(print(p_mcs_con_gmm2_s))
```

```{r}

mcs_con_people3 <- as.data.frame(mcs_con_gmm3$pprob[,1:2])
MCS_autism_long_sdq_con$group_mcs_con_gmm3 <- factor(mcs_con_people3$class[sapply(MCS_autism_long_sdq_con$numericID, function(x) which(mcs_con_people3$numericID==x))])
p_mcs_con_gmm3 <- ggplot(MCS_autism_long_sdq_con , aes(Sweep, value, group=numericID, colour=group_mcs_con_gmm3)) + geom_line() + geom_smooth(aes(group=group_mcs_con_gmm3), method="loess", size=2, se=F)  + scale_y_continuous(limits = c(0,10)) + scale_x_continuous(labels = age) + labs(x="Age(years)",y="SDQ_con",colour="Latent Class") 
p_mcs_con_gmm3_s <- ggplot(MCS_autism_long_sdq_con , aes(Sweep, value, group=numericID, colour=group_mcs_con_gmm3)) + geom_smooth(aes(group=numericID, colour=group_mcs_con_gmm3),size=0.5, se=F) + geom_smooth(aes(group=group_mcs_con_gmm3), method="loess", size=2, se=T)  + scale_y_continuous(limits = c(0,10)) + scale_x_continuous(labels = age) + labs(x="Age(years)",y="SDQ_con",colour="Latent Class") 

suppressWarnings(print(p_mcs_con_gmm3))
suppressWarnings(print(p_mcs_con_gmm3_s))


```

```{r}
mcs_con_people4 <- as.data.frame(mcs_con_gmm4$pprob[,1:2])
MCS_autism_long_sdq_con$group_mcs_con_gmm3_s <- factor(mcs_con_people4$class[sapply(MCS_autism_long_sdq_con$numericID, function(x) which(mcs_con_people4$numericID==x))])
p_mcs_con_gmm4 <- ggplot(MCS_autism_long_sdq_con , aes(Sweep, value, group=numericID, colour=group_mcs_con_gmm3_s)) + geom_line() + geom_smooth(aes(group=group_mcs_con_gmm3_s), method="loess", size=2, se=F)  + scale_y_continuous(limits = c(0,10)) + scale_x_continuous(labels = age) + labs(x="Age(years)",y="SDQ_con",colour="Latent Class") 
p_mcs_con_gmm4_s <- ggplot(MCS_autism_long_sdq_con , aes(Sweep, value, group=numericID, colour=group_mcs_con_gmm3_s)) + geom_smooth(aes(group=numericID, colour=group_mcs_con_gmm3_s),size=0.5, se=F) + geom_smooth(aes(group=group_mcs_con_gmm3_s), method="loess", size=2, se=T)  + scale_y_continuous(limits = c(0,10)) + scale_x_continuous(labels = age) + labs(x="Age(years)",y="SDQ_con",colour="Latent Class") 

suppressWarnings(print(p_mcs_con_gmm4))
suppressWarnings(print(p_mcs_con_gmm4_s))

```

# Hyperactivity
```{r}

mcs_hyp_gmm1 <- hlme(value ~ Sweep, subject = "numericID", random=~1, ng = 1, data =
MCS_autism_long_sdq_hyp)
summary(mcs_hyp_gmm1)

mcs_hyp_gmm2 <- hlme(value ~ Sweep, subject = "numericID", random=~1,
ng = 2, data = MCS_autism_long_sdq_hyp, mixture = ~ Sweep,
nwg=T, B = mcs_hyp_gmm1)
summary(mcs_hyp_gmm2)
```
mcs_hyp_gmm3 <- hlme(value ~ Sweep, subject = "numericID", random=~1,
ng = 3, data = MCS_autism_long_sdq_hyp, mixture = ~ Sweep,
nwg=T, B = mcs_hyp_gmm1)

mcs_hyp_gmm4 <- hlme(value ~ Sweep, subject = "numericID", random=~1,
ng = 4, data = MCS_autism_long_sdq_hyp, mixture = ~ Sweep,
nwg=T, B = mcs_hyp_gmm1)


# make a table with results for the 3 models:
fit_ind <- summarytable(mcs_hyp_gmm1, mcs_hyp_gmm2, mcs_hyp_gmm3, mcs_hyp_gmm4)




```{r}

MCS_autism_long_sdq_hyp$numericID <- as.character(MCS_autism_long_sdq_hyp$numericID)
mcs_hyp_people2 <- as.data.frame(mcs_hyp_gmm2$pprob[,1:2])
MCS_autism_long_sdq_hyp$group_mcs_hyp_gmm2_s <- factor(mcs_hyp_people2$class[sapply(MCS_autism_long_sdq_hyp$numericID, function(x) which(mcs_hyp_people2$numericID==x))])
p_mcs_hyp_gmm2 <- ggplot(MCS_autism_long_sdq_hyp , aes(Sweep, value, group=numericID, colour=group_mcs_hyp_gmm2_s)) + geom_line() + geom_smooth(aes(group=group_mcs_hyp_gmm2_s), method="loess", size=2, se=F)  + scale_y_continuous(limits = c(0,10)) + scale_x_continuous(labels = age) + labs(x="Age(years)",y="SDQ_hyp",colour="Latent Class") 
p_mcs_hyp_gmm2_s <- ggplot(MCS_autism_long_sdq_hyp , aes(Sweep, value, group=numericID, colour=group_mcs_hyp_gmm2_s)) + geom_smooth(aes(group=numericID, colour=group_mcs_hyp_gmm2_s),size=0.5, se=F) + geom_smooth(aes(group=group_mcs_hyp_gmm2_s), method="loess", size=2, se=T)  + scale_y_continuous(limits = c(0,10)) + scale_x_continuous(labels = age) + labs(x="Age(years)",y="SDQ_hyp",colour="Latent Class") 
suppressWarnings(print(p_mcs_hyp_gmm2))
suppressWarnings(print(p_mcs_hyp_gmm2_s))
```

```{r}

mcs_hyp_people3 <- as.data.frame(mcs_hyp_gmm3$pprob[,1:2])
MCS_autism_long_sdq_hyp$group_mcs_hyp_gmm3 <- factor(mcs_hyp_people3$class[sapply(MCS_autism_long_sdq_hyp$numericID, function(x) which(mcs_hyp_people3$numericID==x))])
p_mcs_hyp_gmm3 <- ggplot(MCS_autism_long_sdq_hyp , aes(Sweep, value, group=numericID, colour=group_mcs_hyp_gmm3)) + geom_line() + geom_smooth(aes(group=group_mcs_hyp_gmm3), method="loess", size=2, se=F)  + scale_y_continuous(limits = c(0,10)) + scale_x_continuous(labels = age) + labs(x="Age(years)",y="SDQ_hyp",colour="Latent Class") 
p_mcs_hyp_gmm3_s <- ggplot(MCS_autism_long_sdq_hyp , aes(Sweep, value, group=numericID, colour=group_mcs_hyp_gmm3)) + geom_smooth(aes(group=numericID, colour=group_mcs_hyp_gmm3),size=0.5, se=F) + geom_smooth(aes(group=group_mcs_hyp_gmm3), method="loess", size=2, se=T)  + scale_y_continuous(limits = c(0,10)) + scale_x_continuous(labels = age) + labs(x="Age(years)",y="SDQ_hyp",colour="Latent Class") 

suppressWarnings(print(p_mcs_hyp_gmm3))
suppressWarnings(print(p_mcs_hyp_gmm3_s))


```

```{r}
mcs_hyp_people4 <- as.data.frame(mcs_hyp_gmm4$pprob[,1:2])
MCS_autism_long_sdq_hyp$group_mcs_hyp_gmm3_s <- factor(mcs_hyp_people4$class[sapply(MCS_autism_long_sdq_hyp$numericID, function(x) which(mcs_hyp_people4$numericID==x))])
p_mcs_hyp_gmm4 <- ggplot(MCS_autism_long_sdq_hyp , aes(Sweep, value, group=numericID, colour=group_mcs_hyp_gmm3_s)) + geom_line() + geom_smooth(aes(group=group_mcs_hyp_gmm3_s), method="loess", size=2, se=F)  + scale_y_continuous(limits = c(0,10)) + scale_x_continuous(labels = age) + labs(x="Age(years)",y="SDQ_hyp",colour="Latent Class") 
p_mcs_hyp_gmm4_s <- ggplot(MCS_autism_long_sdq_hyp , aes(Sweep, value, group=numericID, colour=group_mcs_hyp_gmm3_s)) + geom_smooth(aes(group=numericID, colour=group_mcs_hyp_gmm3_s),size=0.5, se=F) + geom_smooth(aes(group=group_mcs_hyp_gmm3_s), method="loess", size=2, se=T)  + scale_y_continuous(limits = c(0,10)) + scale_x_continuous(labels = age) + labs(x="Age(years)",y="SDQ_hyp",colour="Latent Class") 

suppressWarnings(print(p_mcs_hyp_gmm4))
suppressWarnings(print(p_mcs_hyp_gmm4_s))

```




# Peer 

```{r}

mcs_peer_gmm1 <- hlme(value ~ Sweep, subject = "numericID", random=~1, ng = 1, data =
MCS_autism_long_sdq_peer)
summary(mcs_peer_gmm1)

mcs_peer_gmm2 <- hlme(value ~ Sweep, subject = "numericID", random=~1,
ng = 2, data = MCS_autism_long_sdq_peer, mixture = ~ Sweep,
nwg=T, B = mcs_peer_gmm1)
summary(mcs_peer_gmm2)
```
mcs_peer_gmm3 <- hlme(value ~ Sweep, subject = "numericID", random=~1,
ng = 3, data = MCS_autism_long_sdq_peer, mixture = ~ Sweep,
nwg=T, B = mcs_peer_gmm1)

mcs_peer_gmm4 <- hlme(value ~ Sweep, subject = "numericID", random=~1,
ng = 4, data = MCS_autism_long_sdq_peer, mixture = ~ Sweep,
nwg=T, B = mcs_peer_gmm1)


# make a table with results for the 3 models:
fit_ind <- summarytable(mcs_peer_gmm1, mcs_peer_gmm2, mcs_peer_gmm3, mcs_peer_gmm4)




```{r}

MCS_autism_long_sdq_peer$numericID <- as.character(MCS_autism_long_sdq_peer$numericID)
mcs_peer_people2 <- as.data.frame(mcs_peer_gmm2$pprob[,1:2])
MCS_autism_long_sdq_peer$group_mcs_peer_gmm2_s <- factor(mcs_peer_people2$class[sapply(MCS_autism_long_sdq_peer$numericID, function(x) which(mcs_peer_people2$numericID==x))])
p_mcs_peer_gmm2 <- ggplot(MCS_autism_long_sdq_peer , aes(Sweep, value, group=numericID, colour=group_mcs_peer_gmm2_s)) + geom_line() + geom_smooth(aes(group=group_mcs_peer_gmm2_s), method="loess", size=2, se=F)  + scale_y_continuous(limits = c(0,10)) + scale_x_continuous(labels = age) + labs(x="Age(years)",y="SDQ_peer",colour="Latent Class") 
p_mcs_peer_gmm2_s <- ggplot(MCS_autism_long_sdq_peer , aes(Sweep, value, group=numericID, colour=group_mcs_peer_gmm2_s)) + geom_smooth(aes(group=numericID, colour=group_mcs_peer_gmm2_s),size=0.5, se=F) + geom_smooth(aes(group=group_mcs_peer_gmm2_s), method="loess", size=2, se=T)  + scale_y_continuous(limits = c(0,10)) + scale_x_continuous(labels = age) + labs(x="Age(years)",y="SDQ_peer",colour="Latent Class") 
suppressWarnings(print(p_mcs_peer_gmm2))
suppressWarnings(print(p_mcs_peer_gmm2_s))
```

```{r}

mcs_peer_people3 <- as.data.frame(mcs_peer_gmm3$pprob[,1:2])
MCS_autism_long_sdq_peer$group_mcs_peer_gmm3 <- factor(mcs_peer_people3$class[sapply(MCS_autism_long_sdq_peer$numericID, function(x) which(mcs_peer_people3$numericID==x))])
p_mcs_peer_gmm3 <- ggplot(MCS_autism_long_sdq_peer , aes(Sweep, value, group=numericID, colour=group_mcs_peer_gmm3)) + geom_line() + geom_smooth(aes(group=group_mcs_peer_gmm3), method="loess", size=2, se=F)  + scale_y_continuous(limits = c(0,10)) + scale_x_continuous(labels = age) + labs(x="Age(years)",y="SDQ_peer",colour="Latent Class") 
p_mcs_peer_gmm3_s <- ggplot(MCS_autism_long_sdq_peer , aes(Sweep, value, group=numericID, colour=group_mcs_peer_gmm3)) + geom_smooth(aes(group=numericID, colour=group_mcs_peer_gmm3),size=0.5, se=F) + geom_smooth(aes(group=group_mcs_peer_gmm3), method="loess", size=2, se=T)  + scale_y_continuous(limits = c(0,10)) + scale_x_continuous(labels = age) + labs(x="Age(years)",y="SDQ_peer",colour="Latent Class") 

suppressWarnings(print(p_mcs_peer_gmm3))
suppressWarnings(print(p_mcs_peer_gmm3_s))


```

```{r}
mcs_peer_people4 <- as.data.frame(mcs_peer_gmm4$pprob[,1:2])
MCS_autism_long_sdq_peer$group_mcs_peer_gmm3_s <- factor(mcs_peer_people4$class[sapply(MCS_autism_long_sdq_peer$numericID, function(x) which(mcs_peer_people4$numericID==x))])
p_mcs_peer_gmm4 <- ggplot(MCS_autism_long_sdq_peer , aes(Sweep, value, group=numericID, colour=group_mcs_peer_gmm3_s)) + geom_line() + geom_smooth(aes(group=group_mcs_peer_gmm3_s), method="loess", size=2, se=F)  + scale_y_continuous(limits = c(0,10)) + scale_x_continuous(labels = age) + labs(x="Age(years)",y="SDQ_peer",colour="Latent Class") 
p_mcs_peer_gmm4_s <- ggplot(MCS_autism_long_sdq_peer , aes(Sweep, value, group=numericID, colour=group_mcs_peer_gmm3_s)) + geom_smooth(aes(group=numericID, colour=group_mcs_peer_gmm3_s),size=0.5, se=F) + geom_smooth(aes(group=group_mcs_peer_gmm3_s), method="loess", size=2, se=T)  + scale_y_continuous(limits = c(0,10)) + scale_x_continuous(labels = age) + labs(x="Age(years)",y="SDQ_peer",colour="Latent Class") 

suppressWarnings(print(p_mcs_peer_gmm4))
suppressWarnings(print(p_mcs_peer_gmm4_s))

```




# Prosocial

```{r}

mcs_pro_gmm1 <- hlme(value ~ Sweep, subject = "numericID", random=~1, ng = 1, data =
MCS_autism_long_sdq_pro)
summary(mcs_pro_gmm1)

mcs_pro_gmm2 <- hlme(value ~ Sweep, subject = "numericID", random=~1,
ng = 2, data = MCS_autism_long_sdq_pro, mixture = ~ Sweep,
nwg=T, B = mcs_pro_gmm1)
summary(mcs_pro_gmm2)
```
mcs_pro_gmm3 <- hlme(value ~ Sweep, subject = "numericID", random=~1,
ng = 3, data = MCS_autism_long_sdq_pro, mixture = ~ Sweep,
nwg=T, B = mcs_pro_gmm1)
summary(mcs_pro_gmm3)

mcs_pro_gmm4 <- hlme(value ~ Sweep, subject = "numericID", random=~1,
ng = 4, data = MCS_autism_long_sdq_pro, mixture = ~ Sweep,
nwg=T, B = mcs_pro_gmm1)
summary(mcs_pro_gmm4)

mcs_pro_gmm5 <- hlme(value ~ Sweep, subject = "numericID", random=~1,
ng = 5, , data = MCS_autism_long_sdq_pro, mixture = ~ Sweep, 
nwg=T, B = mcs_pro_gmm1)
summary(mcs_pro_gmm5)
# make a table with results for the 3 models:
fit_ind <- summarytable(mcs_pro_gmm1, mcs_pro_gmm2, mcs_pro_gmm3, mcs_pro_gmm4, mcs_pro_gmm5)




```{r}

MCS_autism_long_sdq_pro$numericID <- as.character(MCS_autism_long_sdq_pro$numericID)
mcs_pro_people2 <- as.data.frame(mcs_pro_gmm2$pprob[,1:2])
MCS_autism_long_sdq_pro$group_mcs_pro_gmm2_s <- factor(mcs_pro_people2$class[sapply(MCS_autism_long_sdq_pro$numericID, function(x) which(mcs_pro_people2$numericID==x))])
p_mcs_pro_gmm2 <- ggplot(MCS_autism_long_sdq_pro , aes(Sweep, value, group=numericID, colour=group_mcs_pro_gmm2_s)) + geom_line() + geom_smooth(aes(group=group_mcs_pro_gmm2_s), method="loess", size=2, se=F)  + scale_y_continuous(limits = c(0,10)) + scale_x_continuous(labels = age) + labs(x="Age(years)",y="SDQ_pro",colour="Latent Class") 
p_mcs_pro_gmm2_s <- ggplot(MCS_autism_long_sdq_pro , aes(Sweep, value, group=numericID, colour=group_mcs_pro_gmm2_s)) + geom_smooth(aes(group=numericID, colour=group_mcs_pro_gmm2_s),size=0.5, se=F) + geom_smooth(aes(group=group_mcs_pro_gmm2_s), method="loess", size=2, se=T)  + scale_y_continuous(limits = c(0,10)) + scale_x_continuous(labels = age) + labs(x="Age(years)",y="SDQ_pro",colour="Latent Class") 
suppressWarnings(print(p_mcs_pro_gmm2))
suppressWarnings(print(p_mcs_pro_gmm2_s))
```

```{r}

mcs_pro_people3 <- as.data.frame(mcs_pro_gmm3$pprob[,1:2])
MCS_autism_long_sdq_pro$group_mcs_pro_gmm3 <- factor(mcs_pro_people3$class[sapply(MCS_autism_long_sdq_pro$numericID, function(x) which(mcs_pro_people3$numericID==x))])
p_mcs_pro_gmm3 <- ggplot(MCS_autism_long_sdq_pro , aes(Sweep, value, group=numericID, colour=group_mcs_pro_gmm3)) + geom_line() + geom_smooth(aes(group=group_mcs_pro_gmm3), method="loess", size=2, se=F)  + scale_y_continuous(limits = c(0,10)) + scale_x_continuous(labels = age) + labs(x="Age(years)",y="SDQ_pro",colour="Latent Class") 
p_mcs_pro_gmm3_s <- ggplot(MCS_autism_long_sdq_pro , aes(Sweep, value, group=numericID, colour=group_mcs_pro_gmm3)) + geom_smooth(aes(group=numericID, colour=group_mcs_pro_gmm3),size=0.5, se=F) + geom_smooth(aes(group=group_mcs_pro_gmm3), method="loess", size=2, se=T)  + scale_y_continuous(limits = c(0,10)) + scale_x_continuous(labels = age) + labs(x="Age(years)",y="SDQ_pro",colour="Latent Class") 

suppressWarnings(print(p_mcs_pro_gmm3))
suppressWarnings(print(p_mcs_pro_gmm3_s))


```

```{r}
mcs_pro_people4 <- as.data.frame(mcs_pro_gmm4$pprob[,1:2])
MCS_autism_long_sdq_pro$group_mcs_pro_gmm3_s <- factor(mcs_pro_people4$class[sapply(MCS_autism_long_sdq_pro$numericID, function(x) which(mcs_pro_people4$numericID==x))])
p_mcs_pro_gmm4 <- ggplot(MCS_autism_long_sdq_pro , aes(Sweep, value, group=numericID, colour=group_mcs_pro_gmm3_s)) + geom_line() + geom_smooth(aes(group=group_mcs_pro_gmm3_s), method="loess", size=2, se=F)  + scale_y_continuous(limits = c(0,10)) + scale_x_continuous(labels = age) + labs(x="Age(years)",y="SDQ_pro",colour="Latent Class") 
p_mcs_pro_gmm4_s <- ggplot(MCS_autism_long_sdq_pro , aes(Sweep, value, group=numericID, colour=group_mcs_pro_gmm3_s)) + geom_smooth(aes(group=numericID, colour=group_mcs_pro_gmm3_s),size=0.5, se=F) + geom_smooth(aes(group=group_mcs_pro_gmm3_s), method="loess", size=2, se=T)  + scale_y_continuous(limits = c(0,10)) + scale_x_continuous(labels = age) + labs(x="Age(years)",y="SDQ_pro",colour="Latent Class") 

suppressWarnings(print(p_mcs_pro_gmm4))
suppressWarnings(print(p_mcs_pro_gmm4_s))

```

```{r}

MCS_autism_long_sdq_pro$numericID <- as.character(MCS_autism_long_sdq_pro$numericID)
mcs_pro_people5 <- as.data.frame(mcs_pro_gmm5$pprob[,1:2])
MCS_autism_long_sdq_pro$group_mcs_pro_gmm4 <- factor(mcs_pro_people5$class[sapply(MCS_autism_long_sdq_pro$numericID, function(x) which(mcs_pro_people5$numericID==x))])
p_mcs_pro_gmm5 <- ggplot(MCS_autism_long_sdq_pro , aes(Sweep, value, group=numericID, colour=group_mcs_pro_gmm4)) + geom_line() + geom_smooth(aes(group=group_mcs_pro_gmm4), method="loess", size=2, se=F)  + scale_y_continuous(limits = c(0,10)) + scale_x_continuous(labels = age) + labs(x="Age(years)",y="SDQ_pro",colour="Latent Class") 
p_mcs_pro_gmm5_s <- ggplot(MCS_autism_long_sdq_pro , aes(Sweep, value, group=numericID, colour=group_mcs_pro_gmm4)) + geom_smooth(aes(group=numericID, colour=group_mcs_pro_gmm4),size=0.5, se=F) + geom_smooth(aes(group=group_mcs_pro_gmm4), method="loess", size=2, se=T)  + scale_y_continuous(limits = c(0,10)) + scale_x_continuous(labels = age) + labs(x="Age(years)",y="SDQ_pro",colour="Latent Class") 
suppressWarnings(print(p_mcs_pro_gmm5))
suppressWarnings(print(p_mcs_pro_gmm5_s))
```


# Group membership
```{r}

MCS_autism_wide_sdq_emo$numericID <- as.character(MCS_autism_wide_sdq_emo$numericID)
mcs_ttl_people2$numericID <- as.character(mcs_ttl_people2$numericID)
mcs_emo_people2$numericID <- as.character(mcs_emo_people2$numericID)
mcs_con_people2$numericID <- as.character(mcs_con_people2$numericID)
mcs_hyp_people2$numericID <- as.character(mcs_hyp_people2$numericID)
mcs_peer_people2$numericID <- as.character(mcs_peer_people2$numericID)
mcs_pro_people2$numericID <- as.character(mcs_pro_people2$numericID)
group_df_list_2 <- list(MCS_autism_wide_sdq_emo[,c("numericID","diag.age","Sex")], mcs_ttl_people2,mcs_emo_people2, mcs_con_people2, mcs_hyp_people2, mcs_peer_people2, mcs_pro_people2)

group_membership_2 <- group_df_list_2 %>% reduce(full_join, by= 'numericID') 

colnames(group_membership_2)[4:9] <- c("ttl","emo","con","hyp","peer","pro")
group_membership_2$Sex <- ifelse(group_membership_2$Sex=="Male", 1, 2)

```



# Multinomial regression
## Total score
```{r}
apply(group_membership_2[,2:3], 2, table)

table(group_membership_2$ttl, group_membership_2$Sex, group_membership_2$diag.age)
```

```{r}
library(ggplot2)
ggplot(group_membership_2, aes(as.factor(diag.age))) +
  geom_bar(aes(fill = as.factor(ttl)), color = "black")
```

```{r}
with(group_membership_2, table(Sex,ttl))
with(group_membership_2, do.call(rbind, tapply(diag.age, ttl, function(x) c(M = mean(x), SD = sd(x)))))
```


```{r}
group_membership_2$ttl[group_membership_2$ttl == 1] <- 0
group_membership_2$ttl[group_membership_2$ttl == 2] <- 1
model_sex <- glm(ttl ~ Sex , data=group_membership_2, family="binomial")
summary(model_sex)
model_diag_age <- glm(ttl ~ diag.age , data=group_membership_2, family="binomial")
summary(model_diag_age)
model <- glm(ttl ~ Sex + diag.age, data=group_membership_2, family="binomial")
summary(model)
model_cor <- glm(ttl ~ Sex + diag.age + Sex * diag.age, data=group_membership_2, family="binomial")
summary(model_cor)

# Sex and the correlation between sex and diagnosis age are not significant predictors of which latent group an individual falls in, whereas diagnosis age is a significant predictor
# As the AIC suggests, the model with only *diag.age* as the covariate explains the data the best among the four models fitted
# So, to interpret the logistic regression result of that model, I went on calculating the odds ratio
coefs <- coef(model_diag_age)
exp(coefs)
# This gives the odds ratio of diagnosis age: 0.67: For a one unit increase in diagnosis age, we expect to see a 67% increase in the odds of falling in the 2nd latent group (the increasing difficulties one). With a z-value of -6.262 and an associated p-value of 3.79e-10.

```


# 3 latent groups

```{r}

MCS_autism_wide_sdq_emo$numericID <- as.character(MCS_autism_wide_sdq_emo$numericID)
mcs_ttl_people3$numericID <- as.character(mcs_ttl_people3$numericID)
mcs_emo_people3$numericID <- as.character(mcs_emo_people3$numericID)
mcs_con_people3$numericID <- as.character(mcs_con_people3$numericID)
mcs_hyp_people3$numericID <- as.character(mcs_hyp_people3$numericID)
mcs_peer_people3$numericID <- as.character(mcs_peer_people3$numericID)
mcs_pro_people3$numericID <- as.character(mcs_pro_people3$numericID)
group_df_list_3 <- list(MCS_autism_wide_sdq_emo[,c("numericID","diag.age","Sex")], mcs_ttl_people3,mcs_emo_people3, mcs_con_people3, mcs_hyp_people3, mcs_peer_people3, mcs_pro_people3)

group_membership_3 <- group_df_list_3 %>% reduce(full_join, by= 'numericID') 

colnames(group_membership_3)[4:9] <- c("ttl","emo","con","hyp","peer","pro")
group_membership_3$Sex <- ifelse(group_membership_3$Sex=="Male", 1, 2)

```

```{r}

ggplot(group_membership_3, aes(as.factor(diag.age))) +
  geom_bar(aes(fill = as.factor(ttl)), color = "black")

with(group_membership_3, table(Sex,ttl))
with(group_membership_3, do.call(rbind, tapply(diag.age, ttl, function(x) c(M = mean(x), SD = sd(x)))))

```


```{r}
# multinomial logistic regression, here the reference latent group is 1
# No significant covariate
library(nnet)
group_membership_3$ttl <- as.factor(group_membership_3$ttl)
group_membership_3$diag.age <- as.factor(group_membership_3$diag.age)
model <- multinom(ttl ~  diag.age + Sex, data = group_membership_3)
summary(model)
coefs <- coef(model)
exp(coefs)

summary(model)$standard.errors
zvalues <- summary(model)$coefficients / summary(model)$standard.errors
zvalues
p_values<- pnorm(abs(zvalues), lower.tail=FALSE)*2
p_values
```


# 4 latent groups

```{r}

MCS_autism_wide_sdq_emo$numericID <- as.character(MCS_autism_wide_sdq_emo$numericID)
mcs_ttl_people4$numericID <- as.character(mcs_ttl_people4$numericID)
mcs_emo_people4$numericID <- as.character(mcs_emo_people4$numericID)
mcs_con_people4$numericID <- as.character(mcs_con_people4$numericID)
mcs_hyp_people4$numericID <- as.character(mcs_hyp_people4$numericID)
mcs_peer_people4$numericID <- as.character(mcs_peer_people4$numericID)
mcs_pro_people4$numericID <- as.character(mcs_pro_people4$numericID)
group_df_list_4 <- list(MCS_autism_wide_sdq_emo[,c("numericID","diag.age","Sex")], mcs_ttl_people4,mcs_emo_people4, mcs_con_people4, mcs_hyp_people4, mcs_peer_people4, mcs_pro_people4)

group_membership_4 <- group_df_list_4 %>% reduce(full_join, by= 'numericID') 

colnames(group_membership_4)[4:9] <- c("ttl","emo","con","hyp","peer","pro")

```

```{r}

ggplot(group_membership_4, aes(as.factor(diag.age))) +
  geom_bar(aes(fill = as.factor(ttl)), color = "black")

with(group_membership_4, table(Sex,ttl))
with(group_membership_4, do.call(rbind, tapply(diag.age, ttl, function(x) c(M = mean(x), SD = sd(x)))))

```


```{r}
# multinomial logistic regression, here the reference latent group is 1
# No significant covariate
library(nnet)
group_membership_4$ttl <- as.factor(group_membership_4$ttl)
group_membership_4$diag.age <- as.factor(group_membership_4$diag.age)
model <- multinom(ttl ~  diag.age + Sex, data = group_membership_4)
summary(model)
coefs <- coef(model)
exp(coefs)

summary(model)$standard.errors
zvalues <- summary(model)$coefficients / summary(model)$standard.errors
zvalues
p_values<- pnorm(abs(zvalues), lower.tail=FALSE)*2
p_values

```


```{r}
pp <- fitted(model)
head(pp)
```

# Prosocialability

```{r}
stack_ttl <- ggplot(group_membership_2,  aes(x = factor(diag.age), fill = factor(ttl))) +
  geom_bar(position="fill") + scale_y_continuous(labels = scales::percent) +
  labs(x = "diagnosis age", y = "percentage", title = "distribution of latent group membership of total score by diagnosis ages") + scale_fill_brewer(labels=c('decreasing difficulties','increasing difficulties'), name = "latent group membership", palette = "Pastel1")
stack_ttl


stack_emo <- ggplot(group_membership_2,  aes(x = factor(diag.age), fill = factor(emo))) +
  geom_bar(position="fill") + scale_y_continuous(labels = scales::percent) +
  labs(x = "diagnosis age", y = "percentage", title = "distribution of latent group membership of smotional symptoms by diagnosis ages") + scale_fill_brewer(labels=c('decreasing difficulties','increasing difficulties'), name = "latent group membership", palette = "Pastel1")

stack_con <- ggplot(group_membership_2,  aes(x = factor(diag.age), fill = factor(con))) +
  geom_bar(position="fill") + scale_y_continuous(labels = scales::percent) +
  labs(x = "diagnosis age", y = "percentage", title = "distribution of latent group membership of conduct problems by diagnosis ages") + scale_fill_brewer(labels=c('decreasing difficulties','increasing difficulties'), name = "latent group membership", palette = "Pastel1")

stack_hyp <- ggplot(group_membership_2,  aes(x = factor(diag.age), fill = factor(hyp))) +
  geom_bar(position="fill") + scale_y_continuous(labels = scales::percent) +
  labs(x = "diagnosis age", y = "percentage", title = "distribution of latent group membership of hyperactivity by diagnosis ages") + scale_fill_brewer(labels=c('decreasing difficulties','increasing difficulties'), name = "latent group membership", palette = "Pastel1")

stack_peer <- ggplot(group_membership_2,  aes(x = factor(diag.age), fill = factor(peer))) +
  geom_bar(position="fill") + scale_y_continuous(labels = scales::percent) +
  labs(x = "diagnosis age", y = "percentage", title = "distribution of latent group membership of peer relationship problems by diagnosis ages") + scale_fill_brewer(labels=c('increasing difficulties','decreasing difficulties'), name = "latent group membership", palette = "Pastel1")
```

```{r}
stack_pro <- ggplot(group_membership_2,  aes(x = factor(diag.age), fill = factor(pro))) +
  geom_bar(position="fill") + scale_y_continuous(labels = scales::percent) +
  labs(x = "diagnosis age", y = "percentage", title = "distribution of latent group membership of prosocialness by diagnosis ages") + scale_fill_brewer(labels=c('decreasing prosocialness','increasing prosocialness'), name = "latent group membership", palette = "Pastel1")
print(stack_pro)
  
```

```{r}
pdf("MCS_autism_gmm_stacked_bar.pdf")
print(stack_ttl) 
print(stack_emo) 
print(stack_con)
print(stack_hyp)
print(stack_peer)
print(stack_pro)
dev.off()
```

```{r}
with(group_membership_2, table(Sex,pro))
with(group_membership_2, do.call(rbind, tapply(diag.age, pro, function(x) c(M = mean(x), SD = sd(x)))))
```


```{r}
group_membership_2$pro <- as.numeric(group_membership_2$pro)
group_membership_2$pro[group_membership_2$pro == 1] <- 1
group_membership_2$pro[group_membership_2$pro == 2] <- 0
model_sex <- glm(pro ~ Sex , data=group_membership_2, family="binomial")
summary(model_sex)
model_diag_age <- glm(pro ~ diag.age , data=group_membership_2, family="binomial")
summary(model_diag_age)
model <- glm(pro ~ Sex + diag.age, data=group_membership_2, family="binomial")
summary(model)
model_cor <- glm(pro ~ Sex + diag.age + Sex * diag.age, data=group_membership_2, family="binomial")
summary(model_cor)

# Sex and the correlation between sex and diagnosis age are not significant predictors of which latent group an individual falls in, whereas diagnosis age is a significant predictor
# As the AIC suggests, the model with only *diag.age* as the covariate explains the data the best among the four models fitted
# So, to interpret the logistic regression result of that model, I went on calculating the odds ratio
coefs <- coef(model_diag_age)
exp(coefs)
# This gives the odds ratio of diagnosis age: 1.21: For a one unit increase in diagnosis age, we expect to see a 1.21 times more likely to fall in the 1st latent group (the decreasing prosocialability one). With a z-value of 3.94 and an associated p-value of 8.22e-05.

```