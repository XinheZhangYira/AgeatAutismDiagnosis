---
title: "MCS LGCM tests"
author: "Yira Zhang"
date: "2023-11-02"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(ggplot2)
library(tidyr)
library(data.table)
library(tidyverse)
library(lavaan)
```

## Data
# Load prepared data
```{r}
# Cr. Genie
MCS_autism <- read.csv("/Users/zhangxinhe/Documents/who recieves a diagnosis/MCS/MCS_SDQ_autism.csv") # 188 in total
MCS_sdq_autism <- MCS_autism[,c(1:21,34:39,22:33,40:45)]
MCS_sdq_autism$sex_num <- ifelse(MCS_sdq_autism$Sex =="Male", 1, 2)
#MCS_adhd <- read.csv("/Users/zhangxinhe/Documents/who recieves a diagnosis/MCS/MCS_SDQ_adhd.csv") # 89 in total
#MCS_sdq_adhd <- MCS_adhd[,c(1:21,34:39,22:33,40:45)]
#MCS_autism_adhd_both <- read.csv("/Users/zhangxinhe/Documents/who recieves a diagnosis/MCS/MCS_SDQ_both.csv")
#MCS_sdq_both <- MCS_autism_adhd_both[,c(1:21,34:39,22:33,40:45)]
MCS_no_diag <- read.csv("/Users/zhangxinhe/Documents/who recieves a diagnosis/MCS/MCS_SDQ_control.csv") # 6047 in total
MCS_no_diag$sex_num <- ifelse(MCS_no_diag$Sex == "Male", 1,2)
MCS_no_diag$grp <- "no_diag"
MCS_no_diag$grp_num <- 3
MCS_sdq_no_diag <- MCS_no_diag[,c(1:21,34:39,22:33,40:45)]
```

# Load predictors
```{r}
mcs2_parent_interview <- read_delim("/Users/zhangxinhe/Documents/who recieves a diagnosis/MCS/MCS_data/UKDA-5350-tab/tab/mcs2_parent_interview.tab")
mcs_ID_identifier <- read.csv("/Users/zhangxinhe/Documents/who recieves a diagnosis/MCS/mcs_ID_identifier.csv")
mcs_ethnicity_mbirth_age <- read.csv("/Users/zhangxinhe/Documents/who recieves a diagnosis/MCS/mcs_race_mbirthage.csv")
mcs2_ses_identifier <- read.csv("/Users/zhangxinhe/Documents/who recieves a diagnosis/MCS/mcs_ses_identifier.csv")
mcs2_dep_identifier <- read.csv("/Users/zhangxinhe/Documents/who recieves a diagnosis/MCS/mcs_deprivation_identifier.csv")
mcs2_family_derived <- read_delim("/Users/zhangxinhe/Documents/who recieves a diagnosis/MCS/MCS_data/UKDA-5350-tab/tab/mcs2_family_derived.tab")
mcs2_other_ses_identifier <- read.csv("/Users/zhangxinhe/Documents/who recieves a diagnosis/MCS/mcs_other_ses_identifier.csv")
```
# sex ratio plot
#```{r}
MCS_sdq_autism_for_plot <- MCS_sdq_autism %>% dplyr::mutate(diag.age = case_when(ASD.Diagnosis.Age == "at W3" ~ 5,
         ASD.Diagnosis.Age == "at W4" ~ 7,
           ASD.Diagnosis.Age == "at W5" ~ 11,
           ASD.Diagnosis.Age == "at W6" ~ 14 ))
xtab <- xtabs(~ diag.age + Sex,data = MCS_sdq_autism_for_plot)
xtabs <- as.data.frame(table(MCS_sdq_autism_for_plot$diag.age,MCS_sdq_autism_for_plot$Sex))
names(xtabs) <- c("diag.age","sex","count")

mosaicplot(
  xtab,
  main = NULL,
  color = c("#FB9A99","#A6CEE3"),  # Specify custom colors
  xlab = "Diagnosis age group",
  ylab = "Sex",
  cex.axis = 1.2, las = 1  # Adjust axis label size
)
vcd::labeling_cells(text = as.table(xtab), margin = 0)(as.table(xtab))
#mosaicplot(xtab, color = TRUE, main = "Age Group by Gender")




## Autism
# Reshape data to plot-ready form
```{r}
# Group autstic group according to their diagnosis age
# Though some parents provided specific diagnosis age in years, to conform to analysis in other cohorts so that cross-population comparisons could be allowed in the future
# "Early" = first reported diagnosis at w3 (age5) or w4 (age7)
# "Late = first reported diagnosis at w5 (age11) or w6 (age14)


MCS_sdq_autism_early <- MCS_sdq_autism %>% filter (ASD.Diagnosis.Age %in% c("at W3","at W4","at W5")) # n = 118

MCS_sdq_autism_late <- MCS_sdq_autism %>% filter (ASD.Diagnosis.Age %in% c("at W6")) # n = 70
MCS_sdq_autism$grp <- ifelse(MCS_sdq_autism$ASD.Diagnosis.Age %in% c("at W3","at W4","at W5"), "Early", ifelse(MCS_sdq_autism$ASD.Diagnosis.Age %in% c("at W6"), "Late", NA))
MCS_sdq_autism$grp_num <- ifelse(MCS_sdq_autism$ASD.Diagnosis.Age %in% c("at W3","at W4","at W5"), 1, ifelse(MCS_sdq_autism$ASD.Diagnosis.Age %in% c("at W6"), 2, NA))
MCS_sdq_all <- rbind(MCS_no_diag,MCS_sdq_autism)
```



## linear LGCM (slope age adjusted)
```{r}
mcs_autism_ttl_adj <- "
int =~ 1*BEBDTOT + 1*CEBDTOT + 1*DDDEBDTOT + 1*EEBDTOT + 1*FEBDTOT + 1*GEBDTOT
slp =~ 3*BEBDTOT + 5*CEBDTOT + 7*DDDEBDTOT + 11*EEBDTOT + 14*FEBDTOT + 17*GEBDTOT
int ~ sex_num + grp_num
slp ~ sex_num + grp_num
sex_num ~~ sex_num
grp_num ~~ grp_num
# the parametres for slope reflect the designed ages at corresponding sweeps
"


fit_mcs_autism_ttl_adj <- growth(mcs_autism_ttl_adj, data = MCS_sdq_autism,  missing = "fiml", estimator = "ml", fixed.x = F)
summary(fit_mcs_autism_ttl_adj)
```

```{r}
mcs_agestr_ttl_adj <- "
int =~ 1*BEBDTOT + 1*CEBDTOT + 1*DDDEBDTOT + 1*EEBDTOT + 1*FEBDTOT + 1*GEBDTOT
slp =~ 3*BEBDTOT + 5*CEBDTOT + 7*DDDEBDTOT + 11*EEBDTOT + 14*FEBDTOT + 17*GEBDTOT

# the parametres for slope reflect the designed ages at corresponding sweeps
"
mcs_agestr_ttl_fit_adj <- growth(mcs_agestr_ttl_adj, data = MCS_sdq_all, group = "grp_num",  missing = "fiml", estimator = "ml", fixed.x = F)
summary(mcs_agestr_ttl_fit_adj)

```
```{r}
est_mcs_agestr_ttl_fit_adj <- parameterEstimates(mcs_agestr_ttl_fit_adj) %>% filter(grepl("^(int|slp)$", lhs) & op == "~1")
results_mcs_agestr_ttl <- est_mcs_agestr_ttl_fit_adj %>%
  dplyr::select(lhs,group, est, ci.lower, ci.upper, pvalue) %>%
  mutate(Estimates = paste(round(est, 2), " [", round(ci.lower, 2), ", ", round(ci.upper, 2), "]"),
         p_value = round(pvalue,3)) %>%
  dplyr::select(lhs,group,Estimates, p_value)
results_mcs_agestr_ttl

```

```{r}


# Extract intercepts for two groups
intercept_early <- est_mcs_agestr_ttl_fit_adj %>% filter(lhs == "int" & group == 3) %>% select(est, se, z)
intercept_late <- est_mcs_agestr_ttl_fit_adj %>% filter(lhs == "int" & group == 2) %>% select(est, se, z)

# Calculate the z-score for the difference between two groups
mean_early <- intercept_early$est
se_early <- intercept_early$se

mean_late <- intercept_late$est
se_late <- intercept_late$se

z_score <- (mean_early - mean_late) / sqrt(se_early^2 + se_late^2)

# Print z-score


# Calculate two-tailed p-value
p_value <- 2 * (1 - pnorm(abs(z_score)))


# Extract slopes for two groups
slope_early <- est_mcs_agestr_ttl_fit_adj %>% filter(lhs == "slp" & group == 3) %>% select(est, se, z)
slope_late <- est_mcs_agestr_ttl_fit_adj %>% filter(lhs == "slp" & group == 2) %>% select(est, se, z)

# Calculate the z-score for the difference between two groups
slp_mean_early <- slope_early$est
slp_se_early <- slope_early$se

slp_mean_late <- slope_late$est
slp_se_late <- slope_late$se

slp_z_score <- (slp_mean_early - slp_mean_late) / sqrt(slp_se_early^2 + slp_se_late^2)
# Calculate two-tailed p-value
slp_p_value <- 2 * (1 - pnorm(abs(slp_z_score)))

cat("Z-score for intercepts:", z_score, "\n")
cat("P-value for intercepts:", p_value, "\n")
cat("Z-score for slopes:", slp_z_score, "\n")
cat("P-value for slopes:", p_value, "\n")
```




```{r}
mcs_sexstr_ttl_adj <- "
int =~ 1*BEBDTOT + 1*CEBDTOT + 1*DDDEBDTOT + 1*EEBDTOT + 1*FEBDTOT + 1*GEBDTOT
slp =~ 3*BEBDTOT + 5*CEBDTOT + 7*DDDEBDTOT + 11*EEBDTOT + 14*FEBDTOT + 17*GEBDTOT

# the parametres for slope reflect the designed ages at corresponding sweeps
"
mcs_ttl_fit_adj <- growth(mcs_sexstr_ttl_adj, data = MCS_sdq_autism, missing = "fiml", estimator = "ml", fixed.x = F)
mcs_sexstr_ttl_fit_adj <- growth(mcs_sexstr_ttl_adj, data = MCS_sdq_autism, group = "Sex",  missing = "fiml", estimator = "ml", fixed.x = F)
mcs_agestr_ttl_fit_adj_asd <- growth(mcs_sexstr_ttl_adj, data = MCS_sdq_autism, group = "grp_num",  missing = "fiml", estimator = "ml", fixed.x = F)
#summary(mcs_sexstr_ttl_fit_adj)
```
```{r}
anova_ttl_age <- anova(mcs_ttl_fit_adj,mcs_agestr_ttl_fit_adj_asd)
anova_ttl_sex <- anova(mcs_ttl_fit_adj,mcs_sexstr_ttl_fit_adj)
anova_ttl_age_results<- data.frame(anova_ttl_age)
anova_ttl_sex_results<- data.frame(anova_ttl_sex)
anova_ttl <- rbind(anova_ttl_age_results,anova_ttl_sex_results)
anova_ttl

```


```{r}
est_mcs_sexstr_ttl_fit_adj <- parameterEstimates(mcs_sexstr_ttl_fit_adj) %>% filter(grepl("^(int|slp)$", lhs) & op == "~1")
results_mcs_sexstr_ttl <- est_mcs_sexstr_ttl_fit_adj %>%
  dplyr::select(lhs,group, est, ci.lower, ci.upper, pvalue) %>%
  mutate(Estimates = paste(round(est, 2), " [", round(ci.lower, 2), ", ", round(ci.upper, 2), "]"),
         p_value = round(pvalue,3)) %>%
  dplyr::select(lhs,group,Estimates, p_value)
results_mcs_sexstr_ttl
```

```{r}
# Extract intercepts for two groups
intercept_female <- est_mcs_sexstr_ttl_fit_adj %>% filter(lhs == "int" & group == 1) %>% select(est, se, z)
intercept_male <- est_mcs_sexstr_ttl_fit_adj %>% filter(lhs == "int" & group == 2) %>% select(est, se, z)

# Calcumale the z-score for the difference between two groups
int_mean_female <- intercept_female$est
int_se_female <- intercept_female$se

int_mean_male <- intercept_male$est
int_se_male <- intercept_male$se

int_z_score <- (int_mean_male - int_mean_female) / sqrt(int_se_female^2 + int_se_male^2)

# Print z-score


# Calcumale two-tailed p-value
int_p_value <- 2 * (1 - pnorm(abs(int_z_score)))


# Extract slopes for two groups
slope_female <- est_mcs_agestr_ttl_fit_adj %>% filter(lhs == "slp" & group == 3) %>% select(est, se, z)
slope_male <- est_mcs_agestr_ttl_fit_adj %>% filter(lhs == "slp" & group == 2) %>% select(est, se, z)

# Calcumale the z-score for the difference between two groups
slp_mean_female <- slope_female$est
slp_se_female <- slope_female$se

slp_mean_male <- slope_male$est
slp_se_male <- slope_male$se

slp_z_score <- (slp_mean_male - slp_mean_female) / sqrt(slp_se_male^2 + slp_se_female^2)
# Calcumale two-tailed p-value
slp_p_value <- 2 * (1 - pnorm(abs(slp_z_score)))

cat("Z-score for intercepts:", int_z_score, "\n")
cat("P-value for intercepts:", int_p_value, "\n")
cat("Z-score for slopes:", slp_z_score, "\n")
cat("P-value for slopes:", slp_p_value, "\n")
```

## quadratic
```{r}
mcs_agestr_ttl_adj_2 <- "
int =~ 1*BEBDTOT + 1*CEBDTOT + 1*DDDEBDTOT + 1*EEBDTOT + 1*FEBDTOT + 1*GEBDTOT
slp =~ 3*BEBDTOT + 5*CEBDTOT + 7*DDDEBDTOT + 11*EEBDTOT + 14*FEBDTOT + 17*GEBDTOT
qua =~ 9*BEBDTOT + 25*CEBDTOT + 49*DDDEBDTOT + 121*EEBDTOT + 196*FEBDTOT + 289*GEBDTOT
GEBDTOT ~~ 1*GEBDTOT
# the parametres for slope reflect the designed ages at corresponding sweeps
"


mcs_ttl_fit_adj_2 <- growth(mcs_agestr_ttl_adj_2, data = MCS_sdq_all,  missing = "fiml", estimator = "ml", fixed.x = F)
#summary(mcs_ttl_fit_adj_2)
mcs_agestr_ttl_fit_adj_2 <- growth(mcs_agestr_ttl_adj_2, data = MCS_sdq_all, group = "grp_num", missing = "fiml", estimator = "ml", fixed.x = F)
summary(mcs_agestr_ttl_fit_adj_2)
mcs_sexstr_ttl_fit_adj_2 <- growth(mcs_agestr_ttl_adj_2, data = MCS_sdq_autism, group = "Sex", missing = "fiml", estimator = "ml", fixed.x = F)
#summary(mcs_sexstr_ttl_fit_adj_2)
```
```{r}
est_mcs_agestr_ttl_fit_adj_2 <- parameterEstimates(mcs_agestr_ttl_fit_adj_2) %>% filter(grepl("int|slp|qua",lhs) & op == "~1")
results_mcs_agestr_ttl_fit_adj_2 <- est_mcs_agestr_ttl_fit_adj_2 %>%
  dplyr::select(lhs, group, est, ci.lower, ci.upper, pvalue) %>%
 mutate(Estimates = sprintf("%.2f [%0.2f, %0.2f]", est, ci.lower, ci.upper),
         p_value = sprintf("%.3f", pvalue)) %>%
  dplyr::select(lhs,group,Estimates, p_value)
results_mcs_agestr_ttl_fit_adj_2

```


```{r}

mcs_agestr_emo_adj_2 <- "
int =~ 1*BEMOTION + 1*CEMOTION + 1*DDEMOTION + 1*EEMOTION + 1*FEMOTION + 1*GEMOTION
slp =~ 3*BEMOTION + 5*CEMOTION + 7*DDEMOTION + 11*EEMOTION + 14*FEMOTION + 17*GEMOTION
qua =~ 9*BEMOTION + 25*CEMOTION + 49*DDEMOTION + 121*EEMOTION + 196*FEMOTION + 289*GEMOTION

"
mcs_agestr_con_adj_2 <- "
int =~ 1*BCONDUCT + 1*CCONDUCT + 1*DDCONDUCT + 1*ECONDUCT + 1*FCONDUCT + 1*GCONDUCT
slp =~ 3*BCONDUCT + 5*CCONDUCT + 7*DDCONDUCT + 11*ECONDUCT + 14*FCONDUCT + 17*GCONDUCT
qua =~ 9*BCONDUCT + 25*CCONDUCT + 49*DDCONDUCT + 121*ECONDUCT + 196*FCONDUCT + 289*GCONDUCT

"

mcs_agestr_hyp_adj_2 <- "
int =~ 1*BHYPER + 1*CHYPER + 1*DDHYPER + 1*EHYPER + 1*FHYPER + 1*GHYPER
slp =~ 3*BHYPER + 5*CHYPER + 7*DDHYPER + 11*EHYPER + 14*FHYPER + 17*GHYPER
qua =~ 9*BHYPER + 25*CHYPER + 49*DDHYPER + 121*EHYPER + 196*FHYPER + 289*GHYPER

"

mcs_agestr_peer_adj_2 <- "
int =~ 1*BPEER + 1*CPEER + 1*DDPEER + 1*EPEER + 1*FPEER + 1*GPEER
slp =~ 3*BPEER + 5*CPEER + 7*DDPEER + 11*EPEER + 14*FPEER + 17*GPEER
qua =~ 9*BPEER + 25*CPEER + 49*DDPEER + 121*EPEER + 196*FPEER + 289*GPEER

"

mcs_agestr_pro_adj_2 <- "
int =~ 1*BPROSOC + 1*CPROSOC + 1*DDPROSOC + 1*EPROSOC + 1*FPROSOC + 1*GPROSOC
slp =~ 3*BPROSOC + 5*CPROSOC + 7*DDPROSOC + 11*EPROSOC + 14*FPROSOC + 17*GPROSOC
qua =~ 9*BPROSOC + 25*CPROSOC + 49*DDPROSOC + 121*EPROSOC + 196*FPROSOC + 289*GPROSOC

"

fit_mcs_agestr_emo_adj_2 <- growth(mcs_agestr_emo_adj_2, data = MCS_sdq_all, group =  "grp_num", missing = "fiml", estimator = "ml", fixed.x = F)
summary(fit_mcs_agestr_emo_adj_2)

est_fit_mcs_agestr_emo_adj_2 <- parameterEstimates(fit_mcs_agestr_emo_adj_2) %>% filter(grepl("int|slp|qua",lhs) & op == "~1")


results_fit_mcs_agestr_emo_adj_2 <- est_fit_mcs_agestr_emo_adj_2 %>%
  dplyr::select(lhs, group, est, ci.lower, ci.upper, pvalue) %>%
 mutate(Estimates = sprintf("%.2f [%0.2f, %0.2f]", est, ci.lower, ci.upper),
         p_value = sprintf("%.3f", pvalue)) %>%
  dplyr::select(lhs,group,Estimates, p_value)
results_fit_mcs_agestr_emo_adj_2




fit_mcs_agestr_con_adj_2 <- growth(mcs_agestr_con_adj_2, data = MCS_sdq_all, group =  "grp_num", missing = "fiml", estimator = "ml", fixed.x = F)
summary(fit_mcs_agestr_con_adj_2)

est_fit_mcs_agestr_con_adj_2 <- parameterEstimates(fit_mcs_agestr_con_adj_2) %>% filter(grepl("int|slp|qua",lhs) & op == "~1")
results_fit_mcs_agestr_con_adj_2 <- est_fit_mcs_agestr_con_adj_2 %>%
  dplyr::select(lhs, group, est, ci.lower, ci.upper, pvalue) %>%
 mutate(Estimates = sprintf("%.2f [%0.2f, %0.2f]", est, ci.lower, ci.upper),
         p_value = sprintf("%.3f", pvalue)) %>%
  dplyr::select(lhs,group,Estimates, p_value)
results_fit_mcs_agestr_con_adj_2


fit_mcs_agestr_hyp_adj_2 <- growth(mcs_agestr_hyp_adj_2, data = MCS_sdq_all, group =  "grp_num", missing = "fiml", estimator = "ml", fixed.x = F)
summary(fit_mcs_agestr_hyp_adj_2)

est_fit_mcs_agestr_hyp_adj_2 <- parameterEstimates(fit_mcs_agestr_hyp_adj_2) %>% filter(grepl("int|slp|qua",lhs) & op == "~1")
results_fit_mcs_agestr_hyp_adj_2 <- est_fit_mcs_agestr_hyp_adj_2 %>%
  dplyr::select(lhs, group, est, ci.lower, ci.upper, pvalue) %>%
 mutate(Estimates = sprintf("%.2f [%0.2f, %0.2f]", est, ci.lower, ci.upper),
         p_value = sprintf("%.3f", pvalue)) %>%
  dplyr::select(lhs,group,Estimates, p_value)
results_fit_mcs_agestr_hyp_adj_2


fit_mcs_agestr_peer_adj_2 <- growth(mcs_agestr_peer_adj_2, data = MCS_sdq_all, group =  "grp_num", missing = "fiml", estimator = "ml", fixed.x = F)
summary(fit_mcs_agestr_peer_adj_2)

est_fit_mcs_agestr_peer_adj_2 <- parameterEstimates(fit_mcs_agestr_peer_adj_2) %>% filter(grepl("int|slp|qua",lhs) & op == "~1")
results_fit_mcs_agestr_peer_adj_2 <- est_fit_mcs_agestr_peer_adj_2 %>%
  dplyr::select(lhs, group, est, ci.lower, ci.upper, pvalue) %>%
 mutate(Estimates = sprintf("%.2f [%0.2f, %0.2f]", est, ci.lower, ci.upper),
         p_value = sprintf("%.3f", pvalue)) %>%
  dplyr::select(lhs,group,Estimates, p_value)
results_fit_mcs_agestr_peer_adj_2

fit_mcs_agestr_pro_adj_2 <- growth(mcs_agestr_pro_adj_2, data = MCS_sdq_all, group =  "grp_num", missing = "fiml", estimator = "ml", fixed.x = F)
summary(fit_mcs_agestr_pro_adj_2)

est_fit_mcs_agestr_pro_adj_2 <- parameterEstimates(fit_mcs_agestr_pro_adj_2) %>% filter(grepl("int|slp|qua",lhs) & op == "~1")
results_fit_mcs_agestr_pro_adj_2 <- est_fit_mcs_agestr_pro_adj_2 %>%
  dplyr::select(lhs, group, est, ci.lower, ci.upper, pvalue) %>%
 mutate(Estimates = sprintf("%.2f [%0.2f, %0.2f]", est, ci.lower, ci.upper),
         p_value = sprintf("%.3f", pvalue)) %>%
  dplyr::select(lhs,group,Estimates, p_value)
results_fit_mcs_agestr_pro_adj_2

```




## cubic 

```{r}
mcs_agestr_ttl_adj_3 <- "
int =~ 1*BEBDTOT + 1*CEBDTOT + 1*DDDEBDTOT + 1*EEBDTOT + 1*FEBDTOT + 1*GEBDTOT
slp =~ .3*BEBDTOT + .5*CEBDTOT + .7*DDDEBDTOT + 1.1*EEBDTOT + 1.4*FEBDTOT + 1.7*GEBDTOT
qua =~ .09*BEBDTOT + .25*CEBDTOT + .49*DDDEBDTOT + 1.21*EEBDTOT + 1.96*FEBDTOT + 2.89*GEBDTOT
cub =~ .027*BEBDTOT + .125*CEBDTOT + .343*DDDEBDTOT + 1.331*EEBDTOT + 2.744*FEBDTOT + 4.913*GEBDTOT
# the parametres for slope reflect the designed ages at corresponding sweeps
"


mcs_ttl_fit_adj_3 <- growth(mcs_agestr_ttl_adj_3, data = MCS_sdq_autism,  missing = "fiml", estimator = "ml", fixed.x = F)
summary(mcs_ttl_fit_adj_3)
mcs_agestr_ttl_fit_adj_3 <- growth(mcs_agestr_ttl_adj_3, data = MCS_sdq_autism, group = "grp_num", missing = "fiml", estimator = "ml", fixed.x = F)
summary(mcs_agestr_ttl_fit_adj_3)
# removed group = "grp_num" , 
```
```{r}
fitMeasures(mcs_ttl_fit_adj,c("rmsea","chisq","pvalue","cfi","tli","aic","bic"))
fitMeasures(mcs_agestr_ttl_fit_adj,c("rmsea","chisq","pvalue","cfi","tli","aic","bic"))
fitMeasures(mcs_agestr_ttl_fit_adj_2, c("rmsea","chisq","pvalue","cfi","tli","aic","bic"))
fitMeasures(mcs_agestr_ttl_fit_adj_3, c("rmsea","chisq","pvalue","cfi","tli","aic","bic"))

```

```{r}
fitMeasures(mcs_ttl_fit_adj,c("rmsea","chisq","pvalue","cfi","tli","aic","bic"))
fitMeasures(mcs_ttl_fit_adj_2, c("rmsea","chisq","pvalue","cfi","tli","aic","bic"))
fitMeasures(mcs_ttl_fit_adj_3, c("rmsea","chisq","pvalue","cfi","tli","aic","bic"))
```

```{r, eval=FALSE}
pred_lgm_qua <- as.data.frame(predict(mcs_ttl_fit_adj_2))
# create long data for each individual

pred_lgm_long_qua <- map(c(3,5,7,11,14,17), # loop over time
                     function(x) pred_lgm_qua[, 1] + x * pred_lgm_qua[, 2] + x^2 * pred_lgm_qua[,3]) %>% 
  reduce(cbind) %>% # bring together the wave predictions 
  as.data.frame() %>% # make data frame
  setNames(c(3,5,7,11,14,17)) %>% # give names to variables
  mutate(id = row_number()) %>% # make unique id
  gather(-id, key = Sweep, value = pred) # make long format

pred_lgm_lin <- as.data.frame(predict(mcs_ttl_fit_adj))
pred_lgm_long_lin <-  map(c(3,5,7,11,14,17), # loop over time
                     function(x) pred_lgm_lin[, 1] + x * pred_lgm_lin[, 2]) %>% 
  reduce(cbind) %>% # bring together the wave predictions 
  as.data.frame() %>% # make data frame
  setNames(c(3,5,7,11,14,17)) %>% # give names to variables
  mutate(id = row_number()) %>% # make unique id
  gather(-id, key = Sweep, value = pred) # make long format




# Plot
ggplot() +
  stat_summary(
    data = pred_lgm_long_lin,
    aes(x = as.numeric(Sweep), y = pred, group = 1, linetype = "linear"),
    fun = mean,
    geom = "line",
    size = 1.5
  ) +
  stat_summary(
    data = pred_lgm_long_qua,
    aes(x = as.numeric(Sweep), y = pred, group = 1, linetype = "quadratic"),
    fun = mean,
    geom = "line",
    size = 1.5
  ) +
  theme_bw() +
  labs(y = "SDQ total", x = "Sweep") 



```
# Plots age-str
```{r}
# Early 
MCS_autism_early_sdq_ttl <- MCS_sdq_autism_early[,c(1,9,15,21,27,33,39,45)]

MCS_autism_early_sdq_ttl_long <- melt(setDT(MCS_autism_early_sdq_ttl), id.vars = c("MCSID","Sex"), variable.name = "sweep")

MCS_autism_early_ttl_summary <- MCS_autism_early_sdq_ttl_long %>%
  dplyr::group_by(sweep) %>%
  dplyr::summarise(
    sd = sd(value),
    ttl_mean = mean(value)
  )
MCS_autism_early_ttl_summary$group <- "early"

MCS_autism_early_ttl_summary_male <- MCS_autism_early_sdq_ttl_long %>%
  filter(Sex == "Male") %>% 
  dplyr::group_by(sweep) %>%
  dplyr::summarise(
    sd = sd(value),
    ttl_mean = mean(value),
    se = plotrix::std.error(value)
  )
MCS_autism_early_ttl_summary_male$group <- "Male-early"

# Late

MCS_autism_late_sdq_ttl <- MCS_sdq_autism_late[,c(1,9,15,21,27,33,39,45)]

MCS_autism_late_sdq_ttl_long <- melt(setDT(MCS_autism_late_sdq_ttl), id.vars = c("MCSID","Sex"), variable.name = "sweep")

MCS_autism_late_ttl_summary <- MCS_autism_late_sdq_ttl_long %>%
   dplyr::group_by(sweep) %>%
   dplyr::summarise(
    sd = sd(value),
    ttl_mean = mean(value)
  )
MCS_autism_late_ttl_summary$group <- "late"


MCS_autism_late_ttl_summary_male <- MCS_autism_late_sdq_ttl_long %>%
  filter(Sex == "Male") %>% 
   dplyr::group_by(sweep) %>%
   dplyr::summarise(
    sd = sd(value),
    ttl_mean = mean(value),
    se = plotrix::std.error(value)
  )
MCS_autism_late_ttl_summary_male$group <- "Male-late"

# No diagnosis

MCS_no_diag_sdq_ttl <- MCS_sdq_no_diag[,c(1,9,15,21,27,33,39,42)]

MCS_no_diag_sdq_ttl_long <- melt(setDT(MCS_no_diag_sdq_ttl), id.vars = c("MCSID","Sex"), variable.name = "sweep")

MCS_no_diag_ttl_summary <- MCS_no_diag_sdq_ttl_long %>%
   dplyr::group_by(sweep) %>%
   dplyr::summarise(
    sd = sd(value),
    ttl_mean = mean(value)
  )
MCS_no_diag_ttl_summary$group <- "no diag"

MCS_no_diag_ttl_summary_male <- MCS_no_diag_sdq_ttl_long %>%
  filter(Sex == "Male") %>% 
   dplyr::group_by(sweep) %>%
   dplyr::summarise(
    sd = sd(value),
    ttl_mean = mean(value),
    se = plotrix::std.error(value)
  )
MCS_no_diag_ttl_summary_male$group <- "Male-no diag"
```
```{r}
MCS_autism_early_ttl_summary$lb = MCS_autism_early_ttl_summary$ttl_mean - MCS_autism_early_ttl_summary$sd
MCS_autism_early_ttl_summary$ub = MCS_autism_early_ttl_summary$ttl_mean + MCS_autism_early_ttl_summary$sd
MCS_autism_late_ttl_summary$lb = MCS_autism_late_ttl_summary$ttl_mean - MCS_autism_late_ttl_summary$sd
MCS_autism_late_ttl_summary$ub = MCS_autism_late_ttl_summary$ttl_mean + MCS_autism_late_ttl_summary$sd
MCS_no_diag_ttl_summary$lb = MCS_no_diag_ttl_summary$ttl_mean - MCS_no_diag_ttl_summary$sd
MCS_no_diag_ttl_summary$ub = MCS_no_diag_ttl_summary$ttl_mean + MCS_no_diag_ttl_summary$sd
MCS_sdq_total_mean_full <- rbind(MCS_autism_early_ttl_summary, MCS_autism_late_ttl_summary,MCS_no_diag_ttl_summary)
MCS_sdq_total_mean_full <- MCS_sdq_total_mean_full %>% mutate(sweep.age = case_when(
  sweep == "BEBDTOT" ~ 3,
  sweep == "CEBDTOT" ~ 5,
  sweep == "DDDEBDTOT" ~ 7,
   sweep == "EEBDTOT" ~ 11,
   sweep == "FEBDTOT" ~ 14,
   sweep == "GEBDTOT" ~ 17,
))
MCS_sdq_total_mean_full
```


```{r}
MCS_autism_early_ttl_summary_male$lb = MCS_autism_early_ttl_summary_male$ttl_mean - 1.96*MCS_autism_early_ttl_summary_male$se
MCS_autism_early_ttl_summary_male$ub = MCS_autism_early_ttl_summary_male$ttl_mean + 1.96*MCS_autism_early_ttl_summary_male$se
MCS_autism_late_ttl_summary_male$lb = MCS_autism_late_ttl_summary_male$ttl_mean - 1.96*MCS_autism_late_ttl_summary_male$se
MCS_autism_late_ttl_summary_male$ub = MCS_autism_late_ttl_summary_male$ttl_mean + 1.96*MCS_autism_late_ttl_summary_male$se
MCS_no_diag_ttl_summary_male$lb = MCS_no_diag_ttl_summary_male$ttl_mean - 1.96*MCS_no_diag_ttl_summary_male$se
MCS_no_diag_ttl_summary_male$ub = MCS_no_diag_ttl_summary_male$ttl_mean + 1.96*MCS_no_diag_ttl_summary_male$se
MCS_sdq_total_mean_full_male <- rbind(MCS_autism_early_ttl_summary_male, MCS_autism_late_ttl_summary_male,MCS_no_diag_ttl_summary_male)
MCS_sdq_total_mean_full_male <- MCS_sdq_total_mean_full_male %>% mutate(sweep.age = case_when(
  sweep == "BEBDTOT" ~ 3,
  sweep == "CEBDTOT" ~ 5,
  sweep == "DDDEBDTOT" ~ 7,
   sweep == "EEBDTOT" ~ 11,
   sweep == "FEBDTOT" ~ 14,
   sweep == "GEBDTOT" ~ 17,
))

MCS_sdq_total_mean_full_male

```


```{r}
library(RColorBrewer)
my_colors <- brewer.pal(12, "Paired")[c(2,8,4)]
p <- ggplot(MCS_sdq_total_mean_full_male, aes(x = as.numeric(sweep.age), y = ttl_mean, colour = group)) + geom_line(data = MCS_sdq_total_mean_full_male, aes(x = as.numeric(sweep.age), y = ttl_mean, colour = group)) + geom_point() 
p

breaks = seq(min(as.numeric(MCS_no_diag_ttl_summary_male$sweep)),max(as.numeric(MCS_no_diag_ttl_summary_male$sweep)), length.out = 6)
age <- c("3","5","7","11","14","17")

MCS_full_ttl_in_display_male <- p+geom_ribbon(data = MCS_sdq_total_mean_full_male, aes(x = sweep.age,ymin = lb, ymax = ub), linetype = 2, alpha = 0.2) + scale_x_continuous(breaks = as.numeric(age) ,labels= age) + labs(y = "SDQ Total Score", x = "age(years)")+ scale_colour_manual(values = my_colors)+theme_classic()+ theme(legend.position = "bottom")

MCS_full_ttl_in_display_male


```


```{r}
pred_lgm_qua_early <- as.data.frame(predict(mcs_agestr_ttl_fit_adj_2)$'1')
pred_lgm_qua_late <- as.data.frame(predict(mcs_agestr_ttl_fit_adj_2)$'2')
pred_lgm_qua_no_diag <- as.data.frame(predict(mcs_agestr_ttl_fit_adj_2)$'3')
pred_lgm_long_qua_early <- map(c(3,5,7,11,14,17), # loop over time
                     function(x) pred_lgm_qua_early[, 1] + x * pred_lgm_qua_early[, 2] + x^2 * pred_lgm_qua_early[,3]) %>% 
  reduce(cbind) %>% # bring together the wave predictions 
  as.data.frame() %>% # make data frame
  setNames(c(3,5,7,11,14,17)) %>% # give names to variables
  mutate(id = row_number()) %>% # make unique id
  gather(-id, key = Sweep, value = pred) %>% mutate(group = "early")

pred_lgm_long_qua_late <- map(c(3,5,7,11,14,17), # loop over time
                     function(x) pred_lgm_qua_late[, 1] + x * pred_lgm_qua_late[, 2] + x^2 * pred_lgm_qua_late[,3]) %>% 
  reduce(cbind) %>% # bring together the wave predictions 
  as.data.frame() %>% # make data frame
  setNames(c(3,5,7,11,14,17)) %>% # give names to variables
  mutate(id = row_number()) %>% # make unique id
  gather(-id, key = Sweep, value = pred) %>% mutate(group = "late")

pred_lgm_long_qua_no_diag <- map(c(3,5,7,11,14,17), # loop over time
                     function(x) pred_lgm_qua_no_diag[, 1] + x * pred_lgm_qua_no_diag[, 2] + x^2 * pred_lgm_qua_no_diag[,3]) %>% 
  reduce(cbind) %>% # bring together the wave predictions 
  as.data.frame() %>% # make data frame
  setNames(c(3,5,7,11,14,17)) %>% # give names to variables
  mutate(id = row_number()) %>% # make unique id
  gather(-id, key = Sweep, value = pred) %>% mutate(group = "no diag")


## load the linear coefficients
pred_lgm_lin_early <- as.data.frame(predict(mcs_agestr_ttl_fit_adj)$'1')
pred_lgm_lin_late <- as.data.frame(predict(mcs_agestr_ttl_fit_adj)$'2')
pred_lgm_lin_no_diag <- as.data.frame(predict(mcs_agestr_ttl_fit_adj)$'3')

pred_lgm_long_lin_early <- map(c(3,5,7,11,14,17), # loop over time
                     function(x) pred_lgm_lin_early[, 1] + x * pred_lgm_lin_early[, 2] ) %>% 
  reduce(cbind) %>% # bring together the wave predictions 
  as.data.frame() %>% # make data frame
  setNames(c(3,5,7,11,14,17)) %>% # give names to variables
  mutate(id = row_number()) %>% # make unique id
  gather(-id, key = Sweep, value = pred) %>% mutate(group = "early")

pred_lgm_long_lin_late <- map(c(3,5,7,11,14,17), # loop over time
                     function(x) pred_lgm_lin_late[, 1] + x * pred_lgm_lin_late[, 2]) %>% 
  reduce(cbind) %>% # bring together the wave predictions 
  as.data.frame() %>% # make data frame
  setNames(c(3,5,7,11,14,17)) %>% # give names to variables
  mutate(id = row_number()) %>% # make unique id
  gather(-id, key = Sweep, value = pred) %>% mutate(group = "late")

pred_lgm_long_lin_no_diag <- map(c(3,5,7,11,14,17), # loop over time
                     function(x) pred_lgm_lin_no_diag[, 1] + x * pred_lgm_lin_no_diag[, 2]) %>% 
  reduce(cbind) %>% # bring together the wave predictions 
  as.data.frame() %>% # make data frame
  setNames(c(3,5,7,11,14,17)) %>% # give names to variables
  dplyr::mutate(id = row_number()) %>% # make unique id
  gather(-id, key = Sweep, value = pred) %>% dplyr::mutate(group = "no diag")


colnames(MCS_sdq_total_mean_full)[7] <- "Sweep"
# Plot

my_colors <- brewer.pal(12, "Paired")[c(2,8,4)]
ggplot(MCS_sdq_total_mean_full, aes(x = as.numeric(Sweep), y = ttl_mean, colour = group)) + geom_line(data = MCS_sdq_total_mean_full, aes(x = as.numeric(Sweep), y = ttl_mean, colour = group)) + geom_point()  + geom_ribbon(data = MCS_sdq_total_mean_full, aes(x = as.numeric(Sweep),ymin = lb, ymax = ub), linetype = 4, alpha = 0.2) + 
  stat_summary(
    data = pred_lgm_long_lin_early,
    aes(x = as.numeric(Sweep), y = pred,  linetype = "linear", colour = "early"),
    fun = mean,
    geom = "line",
    size = 1
  ) +
  stat_summary(
    data = pred_lgm_long_lin_late,
    aes(x = as.numeric(Sweep), y = pred,  linetype = "linear", colour = "late"),
    fun = mean,
    geom = "line",
    size = 1
  ) +
   stat_summary(
    data = pred_lgm_long_lin_no_diag,
    aes(x = as.numeric(Sweep), y = pred,  linetype = "linear", colour = "no diag"),
    fun = mean,
    geom = "line",
    size = 1
  ) +
stat_summary(
    data = pred_lgm_long_qua_early,
    aes(x = as.numeric(Sweep), y = pred,  linetype = "quadratic", colour = "early"),
    fun = mean,
    geom = "line",
    size = 1
  ) +
stat_summary(
    data = pred_lgm_long_qua_late,
    aes(x = as.numeric(Sweep), y = pred,  linetype = "quadratic", colour = "late"),
    fun = mean,
    geom = "line",
    size = 1
  ) +
  stat_summary(
    data = pred_lgm_long_qua_no_diag,
    aes(x = as.numeric(Sweep), y = pred,  linetype = "quadratic", colour = "no diag"),
    fun = mean,
    geom = "line",
    size = 1
  ) +
  theme_bw() +theme_classic()+
  scale_colour_manual(values = my_colors)+
  labs(y = "MCS SDQ Total Score", x = "Age (years)")  
  
```

# Plots sex-str
```{r}

MCS_sdq_autism_ttl <- MCS_sdq_autism[,c(1,9,15,21,27,33,39,45,43,47)]
MCS_sdq_autism_ttl[,2:7] <- lapply(MCS_sdq_autism_ttl[,2:7], as.numeric)

MCS_autism_female_ttl <- MCS_sdq_autism_ttl[MCS_sdq_autism_ttl$Sex == "Female",]
MCS_autism_female_sdq_ttl_long <- melt(setDT(MCS_autism_female_ttl), id.vars = c("MCSID","ASD.Diagnosis.Age","grp","Sex"), variable.name = "sweep")

MCS_autism_female_ttl_summary <- MCS_autism_female_sdq_ttl_long %>%
  dplyr::group_by(sweep) %>%
  dplyr::summarise(
    sd = sd(value),
    ttl_mean = mean(value), se = plotrix::std.error(value)
  )
MCS_autism_female_ttl_summary$group <- "autistic female"

# male
MCS_autism_male_ttl <- MCS_sdq_autism_ttl[MCS_sdq_autism_ttl$Sex == "Male",]

MCS_autism_male_sdq_ttl_long <- melt(setDT(MCS_autism_male_ttl), id.vars = c("MCSID","ASD.Diagnosis.Age","grp","Sex"), variable.name = "sweep")

MCS_autism_male_ttl_summary <- MCS_autism_male_sdq_ttl_long %>%
   dplyr::group_by(sweep) %>%
   dplyr::summarise(
    sd = sd(value),
    ttl_mean = mean(value), se = plotrix::std.error(value)
  )
MCS_autism_male_ttl_summary$group <- "autistic male"

# No diagnosis

MCS_no_diag_sdq_ttl <- MCS_sdq_no_diag[,c(1,9,15,21,27,33,39,42)]

MCS_no_diag_sdq_ttl_long <- melt(setDT(MCS_no_diag_sdq_ttl), id.vars = c("MCSID","Sex"), variable.name = "sweep")

MCS_no_diag_ttl_summary <- MCS_no_diag_sdq_ttl_long %>%
   dplyr::group_by(sweep) %>%
   dplyr::summarise(
    sd = sd(value),
    ttl_mean = mean(value), se = plotrix::std.error(value)
  )
MCS_no_diag_ttl_summary$group <- "no autism"
```

```{r}
MCS_autism_female_ttl_summary$lb = MCS_autism_female_ttl_summary$ttl_mean - 1.96*MCS_autism_female_ttl_summary$se
MCS_autism_female_ttl_summary$ub = MCS_autism_female_ttl_summary$ttl_mean + 1.96*MCS_autism_female_ttl_summary$se
MCS_autism_male_ttl_summary$lb = MCS_autism_male_ttl_summary$ttl_mean - 1.96*MCS_autism_male_ttl_summary$se
MCS_autism_male_ttl_summary$ub = MCS_autism_male_ttl_summary$ttl_mean + 1.96*MCS_autism_male_ttl_summary$se
MCS_no_diag_ttl_summary$lb = MCS_no_diag_ttl_summary$ttl_mean - 1.96*MCS_no_diag_ttl_summary$se
MCS_no_diag_ttl_summary$ub = MCS_no_diag_ttl_summary$ttl_mean + 1.96*MCS_no_diag_ttl_summary$se
MCS_sdq_total_mean_full_sexstr <- rbind(MCS_autism_female_ttl_summary, MCS_autism_male_ttl_summary,MCS_no_diag_ttl_summary)
MCS_sdq_total_mean_full_sexstr <- MCS_sdq_total_mean_full_sexstr %>% mutate(sweep.age = case_when(
  sweep == "BEBDTOT" ~ 3,
  sweep == "CEBDTOT" ~ 5,
  sweep == "DDDEBDTOT" ~ 7,
   sweep == "EEBDTOT" ~ 11,
   sweep == "FEBDTOT" ~ 14,
   sweep == "GEBDTOT" ~ 17,
))

```


```{r}
pred_lgm_qua_female <- as.data.frame(predict(mcs_sexstr_ttl_fit_adj_2)$'Female')
pred_lgm_qua_male <- as.data.frame(predict(mcs_sexstr_ttl_fit_adj_2)$'Male')
pred_lgm_qua_no_diag <- as.data.frame(predict(mcs_agestr_ttl_fit_adj_2)$'3')
pred_lgm_long_qua_female <- map(c(3,5,7,11,14,17), # loop over time
                     function(x) pred_lgm_qua_female[, 1] + x * pred_lgm_qua_female[, 2] + x^2 * pred_lgm_qua_female[,3]) %>% 
  reduce(cbind) %>% # bring together the wave predictions 
  as.data.frame() %>% # make data frame
  setNames(c(3,5,7,11,14,17)) %>% # give names to variables
  mutate(id = row_number()) %>% # make unique id
  gather(-id, key = Sweep, value = pred) %>% mutate(group = "autistic female")

pred_lgm_long_qua_male <- map(c(3,5,7,11,14,17), # loop over time
                     function(x) pred_lgm_qua_male[, 1] + x * pred_lgm_qua_male[, 2] + x^2 * pred_lgm_qua_male[,3]) %>% 
  reduce(cbind) %>% # bring together the wave predictions 
  as.data.frame() %>% # make data frame
  setNames(c(3,5,7,11,14,17)) %>% # give names to variables
  mutate(id = row_number()) %>% # make unique id
  gather(-id, key = Sweep, value = pred) %>% mutate(group = "autistic male")

pred_lgm_long_qua_no_diag <- map(c(3,5,7,11,14,17), # loop over time
                     function(x) pred_lgm_qua_no_diag[, 1] + x * pred_lgm_qua_no_diag[, 2] + x^2 * pred_lgm_qua_no_diag[,3]) %>% 
  reduce(cbind) %>% # bring together the wave predictions 
  as.data.frame() %>% # make data frame
  setNames(c(3,5,7,11,14,17)) %>% # give names to variables
  mutate(id = row_number()) %>% # make unique id
  gather(-id, key = Sweep, value = pred) %>% mutate(group = "no autism")


## load the linear coefficients
pred_lgm_lin_female <- as.data.frame(predict(mcs_sexstr_ttl_fit_adj)$'Female')
pred_lgm_lin_male <- as.data.frame(predict(mcs_sexstr_ttl_fit_adj)$'Male')
pred_lgm_lin_no_diag <- as.data.frame(predict(mcs_agestr_ttl_fit_adj)$'3')

pred_lgm_long_lin_female <- map(c(3,5,7,11,14,17), # loop over time
                     function(x) pred_lgm_lin_female[, 1] + x * pred_lgm_lin_female[, 2] ) %>% 
  reduce(cbind) %>% # bring together the wave predictions 
  as.data.frame() %>% # make data frame
  setNames(c(3,5,7,11,14,17)) %>% # give names to variables
  mutate(id = row_number()) %>% # make unique id
  gather(-id, key = Sweep, value = pred) %>% mutate(group = "autistic female")

pred_lgm_long_lin_male <- map(c(3,5,7,11,14,17), # loop over time
                     function(x) pred_lgm_lin_male[, 1] + x * pred_lgm_lin_male[, 2]) %>% 
  reduce(cbind) %>% # bring together the wave predictions 
  as.data.frame() %>% # make data frame
  setNames(c(3,5,7,11,14,17)) %>% # give names to variables
  mutate(id = row_number()) %>% # make unique id
  gather(-id, key = Sweep, value = pred) %>% mutate(group = "autistic male")

pred_lgm_long_lin_no_diag <- map(c(3,5,7,11,14,17), # loop over time
                     function(x) pred_lgm_lin_no_diag[, 1] + x * pred_lgm_lin_no_diag[, 2]) %>% 
  reduce(cbind) %>% # bring together the wave predictions 
  as.data.frame() %>% # make data frame
  setNames(c(3,5,7,11,14,17)) %>% # give names to variables
  dplyr::mutate(id = row_number()) %>% # make unique id
  gather(-id, key = Sweep, value = pred) %>% dplyr::mutate(group = "no diag")


colnames(MCS_sdq_total_mean_full_sexstr)[8] <- "Sweep"
# Plot



my_colors <- brewer.pal(12, "Paired")[c(5,1,4)]
ggplot(MCS_sdq_total_mean_full_sexstr, aes(x = as.numeric(Sweep), y = ttl_mean, colour = group)) + geom_line(data = MCS_sdq_total_mean_full_sexstr, aes(x = as.numeric(Sweep), y = ttl_mean, colour = group)) + geom_point()  + geom_ribbon(data = MCS_sdq_total_mean_full_sexstr, aes(x = as.numeric(Sweep),ymin = lb, ymax = ub), linetype = 2, alpha = 0.2) +  theme_classic() + scale_colour_manual(values = my_colors)+
  labs(y = "MCS SDQ Total Score", x = "Age (years)")  + theme(legend.position = "bottom")
```
  stat_summary(
    data = pred_lgm_long_lin_female,
    aes(x = as.numeric(Sweep), y = pred, colour = "autistic female"),
    fun = mean,
    geom = "line",
    size = 1
  ) +
  stat_summary(
    data = pred_lgm_long_lin_male,
    aes(x = as.numeric(Sweep), y = pred,  colour = "autistic male"),
    fun = mean,
    geom = "line",
    size = 1
  ) +
   stat_summary(
    data = pred_lgm_long_lin_no_diag,
    aes(x = as.numeric(Sweep), y = pred,   colour = "no diag"),
    fun = mean,
    geom = "line",
    size = 1
  ) + theme_classic() +
 



stat_summary(
    data = pred_lgm_long_qua_female,
    aes(x = as.numeric(Sweep), y = pred,  linetype = "quadratic", colour = "autistic female"),
    fun = mean,
    geom = "line",
    size = 1
  ) +
stat_summary(
    data = pred_lgm_long_qua_male,
    aes(x = as.numeric(Sweep), y = pred,  linetype = "quadratic", colour = "autistic male"),
    fun = mean,
    geom = "line",
    size = 1
  ) +
  stat_summary(
    data = pred_lgm_long_qua_no_diag,
    aes(x = as.numeric(Sweep), y = pred,  linetype = "quadratic", colour = "no diag"),
    fun = mean,
    geom = "line",
    size = 1
  ) +
  theme_bw() +
  theme_classic() + scale_colour_manual(values = my_colors)+
  labs(y = "MCS SDQ Total Score", x = "Age (years)")  
# z-test function

```{r}
calc_z_p_values <- function(est1, se1, est2, se2) {
  z_score <- (est1 - est2) / sqrt(se1^2 + se2^2)
  p_value <- 2 * (1 - pnorm(abs(z_score)))
  return(c(z_score, p_value))
}

```
# On males only
```{r}

mcs_agestr_ttl_adj <- "
int =~ 1*BEBDTOT + 1*CEBDTOT + 1*DDDEBDTOT + 1*EEBDTOT + 1*FEBDTOT + 1*GEBDTOT
slp =~ 3*BEBDTOT + 5*CEBDTOT + 7*DDDEBDTOT + 11*EEBDTOT + 14*FEBDTOT + 17*GEBDTOT

# the parametres for slope reflect the designed ages at corresponding sweeps
"
mcs_agestr_ttl_fit_boy <- growth(mcs_agestr_ttl_adj, data = MCS_sdq_all[MCS_sdq_all$Sex == "Male",], group = "grp_num",  missing = "fiml", estimator = "ml", fixed.x = F)
#summary(mcs_agestr_ttl_fit_boy)

```





## Emotional symptoms
```{r}
mcs_autism_emo_adj <- "
int =~ 1*BEMOTION + 1*CEMOTION + 1*DDEMOTION + 1*EEMOTION + 1*FEMOTION + 1*GEMOTION
slp =~ 3*BEMOTION + 5*CEMOTION + 7*DDEMOTION + 11*EEMOTION + 14*FEMOTION + 17*GEMOTION
int ~ sex_num + grp_num
slp ~ sex_num + grp_num
sex_num ~~ sex_num
grp_num ~~ grp_num
# the parametres for slope reflect the designed ages at corresponding sweeps
"


fit_mcs_autism_emo_adj <- growth(mcs_autism_emo_adj, data = MCS_sdq_autism,  missing = "fiml", estimator = "ml", fixed.x = F)
summary(fit_mcs_autism_emo_adj)
```

```{r}
mcs_agestr_emo_adj <- "
int =~ 1*BEMOTION + 1*CEMOTION + 1*DDEMOTION + 1*EEMOTION + 1*FEMOTION + 1*GEMOTION
slp =~ 3*BEMOTION + 5*CEMOTION + 7*DDEMOTION + 11*EEMOTION + 14*FEMOTION + 17*GEMOTION

# the parametres for slope reflect the designed ages at corresponding sweeps
"
mcs_agestr_emo_fit_adj <- growth(mcs_agestr_emo_adj, data = MCS_sdq_all, group = "grp_num",  missing = "fiml", estimator = "ml", fixed.x = F)
summary(mcs_agestr_emo_fit_adj)
```


```{r}
est_mcs_agestr_emo_fit_adj <- parameterEstimates(mcs_agestr_emo_fit_adj) %>% filter(grepl("^(int|slp)$", lhs) & op == "~1")
results_mcs_agestr_emo <- est_mcs_agestr_emo_fit_adj %>%
  dplyr::select(lhs,group, est, ci.lower, ci.upper, pvalue) %>%
  mutate(Estimates = paste(round(est, 2), " [", round(ci.lower, 2), ", ", round(ci.upper, 2), "]"),
         p_value = round(pvalue,3)) %>%
  dplyr::select(lhs,group,Estimates, p_value)
results_mcs_agestr_emo
```

## z-test of difference
```{r}
emo_int_early <- est_mcs_agestr_emo_fit_adj %>% filter(lhs == "int" & group == 3) %>% select(est,se)
emo_int_late <- est_mcs_agestr_emo_fit_adj %>% filter(lhs == "int" & group == 2) %>% select(est,se)
emo_slp_early <- est_mcs_agestr_emo_fit_adj %>% filter(lhs == "slp" & group == 3) %>% select(est,se)
emo_slp_late <- est_mcs_agestr_emo_fit_adj %>% filter(lhs == "slp" & group == 2) %>% select(est,se)

emo_int_mean_early <- emo_int_early$est
emo_int_se_early <- emo_int_early$se
emo_int_mean_late <- emo_int_late$est
emo_int_se_late <- emo_int_late$se
emo_int_diff <- calc_z_p_values(emo_int_mean_early,emo_int_se_early,emo_int_mean_late,emo_int_se_late)
emo_int_diff
emo_slp_mean_early <- emo_slp_early$est
emo_slp_se_early <- emo_slp_early$se
emo_slp_mean_late <- emo_slp_late$est
emo_slp_se_late <- emo_slp_late$se
emo_slp_diff <-calc_z_p_values(emo_slp_mean_early,emo_slp_se_early,emo_slp_mean_late,emo_slp_se_late)
emo_slp_diff
```


```{r}
mcs_sexstr_emo_adj <- "
int =~ 1*BEMOTION + 1*CEMOTION + 1*DDEMOTION + 1*EEMOTION + 1*FEMOTION + 1*GEMOTION
slp =~ 3*BEMOTION + 5*CEMOTION + 7*DDEMOTION + 11*EEMOTION + 14*FEMOTION + 17*GEMOTION

# the parametres for slope reflect the designed ages at corresponding sweeps
"
fit_mcs_autism_emo_adj <- growth(mcs_sexstr_emo_adj, data = MCS_sdq_autism, missing = "fiml", estimator = "ml", fixed.x = F)
mcs_sexstr_emo_fit_adj <- growth(mcs_sexstr_emo_adj, data = MCS_sdq_autism, group = "Sex",  missing = "fiml", estimator = "ml", fixed.x = F)
#summary(mcs_sexstr_emo_fit_adj)
mcs_agestr_emo_fit_adj_asd <- growth(mcs_sexstr_emo_adj, data = MCS_sdq_autism, group = "grp_num",  missing = "fiml", estimator = "ml", fixed.x = F)
#summary(mcs_sexstr_ttl_fit_adj)
```
```{r}
anova_emo_age <- anova(fit_mcs_autism_emo_adj,mcs_agestr_emo_fit_adj_asd)
anova_emo_sex <- anova(fit_mcs_autism_emo_adj,mcs_sexstr_emo_fit_adj)
anova_emo_age_results<- data.frame(anova_emo_age)
anova_emo_sex_results<- data.frame(anova_emo_sex)
anova_emo <- rbind(anova_emo_age_results,anova_emo_sex_results)
anova_emo

```

```{r}
est_mcs_sexstr_emo_fit_adj <- parameterEstimates(mcs_sexstr_emo_fit_adj) %>% filter(grepl("^(int|slp)$", lhs) & op == "~1")
results_mcs_sexstr_emo <- est_mcs_sexstr_emo_fit_adj %>%
  dplyr::select(lhs,group, est, ci.lower, ci.upper, pvalue) %>%
  mutate(Estimates = paste(round(est, 2), " [", round(ci.lower, 2), ", ", round(ci.upper, 2), "]"),
         p_value = round(pvalue,3)) %>%
  dplyr::select(lhs,group,Estimates, p_value)
results_mcs_sexstr_emo
```

### quadratic
```{r}
mcs_agestr_emo_adj_2 <- "
int =~ 1*BEMOTION + 1*CEMOTION + 1*DDEMOTION + 1*EEMOTION + 1*FEMOTION + 1*GEMOTION
slp =~ 3*BEMOTION + 5*CEMOTION + 7*DDEMOTION + 11*EEMOTION + 14*FEMOTION + 17*GEMOTION
qua =~ 9*BEMOTION + 25*CEMOTION + 49*DDEMOTION + 121*EEMOTION + 196*FEMOTION + 289*GEMOTION
GEMOTION ~~ 1*GEMOTION
# the parametres for slope reflect the designed ages at corresponding sweeps
"


mcs_emo_fit_adj_2 <- growth(mcs_agestr_emo_adj_2, data = MCS_sdq_all,  missing = "fiml", estimator = "ml", fixed.x = F)
#summary(mcs_emo_fit_adj_2)
mcs_agestr_emo_fit_adj_2 <- growth(mcs_agestr_emo_adj_2, data = MCS_sdq_all, group = "grp_num", missing = "fiml", estimator = "ml", fixed.x = F)
#summary(mcs_agestr_emo_fit_adj_2)
mcs_sexstr_emo_fit_adj_2 <- growth(mcs_agestr_emo_adj_2, data = MCS_sdq_autism, group = "Sex", missing = "fiml", estimator = "ml", fixed.x = F)
#summary(mcs_sexstr_emo_fit_adj_2)
```

### cubic 

```{r}
mcs_agestr_emo_adj_3 <- "
int =~ 1*BEMOTION + 1*CEMOTION + 1*DDEMOTION + 1*EEMOTION + 1*FEMOTION + 1*GEMOTION
slp =~ .3*BEMOTION + .5*CEMOTION + .7*DDEMOTION + 1.1*EEMOTION + 1.4*FEMOTION + 1.7*GEMOTION
qua =~ .09*BEMOTION + .25*CEMOTION + .49*DDEMOTION + 1.21*EEMOTION + 1.96*FEMOTION + 2.89*GEMOTION
cub =~ .027*BEMOTION + .125*CEMOTION + .343*DDEMOTION + 1.331*EEMOTION + 2.744*FEMOTION + 4.913*GEMOTION
# the parametres for slope reflect the designed ages at corresponding sweeps
"


mcs_emo_fit_adj_3 <- growth(mcs_agestr_emo_adj_3, data = MCS_sdq_autism,  missing = "fiml", estimator = "ml", fixed.x = F)
summary(mcs_emo_fit_adj_3)
mcs_agestr_emo_fit_adj_3 <- growth(mcs_agestr_emo_adj_3, data = MCS_sdq_autism, group = "grp_num", missing = "fiml", estimator = "ml", fixed.x = F)
summary(mcs_agestr_emo_fit_adj_3)
# removed group = "grp_num" , 
```

## Conduct problems
```{r}
mcs_autism_con_adj <- "
int =~ 1*BCONDUCT + 1*CCONDUCT + 1*DDCONDUCT + 1*ECONDUCT + 1*FCONDUCT + 1*GCONDUCT
slp =~ 3*BCONDUCT + 5*CCONDUCT + 7*DDCONDUCT + 11*ECONDUCT + 14*FCONDUCT + 17*GCONDUCT
int ~ sex_num + grp_num
slp ~ sex_num + grp_num
sex_num ~~ sex_num
grp_num ~~ grp_num
# the parametres for slope reflect the designed ages at corresponding sweeps
"


fit_mcs_autism_con_adj <- growth(mcs_autism_con_adj, data = MCS_sdq_autism,  missing = "fiml", estimator = "ml", fixed.x = F)
summary(fit_mcs_autism_con_adj)
```

```{r}
mcs_agestr_con_adj <- "
int =~ 1*BCONDUCT + 1*CCONDUCT + 1*DDCONDUCT + 1*ECONDUCT + 1*FCONDUCT + 1*GCONDUCT
slp =~ 3*BCONDUCT + 5*CCONDUCT + 7*DDCONDUCT + 11*ECONDUCT + 14*FCONDUCT + 17*GCONDUCT

# the parametres for slope reflect the designed ages at corresponding sweeps
"
mcs_agestr_con_fit_adj <- growth(mcs_agestr_con_adj, data = MCS_sdq_all, group = "grp_num",  missing = "fiml", estimator = "ml", fixed.x = F)
#summary(mcs_agestr_con_fit_adj)
```


```{r}
est_mcs_agestr_con_fit_adj <- parameterEstimates(mcs_agestr_con_fit_adj) %>% filter(grepl("^(int|slp)$", lhs) & op == "~1")
results_mcs_agestr_con <- est_mcs_agestr_con_fit_adj %>%
  dplyr::select(lhs,group, est, ci.lower, ci.upper, pvalue) %>%
  mutate(Estimates = paste(round(est, 2), " [", round(ci.lower, 2), ", ", round(ci.upper, 2), "]"),
         p_value = round(pvalue,3)) %>%
  dplyr::select(lhs,group,Estimates, p_value)
results_mcs_agestr_con
```

## z-test of difference
```{r}
con_int_early <- est_mcs_agestr_con_fit_adj %>% filter(lhs == "int" & group == 3) %>% select(est,se)
con_int_late <- est_mcs_agestr_con_fit_adj %>% filter(lhs == "int" & group == 2) %>% select(est,se)
con_slp_early <- est_mcs_agestr_con_fit_adj %>% filter(lhs == "slp" & group == 3) %>% select(est,se)
con_slp_late <- est_mcs_agestr_con_fit_adj %>% filter(lhs == "slp" & group == 2) %>% select(est,se)

con_int_mean_early <- con_int_early$est
con_int_se_early <- con_int_early$se
con_int_mean_late <- con_int_late$est
con_int_se_late <- con_int_late$se
con_int_diff <- calc_z_p_values(con_int_mean_early,con_int_se_early,con_int_mean_late,con_int_se_late)
con_int_diff
con_slp_mean_early <- con_slp_early$est
con_slp_se_early <- con_slp_early$se
con_slp_mean_late <- con_slp_late$est
con_slp_se_late <- con_slp_late$se
con_slp_diff <-calc_z_p_values(con_slp_mean_early,con_slp_se_early,con_slp_mean_late,con_slp_se_late)
con_slp_diff
```

```{r}
mcs_sexstr_con_adj <- "
int =~ 1*BCONDUCT + 1*CCONDUCT + 1*DDCONDUCT + 1*ECONDUCT + 1*FCONDUCT + 1*GCONDUCT
slp =~ 3*BCONDUCT + 5*CCONDUCT + 7*DDCONDUCT + 11*ECONDUCT + 14*FCONDUCT + 17*GCONDUCT

# the parametres for slope reflect the designed ages at corresponding sweeps
"
mcs_sexstr_con_fit_adj <- growth(mcs_sexstr_con_adj, data = MCS_sdq_autism, group = "sex",  missing = "fiml", estimator = "ml", fixed.x = F)
#summary(mcs_sexstr_con_fit_adj)
fit_mcs_autism_con_adj <- growth(mcs_sexstr_con_adj, data = MCS_sdq_autism, missing = "fiml", estimator = "ml", fixed.x = F)
mcs_agestr_con_fit_adj_asd <- growth(mcs_sexstr_con_adj, data = MCS_sdq_autism, group = "grp_num",  missing = "fiml", estimator = "ml", fixed.x = F)

```
```{r}
anova_con_age <- anova(fit_mcs_autism_con_adj,mcs_agestr_con_fit_adj_asd)
anova_con_sex <- anova(fit_mcs_autism_con_adj,mcs_sexstr_con_fit_adj)
anova_con_age_results<- data.frame(anova_con_age)
anova_con_sex_results<- data.frame(anova_con_sex)
anova_con <- rbind(anova_con_age_results,anova_con_sex_results)
anova_con
```

```{r}
est_mcs_sexstr_con_fit_adj <- parameterEstimates(mcs_sexstr_con_fit_adj) %>% filter(grepl("^(int|slp)$", lhs) & op == "~1")
results_mcs_sexstr_con <- est_mcs_sexstr_con_fit_adj %>%
  dplyr::select(lhs,group, est, ci.lower, ci.upper, pvalue) %>%
  mutate(Estimates = paste(round(est, 2), " [", round(ci.lower, 2), ", ", round(ci.upper, 2), "]"),
         p_value = round(pvalue,3)) %>%
  dplyr::select(lhs,group,Estimates, p_value)
results_mcs_sexstr_con
```
## Hyperactivity -Inattention
```{r}
mcs_autism_hyp_adj <- "
int =~ 1*BHYPER + 1*CHYPER + 1*DDHYPER + 1*EHYPER + 1*FHYPER + 1*GHYPER
slp =~ 3*BHYPER + 5*CHYPER + 7*DDHYPER + 11*EHYPER + 14*FHYPER + 17*GHYPER
int ~ sex_num + grp_num
slp ~ sex_num + grp_num
sex_num ~~ sex_num
grp_num ~~ grp_num
# the parametres for slope reflect the designed ages at corresponding sweeps
"


fit_mcs_autism_hyp_adj <- growth(mcs_autism_hyp_adj, data = MCS_sdq_autism,  missing = "fiml", estimator = "ml", fixed.x = F)
summary(fit_mcs_autism_hyp_adj)
```

```{r}
mcs_agestr_hyp_adj <- "
int =~ 1*BHYPER + 1*CHYPER + 1*DDHYPER + 1*EHYPER + 1*FHYPER + 1*GHYPER
slp =~ 3*BHYPER + 5*CHYPER + 7*DDHYPER + 11*EHYPER + 14*FHYPER + 17*GHYPER

# the parametres for slope reflect the designed ages at corresponding sweeps
"
mcs_agestr_hyp_fit_adj <- growth(mcs_agestr_hyp_adj, data = MCS_sdq_all, group = "grp_num",  missing = "fiml", estimator = "ml", fixed.x = F)
#summary(mcs_agestr_hyp_fit_adj)
```


```{r}
est_mcs_agestr_hyp_fit_adj <- parameterEstimates(mcs_agestr_hyp_fit_adj) %>% filter(grepl("^(int|slp)$", lhs) & op == "~1")
results_mcs_agestr_hyp <- est_mcs_agestr_hyp_fit_adj %>%
  dplyr::select(lhs,group, est, ci.lower, ci.upper, pvalue) %>%
  mutate(Estimates = paste(round(est, 2), " [", round(ci.lower, 2), ", ", round(ci.upper, 2), "]"),
         p_value = round(pvalue,3)) %>%
  dplyr::select(lhs,group,Estimates, p_value)
results_mcs_agestr_hyp
```
## z-test of difference
```{r}
hyp_int_early <- est_mcs_agestr_hyp_fit_adj %>% filter(lhs == "int" & group == 3) %>% select(est,se)
hyp_int_late <- est_mcs_agestr_hyp_fit_adj %>% filter(lhs == "int" & group == 2) %>% select(est,se)
hyp_slp_early <- est_mcs_agestr_hyp_fit_adj %>% filter(lhs == "slp" & group == 3) %>% select(est,se)
hyp_slp_late <- est_mcs_agestr_hyp_fit_adj %>% filter(lhs == "slp" & group == 2) %>% select(est,se)

hyp_int_mean_early <- hyp_int_early$est
hyp_int_se_early <- hyp_int_early$se
hyp_int_mean_late <- hyp_int_late$est
hyp_int_se_late <- hyp_int_late$se
hyp_int_diff <- calc_z_p_values(hyp_int_mean_early,hyp_int_se_early,hyp_int_mean_late,hyp_int_se_late)
hyp_int_diff
hyp_slp_mean_early <- hyp_slp_early$est
hyp_slp_se_early <- hyp_slp_early$se
hyp_slp_mean_late <- hyp_slp_late$est
hyp_slp_se_late <- hyp_slp_late$se
hyp_slp_diff <-calc_z_p_values(hyp_slp_mean_early,hyp_slp_se_early,hyp_slp_mean_late,hyp_slp_se_late)
hyp_slp_diff
```


```{r}
mcs_sexstr_hyp_adj <- "
int =~ 1*BHYPER + 1*CHYPER + 1*DDHYPER + 1*EHYPER + 1*FHYPER + 1*GHYPER
slp =~ 3*BHYPER + 5*CHYPER + 7*DDHYPER + 11*EHYPER + 14*FHYPER + 17*GHYPER

# the parametres for slope reflect the designed ages at corresponding sweeps
"

mcs_sexstr_hyp_fit_adj <- growth(mcs_sexstr_hyp_adj, data = MCS_sdq_autism, group = "sex",  missing = "fiml", estimator = "ml", fixed.x = F)
#summary(mcs_sexstr_hyp_fit_adj)
fit_mcs_autism_hyp_adj <- growth(mcs_sexstr_hyp_adj, data = MCS_sdq_autism, missing = "fiml", estimator = "ml", fixed.x = F)
mcs_agestr_hyp_fit_adj_asd <- growth(mcs_sexstr_hyp_adj, data = MCS_sdq_autism, group = "grp_num",  missing = "fiml", estimator = "ml", fixed.x = F)

```
```{r}
anova_hyp_age <- anova(fit_mcs_autism_hyp_adj,mcs_agestr_hyp_fit_adj_asd)
anova_hyp_sex <- anova(fit_mcs_autism_hyp_adj,mcs_sexstr_hyp_fit_adj)
anova_hyp_age_results<- data.frame(anova_hyp_age)
anova_hyp_sex_results<- data.frame(anova_hyp_sex)
anova_hyp <- rbind(anova_hyp_age_results,anova_hyp_sex_results)
anova_hyp
```

```{r}
est_mcs_sexstr_hyp_fit_adj <- parameterEstimates(mcs_sexstr_hyp_fit_adj) %>% filter(grepl("^(int|slp)$", lhs) & op == "~1")
results_mcs_sexstr_hyp <- est_mcs_sexstr_hyp_fit_adj %>%
  dplyr::select(lhs,group, est, ci.lower, ci.upper, pvalue) %>%
  mutate(Estimates = paste(round(est, 2), " [", round(ci.lower, 2), ", ", round(ci.upper, 2), "]"),
         p_value = round(pvalue,3)) %>%
  dplyr::select(lhs,group,Estimates, p_value)
results_mcs_sexstr_hyp
```
## Peer relationship problems
```{r}
mcs_autism_peer_adj <- "
int =~ 1*BPEER + 1*CPEER + 1*DDPEER + 1*EPEER + 1*FPEER + 1*GPEER
slp =~ 3*BPEER + 5*CPEER + 7*DDPEER + 11*EPEER + 14*FPEER + 17*GPEER
int ~ sex_num + grp_num
slp ~ sex_num + grp_num
sex_num ~~ sex_num
grp_num ~~ grp_num
# the parametres for slope reflect the designed ages at corresponding sweeps
"


fit_mcs_autism_peer_adj <- growth(mcs_autism_peer_adj, data = MCS_sdq_autism,  missing = "fiml", estimator = "ml", fixed.x = F)
summary(fit_mcs_autism_peer_adj)
```

```{r}
mcs_agestr_peer_adj <- "
int =~ 1*BPEER + 1*CPEER + 1*DDPEER + 1*EPEER + 1*FPEER + 1*GPEER
slp =~ 3*BPEER + 5*CPEER + 7*DDPEER + 11*EPEER + 14*FPEER + 17*GPEER

# the parametres for slope reflect the designed ages at corresponding sweeps
"
mcs_agestr_peer_fit_adj <- growth(mcs_agestr_peer_adj, data = MCS_sdq_all, group = "grp_num",  missing = "fiml", estimator = "ml", fixed.x = F)
#summary(mcs_agestr_peer_fit_adj)
```


```{r}
est_mcs_agestr_peer_fit_adj <- parameterEstimates(mcs_agestr_peer_fit_adj) %>% filter(grepl("^(int|slp)$", lhs) & op == "~1")
results_mcs_agestr_peer <- est_mcs_agestr_peer_fit_adj %>%
  dplyr::select(lhs,group, est, ci.lower, ci.upper, pvalue) %>%
  mutate(Estimates = paste(round(est, 2), " [", round(ci.lower, 2), ", ", round(ci.upper, 2), "]"),
         p_value = round(pvalue,3)) %>%
  dplyr::select(lhs,group,Estimates, p_value)
results_mcs_agestr_peer
```

```{r}
peer_int_early <- est_mcs_agestr_peer_fit_adj %>% filter(lhs == "int" & group == 3) %>% select(est,se)
peer_int_late <- est_mcs_agestr_peer_fit_adj %>% filter(lhs == "int" & group == 2) %>% select(est,se)
peer_slp_early <- est_mcs_agestr_peer_fit_adj %>% filter(lhs == "slp" & group == 3) %>% select(est,se)
peer_slp_late <- est_mcs_agestr_peer_fit_adj %>% filter(lhs == "slp" & group == 2) %>% select(est,se)

peer_int_mean_early <- peer_int_early$est
peer_int_se_early <- peer_int_early$se
peer_int_mean_late <- peer_int_late$est
peer_int_se_late <- peer_int_late$se
peer_int_diff <- calc_z_p_values(peer_int_mean_early,peer_int_se_early,peer_int_mean_late,peer_int_se_late)
peer_int_diff
peer_slp_mean_early <- peer_slp_early$est
peer_slp_se_early <- peer_slp_early$se
peer_slp_mean_late <- peer_slp_late$est
peer_slp_se_late <- peer_slp_late$se
peer_slp_diff <-calc_z_p_values(peer_slp_mean_early,peer_slp_se_early,peer_slp_mean_late,peer_slp_se_late)
peer_slp_diff
```
```{r}
mcs_sexstr_peer_adj <- "
int =~ 1*BPEER + 1*CPEER + 1*DDPEER + 1*EPEER + 1*FPEER + 1*GPEER
slp =~ 3*BPEER + 5*CPEER + 7*DDPEER + 11*EPEER + 14*FPEER + 17*GPEER

# the parametres for slope reflect the designed ages at corresponding sweeps
"

mcs_sexstr_peer_fit_adj <- growth(mcs_sexstr_peer_adj, data = MCS_sdq_autism, group = "sex",  missing = "fiml", estimator = "ml", fixed.x = F)
#summary(mcs_sexstr_peer_fit_adj)
fit_mcs_autism_peer_adj <- growth(mcs_sexstr_peer_adj, data = MCS_sdq_autism, missing = "fiml", estimator = "ml", fixed.x = F)
mcs_agestr_peer_fit_adj_asd <- growth(mcs_sexstr_peer_adj, data = MCS_sdq_autism, group = "grp_num",  missing = "fiml", estimator = "ml", fixed.x = F)

```
```{r}
anova_peer_age <- anova(fit_mcs_autism_peer_adj,mcs_agestr_peer_fit_adj_asd)
anova_peer_sex <- anova(fit_mcs_autism_peer_adj,mcs_sexstr_peer_fit_adj)
anova_peer_age_results<- data.frame(anova_peer_age)
anova_peer_sex_results<- data.frame(anova_peer_sex)
anova_peer <- rbind(anova_peer_age_results,anova_peer_sex_results)
anova_peer
```

```{r}
est_mcs_sexstr_peer_fit_adj <- parameterEstimates(mcs_sexstr_peer_fit_adj) %>% filter(grepl("^(int|slp)$", lhs) & op == "~1")
results_mcs_sexstr_peer <- est_mcs_sexstr_peer_fit_adj %>%
  dplyr::select(lhs,group, est, ci.lower, ci.upper, pvalue) %>%
  mutate(Estimates = paste(round(est, 2), " [", round(ci.lower, 2), ", ", round(ci.upper, 2), "]"),
         p_value = round(pvalue,3)) %>%
  dplyr::select(lhs,group,Estimates, p_value)
results_mcs_sexstr_peer
```
## Prosocial behaviours
```{r}
mcs_autism_pro_adj <- "
int =~ 1*BPROSOC + 1*CPROSOC + 1*DDPROSOC + 1*EPROSOC + 1*FPROSOC + 1*GPROSOC
slp =~ 3*BPROSOC + 5*CPROSOC + 7*DDPROSOC + 11*EPROSOC + 14*FPROSOC + 17*GPROSOC
int ~ sex_num + grp_num
slp ~ sex_num + grp_num
sex_num ~~ sex_num
grp_num ~~ grp_num
# the parametres for slope reflect the designed ages at corresponding sweeps
"


fit_mcs_autism_pro_adj <- growth(mcs_autism_pro_adj, data = MCS_sdq_autism,  missing = "fiml", estimator = "ml", fixed.x = F)
summary(fit_mcs_autism_pro_adj)
```

```{r}
mcs_agestr_pro_adj <- "
int =~ 1*BPROSOC + 1*CPROSOC + 1*DDPROSOC + 1*EPROSOC + 1*FPROSOC + 1*GPROSOC
slp =~ 3*BPROSOC + 5*CPROSOC + 7*DDPROSOC + 11*EPROSOC + 14*FPROSOC + 17*GPROSOC

# the parametres for slope reflect the designed ages at corresponding sweeps
"
mcs_agestr_pro_fit_adj <- growth(mcs_agestr_pro_adj, data = MCS_sdq_all, group = "grp_num",  missing = "fiml", estimator = "ml", fixed.x = F)
#summary(mcs_agestr_pro_fit_adj)
```


```{r}
est_mcs_agestr_pro_fit_adj <- parameterEstimates(mcs_agestr_pro_fit_adj) %>% filter(grepl("^(int|slp)$", lhs) & op == "~1")
results_mcs_agestr_pro <- est_mcs_agestr_pro_fit_adj %>%
  dplyr::select(lhs,group, est, ci.lower, ci.upper, pvalue) %>%
  mutate(Estimates = paste(round(est, 2), " [", round(ci.lower, 2), ", ", round(ci.upper, 2), "]"),
         p_value = round(pvalue,3)) %>%
  dplyr::select(lhs,group,Estimates, p_value)
results_mcs_agestr_pro
```
```{r}
pro_int_early <- est_mcs_agestr_pro_fit_adj %>% filter(lhs == "int" & group == 3) %>% select(est,se)
pro_int_late <- est_mcs_agestr_pro_fit_adj %>% filter(lhs == "int" & group == 2) %>% select(est,se)
pro_slp_early <- est_mcs_agestr_pro_fit_adj %>% filter(lhs == "slp" & group == 3) %>% select(est,se)
pro_slp_late <- est_mcs_agestr_pro_fit_adj %>% filter(lhs == "slp" & group == 2) %>% select(est,se)

pro_int_mean_early <- pro_int_early$est
pro_int_se_early <- pro_int_early$se
pro_int_mean_late <- pro_int_late$est
pro_int_se_late <- pro_int_late$se
pro_int_diff <- calc_z_p_values(pro_int_mean_early,pro_int_se_early,pro_int_mean_late,pro_int_se_late)
pro_int_diff
pro_slp_mean_early <- pro_slp_early$est
pro_slp_se_early <- pro_slp_early$se
pro_slp_mean_late <- pro_slp_late$est
pro_slp_se_late <- pro_slp_late$se
pro_slp_diff <-calc_z_p_values(pro_slp_mean_early,pro_slp_se_early,pro_slp_mean_late,pro_slp_se_late)
pro_slp_diff
```

```{r}
mcs_sexstr_pro_adj <- "
int =~ 1*BPROSOC + 1*CPROSOC + 1*DDPROSOC + 1*EPROSOC + 1*FPROSOC + 1*GPROSOC
slp =~ 3*BPROSOC + 5*CPROSOC + 7*DDPROSOC + 11*EPROSOC + 14*FPROSOC + 17*GPROSOC

# the parametres for slope reflect the designed ages at corresponding sweeps
"

mcs_sexstr_pro_fit_adj <- growth(mcs_sexstr_pro_adj, data = MCS_sdq_autism, group = "sex",  missing = "fiml", estimator = "ml", fixed.x = F)
#summary(mcs_sexstr_pro_fit_adj)
fit_mcs_autism_pro_adj <- growth(mcs_sexstr_pro_adj, data = MCS_sdq_autism, missing = "fiml", estimator = "ml", fixed.x = F)
mcs_agestr_pro_fit_adj_asd <- growth(mcs_sexstr_pro_adj, data = MCS_sdq_autism, group = "grp_num",  missing = "fiml", estimator = "ml", fixed.x = F)

```
```{r}
anova_pro_age <- anova(fit_mcs_autism_pro_adj,mcs_agestr_pro_fit_adj_asd)
anova_pro_sex <- anova(fit_mcs_autism_pro_adj,mcs_sexstr_pro_fit_adj)
anova_pro_age_results<- data.frame(anova_pro_age)
anova_pro_sex_results<- data.frame(anova_pro_sex)
anova_pro <- rbind(anova_pro_age_results,anova_pro_sex_results)
anova_pro
```

```{r}
est_mcs_sexstr_pro_fit_adj <- parameterEstimates(mcs_sexstr_pro_fit_adj) %>% filter(grepl("^(int|slp)$", lhs) & op == "~1")
results_mcs_sexstr_pro <- est_mcs_sexstr_pro_fit_adj %>%
  dplyr::select(lhs,group, est, ci.lower, ci.upper, pvalue) %>%
  mutate(Estimates = paste(round(est, 2), " [", round(ci.lower, 2), ", ", round(ci.upper, 2), "]"),
         p_value = round(pvalue,3)) %>%
  dplyr::select(lhs,group,Estimates, p_value)
results_mcs_sexstr_pro
```



# LGCM grouped by diag.age, regressed with sex
## Total 
```{r}
mcs_agestr_sex_ttl <- "
int =~ 1*BEBDTOT + 1*CEBDTOT + 1*DDDEBDTOT + 1*EEBDTOT + 1*FEBDTOT + 1*GEBDTOT
slp =~ 3*BEBDTOT + 5*CEBDTOT + 7*DDDEBDTOT + 11*EEBDTOT + 14*FEBDTOT + 17*GEBDTOT
int ~ sex_num
slp ~ sex_num
sex_num ~~ sex_num"


mcs_agestr_sex_ttl_fit <- growth(mcs_agestr_sex_ttl, data = MCS_sdq_all, group = "grp_num",
                                 missing = "fiml", estimator = "ml", fixed.x = F)
summary(mcs_agestr_sex_ttl_fit)
```

## Emotional
```{r}
mcs_agestr_sex_emo <- "
int =~ 1*BEMOTION + 1*CEMOTION + 1*DDEMOTION + 1*EEMOTION + 1*FEMOTION + 1*GEMOTION
slp =~ 3*BEMOTION + 5*CEMOTION + 7*DDEMOTION + 11*EEMOTION + 14*FEMOTION + 17*GEMOTION
int ~ sex_num
slp ~ sex_num
sex_num ~~ sex_num"


mcs_agestr_sex_emo_fit <- growth(mcs_agestr_sex_emo, data = MCS_sdq_all, group = "grp_num",
                                 missing = "fiml", estimator = "ml", fixed.x = F)
summary(mcs_agestr_sex_emo_fit)
```
## Conduct
```{r}
mcs_agestr_sex_con <- "
int =~ 1*BCONDUCT + 1*CCONDUCT + 1*DDCONDUCT + 1*ECONDUCT + 1*FCONDUCT + 1*GCONDUCT
slp =~ 3*BCONDUCT + 5*CCONDUCT + 7*DDCONDUCT + 11*ECONDUCT + 14*FCONDUCT + 17*GCONDUCT
int ~ sex_num
slp ~ sex_num
sex_num ~~ sex_num"


mcs_agestr_sex_con_fit <- growth(mcs_agestr_sex_con, data = MCS_sdq_all, group = "grp_num",
                                 missing = "fiml", estimator = "ml", fixed.x = F)
#summary(mcs_agestr_sex_con_fit)
```
## Hyperactivity
```{r}
mcs_agestr_sex_hyp <- "
int =~ 1*BHYPER + 1*CHYPER + 1*DDHYPER + 1*EHYPER + 1*FHYPER + 1*GHYPER
slp =~ 3*BHYPER + 5*CHYPER + 7*DDHYPER + 11*EHYPER + 14*FHYPER + 17*GHYPER
int ~ sex_num
slp ~ sex_num
sex_num ~~ sex_num"


mcs_agestr_sex_hyp_fit <- growth(mcs_agestr_sex_hyp, data = MCS_sdq_all, group = "grp_num",
                                 missing = "fiml", estimator = "ml", fixed.x = F)
#summary(mcs_agestr_sex_hyp_fit)
```
## Peer
```{r}
mcs_agestr_sex_peer <- "
int =~ 1*BPEER + 1*CPEER + 1*DDPEER + 1*EPEER + 1*FPEER + 1*GPEER
slp =~ 3*BPEER + 5*CPEER + 7*DDPEER + 11*EPEER + 14*FPEER + 17*GPEER
int ~ sex_num
slp ~ sex_num
sex_num ~~ sex_num"


mcs_agestr_sex_peer_fit <- growth(mcs_agestr_sex_peer, data = MCS_sdq_all, group = "grp_num",
                                 missing = "fiml", estimator = "ml", fixed.x = F)
#summary(mcs_agestr_sex_peer_fit)
```

## Prosocial
```{r}
mcs_agestr_sex_pro <- "
int =~ 1*BPROSOC + 1*CPROSOC + 1*DDPROSOC + 1*EPROSOC + 1*FPROSOC + 1*GPROSOC
slp =~ 3*BPROSOC + 5*CPROSOC + 7*DDPROSOC + 11*EPROSOC + 14*FPROSOC + 17*GPROSOC
int ~ sex_num
slp ~ sex_num
sex_num ~~ sex_num"


mcs_agestr_sex_pro_fit <- growth(mcs_agestr_sex_pro, data = MCS_sdq_all, group = "grp_num",
                                 missing = "fiml", estimator = "ml", fixed.x = F)
summary(mcs_agestr_sex_pro_fit)
```

```{r}
est_mcs_agestr_sex_ttl_fit <- parameterEstimates(mcs_agestr_sex_ttl_fit) %>% filter(grepl("^(int|slp)$", lhs) & op == "~1")
results_mcs_agestr_sex_ttl <- est_mcs_agestr_sex_ttl_fit %>%
  dplyr::select(lhs,group, est, ci.lower, ci.upper, pvalue) %>%
  mutate(Estimates = paste(round(est, 2), " [", round(ci.lower, 2), ", ", round(ci.upper, 2), "]"),
         p_value = round(pvalue,3)) %>%
  dplyr::select(lhs,group,Estimates, p_value)
  

est_mcs_agestr_sex_emo_fit <- parameterEstimates(mcs_agestr_sex_emo_fit) %>% filter(grepl("int|slp", lhs) & op == "~1")
results_mcs_agestr_sex_emo <- est_mcs_agestr_sex_emo_fit %>%
  dplyr::select(lhs,group, est, ci.lower, ci.upper, pvalue) %>%
  mutate(Estimates = paste(round(est, 2), " [", round(ci.lower, 2), ", ", round(ci.upper, 2), "]"),
         p_value = round(pvalue,3)) %>%
  dplyr::select(lhs,group,Estimates, p_value)


est_mcs_agestr_sex_con_fit <- parameterEstimates(mcs_agestr_sex_con_fit) %>% filter(grepl("int|slp", lhs)& op == "~1")
results_mcs_agestr_sex_con <- est_mcs_agestr_sex_con_fit %>%
  dplyr::select(lhs,group, est, ci.lower, ci.upper, pvalue) %>%
  mutate(Estimates = paste(round(est, 2), " [", round(ci.lower, 2), ", ", round(ci.upper, 2), "]"),
         p_value = round(pvalue,3)) %>%
  dplyr::select(lhs,group,Estimates, p_value)



est_mcs_agestr_sex_hyp_fit <- parameterEstimates(mcs_agestr_sex_hyp_fit) %>% filter(grepl("int|slp", lhs)& op == "~1")
results_mcs_agestr_sex_hyp <- est_mcs_agestr_sex_hyp_fit %>%
  dplyr::select(lhs,group, est, ci.lower, ci.upper, pvalue) %>%
  mutate(Estimates = paste(round(est, 2), " [", round(ci.lower, 2), ", ", round(ci.upper, 2), "]"),
         p_value = round(pvalue,3)) %>%
  dplyr::select(lhs,group,Estimates, p_value)



est_mcs_agestr_sex_peer_fit <- parameterEstimates(mcs_agestr_sex_peer_fit) %>% filter(grepl("int|slp", lhs)& op == "~1")
results_mcs_agestr_sex_peer <- est_mcs_agestr_sex_peer_fit %>%
  dplyr::select(lhs,group, est, ci.lower, ci.upper, pvalue) %>%
  mutate(Estimates = paste(round(est, 2), " [", round(ci.lower, 2), ", ", round(ci.upper, 2), "]"),
         p_value = round(pvalue,3)) %>%
  dplyr::select(lhs,group,Estimates, p_value)



est_mcs_agestr_sex_pro_fit <- parameterEstimates(mcs_agestr_sex_pro_fit) %>% filter(grepl("int|slp", lhs)& op == "~1")
results_mcs_agestr_sex_pro <- est_mcs_agestr_sex_pro_fit %>%
  dplyr::select(lhs,group, est, ci.lower, ci.upper, pvalue) %>%
  mutate(Estimates = paste(round(est, 2), " [", round(ci.lower, 2), ", ", round(ci.upper, 2), "]"),
         p_value = round(pvalue,3)) %>%
  dplyr::select(lhs,group,Estimates, p_value)

agestr_sex_results_results_table <- rbind(results_mcs_agestr_sex_ttl,results_mcs_agestr_sex_emo,results_mcs_agestr_sex_con,results_mcs_agestr_sex_hyp,results_mcs_agestr_sex_peer,results_mcs_agestr_sex_pro)
agestr_sex_results_results_table
```




# Startified by sex
## Total
```{r}
mcs_sexstr_ttl <- "
int =~ 1*BEBDTOT + 1*CEBDTOT + 1*DDDEBDTOT + 1*EEBDTOT + 1*FEBDTOT + 1*GEBDTOT
slp =~ 0*BEBDTOT + 1*CEBDTOT + 2*DDDEBDTOT + 3*EEBDTOT + 4*FEBDTOT + 5*GEBDTOT
"


mcs_sexstr_ttl_fit <- growth(mcs_sexstr_ttl, data = MCS_sdq_autism, group = "sex_num",
                                 missing = "fiml", estimator = "ml", fixed.x = F)
summary(mcs_sexstr_ttl_fit)
```


## Emotional
```{r}
mcs_sexstr_emo <- "
emo.int =~ 1*BEMOTION + 1*CEMOTION + 1*DDEMOTION + 1*EEMOTION + 1*FEMOTION + 1*GEMOTION
emo.slp =~ 0*BEMOTION + 1*CEMOTION + 2*DDEMOTION + 3*EEMOTION + 4*FEMOTION + 5*GEMOTION
"


mcs_sexstr_emo_fit <- growth(mcs_sexstr_emo, data = MCS_sdq_autism, group = "sex_num",
                                 missing = "fiml", estimator = "ml", fixed.x = F)
summary(mcs_sexstr_emo_fit)
```

## Conduct
```{r}
mcs_sexstr_con <- "
con.int =~ 1*BCONDUCT + 1*CCONDUCT + 1*DDCONDUCT + 1*ECONDUCT + 1*FCONDUCT + 1*GCONDUCT
con.slp =~ 0*BCONDUCT + 1*CCONDUCT + 2*DDCONDUCT + 3*ECONDUCT + 4*FCONDUCT + 5*GCONDUCT
"


mcs_sexstr_con_fit <- growth(mcs_sexstr_con, data = MCS_sdq_autism, group = "sex_num",
                                 missing = "fiml", estimator = "ml", fixed.x = F)
summary(mcs_sexstr_con_fit)
```

## Hyperactivity
```{r}
mcs_sexstr_hyp <- "
hyp.int =~ 1*BHYPER + 1*CHYPER + 1*DDHYPER + 1*EHYPER + 1*FHYPER + 1*GHYPER
hyp.slp =~ 0*BHYPER + 1*CHYPER + 2*DDHYPER + 3*EHYPER + 4*FHYPER + 5*GHYPER
"


mcs_sexstr_hyp_fit <- growth(mcs_sexstr_hyp, data = MCS_sdq_autism, group = "sex_num",
                                 missing = "fiml", estimator = "ml", fixed.x = F)
summary(mcs_sexstr_hyp_fit)
```

## Peer
```{r}
mcs_sexstr_peer <- "
peer.int =~ 1*BPEER + 1*CPEER + 1*DDPEER + 1*EPEER + 1*FPEER + 1*GPEER
peer.slp =~ 0*BPEER + 1*CPEER + 2*DDPEER + 3*EPEER + 4*FPEER + 5*GPEER
"


mcs_sexstr_peer_fit <- growth(mcs_sexstr_peer, data = MCS_sdq_autism, group = "sex_num",
                                 missing = "fiml", estimator = "ml", fixed.x = F)
summary(mcs_sexstr_peer_fit)
```

## Prosocial
```{r}
mcs_sexstr_pro <- "
pro.int =~ 1*BPROSOC + 1*CPROSOC + 1*DDPROSOC + 1*EPROSOC + 1*FPROSOC + 1*GPROSOC
pro.slp =~ 0*BPROSOC + 1*CPROSOC + 2*DDPROSOC + 3*EPROSOC + 4*FPROSOC + 5*GPROSOC
"


mcs_sexstr_pro_fit <- growth(mcs_sexstr_pro, data = MCS_sdq_autism, group = "sex_num",
                                 missing = "fiml", estimator = "ml", fixed.x = F)
summary(mcs_sexstr_pro_fit)
```

```{r}
est_mcs_sexstr_ttl_fit <- parameterEstimates(mcs_sexstr_ttl_fit) %>% filter(grepl("^(int|slp)$", lhs) & op == "~1")
results_mcs_sexstr_ttl <- est_mcs_sexstr_ttl_fit %>%
  dplyr::select(lhs,group, est, ci.lower, ci.upper, pvalue) %>%
  mutate(Estimates = paste(round(est, 2), " [", round(ci.lower, 2), ", ", round(ci.upper, 2), "]"),
         p_value = round(pvalue,3)) %>%
  dplyr::select(lhs,group,Estimates, p_value)
  

est_mcs_sexstr_emo_fit <- parameterEstimates(mcs_sexstr_emo_fit) %>% filter(grepl("int|slp", lhs) & op == "~1")
results_mcs_sexstr_emo <- est_mcs_sexstr_emo_fit %>%
  dplyr::select(lhs,group, est, ci.lower, ci.upper, pvalue) %>%
  mutate(Estimates = paste(round(est, 2), " [", round(ci.lower, 2), ", ", round(ci.upper, 2), "]"),
         p_value = round(pvalue,3)) %>%
  dplyr::select(lhs,group,Estimates, p_value)


est_mcs_sexstr_con_fit <- parameterEstimates(mcs_sexstr_con_fit) %>% filter(grepl("int|slp", lhs)& op == "~1")
results_mcs_sexstr_con <- est_mcs_sexstr_con_fit %>%
  dplyr::select(lhs,group, est, ci.lower, ci.upper, pvalue) %>%
  mutate(Estimates = paste(round(est, 2), " [", round(ci.lower, 2), ", ", round(ci.upper, 2), "]"),
         p_value = round(pvalue,3)) %>%
  dplyr::select(lhs,group,Estimates, p_value)



est_mcs_sexstr_hyp_fit <- parameterEstimates(mcs_sexstr_hyp_fit) %>% filter(grepl("int|slp", lhs)& op == "~1")
results_mcs_sexstr_hyp <- est_mcs_sexstr_hyp_fit %>%
  dplyr::select(lhs,group, est, ci.lower, ci.upper, pvalue) %>%
  mutate(Estimates = paste(round(est, 2), " [", round(ci.lower, 2), ", ", round(ci.upper, 2), "]"),
         p_value = round(pvalue,3)) %>%
  dplyr::select(lhs,group,Estimates, p_value)



est_mcs_sexstr_peer_fit <- parameterEstimates(mcs_sexstr_peer_fit) %>% filter(grepl("int|slp", lhs)& op == "~1")
results_mcs_sexstr_peer <- est_mcs_sexstr_peer_fit %>%
  dplyr::select(lhs,group, est, ci.lower, ci.upper, pvalue) %>%
  mutate(Estimates = paste(round(est, 2), " [", round(ci.lower, 2), ", ", round(ci.upper, 2), "]"),
         p_value = round(pvalue,3)) %>%
  dplyr::select(lhs,group,Estimates, p_value)



est_mcs_sexstr_pro_fit <- parameterEstimates(mcs_sexstr_pro_fit) %>% filter(grepl("int|slp", lhs)& op == "~1")
results_mcs_sexstr_pro <- est_mcs_sexstr_pro_fit %>%
  dplyr::select(lhs,group, est, ci.lower, ci.upper, pvalue) %>%
  mutate(Estimates = paste(round(est, 2), " [", round(ci.lower, 2), ", ", round(ci.upper, 2), "]"),
         p_value = round(pvalue,3)) %>%
  dplyr::select(lhs,group,Estimates, p_value)

sex_results_results_table <- rbind(results_mcs_sexstr_ttl,results_mcs_sexstr_emo,results_mcs_sexstr_con,results_mcs_sexstr_hyp,results_mcs_sexstr_peer,results_mcs_sexstr_pro)
sex_results_results_table
```


# Startified by sex regress with diag.age.grp

## Total
```{r}
mcs_sexstr_age_ttl <- "
int =~ 1*BEBDTOT + 1*CEBDTOT + 1*DDDEBDTOT + 1*EEBDTOT + 1*FEBDTOT + 1*GEBDTOT
slp =~ 3*BEBDTOT + 5*CEBDTOT + 7*DDDEBDTOT + 11*EEBDTOT + 14*FEBDTOT + 17*GEBDTOT
int ~ grp_num
slp ~ grp_num
grp_num ~~ grp_num"


mcs_sexstr_age_ttl_fit <- growth(mcs_sexstr_age_ttl, data = MCS_sdq_autism, group = "sex_num",
                                 missing = "fiml", estimator = "ml", fixed.x = F)
summary(mcs_sexstr_age_ttl_fit)
```

## Emotional
```{r}
mcs_sexstr_age_emo <- "
int =~ 1*BEMOTION + 1*CEMOTION + 1*DDEMOTION + 1*EEMOTION + 1*FEMOTION + 1*GEMOTION
slp =~ 3*BEMOTION + 5*CEMOTION + 7*DDEMOTION + 11*EEMOTION + 14*FEMOTION + 17*GEMOTION
int ~ grp_num
slp ~ grp_num
grp_num ~~ grp_num"


mcs_sexstr_age_emo_fit <- growth(mcs_sexstr_age_emo, data = MCS_sdq_autism, group = "sex_num",
                                 missing = "fiml", estimator = "ml", fixed.x = F)
#summary(mcs_sexstr_age_emo_fit)
```

## Conduct
```{r}
mcs_sexstr_age_con <- "
int =~ 1*BCONDUCT + 1*CCONDUCT + 1*DDCONDUCT + 1*ECONDUCT + 1*FCONDUCT + 1*GCONDUCT
slp =~ 3*BCONDUCT + 5*CCONDUCT + 7*DDCONDUCT + 11*ECONDUCT + 14*FCONDUCT + 17*GCONDUCT
int ~ grp_num
slp ~ grp_num
grp_num ~~ grp_num"


mcs_sexstr_age_con_fit <- growth(mcs_sexstr_age_con, data = MCS_sdq_autism, group = "sex_num",
                                 missing = "fiml", estimator = "ml", fixed.x = F)
#summary(mcs_sexstr_age_con_fit)
```

## Hyperactivity
```{r}
mcs_sexstr_age_hyp <- "
int =~ 1*BHYPER + 1*CHYPER + 1*DDHYPER + 1*EHYPER + 1*FHYPER + 1*GHYPER
slp =~ 3*BHYPER + 5*CHYPER + 7*DDHYPER + 11*EHYPER + 14*FHYPER + 17*GHYPER
int ~ grp_num
slp ~ grp_num
grp_num ~~ grp_num"


mcs_sexstr_age_hyp_fit <- growth(mcs_sexstr_age_hyp, data = MCS_sdq_autism, group = "sex_num",
                                 missing = "fiml", estimator = "ml", fixed.x = F)
#summary(mcs_sexstr_age_hyp_fit)
```

## Peer
```{r}
mcs_sexstr_age_peer <- "
int =~ 1*BPEER + 1*CPEER + 1*DDPEER + 1*EPEER + 1*FPEER + 1*GPEER
slp =~ 3*BPEER + 5*CPEER + 7*DDPEER + 11*EPEER + 14*FPEER + 17*GPEER
int ~ grp_num
slp ~ grp_num
grp_num ~~ grp_num"


mcs_sexstr_age_peer_fit <- growth(mcs_sexstr_age_peer, data = MCS_sdq_autism, group = "sex_num",
                                 missing = "fiml", estimator = "ml", fixed.x = F)
#summary(mcs_sexstr_age_peer_fit)
```

## Prosocial
```{r}
mcs_sexstr_age_pro <- "
int =~ 1*BPROSOC + 1*CPROSOC + 1*DDPROSOC + 1*EPROSOC + 1*FPROSOC + 1*GPROSOC
slp =~ 3*BPROSOC + 5*CPROSOC + 7*DDPROSOC + 11*EPROSOC + 14*FPROSOC + 17*GPROSOC
int ~ grp_num
slp ~ grp_num
grp_num ~~ grp_num"


mcs_sexstr_age_pro_fit <- growth(mcs_sexstr_age_pro, data = MCS_sdq_autism, group = "sex_num",
                                 missing = "fiml", estimator = "ml", fixed.x = F)
#summary(mcs_sexstr_age_pro_fit)
```



```{r}
est_mcs_sexstr_age_ttl_fit <- parameterEstimates(mcs_sexstr_age_ttl_fit) %>% subset(lhs %in% c("int", "slp") & op == "~1")
results_mcs_sexstr_age_ttl <- est_mcs_sexstr_age_ttl_fit %>%
  dplyr::select(lhs,group, est, ci.lower, ci.upper, pvalue) %>%
  mutate(Estimates = paste(round(est, 2), " [", round(ci.lower, 2), ", ", round(ci.upper, 2), "]"),
         p_value = round(pvalue,3)) %>%
  dplyr::select(lhs,group,Estimates, p_value)
  

est_mcs_sexstr_age_emo_fit <- parameterEstimates(mcs_sexstr_age_emo_fit) %>% subset(lhs %in% c("int", "slp") & op == "~1")
results_mcs_sexstr_age_emo <- est_mcs_sexstr_age_emo_fit %>%
  dplyr::select(lhs,group, est, ci.lower, ci.upper, pvalue) %>%
  mutate(Estimates = paste(round(est, 2), " [", round(ci.lower, 2), ", ", round(ci.upper, 2), "]"),
         p_value = round(pvalue,3)) %>%
  dplyr::select(lhs,group,Estimates, p_value)


est_mcs_sexstr_age_con_fit <- parameterEstimates(mcs_sexstr_age_emo_fit) %>% subset(lhs %in% c("int", "slp") & op == "~1")
results_mcs_sexstr_age_con <- est_mcs_sexstr_age_con_fit %>%
  dplyr::select(lhs,group, est, ci.lower, ci.upper, pvalue) %>%
  mutate(Estimates = paste(round(est, 2), " [", round(ci.lower, 2), ", ", round(ci.upper, 2), "]"),
         p_value = round(pvalue,3)) %>%
  dplyr::select(lhs,group,Estimates, p_value)



est_mcs_sexstr_age_hyp_fit <- parameterEstimates(mcs_sexstr_age_hyp_fit) %>% subset(lhs %in% c("int", "slp") & op == "~1")
results_mcs_sexstr_age_hyp <- est_mcs_sexstr_age_hyp_fit %>%
  dplyr::select(lhs,group, est, ci.lower, ci.upper, pvalue) %>%
  mutate(Estimates = paste(round(est, 2), " [", round(ci.lower, 2), ", ", round(ci.upper, 2), "]"),
         p_value = round(pvalue,3)) %>%
  dplyr::select(lhs,group,Estimates, p_value)



est_mcs_sexstr_age_peer_fit <- parameterEstimates(mcs_sexstr_age_peer_fit) %>% subset(lhs %in% c("int", "slp") & op == "~1")
results_mcs_sexstr_age_peer <- est_mcs_sexstr_age_peer_fit %>%
  dplyr::select(lhs,group, est, ci.lower, ci.upper, pvalue) %>%
  mutate(Estimates = paste(round(est, 2), " [", round(ci.lower, 2), ", ", round(ci.upper, 2), "]"),
         p_value = round(pvalue,3)) %>%
  dplyr::select(lhs,group,Estimates, p_value)



est_mcs_sexstr_age_pro_fit <- parameterEstimates(mcs_sexstr_age_pro_fit) %>% subset(lhs %in% c("int", "slp") & op == "~1")
results_mcs_sexstr_age_pro <- est_mcs_sexstr_age_pro_fit %>%
  dplyr::select(lhs,group, est, ci.lower, ci.upper, pvalue) %>%
  mutate(Estimates = paste(round(est, 2), " [", round(ci.lower, 2), ", ", round(ci.upper, 2), "]"),
         p_value = round(pvalue,3)) %>%
  dplyr::select(lhs,group,Estimates, p_value)

sexstr_age_results_table <- rbind(results_mcs_sexstr_age_ttl,results_mcs_sexstr_age_emo,results_mcs_sexstr_age_con,results_mcs_sexstr_age_hyp,results_mcs_sexstr_age_peer,results_mcs_sexstr_age_pro)
sexstr_age_results_table

```


# Matching samples for early-late and sexes
```{r}
# mcs_autism_all_tip_gmm from mcs_gmm_tip_regression.Rmd
mcs_autism_sdp_tip <- merge(MCS_sdq_autism, mcs_autism_all_tip_gmm, by = "MCSID")

mcs_autism_sdq_for_match  <- mcs_autism_sdp_tip[,c(1,2,4:39,45:47,49,52,53,56,62,63,69:76)]
names(mcs_autism_sdq_for_match) <- c("MCSID","CNUM","BEMOTION","BCONDUCT","BHYPER","BPEER","BPROSOC","BEBDTOT","CEMOTION","CCONDUCT","CHYPER","CPEER","CPROSOC","CEBDTOT","DDEMOTION", 
"DDCONDUCT","DDHYPER","DDPEER","DDPROSOC","DDDEBDTOT",
"EEMOTION","ECONDUCT","EHYPER","EPEER","EPROSOC",
"EEBDTOT","FEMOTION","FCONDUCT","FHYPER","FPEER", 
"FPROSOC","FEBDTOT","GEMOTION","GCONDUCT","GHYPER",    
"GPEER","GPROSOC","GEBDTOT","sex","nuericID","diag.age","cmid","IQ","Eth","mad","ES","country","dep","ttl","emo","con","hyp","peer","pro","group")
```

```{r}
library(MatchIt)
library(tableone)
mcs_autism_sdq_for_match$Eth <- as.character(mcs_autism_sdq_for_match$Eth)
mcs_autism_sdq_for_match$country <- as.character(mcs_autism_sdq_for_match$country)
table1 <- CreateTableOne(vars = c('ES', 'sex', 'Eth','mad','country','dep','IQ'), 
                         data = mcs_autism_sdq_for_match, 
                         factorVars = 'sex', 
                         strata = 'group')
table1

mcs_autism_sdq_for_match$Group <- ifelse(mcs_autism_sdq_for_match$group == "early",1,0)
mcs_autism_sdq_for_match$Sex <- ifelse(mcs_autism_sdq_for_match$sex == "Male",0,1)
match.it_null <- matchit(Sex ~ Group + ES + Eth + mad + country + dep + IQ, data = mcs_autism_sdq_for_match, method=NULL, ratio=1)
summary(match.it_null)
match.it_nearest <- matchit(Sex ~ Group + ES + Eth + mad + country + dep + IQ, data = mcs_autism_sdq_for_match, method="nearest", ratio=1)
summary(match.it_nearest)
match.it_opt <- matchit(Sex ~ Group + ES + Eth + mad + country + dep + IQ, data = mcs_autism_sdq_for_match, method="optimal", ratio=1)
summary(match.it_opt)
match.it_full <- matchit(Sex ~ Group + ES + Eth + mad + country + dep + IQ, data = mcs_autism_sdq_for_match, method="full", ratio=1)
summary(match.it_full)
```

```{r}
plot(match.it_null, type = 'jitter', interactive = FALSE)
plot(match.it_nearest, type = 'jitter', interactive = FALSE)
plot(match.it_opt, type = 'jitter', interactive = FALSE)
plot(match.it_full, type = 'jitter', interactive = FALSE)
df.match_nearest <- match.data(match.it_nearest)[1:ncol(mcs_autism_sdq_for_match)]
table1_aft_nearest <- CreateTableOne(vars = c('ES', 'sex', 'Eth','mad','country','dep','IQ'), 
                         data = df.match, 
                         factorVars = 'sex', 
                         strata = 'group')
table1_aft_nearest

df.match_opt <- match.data(match.it_opt)[1:ncol(mcs_autism_sdq_for_match)]
table1_aft_opt <- CreateTableOne(vars = c('ES', 'sex', 'Eth','mad','country','dep','IQ'), 
                         data = df.match, 
                         factorVars = 'sex', 
                         strata = 'group')
table1_aft_opt

df.match_full <- match.data(match.it_full)[1:ncol(mcs_autism_sdq_for_match)]
table1_aft_full <- CreateTableOne(vars = c('ES', 'sex', 'Eth','mad','country','dep','IQ'), 
                         data = df.match, 
                         factorVars = 'sex', 
                         strata = 'group')
table1_aft_full
```

## Conduct LGCM on matched sample
```{r}
mcs_agestr_ttl_fit_matched_opt <- growth(mcs_agestr_ttl_adj, data = df.match_opt, group = "group",  missing = "fiml", estimator = "ml", fixed.x = F)
#summary(mcs_agestr_ttl_fit_matched)
mcs_all_ttl_fit_matched_opt <- growth(mcs_agestr_ttl_adj, data = df.match_opt,  missing = "fiml", estimator = "ml", fixed.x = F)
#summary(mcs_all_ttl_fit_matched)
mcs_sexstr_ttl_fit_matched_opt <- growth(mcs_agestr_ttl_adj, data = df.match_opt, group = "sex",  missing = "fiml", estimator = "ml", fixed.x = F)
#summary(mcs_sexstr_ttl_fit_matched)
anova(mcs_all_ttl_fit_matched_opt,mcs_agestr_ttl_fit_matched_opt)
anova(mcs_all_ttl_fit_matched_opt,mcs_sexstr_ttl_fit_matched_opt)


mcs_agestr_ttl_fit_matched_full <- growth(mcs_agestr_ttl_adj, data = df.match_full, group = "group",  missing = "fiml", estimator = "ml", fixed.x = F)
#summary(mcs_agestr_ttl_fit_matched)
mcs_all_ttl_fit_matched_full <- growth(mcs_agestr_ttl_adj, data = df.match_full,  missing = "fiml", estimator = "ml", fixed.x = F)
#summary(mcs_all_ttl_fit_matched)
mcs_sexstr_ttl_fit_matched_full <- growth(mcs_agestr_ttl_adj, data = df.match_full, group = "sex",  missing = "fiml", estimator = "ml", fixed.x = F)
#summary(mcs_sexstr_ttl_fit_matched)
anova(mcs_all_ttl_fit_matched_full,mcs_agestr_ttl_fit_matched_full)
anova(mcs_all_ttl_fit_matched_full,mcs_sexstr_ttl_fit_matched_full)


mcs_agestr_ttl_fit_matched_nearest <- growth(mcs_agestr_ttl_adj, data = df.match_nearest, group = "group",  missing = "fiml", estimator = "ml", fixed.x = F)
#summary(mcs_agestr_ttl_fit_matched)
mcs_all_ttl_fit_matched_nearest <- growth(mcs_agestr_ttl_adj, data = df.match_nearest,  missing = "fiml", estimator = "ml", fixed.x = F)
#summary(mcs_all_ttl_fit_matched)
mcs_sexstr_ttl_fit_matched_nearest <- growth(mcs_agestr_ttl_adj, data = df.match_nearest, group = "sex",  missing = "fiml", estimator = "ml", fixed.x = F)
#summary(mcs_sexstr_ttl_fit_matched)
anova(mcs_all_ttl_fit_matched_nearest,mcs_agestr_ttl_fit_matched_nearest)
anova(mcs_all_ttl_fit_matched_nearest,mcs_sexstr_ttl_fit_matched_nearest)
# matching method Full: agestr significant, sexstr not significant
# matching method optimal: agestr not significant, sexstr not significant
# matching method nearest: agestr not significant, sexstr significant
```
### Cross-lagged panel model
# data prep
```{r}
mcs_pattern <- read.csv("/Users/zhangxinhe/Documents/who recieves a diagnosis/MCS/mcs_loose_pattern.csv")
mcs_pattern <- mcs_pattern[-1]
MCS_autism$cmid <- paste(MCS_autism$MCSID, MCS_autism$CNUM, sep = "")
MCS_autism_clean <- subset(MCS_autism, select = -c(PID,MCSID_CNUM,Diagnosis.outcome.Label,ADHD.Diagnosis.Age))
mcs_strict_pattern <- inner_join(MCS_autism_clean, mcs_pattern, by = c("MCSID","cmid","PNUM"))
mcs_strict_pattern <- mcs_strict_pattern %>% dplyr::mutate_at(vars(CPAUTS00:FPAUTS00), ~ifelse(. %in% c(2,NA), 0,.))
# create new indicators to only display 1 when its the sweep the child got a diagnosis
mcs_strict_pattern$Cdiag <- mcs_strict_pattern$CPAUTS00
mcs_strict_pattern$Ddiag <- ifelse(mcs_strict_pattern$CPAUTS00 == 0 & mcs_strict_pattern$DPAUTS00 == 1, 1, 0)
mcs_strict_pattern$Ediag <- ifelse(mcs_strict_pattern$DPAUTS00 == 0 & mcs_strict_pattern$EPAUTS00 == 1, 1, 0)
mcs_strict_pattern$Fdiag <- ifelse(mcs_strict_pattern$EPAUTS00 == 0 & mcs_strict_pattern$FPAUTS00 == 1, 1, 0)

```

# SEM
```{r}
library(lavaan)
clpm_model <- 'int =~ 1*BEBDTOT + 1*CEBDTOT + 1*DDDEBDTOT + 1*EEBDTOT + 1*FEBDTOT + 1*GEBDTOT
slp =~ 3*BEBDTOT + 5*CEBDTOT + 7*DDDEBDTOT + 11*EEBDTOT + 14*FEBDTOT + 17*GEBDTOT
               
               Cdiag ~ 1 + BEBDTOT
               Ddiag ~ 1 + CEBDTOT + Cdiag
               Ediag ~ 1 + Ddiag + DDDEBDTOT
               Fdiag ~ 1 + Ediag + EEBDTOT
               
               CEBDTOT ~ 1 + BEBDTOT
               DDDEBDTOT ~ 1 + CEBDTOT + Cdiag
               EEBDTOT ~ 1 + DDDEBDTOT + Ddiag
               FEBDTOT ~ 1 + EEBDTOT + Ediag
               GEBDTOT ~ 1 + FEBDTOT + Fdiag

              CEBDTOT ~~ Cdiag
              DDDEBDTOT ~~ Ddiag
              EEBDTOT ~~ Ediag
             FEBDTOT ~~ Fdiag
'

fit_clpm <- sem(clpm_model, data = mcs_strict_pattern, ordered = c("Cdiag","Ddiag","Ediag","Fdiag"))
summary(fit_clpm)
```

```{r}
library(semPlot)
semPaths(fit_clpm, what = "paths")
```